<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Raajje Theft Auto 1: The Baokalo Chronicles</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        
        body {
            background: #0a0a0a;
            color: #fff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            touch-action: none;
        }
        
        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #game-canvas {
            background: #1a3a4a;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }
        
        /* Main Menu Styles */
        #main-menu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0d1b2a 0%, #1b263b 50%, #415a77 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        #main-menu.hidden {
            display: none;
        }
        
        .menu-title {
            font-size: clamp(24px, 6vw, 48px);
            font-weight: bold;
            color: #e0e1dd;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
            margin-bottom: 10px;
            text-align: center;
        }
        
        .menu-subtitle {
            font-size: clamp(14px, 3vw, 24px);
            color: #778da9;
            margin-bottom: 40px;
            text-align: center;
        }
        
        .menu-btn {
            width: clamp(200px, 60vw, 300px);
            padding: 15px 30px;
            margin: 10px;
            font-size: clamp(14px, 3vw, 18px);
            font-weight: bold;
            color: #e0e1dd;
            background: linear-gradient(180deg, #415a77 0%, #1b263b 100%);
            border: 2px solid #778da9;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .menu-btn:hover, .menu-btn:active {
            background: linear-gradient(180deg, #778da9 0%, #415a77 100%);
            transform: scale(1.05);
        }
        
        .menu-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* HUD Styles */
        #hud {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            pointer-events: none;
            z-index: 50;
        }
        
        #hud.hidden {
            display: none;
        }
        
        .hud-top {
            display: flex;
            justify-content: space-between;
            padding: 10px;
        }
        
        .hud-stat {
            background: rgba(0,0,0,0.7);
            padding: 8px 12px;
            border-radius: 5px;
            font-size: clamp(10px, 2.5vw, 14px);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .stat-bar {
            width: 60px;
            height: 8px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .stat-fill {
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .health-fill { background: linear-gradient(90deg, #ff4444, #ff6666); }
        .stamina-fill { background: linear-gradient(90deg, #44ff44, #66ff66); }
        .karma-fill { background: linear-gradient(90deg, #4444ff, #6666ff); }
        
        #mini-map {
            position: absolute;
            bottom: 100px;
            right: 10px;
            width: clamp(80px, 20vw, 150px);
            height: clamp(80px, 20vw, 150px);
            background: rgba(0,0,0,0.7);
            border: 2px solid #778da9;
            border-radius: 5px;
            overflow: hidden;
        }
        
        /* Touch Controls */
        #touch-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 200px;
            pointer-events: none;
            z-index: 60;
        }
        
        #touch-controls.hidden {
            display: none;
        }
        
        .joystick-container {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 120px;
            height: 120px;
            pointer-events: auto;
        }
        
        .joystick-base {
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.2);
            border: 3px solid rgba(255,255,255,0.4);
            border-radius: 50%;
        }
        
        .joystick-stick {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 50px;
            height: 50px;
            background: rgba(255,255,255,0.6);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: none;
        }
        
        .action-buttons {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            pointer-events: auto;
        }
        
        .action-btn {
            width: 60px;
            height: 60px;
            background: rgba(255,255,255,0.2);
            border: 3px solid rgba(255,255,255,0.4);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.1s ease;
        }
        
        .action-btn:active {
            background: rgba(255,255,255,0.5);
            transform: scale(0.9);
        }
        
        .action-btn.attack { border-color: #ff6666; }
        .action-btn.interact { border-color: #66ff66; }
        .action-btn.sprint { border-color: #6666ff; }
        .action-btn.menu { border-color: #ffff66; }
        
        /* Dialogue Box */
        #dialogue-box {
            position: absolute;
            bottom: 220px;
            left: 50%;
            transform: translateX(-50%);
            width: clamp(280px, 90vw, 600px);
            background: rgba(0,0,0,0.9);
            border: 2px solid #778da9;
            border-radius: 10px;
            padding: 15px;
            z-index: 70;
        }
        
        #dialogue-box.hidden {
            display: none;
        }
        
        .dialogue-speaker {
            font-size: clamp(12px, 3vw, 16px);
            font-weight: bold;
            color: #778da9;
            margin-bottom: 8px;
        }
        
        .dialogue-text {
            font-size: clamp(14px, 3.5vw, 18px);
            color: #e0e1dd;
            line-height: 1.4;
            margin-bottom: 10px;
        }
        
        .dialogue-choices {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .dialogue-choice {
            padding: 10px;
            background: rgba(65, 90, 119, 0.5);
            border: 1px solid #778da9;
            border-radius: 5px;
            cursor: pointer;
            font-size: clamp(12px, 3vw, 14px);
            color: #e0e1dd;
            pointer-events: auto;
        }
        
        .dialogue-choice:hover, .dialogue-choice:active {
            background: rgba(119, 141, 169, 0.5);
        }
        
        .dialogue-choice.karma-good { border-left: 4px solid #66ff66; }
        .dialogue-choice.karma-bad { border-left: 4px solid #ff6666; }
        
        /* Mission Tracker */
        #mission-tracker {
            position: absolute;
            top: 60px;
            left: 10px;
            max-width: clamp(150px, 40vw, 250px);
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 5px;
            border-left: 3px solid #ffcc00;
        }
        
        #mission-tracker.hidden {
            display: none;
        }
        
        .mission-title {
            font-size: clamp(10px, 2.5vw, 14px);
            font-weight: bold;
            color: #ffcc00;
            margin-bottom: 5px;
        }
        
        .mission-objective {
            font-size: clamp(9px, 2vw, 12px);
            color: #e0e1dd;
        }
        
        /* Notification */
        #notification {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            padding: 20px 40px;
            border-radius: 10px;
            border: 2px solid #ffcc00;
            text-align: center;
            z-index: 80;
            opacity: 0;
            transition: opacity 0.5s ease;
            pointer-events: none;
        }
        
        #notification.show {
            opacity: 1;
        }
        
        .notif-title {
            font-size: clamp(16px, 4vw, 24px);
            font-weight: bold;
            color: #ffcc00;
            margin-bottom: 10px;
        }
        
        .notif-text {
            font-size: clamp(12px, 3vw, 16px);
            color: #e0e1dd;
        }
        
        /* Sub-menus */
        .sub-menu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(13, 27, 42, 0.95);
            display: flex;
            flex-direction: column;
            z-index: 90;
            overflow-y: auto;
        }
        
        .sub-menu.hidden {
            display: none;
        }
        
        .sub-menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(0,0,0,0.5);
            border-bottom: 2px solid #778da9;
        }
        
        .sub-menu-title {
            font-size: clamp(18px, 4vw, 24px);
            font-weight: bold;
            color: #e0e1dd;
        }
        
        .close-btn {
            width: 40px;
            height: 40px;
            background: rgba(255,100,100,0.3);
            border: 2px solid #ff6666;
            border-radius: 50%;
            color: #ff6666;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .sub-menu-content {
            padding: 15px;
            flex: 1;
            overflow-y: auto;
        }
        
        /* Codex */
        .codex-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 15px;
        }
        
        .codex-tab {
            padding: 8px 15px;
            background: rgba(65, 90, 119, 0.3);
            border: 1px solid #778da9;
            border-radius: 5px;
            cursor: pointer;
            font-size: clamp(10px, 2.5vw, 14px);
            color: #e0e1dd;
        }
        
        .codex-tab.active {
            background: rgba(119, 141, 169, 0.5);
        }
        
        .codex-entry {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .codex-entry-title {
            font-size: clamp(14px, 3vw, 18px);
            font-weight: bold;
            color: #778da9;
            margin-bottom: 8px;
        }
        
        .codex-entry-text {
            font-size: clamp(12px, 2.5vw, 14px);
            color: #e0e1dd;
            line-height: 1.5;
        }
        
        /* Upgrades */
        .upgrade-tree {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .upgrade-category {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #778da9;
        }
        
        .upgrade-category-title {
            font-size: clamp(14px, 3vw, 18px);
            font-weight: bold;
            color: #ffcc00;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .upgrade-item {
            padding: 10px;
            background: rgba(65, 90, 119, 0.3);
            border: 1px solid #778da9;
            border-radius: 5px;
            margin-bottom: 8px;
            cursor: pointer;
        }
        
        .upgrade-item:hover {
            background: rgba(119, 141, 169, 0.3);
        }
        
        .upgrade-item.unlocked {
            border-color: #66ff66;
            background: rgba(102, 255, 102, 0.1);
        }
        
        .upgrade-item.locked {
            opacity: 0.5;
        }
        
        .upgrade-name {
            font-size: clamp(11px, 2.5vw, 14px);
            font-weight: bold;
            color: #e0e1dd;
        }
        
        .upgrade-cost {
            font-size: clamp(10px, 2vw, 12px);
            color: #ffcc00;
        }
        
        /* Mini-game overlay */
        #minigame-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 85;
        }
        
        #minigame-overlay.hidden {
            display: none;
        }
        
        .minigame-title {
            font-size: clamp(20px, 5vw, 32px);
            font-weight: bold;
            color: #ffcc00;
            margin-bottom: 20px;
        }
        
        #minigame-canvas {
            border: 3px solid #778da9;
            border-radius: 10px;
        }
        
        .minigame-score {
            font-size: clamp(14px, 3vw, 20px);
            color: #e0e1dd;
            margin-top: 15px;
        }
        
        /* Radio */
        #radio-display {
            position: absolute;
            top: 60px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid #778da9;
            max-width: 200px;
        }
        
        #radio-display.hidden {
            display: none;
        }
        
        .radio-station {
            font-size: clamp(10px, 2.5vw, 12px);
            color: #ffcc00;
            font-weight: bold;
        }
        
        .radio-text {
            font-size: clamp(9px, 2vw, 11px);
            color: #e0e1dd;
            margin-top: 5px;
            font-style: italic;
        }
        
        /* Weather overlay */
        #weather-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 40;
        }
        
        .rain-drop {
            position: absolute;
            width: 2px;
            height: 15px;
            background: linear-gradient(transparent, rgba(174, 194, 224, 0.6));
            animation: rain-fall linear infinite;
        }
        
        @keyframes rain-fall {
            0% { transform: translateY(-100vh); }
            100% { transform: translateY(100vh); }
        }
        
        /* Loading screen */
        #loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0a0a0a;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200;
        }
        
        #loading-screen.hidden {
            display: none;
        }
        
        .loading-text {
            font-size: clamp(16px, 4vw, 24px);
            color: #778da9;
            margin-bottom: 20px;
        }
        
        .loading-bar {
            width: clamp(200px, 60vw, 400px);
            height: 10px;
            background: #333;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .loading-fill {
            height: 100%;
            background: linear-gradient(90deg, #415a77, #778da9);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        /* Pause menu */
        #pause-menu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 95;
        }
        
        #pause-menu.hidden {
            display: none;
        }
        
        .pause-title {
            font-size: clamp(24px, 6vw, 36px);
            font-weight: bold;
            color: #e0e1dd;
            margin-bottom: 30px;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <!-- Loading Screen -->
        <div id="loading-screen">
            <div class="loading-text">Loading Raajje Theft Auto...</div>
            <div class="loading-bar">
                <div class="loading-fill" id="loading-fill"></div>
            </div>
        </div>
        
        <!-- Main Menu -->
        <div id="main-menu" class="hidden">
            <div class="menu-title">üèùÔ∏è RAAJJE THEFT AUTO 1 üèùÔ∏è</div>
            <div class="menu-subtitle">The Baokalo Chronicles</div>
            <button class="menu-btn" id="btn-new-game">üéÆ New Game</button>
            <button class="menu-btn" id="btn-continue" disabled>üìÇ Continue</button>
            <button class="menu-btn" id="btn-load-act">üìã Load Act</button>
            <button class="menu-btn" id="btn-codex">üìö Codex</button>
            <button class="menu-btn" id="btn-upgrades">‚¨ÜÔ∏è Upgrades</button>
            <button class="menu-btn" id="btn-options">‚öôÔ∏è Options</button>
            <button class="menu-btn" id="btn-achievements">üèÜ Achievements</button>
        </div>
        
        <!-- Game Canvas -->
        <canvas id="game-canvas"></canvas>
        
        <!-- HUD -->
        <div id="hud" class="hidden">
            <div class="hud-top">
                <div class="hud-stat">
                    ‚ù§Ô∏è <div class="stat-bar"><div class="stat-fill health-fill" id="health-bar" style="width: 100%"></div></div>
                </div>
                <div class="hud-stat">
                    ‚ö° <div class="stat-bar"><div class="stat-fill stamina-fill" id="stamina-bar" style="width: 100%"></div></div>
                </div>
                <div class="hud-stat">
                    ‚òØÔ∏è <div class="stat-bar"><div class="stat-fill karma-fill" id="karma-bar" style="width: 50%"></div></div>
                </div>
                <div class="hud-stat">
                    üí∞ <span id="money-display">0</span>
                </div>
            </div>
            <div id="mini-map">
                <canvas id="minimap-canvas"></canvas>
            </div>
        </div>
        
        <!-- Mission Tracker -->
        <div id="mission-tracker" class="hidden">
            <div class="mission-title" id="mission-title">Mission</div>
            <div class="mission-objective" id="mission-objective">Objective</div>
        </div>
        
        <!-- Dialogue Box -->
        <div id="dialogue-box" class="hidden">
            <div class="dialogue-speaker" id="dialogue-speaker">Speaker</div>
            <div class="dialogue-text" id="dialogue-text">Text</div>
            <div class="dialogue-choices" id="dialogue-choices"></div>
        </div>
        
        <!-- Touch Controls -->
        <div id="touch-controls" class="hidden">
            <div class="joystick-container" id="joystick-container">
                <div class="joystick-base">
                    <div class="joystick-stick" id="joystick-stick"></div>
                </div>
            </div>
            <div class="action-buttons">
                <button class="action-btn attack" id="btn-attack">üëä</button>
                <button class="action-btn interact" id="btn-interact">ü§ù</button>
                <button class="action-btn sprint" id="btn-sprint">üèÉ</button>
                <button class="action-btn menu" id="btn-pause">‚è∏Ô∏è</button>
            </div>
        </div>
        
        <!-- Notification -->
        <div id="notification">
            <div class="notif-title" id="notif-title">Title</div>
            <div class="notif-text" id="notif-text">Text</div>
        </div>
        
        <!-- Radio Display -->
        <div id="radio-display" class="hidden">
            <div class="radio-station" id="radio-station">üìª Raajje FM</div>
            <div class="radio-text" id="radio-text">Loading...</div>
        </div>
        
        <!-- Weather Overlay -->
        <div id="weather-overlay"></div>
        
        <!-- Mini-game Overlay -->
        <div id="minigame-overlay" class="hidden">
            <div class="minigame-title" id="minigame-title">Mini-Game</div>
            <canvas id="minigame-canvas" width="400" height="300"></canvas>
            <div class="minigame-score" id="minigame-score">Score: 0</div>
        </div>
        
        <!-- Pause Menu -->
        <div id="pause-menu" class="hidden">
            <div class="pause-title">‚è∏Ô∏è PAUSED</div>
            <button class="menu-btn" id="btn-resume">‚ñ∂Ô∏è Resume</button>
            <button class="menu-btn" id="btn-save">üíæ Save Game</button>
            <button class="menu-btn" id="btn-load">üìÇ Load Game</button>
            <button class="menu-btn" id="btn-options-pause">‚öôÔ∏è Options</button>
            <button class="menu-btn" id="btn-quit">üö™ Quit to Menu</button>
        </div>
        
        <!-- Sub-menus -->
        <div id="codex-menu" class="sub-menu hidden">
            <div class="sub-menu-header">
                <div class="sub-menu-title">üìö Codex</div>
                <button class="close-btn" onclick="closeSubMenu('codex-menu')">‚úï</button>
            </div>
            <div class="sub-menu-content" id="codex-content"></div>
        </div>
        
        <div id="upgrades-menu" class="sub-menu hidden">
            <div class="sub-menu-header">
                <div class="sub-menu-title">‚¨ÜÔ∏è Upgrades</div>
                <button class="close-btn" onclick="closeSubMenu('upgrades-menu')">‚úï</button>
            </div>
            <div class="sub-menu-content" id="upgrades-content"></div>
        </div>
        
        <div id="options-menu" class="sub-menu hidden">
            <div class="sub-menu-header">
                <div class="sub-menu-title">‚öôÔ∏è Options</div>
                <button class="close-btn" onclick="closeSubMenu('options-menu')">‚úï</button>
            </div>
            <div class="sub-menu-content" id="options-content"></div>
        </div>
        
        <div id="achievements-menu" class="sub-menu hidden">
            <div class="sub-menu-header">
                <div class="sub-menu-title">üèÜ Achievements</div>
                <button class="close-btn" onclick="closeSubMenu('achievements-menu')">‚úï</button>
            </div>
            <div class="sub-menu-content" id="achievements-content"></div>
        </div>
        
        <div id="load-act-menu" class="sub-menu hidden">
            <div class="sub-menu-header">
                <div class="sub-menu-title">üìã Load Act</div>
                <button class="close-btn" onclick="closeSubMenu('load-act-menu')">‚úï</button>
            </div>
            <div class="sub-menu-content" id="load-act-content"></div>
        </div>
    </div>
    
                                            <script>
// ========== graphics.js ==========
// ==================== GTA 2-STYLE GRAPHICS MODULE ====================
// Canvas-based sprite and tile rendering system
// All graphics are procedurally generated - no external assets

// ==================== TILE RENDERING ====================
class TileRenderer {
    constructor(tileSize = 32) {
        this.tileSize = tileSize;
        this.tileCache = {};
    }

    // Render a tile with GTA 2-style appearance
    renderTile(ctx, x, y, tileType, isSelected = false) {
        const size = this.tileSize;
        const cacheKey = `${tileType}_${size}`;

        // Draw tile background
        switch (tileType) {
            case 0: // Water
                this.drawWaterTile(ctx, x, y, size);
                break;
            case 1: // Ground/Grass
                this.drawGrassland(ctx, x, y, size);
                break;
            case 2: // Road
                this.drawRoad(ctx, x, y, size);
                break;
            case 3: // Building
                this.drawBuilding(ctx, x, y, size);
                break;
            case 4: // Market/Zone
                this.drawMarket(ctx, x, y, size);
                break;
            case 5: // Dock
                this.drawDock(ctx, x, y, size);
                break;
            case 6: // Park
                this.drawPark(ctx, x, y, size);
                break;
            case 7: // Religious
                this.drawReligious(ctx, x, y, size);
                break;
            case 8: // Gang Territory
                this.drawGangTerritory(ctx, x, y, size);
                break;
            default:
                this.drawGrassland(ctx, x, y, size);
        }

        // Highlight if selected
        if (isSelected) {
            ctx.strokeStyle = '#ffff00';
            ctx.lineWidth = 2;
            ctx.strokeRect(x, y, size, size);
        }
    }

    drawWaterTile(ctx, x, y, size) {
        // Ocean blue gradient
        const gradient = ctx.createLinearGradient(x, y, x, y + size);
        gradient.addColorStop(0, '#1a5f7a');
        gradient.addColorStop(1, '#0d3a4a');
        ctx.fillStyle = gradient;
        ctx.fillRect(x, y, size, size);

        // Wave pattern
        ctx.strokeStyle = 'rgba(255,255,255,0.1)';
        ctx.lineWidth = 1;
        for (let i = 0; i < 3; i++) {
            ctx.beginPath();
            ctx.moveTo(x, y + i * 10);
            ctx.lineTo(x + size, y + i * 10);
            ctx.stroke();
        }
    }

    drawGrassland(ctx, x, y, size) {
        // Grass base
        ctx.fillStyle = '#2d5a3d';
        ctx.fillRect(x, y, size, size);

        // Grass texture
        ctx.fillStyle = 'rgba(100,150,80,0.3)';
        for (let i = 0; i < 5; i++) {
            const px = x + Math.random() * size;
            const py = y + Math.random() * size;
            ctx.fillRect(px, py, 2, 2);
        }

        // Border shadow
        ctx.strokeStyle = 'rgba(0,0,0,0.2)';
        ctx.lineWidth = 1;
        ctx.strokeRect(x, y, size, size);
    }

    drawRoad(ctx, x, y, size) {
        // Asphalt base
        ctx.fillStyle = '#3a3a3a';
        ctx.fillRect(x, y, size, size);

        // Road markings
        ctx.strokeStyle = '#ffff00';
        ctx.lineWidth = 1;
        ctx.setLineDash([4, 4]);
        ctx.beginPath();
        ctx.moveTo(x + size / 2, y);
        ctx.lineTo(x + size / 2, y + size);
        ctx.stroke();
        ctx.setLineDash([]);

        // Wear marks
        ctx.fillStyle = 'rgba(0,0,0,0.2)';
        for (let i = 0; i < 3; i++) {
            const px = x + Math.random() * size;
            const py = y + Math.random() * size;
            ctx.fillRect(px, py, 3, 3);
        }
    }

    drawBuilding(ctx, x, y, size) {
        // Building base
        const baseColor = '#8b7355';
        ctx.fillStyle = baseColor;
        ctx.fillRect(x, y, size, size);

        // Roof shadow
        ctx.fillStyle = '#6b5345';
        ctx.fillRect(x, y, size, 4);

        // Windows
        ctx.fillStyle = '#ffff99';
        const windowSize = 6;
        const windowGap = 2;
        for (let row = 0; row < 2; row++) {
            for (let col = 0; col < 2; col++) {
                const wx = x + 4 + col * (windowSize + windowGap);
                const wy = y + 8 + row * (windowSize + windowGap);
                ctx.fillRect(wx, wy, windowSize, windowSize);
                // Window frame
                ctx.strokeStyle = '#333333';
                ctx.lineWidth = 1;
                ctx.strokeRect(wx, wy, windowSize, windowSize);
            }
        }

        // Door
        ctx.fillStyle = '#5a4a3a';
        ctx.fillRect(x + 12, y + 20, 8, 12);
        ctx.fillStyle = '#ffff99';
        ctx.fillRect(x + 14, y + 22, 4, 4);
    }

    drawMarket(ctx, x, y, size) {
        // Market stall base
        ctx.fillStyle = '#d4a574';
        ctx.fillRect(x, y, size, size);

        // Stall stripes (market awning)
        ctx.strokeStyle = '#ff6b6b';
        ctx.lineWidth = 2;
        for (let i = 0; i < size; i += 6) {
            ctx.beginPath();
            ctx.moveTo(x + i, y);
            ctx.lineTo(x + i + 3, y + size);
            ctx.stroke();
        }

        // Market goods (small boxes)
        ctx.fillStyle = '#ff6b6b';
        ctx.fillRect(x + 4, y + 4, 8, 8);
        ctx.fillStyle = '#4ecdc4';
        ctx.fillRect(x + 20, y + 4, 8, 8);
    }

    drawDock(ctx, x, y, size) {
        // Dock wood texture
        ctx.fillStyle = '#8b6f47';
        ctx.fillRect(x, y, size, size);

        // Wooden planks
        ctx.strokeStyle = 'rgba(0,0,0,0.3)';
        ctx.lineWidth = 1;
        for (let i = 0; i < size; i += 8) {
            ctx.beginPath();
            ctx.moveTo(x, y + i);
            ctx.lineTo(x + size, y + i);
            ctx.stroke();
        }

        // Water edge
        ctx.strokeStyle = '#1a5f7a';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(x, y + size);
        ctx.lineTo(x + size, y + size);
        ctx.stroke();
    }

    drawPark(ctx, x, y, size) {
        // Grass
        ctx.fillStyle = '#4a7c3a';
        ctx.fillRect(x, y, size, size);

        // Trees
        ctx.fillStyle = '#2d5a2d';
        ctx.beginPath();
        ctx.arc(x + 8, y + 8, 4, 0, Math.PI * 2);
        ctx.fill();
        ctx.beginPath();
        ctx.arc(x + 24, y + 24, 4, 0, Math.PI * 2);
        ctx.fill();

        // Tree trunks
        ctx.fillStyle = '#8b6f47';
        ctx.fillRect(x + 7, y + 12, 2, 4);
        ctx.fillRect(x + 23, y + 28, 2, 4);
    }

    drawReligious(ctx, x, y, size) {
        // Mosque base
        ctx.fillStyle = '#e8d4b0';
        ctx.fillRect(x, y, size, size);

        // Dome
        ctx.fillStyle = '#4a9d6f';
        ctx.beginPath();
        ctx.arc(x + size / 2, y + 8, 6, 0, Math.PI, true);
        ctx.fill();

        // Minaret
        ctx.fillStyle = '#c9a961';
        ctx.fillRect(x + size - 6, y + 4, 4, 20);

        // Crescent on dome
        ctx.strokeStyle = '#ffff99';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.arc(x + size / 2, y + 8, 4, 0, Math.PI * 2);
        ctx.stroke();
    }

    drawGangTerritory(ctx, x, y, size) {
        // Danger zone - darker, grittier
        ctx.fillStyle = '#4a3a2a';
        ctx.fillRect(x, y, size, size);

        // Gang markings (graffiti)
        ctx.fillStyle = 'rgba(255,100,100,0.4)';
        ctx.fillRect(x + 2, y + 2, 6, 6);
        ctx.fillStyle = 'rgba(100,100,255,0.4)';
        ctx.fillRect(x + 22, y + 22, 6, 6);

        // Warning pattern
        ctx.strokeStyle = '#ff4444';
        ctx.lineWidth = 1;
        ctx.setLineDash([2, 2]);
        ctx.strokeRect(x + 1, y + 1, size - 2, size - 2);
        ctx.setLineDash([]);
    }
}

// ==================== CHARACTER SPRITE RENDERER ====================
class CharacterRenderer {
    static drawCharacter(ctx, x, y, character, direction = 'down') {
        const size = 24;
        const halfSize = size / 2;

        // Shadow
        ctx.fillStyle = 'rgba(0,0,0,0.3)';
        ctx.beginPath();
        ctx.ellipse(x, y + halfSize + 2, halfSize, 3, 0, 0, Math.PI * 2);
        ctx.fill();

        // Body
        ctx.fillStyle = character.color || '#8b4513';
        ctx.fillRect(x - halfSize / 2, y - halfSize / 2, halfSize, halfSize);

        // Head
        ctx.fillStyle = character.skinColor || '#d4a574';
        ctx.beginPath();
        ctx.arc(x, y - halfSize - 2, 4, 0, Math.PI * 2);
        ctx.fill();

        // Eyes
        ctx.fillStyle = '#000000';
        ctx.fillRect(x - 2, y - halfSize - 4, 1, 1);
        ctx.fillRect(x + 1, y - halfSize - 4, 1, 1);

        // Weapon indicator
        if (character.weapon && character.weapon !== 'fists') {
            ctx.fillStyle = '#444444';
            ctx.fillRect(x + halfSize / 2 - 2, y - 2, 4, 4);
        }
    }

    static drawEnemy(ctx, x, y, enemyType = 'thug') {
        const size = 24;
        const halfSize = size / 2;

        // Shadow
        ctx.fillStyle = 'rgba(0,0,0,0.3)';
        ctx.beginPath();
        ctx.ellipse(x, y + halfSize + 2, halfSize, 3, 0, 0, Math.PI * 2);
        ctx.fill();

        // Body (red for enemies)
        ctx.fillStyle = '#cc3333';
        ctx.fillRect(x - halfSize / 2, y - halfSize / 2, halfSize, halfSize);

        // Head
        ctx.fillStyle = '#d4a574';
        ctx.beginPath();
        ctx.arc(x, y - halfSize - 2, 4, 0, Math.PI * 2);
        ctx.fill();

        // Angry eyes
        ctx.fillStyle = '#ff0000';
        ctx.fillRect(x - 2, y - halfSize - 4, 1, 1);
        ctx.fillRect(x + 1, y - halfSize - 4, 1, 1);

        // Weapon
        ctx.fillStyle = '#333333';
        ctx.fillRect(x + halfSize / 2 - 2, y - 2, 4, 4);
    }

    static drawNPC(ctx, x, y, npcType = 'civilian') {
        const size = 20;
        const halfSize = size / 2;

        // Shadow
        ctx.fillStyle = 'rgba(0,0,0,0.2)';
        ctx.beginPath();
        ctx.ellipse(x, y + halfSize + 1, halfSize, 2, 0, 0, Math.PI * 2);
        ctx.fill();

        // Body (various colors for NPCs)
        const colors = { civilian: '#4a7c9e', merchant: '#8b7355', police: '#3a4a6a' };
        ctx.fillStyle = colors[npcType] || '#4a7c9e';
        ctx.fillRect(x - halfSize / 2, y - halfSize / 2, halfSize, halfSize);

        // Head
        ctx.fillStyle = '#d4a574';
        ctx.beginPath();
        ctx.arc(x, y - halfSize - 1, 3, 0, Math.PI * 2);
        ctx.fill();
    }
}

// ==================== VEHICLE SPRITE RENDERER ====================
class VehicleRenderer {
    static drawMotorcycle(ctx, x, y, direction = 'right') {
        // Motorcycle body
        ctx.fillStyle = '#333333';
        ctx.fillRect(x - 12, y - 6, 24, 12);

        // Wheels
        ctx.fillStyle = '#1a1a1a';
        ctx.beginPath();
        ctx.arc(x - 8, y + 6, 4, 0, Math.PI * 2);
        ctx.fill();
        ctx.beginPath();
        ctx.arc(x + 8, y + 6, 4, 0, Math.PI * 2);
        ctx.fill();

        // Seat
        ctx.fillStyle = '#cc6633';
        ctx.fillRect(x - 6, y - 4, 12, 3);

        // Headlight
        ctx.fillStyle = '#ffff99';
        ctx.fillRect(x - 12, y - 2, 3, 3);
    }

    static drawDhoni(ctx, x, y) {
        // Boat hull
        ctx.fillStyle = '#8b4513';
        ctx.beginPath();
        ctx.ellipse(x, y, 20, 12, 0, 0, Math.PI * 2);
        ctx.fill();

        // Boat outline
        ctx.strokeStyle = '#5a2a0a';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.ellipse(x, y, 20, 12, 0, 0, Math.PI * 2);
        ctx.stroke();

        // Cabin
        ctx.fillStyle = '#d4a574';
        ctx.fillRect(x - 8, y - 4, 16, 6);

        // Window
        ctx.fillStyle = '#ffff99';
        ctx.fillRect(x - 4, y - 2, 8, 3);

        // Mast
        ctx.strokeStyle = '#8b7355';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(x, y - 4);
        ctx.lineTo(x, y - 12);
        ctx.stroke();
    }

    static drawSpeedboat(ctx, x, y) {
        // Hull
        ctx.fillStyle = '#ffffff';
        ctx.beginPath();
        ctx.moveTo(x - 16, y);
        ctx.lineTo(x + 16, y - 4);
        ctx.lineTo(x + 16, y + 4);
        ctx.closePath();
        ctx.fill();

        // Cabin
        ctx.fillStyle = '#4a7c9e';
        ctx.fillRect(x - 8, y - 6, 12, 6);

        // Window
        ctx.fillStyle = '#ffff99';
        ctx.fillRect(x - 4, y - 4, 6, 3);

        // Engine
        ctx.fillStyle = '#333333';
        ctx.fillRect(x + 12, y - 2, 6, 4);
    }

    static drawSeaplane(ctx, x, y) {
        // Fuselage
        ctx.fillStyle = '#4a7c9e';
        ctx.fillRect(x - 12, y - 4, 24, 8);

        // Wings
        ctx.fillStyle = '#3a6a8e';
        ctx.fillRect(x - 20, y - 2, 40, 2);

        // Tail
        ctx.fillStyle = '#3a6a8e';
        ctx.beginPath();
        ctx.moveTo(x + 12, y - 3);
        ctx.lineTo(x + 16, y - 5);
        ctx.lineTo(x + 16, y + 5);
        ctx.closePath();
        ctx.fill();

        // Cockpit
        ctx.fillStyle = '#ffff99';
        ctx.fillRect(x - 6, y - 2, 8, 4);

        // Floats
        ctx.fillStyle = '#ffff99';
        ctx.fillRect(x - 16, y + 4, 6, 3);
        ctx.fillRect(x + 10, y + 4, 6, 3);
    }
}

// ==================== ENVIRONMENT RENDERER ====================
class EnvironmentRenderer {
    static drawTree(ctx, x, y) {
        // Trunk
        ctx.fillStyle = '#8b6f47';
        ctx.fillRect(x - 2, y, 4, 10);

        // Foliage
        ctx.fillStyle = '#2d5a2d';
        ctx.beginPath();
        ctx.arc(x, y - 4, 8, 0, Math.PI * 2);
        ctx.fill();

        // Highlight
        ctx.fillStyle = 'rgba(100,150,80,0.4)';
        ctx.beginPath();
        ctx.arc(x - 3, y - 6, 4, 0, Math.PI * 2);
        ctx.fill();
    }

    static drawLamppost(ctx, x, y) {
        // Pole
        ctx.strokeStyle = '#666666';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(x, y);
        ctx.lineTo(x, y - 16);
        ctx.stroke();

        // Light
        ctx.fillStyle = '#ffff99';
        ctx.beginPath();
        ctx.arc(x + 4, y - 16, 3, 0, Math.PI * 2);
        ctx.fill();

        // Glow
        ctx.fillStyle = 'rgba(255,255,153,0.2)';
        ctx.beginPath();
        ctx.arc(x + 4, y - 16, 8, 0, Math.PI * 2);
        ctx.fill();
    }

    static drawFence(ctx, x, y, length = 32) {
        // Posts
        ctx.fillStyle = '#8b6f47';
        ctx.fillRect(x, y, 2, 12);
        ctx.fillRect(x + length - 2, y, 2, 12);

        // Rails
        ctx.strokeStyle = '#8b6f47';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(x + 2, y + 3);
        ctx.lineTo(x + length - 2, y + 3);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(x + 2, y + 9);
        ctx.lineTo(x + length - 2, y + 9);
        ctx.stroke();
    }

    static drawBarrier(ctx, x, y) {
        // Barrier block
        ctx.fillStyle = '#ff6b6b';
        ctx.fillRect(x - 6, y - 4, 12, 8);

        // Stripes
        ctx.fillStyle = '#ffff99';
        ctx.fillRect(x - 4, y - 2, 2, 4);
        ctx.fillRect(x + 2, y - 2, 2, 4);
    }
}

// Export for use in main game
if (typeof module !== 'undefined' && module.exports) {
    module.exports = { TileRenderer, CharacterRenderer, VehicleRenderer, EnvironmentRenderer };
}


// ========== game.js ==========
// ============================================
// RAAJJE THEFT AUTO 1: THE BAOKALO CHRONICLES
// Complete Game Engine - Act 1: Maafannu Awakening
// ============================================

// ==================== GAME STATE ====================
const GameState = {
    // Core state
    currentAct: 1,
    currentMission: 0,
    missionPhase: 0,
    isPlaying: false,
    isPaused: false,
    isInDialogue: false,
    isInMinigame: false,
    
    // Player stats
    player: {
        x: 400,
        y: 300,
        width: 32,
        height: 32,
        speed: 3,
        health: 100,
        maxHealth: 100,
        stamina: 100,
        maxStamina: 100,
        karma: 50, // 0-100, 50 is neutral
        familyMeter: 50, // 0-100
        money: 0,
        direction: 'down',
        isMoving: false,
        isSprinting: false,
        isAttacking: false,
        attackCooldown: 0,
        inventory: [],
        weapons: ['fists'],
        currentWeapon: 'fists',
        skills: {
            combat: 1,
            stealth: 1,
            charisma: 1,
            piloting: 1
        }
    },
    
    // World state
    world: {
        currentMap: 'male_maafannu',
        time: 8, // 0-24 hours
        weather: 'clear', // clear, cloudy, rain, storm
        heat: 0, // 0-5 police heat level
    },
    
    // Gang relations
    gangs: {
        hulhuHustlers: { reputation: 0, allied: false },
        maleSharks: { reputation: 0, allied: false },
        masodi: { reputation: -20, allied: false },
        kudaHenveiru: { reputation: -10, allied: false },
        wanted: { reputation: -30, allied: false }
    },
    
    // Story flags
    flags: {
        metHulhuHustlers: false,
        completedTutorial: false,
        sawNunnuNews: false,
        familyDinnerHappened: false,
        rippooSecretHinted: false,
        recruitedMinors: false
    },
    
    // Completed missions
    completedMissions: [],
    completedSideMissions: [],
    
    // Choices made
    choices: [],
    
    // Achievements
    achievements: [],
    
    // Upgrades purchased
    upgrades: []
};

// ==================== CONSTANTS ====================
const TILE_SIZE = 32;
const CANVAS_WIDTH = 800;
const CANVAS_HEIGHT = 600;

// Character emoji sprites
const SPRITES = {
    baokalo: 'üßëüèæ',
    baokaloAngry: 'üò†',
    rippoo: 'üë©üèæ',
    abuch: 'üë®üèæ',
    nunnu: 'üë©üèæ‚Äç‚öïÔ∏è',
    ronda: 'üë¥üèæ',
    nappey: 'üëµüèæ',
    dhodho: 'üë®üèæ‚Äç‚úàÔ∏è',
    zadey: 'üë©üèæ‚Äçüíº',
    gangMember: 'üßîüèæ',
    gangLeader: 'üòé',
    police: 'üëÆüèæ',
    tourist: 'üßëüèª',
    fisherman: 'üé£',
    shopkeeper: 'üßëüèæ‚Äçüç≥',
    politician: 'ü§µüèæ',
    mooizbe: 'ü§¥üèæ',
    anni: 'üë®üèæ‚Äçüíº',
    jabibe: 'ü§ë',
    rishbe: 'üßëüèæ‚Äçüíª',
    muaz: 'üßîüèæ‚Äç‚ôÇÔ∏è',
    npc: 'üßëüèæ',
    child: 'üë¶üèæ'
};

// Vehicle sprites
const VEHICLES = {
    motorcycle: 'üèçÔ∏è',
    dhoni: 'üö£',
    speedboat: 'üö§',
    seaplane: 'üõ©Ô∏è',
    bicycle: 'üö≤'
};

// Item sprites
const ITEMS = {
    money: 'üíµ',
    wallet: 'üëõ',
    phone: 'üì±',
    bat: 'üèè',
    knife: 'üî™',
    drugs: 'üíä',
    fish: 'üêü',
    key: 'üîë'
};

// ==================== DHIVEHI DIALOGUES ====================
const DIALOGUES = {
    // Tutorial dialogues
    tutorial_intro: {
        speaker: "Hulhu Hustlers Member",
        sprite: SPRITES.gangMember,
        lines: [
            { text: "Kaley new? Aharen Faisal. Welcome to Maafannu.", dhivehi: true },
            { text: "Easy job first - just snatch wallets in fish market.", dhivehi: false },
            { text: "Mashakah show kaley how it's done. Follow me.", dhivehi: true }
        ]
    },
    
    tutorial_pickpocket: {
        speaker: "Faisal",
        sprite: SPRITES.gangMember,
        lines: [
            { text: "See that tourist? üßëüèª Walk behind, press ü§ù to grab wallet.", dhivehi: false },
            { text: "Don't let them see kaley! Stealth is key.", dhivehi: true },
            { text: "Bring 3 wallets. Faisaa for the crew!", dhivehi: true }
        ]
    },
    
    tutorial_combat: {
        speaker: "Faisal",
        sprite: SPRITES.gangMember,
        lines: [
            { text: "Kuda Henveiru sodu coming! Time to fight!", dhivehi: true },
            { text: "Use üëä to attack. Dodge their swings!", dhivehi: false },
            { text: "Show them Hulhu Hustlers own Maafannu!", dhivehi: true }
        ]
    },
    
    // Family dialogues
    rippoo_confrontation: {
        speaker: "Rippoo (Mother)",
        sprite: SPRITES.rippoo,
        lines: [
            { text: "Kipal! Aharen heard what kaley doing in Maafannu!", dhivehi: true },
            { text: "Mashakah escaped this life! Why kaley choose it?!", dhivehi: true },
            { text: "Darifulhaakah... please. Come home.", dhivehi: true }
        ],
        choices: [
            { text: "Aharen sorry, mother. But I have no choice.", karma: 5, response: "choice_apologize" },
            { text: "Kaley don't understand! Nunnu gets everything!", karma: -5, response: "choice_angry" },
            { text: "[Stay silent]", karma: 0, response: "choice_silent" }
        ]
    },
    
    rippoo_response_apologize: {
        speaker: "Rippoo",
        sprite: SPRITES.rippoo,
        lines: [
            { text: "*sighs* There's always a choice, Kipal.", dhivehi: false },
            { text: "Mashakah praying for kaley. Be careful.", dhivehi: true }
        ]
    },
    
    rippoo_response_angry: {
        speaker: "Rippoo",
        sprite: SPRITES.rippoo,
        lines: [
            { text: "*slaps Baokalo* Kaley sodu! Don't speak of sister!", dhivehi: true },
            { text: "Aharen sacrificed everything for this family!", dhivehi: true }
        ]
    },
    
    rippoo_response_silent: {
        speaker: "Rippoo",
        sprite: SPRITES.rippoo,
        lines: [
            { text: "*tears up* Just like your father... stubborn.", dhivehi: false },
            { text: "Go then. But remember - mashakah always here.", dhivehi: true }
        ]
    },
    
    // Grandfather disownment
    ronda_disown: {
        speaker: "Ronda Masterah (Grandfather)",
        sprite: SPRITES.ronda,
        lines: [
            { text: "*playing boduberu stops*", dhivehi: false },
            { text: "Thilhen... kaley destroyed our family name.", dhivehi: true },
            { text: "Alhugandakah ashamed. Uzaa from my house!", dhivehi: true }
        ]
    },
    
    // Grandmother support
    nappey_support: {
        speaker: "Nappey Aunty (Grandmother)",
        sprite: SPRITES.nappey,
        lines: [
            { text: "Kalaa dhon darifulhaakah...", dhivehi: true },
            { text: "He is lost, not evil. Mashakah praying for kaley.", dhivehi: true },
            { text: "*hands huni roshi* Eat. Stay safe.", dhivehi: false }
        ]
    },
    
    // Gang dialogues
    gang_recruit: {
        speaker: "Hulhu Hustlers Boss",
        sprite: SPRITES.gangLeader,
        lines: [
            { text: "Kaley got skills, Addu boy.", dhivehi: true },
            { text: "Mashakah need more soldiers. Kids from the street.", dhivehi: true },
            { text: "Recruit 3 young ones. They listen to kaley.", dhivehi: true }
        ],
        choices: [
            { text: "Aharen won't recruit children. Find another way.", karma: 15, familyKarma: 10, response: "refuse_recruit" },
            { text: "Whatever it takes. Mashakah do it.", karma: -20, familyKarma: -15, response: "accept_recruit" }
        ]
    },
    
    // Newspaper about Nunnu
    nunnu_news: {
        speaker: "Newspaper",
        sprite: "üì∞",
        lines: [
            { text: "BREAKING: Addu Student Wins Medical Scholarship!", dhivehi: false },
            { text: "Nunnu Bats Ronda, 18, accepted to Bangalore Medical College.", dhivehi: false },
            { text: "'My family sacrificed everything,' says proud scholar.", dhivehi: false }
        ]
    },
    
    // Mission complete
    mission_complete: {
        speaker: "System",
        sprite: "‚úÖ",
        lines: [
            { text: "Mission Complete!", dhivehi: false },
            { text: "Faisaa earned. Reputation increased.", dhivehi: false }
        ]
    }
};

// ==================== RADIO SATIRE ====================
const RADIO_CONTENT = {
    raajjeFM: {
        name: "üìª Raajje FM",
        segments: [
            { type: "news", text: "Breaking: President Mooizbe declares 'No gangs exist in Raajje!' Police confirm 83 active gangs..." },
            { type: "news", text: "Gang Act 2025 passes! 48-hour detention without lawyer now legal. Minister says 'for safety.'" },
            { type: "satire", text: "Tourism Minister: 'Paradise has no crime!' *gunshots in background*" },
            { type: "news", text: "Drugs Act death penalty proposed. Critics ask: 'What about politician dealers?'" },
            { type: "ad", text: "Visit Maldives! Sun, sand, and definitely no organized crime! üèùÔ∏è" },
            { type: "satire", text: "PNC MP: 'Gangs are fiction!' *surrounded by bodyguards from Masodi*" },
            { type: "news", text: "India boycott continues. China investments surge. Debt? What debt?" },
            { type: "music", text: "‚ô™ Now playing: Traditional Boduberu - 'Dhoni Life' ‚ô™" }
        ]
    },
    undergroundFM: {
        name: "üìª Underground FM",
        segments: [
            { type: "truth", text: "Real talk: 3,050 gang members. 97 are children. Government knows." },
            { type: "truth", text: "Yameen in jail. Muizzu in power. Same corruption, different face." },
            { type: "truth", text: "Journalist Yamin Rasheed - murdered 2017. Case still 'unsolved.'" },
            { type: "truth", text: "250 Maldivians joined ISIS. Highest per capita. Where's the outrage?" },
            { type: "music", text: "‚ô™ Playing: 'Kazzabu Anthem' - The Liars Song ‚ô™" }
        ]
    }
};

// ==================== MAPS DATA ====================
const MAPS = {
    male_maafannu: {
        name: "Maafannu District, Mal√©",
        width: 50,
        height: 40,
        spawnX: 25,
        spawnY: 35,
        // Tile types: 0=water, 1=ground, 2=road, 3=building, 4=market, 5=dock
        tiles: [], // Generated procedurally
        npcs: [],
        items: [],
        zones: {
            fishMarket: { x: 10, y: 10, w: 15, h: 10, name: "Fish Market üêü" },
            teaShop: { x: 30, y: 20, w: 8, h: 6, name: "Rippoo's Tea Shop ‚òï" },
            safehouse: { x: 40, y: 30, w: 6, h: 6, name: "Hulhu Safehouse üè†" },
            alley: { x: 20, y: 25, w: 5, h: 10, name: "Dark Alley üåë" }
        },
        gangTerritory: "Hulhu Hustlers"
    },
    
    male_henveiru: {
        name: "Henveiru District, Mal√©",
        width: 50,
        height: 40,
        spawnX: 5,
        spawnY: 20,
        tiles: [],
        npcs: [],
        items: [],
        zones: {
            kudaTerritory: { x: 20, y: 15, w: 20, h: 15, name: "Kuda Henveiru Turf ‚ö†Ô∏è" },
            park: { x: 35, y: 5, w: 10, h: 10, name: "Sultan Park üå≥" }
        },
        gangTerritory: "Kuda Henveiru"
    },
    
    addu_maradhoo: {
        name: "Maradhoo, Addu City",
        width: 60,
        height: 50,
        spawnX: 30,
        spawnY: 40,
        tiles: [],
        npcs: [],
        items: [],
        zones: {
            rondaHome: { x: 25, y: 20, w: 10, h: 8, name: "Ronda Family Home üè°" },
            beach: { x: 0, y: 35, w: 60, h: 15, name: "Maradhoo Beach üèñÔ∏è" }
        },
        gangTerritory: null // No gang initially
    }
};

// ==================== MISSIONS DATA ====================
const MISSIONS = {
    act1: [
        {
            id: "act1_m1",
            title: "The First Score",
            type: "tutorial",
            description: "Pickpocket 3 wallets in the fish market",
            objectives: [
                { type: "collect", target: "wallet", count: 3, current: 0 }
            ],
            rewards: { money: 100, karma: -5, reputation: { hulhuHustlers: 10 } },
            dialogueStart: "tutorial_intro",
            dialogueEnd: "mission_complete",
            unlocks: ["act1_m2"]
        },
        {
            id: "act1_m2",
            title: "Bat Initiation",
            type: "combat",
            description: "Fight Kuda Henveiru thugs in the alley",
            objectives: [
                { type: "defeat", target: "kudaThug", count: 3, current: 0 }
            ],
            rewards: { money: 150, karma: -10, reputation: { hulhuHustlers: 15, kudaHenveiru: -20 } },
            dialogueStart: "tutorial_combat",
            unlocks: ["act1_m3"]
        },
        {
            id: "act1_m3",
            title: "Mother's Business",
            type: "delivery",
            description: "Deliver package for Rippoo's tea shop",
            objectives: [
                { type: "deliver", target: "package", destination: "velanaAirport", current: false }
            ],
            rewards: { money: 200, karma: -5 },
            dialogueStart: null,
            unlocks: ["act1_m4", "act1_m5", "act1_m6"],
            vehicleUnlock: "motorcycle"
        },
        {
            id: "act1_m4",
            title: "Territory Wars I",
            type: "combat",
            description: "Help Hulhu Hustlers fight Masodi scouts",
            objectives: [
                { type: "defeat", target: "masodiScout", count: 5, current: 0 }
            ],
            rewards: { money: 250, karma: -15, reputation: { hulhuHustlers: 20, masodi: -25 } },
            unlocks: ["act1_m5"]
        },
        {
            id: "act1_m5",
            title: "Territory Wars II",
            type: "combat",
            description: "Defend the fish market from Masodi",
            objectives: [
                { type: "defend", target: "fishMarket", duration: 60, current: 0 }
            ],
            rewards: { money: 300, karma: -10, reputation: { hulhuHustlers: 25 } },
            unlocks: ["act1_m6"]
        },
        {
            id: "act1_m6",
            title: "Territory Wars III",
            type: "combat",
            description: "Push Masodi out of Maafannu",
            objectives: [
                { type: "capture", target: "masodiOutpost", current: false }
            ],
            rewards: { money: 400, karma: -20, reputation: { hulhuHustlers: 30, masodi: -40 } },
            unlocks: ["act1_m7"]
        },
        {
            id: "act1_m7",
            title: "Sister's Shadow",
            type: "story",
            description: "See the newspaper about Nunnu's scholarship",
            objectives: [
                { type: "trigger", target: "readNewspaper", current: false }
            ],
            rewards: { karma: 0 },
            dialogueStart: "nunnu_news",
            unlocks: ["act1_m8", "act1_m9"],
            setFlag: "sawNunnuNews"
        },
        {
            id: "act1_m8",
            title: "Bail Money I",
            type: "extortion",
            description: "Get bail money for arrested gang member",
            objectives: [
                { type: "collect", target: "bailMoney", count: 500, current: 0 }
            ],
            rewards: { money: 100, reputation: { hulhuHustlers: 15 } },
            moralChoice: true,
            unlocks: ["act1_m9"]
        },
        {
            id: "act1_m9",
            title: "Bail Money II",
            type: "extortion",
            description: "Collect remaining bail from shop owner",
            objectives: [
                { type: "interact", target: "shopOwner", current: false }
            ],
            rewards: { money: 200 },
            moralChoice: true,
            choices: [
                { text: "Threaten the owner", karma: -15, outcome: "threaten" },
                { text: "Offer to do a job instead", karma: 10, outcome: "help" }
            ],
            unlocks: ["act1_m10"]
        },
        {
            id: "act1_m10",
            title: "The Recruit",
            type: "recruitment",
            description: "Recruit new members for Hulhu Hustlers",
            objectives: [
                { type: "recruit", target: "gangMember", count: 3, current: 0 }
            ],
            rewards: { money: 300, reputation: { hulhuHustlers: 25 } },
            moralChoice: true,
            dialogueStart: "gang_recruit",
            unlocks: ["act1_m11"],
            setFlag: "recruitedMinors"
        },
        {
            id: "act1_m11",
            title: "Maafannu Claimed I",
            type: "combat",
            description: "Turf war vs Wanted gang",
            objectives: [
                { type: "defeat", target: "wantedMember", count: 8, current: 0 }
            ],
            rewards: { money: 500, karma: -25, reputation: { hulhuHustlers: 35, wanted: -50 } },
            unlocks: ["act1_m12"]
        },
        {
            id: "act1_m12",
            title: "Maafannu Claimed II",
            type: "boss",
            description: "Defeat Marn, leader of Wanted gang",
            objectives: [
                { type: "defeat", target: "marn", count: 1, current: 0 }
            ],
            rewards: { money: 1000, karma: -30, reputation: { hulhuHustlers: 50, wanted: -100 } },
            unlocks: ["act1_climax"],
            bossMusic: true
        },
        {
            id: "act1_climax",
            title: "Family Dinner Disaster",
            type: "story",
            description: "Attend family dinner at Ronda's home",
            objectives: [
                { type: "travel", target: "addu_maradhoo", current: false },
                { type: "trigger", target: "familyDinner", current: false }
            ],
            rewards: { karma: 0 },
            dialogueStart: "ronda_disown",
            unlocks: ["act2_start"],
            setFlag: "familyDinnerHappened",
            actEnd: true
        }
    ]
};

// ==================== SIDE MISSIONS ====================
const SIDE_MISSIONS = {
    act1: [
        { id: "side_pickpocket1", title: "Quick Fingers I", type: "pickpocket", target: 5, reward: 50 },
        { id: "side_pickpocket2", title: "Quick Fingers II", type: "pickpocket", target: 10, reward: 100 },
        { id: "side_race1", title: "Street Race I", type: "race", reward: 150 },
        { id: "side_race2", title: "Street Race II", type: "race", reward: 200 },
        { id: "side_delivery1", title: "Package Run I", type: "delivery", reward: 75 },
        { id: "side_delivery2", title: "Package Run II", type: "delivery", reward: 100 },
        { id: "side_fight1", title: "Alley Brawl I", type: "fight", enemies: 3, reward: 100 },
        { id: "side_fight2", title: "Alley Brawl II", type: "fight", enemies: 5, reward: 150 },
        { id: "side_fishing1", title: "Dhoni Fishing", type: "minigame", game: "fishing", reward: 50 },
        { id: "side_boduberu1", title: "Boduberu Beat", type: "minigame", game: "boduberu", reward: 75 }
    ]
};

// ==================== UPGRADES SYSTEM ====================
const UPGRADES = {
    combat: [
        { id: "combat1", name: "Bat Mastery I", cost: 500, effect: { damage: 1.2 }, requires: null },
        { id: "combat2", name: "Bat Mastery II", cost: 1000, effect: { damage: 1.5 }, requires: "combat1" },
        { id: "combat3", name: "Counter Strike", cost: 1500, effect: { counter: true }, requires: "combat2" },
        { id: "combat4", name: "Rage Mode", cost: 2500, effect: { rage: true }, requires: "combat3" }
    ],
    stealth: [
        { id: "stealth1", name: "Silent Steps", cost: 500, effect: { noise: 0.8 }, requires: null },
        { id: "stealth2", name: "Pickpocket Pro", cost: 1000, effect: { pickpocket: 1.3 }, requires: "stealth1" },
        { id: "stealth3", name: "Blend In", cost: 1500, effect: { detection: 0.7 }, requires: "stealth2" },
        { id: "stealth4", name: "Ghost", cost: 2500, effect: { invisible: 3 }, requires: "stealth3" }
    ],
    charisma: [
        { id: "charisma1", name: "Street Talk", cost: 500, effect: { persuade: 1.2 }, requires: null },
        { id: "charisma2", name: "Intimidate", cost: 1000, effect: { intimidate: 1.3 }, requires: "charisma1" },
        { id: "charisma3", name: "Leader's Voice", cost: 1500, effect: { recruit: 1.5 }, requires: "charisma2" },
        { id: "charisma4", name: "Kingpin Aura", cost: 2500, effect: { allCharisma: 2 }, requires: "charisma3" }
    ],
    piloting: [
        { id: "pilot1", name: "Motorcycle Basics", cost: 300, effect: { bikeSpeed: 1.2 }, requires: null },
        { id: "pilot2", name: "Dhoni Captain", cost: 800, effect: { boatSpeed: 1.3 }, requires: "pilot1" },
        { id: "pilot3", name: "Speedboat Pro", cost: 1500, effect: { speedboatUnlock: true }, requires: "pilot2" },
        { id: "pilot4", name: "Seaplane License", cost: 3000, effect: { seaplaneUnlock: true }, requires: "pilot3" }
    ]
};

// ==================== ACHIEVEMENTS ====================
const ACHIEVEMENTS_LIST = [
    { id: "first_score", name: "First Score", desc: "Complete your first pickpocket", icon: "üëõ" },
    { id: "bat_fighter", name: "Bat Fighter", desc: "Win 10 melee fights", icon: "üèè" },
    { id: "family_man", name: "Family Man", desc: "Keep family meter above 70", icon: "üë®‚Äçüë©‚Äçüëß‚Äçüë¶" },
    { id: "black_sheep", name: "Black Sheep", desc: "Get disowned by grandfather", icon: "üêë" },
    { id: "street_racer", name: "Street Racer", desc: "Win 5 motorcycle races", icon: "üèçÔ∏è" },
    { id: "boduberu_master", name: "Boduberu Master", desc: "Perfect score in rhythm game", icon: "ü•Å" },
    { id: "act1_complete", name: "Maafannu Awakening", desc: "Complete Act 1", icon: "üèÜ" },
    { id: "merciful", name: "Merciful", desc: "Spare 10 enemies", icon: "üïäÔ∏è" },
    { id: "ruthless", name: "Ruthless", desc: "Show no mercy to 10 enemies", icon: "üíÄ" },
    { id: "rich", name: "Faisaa King", desc: "Earn 10,000 money", icon: "üí∞" }
];

// ==================== CODEX DATA ====================
const CODEX = {
    history: [
        { title: "1988: Operation Cactus", text: "Tamil mercenaries attempted coup against Gayoom. India intervened. 19 killed. Baokalo's grandfather witnessed the chaos as a young musician." },
        { title: "2004: Black Friday", text: "5,000 protesters demanded Gayoom's resignation after 26 years. NSS used tear gas and batons. Baokalo's earliest memory - age 4." },
        { title: "2008: First Democracy", text: "Nasheed defeats Gayoom in first democratic election. Hope spreads across Maldives." },
        { title: "2012: The Coup", text: "Police and military mutiny forces Nasheed to resign. Baokalo learns: politics = violence = power." },
        { title: "2015: Yameen Era", text: "Dictatorship peak. Nasheed jailed on terrorism charges. Baokalo joins gangs at age 15." }
    ],
    characters: [
        { title: "Baokalo (Ahmed Kipal Ronda)", text: "Born 2000 in Maradhoo, Addu City. Black sheep of respectable family. Street name means 'The Dark Leader' in Addu Bas." },
        { title: "Rippoo (Mother)", text: "Former gang member 'Rippoo the Razor' (1993-1998). Left gang life when pregnant with Nunnu. Now social worker." },
        { title: "Abuch (Father)", text: "Honest fisherman who worked 18-hour shifts. Died 2020 in storm at sea. His fishing knife is Baokalo's memento." },
        { title: "Ronda Masterah (Grandfather)", text: "Traditional boduberu drummer, 75 years old. Performed for all 5 regimes. Disowns Baokalo for destroying family name." },
        { title: "Nappey Aunty (Grandmother)", text: "Only family member who never judges Baokalo. 'He is lost, not evil.' Provides safe house." }
    ],
    gangs: [
        { title: "Hulhu Hustlers", text: "Baokalo's first gang. Controls Maafannu fish market. Petty crimes, pickpocketing, street fights." },
        { title: "Mal√© Sharks", text: "Major Mal√© gang. Rippoo's old crew from the 1990s. Drug trafficking, extortion." },
        { title: "Masodi (Titans)", text: "Highly active gang. Leaders: Shiru, Nadhamaa. Links to Addu. PNC protection." },
        { title: "Kuda Henveiru", text: "Henveiru district gang. Allied with Masodi. Pickpocketing, drug courier." },
        { title: "Wanted", text: "Professional criminals. Assassination contracts, high-value theft. Leaders: Marn, Thaju." }
    ],
    locations: [
        { title: "Mal√©", text: "Capital city. 103,693 people in 5.8 km¬≤. 44-45 active gangs. Overcrowded, chaotic, dangerous." },
        { title: "Maafannu District", text: "Slum area of Mal√©. Baokalo's starting territory. Fish market, narrow alleys." },
        { title: "Addu City", text: "Southern stronghold. Baokalo's birthplace. 12 gangs, 250+ members. Ronda family home in Maradhoo." },
        { title: "Velana Airport", text: "International airport. Smuggling hub. Uncle DhoDho works here." }
    ],
    dhivehi: [
        { title: "Pronouns", text: "Aharen/Alhugandakah = I (formal). Mashakah = Me. Kaley = You (disrespectful). Thibeyfulhaa = You (respectful). Thilhen = You (extremely offensive)." },
        { title: "Common Phrases", text: "Uzaa = Go away. Sodu = Bastard. Faisaa = Money. Dhimaa = Blood. Darifulhaakah = My child." },
        { title: "Gang Slang", text: "Bao = Boss. Kalo = Dark/black. Miyaru = Shark. Dhoni = Boat. Beys = Drugs." },
        { title: "Political Terms", text: "Kazzabu = Liar. Appathurey = Puppet. Laadheenee = Godless. Beyfulhi = Elite snob." }
    ]
};

// ==================== GAME ENGINE ====================
let canvas, ctx, minimapCanvas, minimapCtx, minigameCanvas, minigameCtx;
let lastTime = 0;
let deltaTime = 0;
let frameCount = 0;

// Input state
const Input = {
    keys: {},
    mouse: { x: 0, y: 0, down: false },
    touch: { active: false, startX: 0, startY: 0, currentX: 0, currentY: 0 },
    joystick: { x: 0, y: 0 }
};

// Camera
const Camera = {
    x: 0,
    y: 0,
    zoom: 1,
    targetX: 0,
    targetY: 0,
    shake: 0
};

// NPCs in current map
let currentNPCs = [];
let currentItems = [];
let currentEnemies = [];

// Audio context for Web Audio API
let audioCtx = null;

// ==================== INITIALIZATION ====================
function init() {
    // Get canvas elements
    canvas = document.getElementById('game-canvas');
    ctx = canvas.getContext('2d');
    minimapCanvas = document.getElementById('minimap-canvas');
    minimapCtx = minimapCanvas.getContext('2d');
    minigameCanvas = document.getElementById('minigame-canvas');
    minigameCtx = minigameCanvas.getContext('2d');
    
    // Set canvas size
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);
    
    // Setup input handlers
    setupInputHandlers();
    
    // Setup touch controls
    setupTouchControls();
    
    // Setup menu buttons
    setupMenuButtons();
    
    // Load saved game if exists
    loadGame();
    
    // Generate maps
    generateMaps();
    
    // Show loading complete
    simulateLoading();
}

function resizeCanvas() {
    const container = document.getElementById('game-container');
    const aspectRatio = CANVAS_WIDTH / CANVAS_HEIGHT;
    
    let width = container.clientWidth;
    let height = container.clientHeight;
    
    if (width / height > aspectRatio) {
        width = height * aspectRatio;
    } else {
        height = width / aspectRatio;
    }
    
    canvas.style.width = width + 'px';
    canvas.style.height = height + 'px';
    canvas.width = CANVAS_WIDTH;
    canvas.height = CANVAS_HEIGHT;
    
    // Minimap
    const minimapSize = Math.min(150, width * 0.2);
    minimapCanvas.width = minimapSize;
    minimapCanvas.height = minimapSize;
}

function simulateLoading() {
    const loadingFill = document.getElementById('loading-fill');
    let progress = 0;
    
    const interval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress >= 100) {
            progress = 100;
            clearInterval(interval);
            setTimeout(() => {
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('main-menu').classList.remove('hidden');
            }, 500);
        }
        loadingFill.style.width = progress + '%';
    }, 100);
}

function generateMaps() {
    // Generate tile data for each map
    for (let mapKey in MAPS) {
        const map = MAPS[mapKey];
        map.tiles = [];
        
        for (let y = 0; y < map.height; y++) {
            map.tiles[y] = [];
            for (let x = 0; x < map.width; x++) {
                // Default to ground
                let tile = 1;
                
                // Water borders
                if (x === 0 || y === 0 || x === map.width - 1 || y === map.height - 1) {
                    tile = 0;
                }
                // Roads (every 5 tiles horizontally and vertically)
                else if (x % 8 === 0 || y % 8 === 0) {
                    tile = 2;
                }
                // Random buildings
                else if (Math.random() < 0.15) {
                    tile = 3;
                }
                
                map.tiles[y][x] = tile;
            }
        }
        
        // Add zones
        for (let zoneKey in map.zones) {
            const zone = map.zones[zoneKey];
            for (let y = zone.y; y < zone.y + zone.h && y < map.height; y++) {
                for (let x = zone.x; x < zone.x + zone.w && x < map.width; x++) {
                    if (y >= 0 && x >= 0) {
                        map.tiles[y][x] = zoneKey.includes('Market') ? 4 : 
                                          zoneKey.includes('dock') ? 5 : 1;
                    }
                }
            }
        }
    }
}

// ==================== INPUT HANDLING ====================
function setupInputHandlers() {
    // Keyboard
    window.addEventListener('keydown', (e) => {
        Input.keys[e.code] = true;
        
        // Prevent default for game keys
        if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Space', 'KeyE', 'Escape'].includes(e.code)) {
            e.preventDefault();
        }
        
        // Handle specific keys
        if (e.code === 'Escape' && GameState.isPlaying) {
            togglePause();
        }
    });
    
    window.addEventListener('keyup', (e) => {
        Input.keys[e.code] = false;
    });
    
    // Mouse
    canvas.addEventListener('mousemove', (e) => {
        const rect = canvas.getBoundingClientRect();
        Input.mouse.x = (e.clientX - rect.left) * (CANVAS_WIDTH / rect.width);
        Input.mouse.y = (e.clientY - rect.top) * (CANVAS_HEIGHT / rect.height);
    });
    
    canvas.addEventListener('mousedown', () => Input.mouse.down = true);
    canvas.addEventListener('mouseup', () => Input.mouse.down = false);
}

function setupTouchControls() {
    const joystickContainer = document.getElementById('joystick-container');
    const joystickStick = document.getElementById('joystick-stick');
    
    let joystickActive = false;
    let joystickCenter = { x: 60, y: 60 };
    
    joystickContainer.addEventListener('touchstart', (e) => {
        e.preventDefault();
        joystickActive = true;
        const touch = e.touches[0];
        const rect = joystickContainer.getBoundingClientRect();
        joystickCenter = {
            x: rect.left + rect.width / 2,
            y: rect.top + rect.height / 2
        };
    });
    
    joystickContainer.addEventListener('touchmove', (e) => {
        e.preventDefault();
        if (!joystickActive) return;
        
        const touch = e.touches[0];
        let dx = touch.clientX - joystickCenter.x;
        let dy = touch.clientY - joystickCenter.y;
        
        const maxDist = 40;
        const dist = Math.sqrt(dx * dx + dy * dy);
        
        if (dist > maxDist) {
            dx = (dx / dist) * maxDist;
            dy = (dy / dist) * maxDist;
        }
        
        joystickStick.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
        
        Input.joystick.x = dx / maxDist;
        Input.joystick.y = dy / maxDist;
    });
    
    joystickContainer.addEventListener('touchend', (e) => {
        e.preventDefault();
        joystickActive = false;
        joystickStick.style.transform = 'translate(-50%, -50%)';
        Input.joystick.x = 0;
        Input.joystick.y = 0;
    });
    
    // Action buttons
    document.getElementById('btn-attack').addEventListener('touchstart', (e) => {
        e.preventDefault();
        playerAttack();
    });
    
    document.getElementById('btn-interact').addEventListener('touchstart', (e) => {
        e.preventDefault();
        playerInteract();
    });
    
    document.getElementById('btn-sprint').addEventListener('touchstart', (e) => {
        e.preventDefault();
        GameState.player.isSprinting = true;
    });
    
    document.getElementById('btn-sprint').addEventListener('touchend', (e) => {
        e.preventDefault();
        GameState.player.isSprinting = false;
    });
    
    document.getElementById('btn-pause').addEventListener('touchstart', (e) => {
        e.preventDefault();
        togglePause();
    });
}

function setupMenuButtons() {
    // Main menu buttons
    document.getElementById('btn-new-game').addEventListener('click', startNewGame);
    document.getElementById('btn-continue').addEventListener('click', continueGame);
    document.getElementById('btn-load-act').addEventListener('click', () => openSubMenu('load-act-menu'));
    document.getElementById('btn-codex').addEventListener('click', () => openSubMenu('codex-menu'));
    document.getElementById('btn-upgrades').addEventListener('click', () => openSubMenu('upgrades-menu'));
    document.getElementById('btn-options').addEventListener('click', () => openSubMenu('options-menu'));
    document.getElementById('btn-achievements').addEventListener('click', () => openSubMenu('achievements-menu'));
    
    // Pause menu buttons
    document.getElementById('btn-resume').addEventListener('click', togglePause);
    document.getElementById('btn-save').addEventListener('click', () => { saveGame(); showNotification('Game Saved', 'Progress saved to LocalStorage'); });
    document.getElementById('btn-load').addEventListener('click', () => { loadGame(); showNotification('Game Loaded', 'Progress restored'); });
    document.getElementById('btn-options-pause').addEventListener('click', () => openSubMenu('options-menu'));
    document.getElementById('btn-quit').addEventListener('click', quitToMenu);
    
    // Initialize sub-menu content
    initCodex();
    initUpgrades();
    initOptions();
    initAchievements();
    initLoadAct();
}

// ==================== MENU FUNCTIONS ====================
function openSubMenu(menuId) {
    document.getElementById(menuId).classList.remove('hidden');
}

function closeSubMenu(menuId) {
    document.getElementById(menuId).classList.add('hidden');
}

function initCodex() {
    const content = document.getElementById('codex-content');
    let html = '<div class="codex-tabs">';
    
    for (let category in CODEX) {
        html += `<button class="codex-tab" onclick="showCodexCategory('${category}')">${category.charAt(0).toUpperCase() + category.slice(1)}</button>`;
    }
    
    html += '</div><div id="codex-entries"></div>';
    content.innerHTML = html;
    
    showCodexCategory('history');
}

function showCodexCategory(category) {
    const entries = document.getElementById('codex-entries');
    let html = '';
    
    CODEX[category].forEach(entry => {
        html += `
            <div class="codex-entry">
                <div class="codex-entry-title">${entry.title}</div>
                <div class="codex-entry-text">${entry.text}</div>
            </div>
        `;
    });
    
    entries.innerHTML = html;
    
    // Update active tab
    document.querySelectorAll('.codex-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.textContent.toLowerCase() === category) {
            tab.classList.add('active');
        }
    });
}

function initUpgrades() {
    const content = document.getElementById('upgrades-content');
    let html = '<div class="upgrade-tree">';
    
    for (let category in UPGRADES) {
        html += `
            <div class="upgrade-category">
                <div class="upgrade-category-title">${category.charAt(0).toUpperCase() + category.slice(1)}</div>
        `;
        
        UPGRADES[category].forEach(upgrade => {
            const isUnlocked = GameState.upgrades.includes(upgrade.id);
            const canAfford = GameState.player.money >= upgrade.cost;
            const hasRequirement = !upgrade.requires || GameState.upgrades.includes(upgrade.requires);
            const statusClass = isUnlocked ? 'unlocked' : (!hasRequirement ? 'locked' : '');
            
            html += `
                <div class="upgrade-item ${statusClass}" onclick="purchaseUpgrade('${upgrade.id}')">
                    <div class="upgrade-name">${isUnlocked ? '‚úì ' : ''}${upgrade.name}</div>
                    <div class="upgrade-cost">${isUnlocked ? 'Owned' : `üí∞ ${upgrade.cost}`}</div>
                </div>
            `;
        });
        
        html += '</div>';
    }
    
    html += '</div>';
    content.innerHTML = html;
}

function purchaseUpgrade(upgradeId) {
    // Find the upgrade
    let upgrade = null;
    for (let category in UPGRADES) {
        upgrade = UPGRADES[category].find(u => u.id === upgradeId);
        if (upgrade) break;
    }
    
    if (!upgrade) return;
    
    // Check if already owned
    if (GameState.upgrades.includes(upgradeId)) {
        showNotification('Already Owned', 'You already have this upgrade');
        return;
    }
    
    // Check requirements
    if (upgrade.requires && !GameState.upgrades.includes(upgrade.requires)) {
        showNotification('Locked', 'Complete the previous upgrade first');
        return;
    }
    
    // Check money
    if (GameState.player.money < upgrade.cost) {
        showNotification('Not Enough Faisaa', `Need ${upgrade.cost} faisaa`);
        return;
    }
    
    // Purchase
    GameState.player.money -= upgrade.cost;
    GameState.upgrades.push(upgradeId);
    
    showNotification('Upgrade Purchased', upgrade.name);
    initUpgrades(); // Refresh display
    updateHUD();
}

function initOptions() {
    const content = document.getElementById('options-content');
    content.innerHTML = `
        <div class="codex-entry">
            <div class="codex-entry-title">üîä Sound Volume</div>
            <input type="range" min="0" max="100" value="80" id="volume-slider" style="width: 100%">
        </div>
        <div class="codex-entry">
            <div class="codex-entry-title">üéµ Music Volume</div>
            <input type="range" min="0" max="100" value="60" id="music-slider" style="width: 100%">
        </div>
        <div class="codex-entry">
            <div class="codex-entry-title">üì± Touch Controls</div>
            <label><input type="checkbox" id="touch-enabled" checked> Enable Touch Controls</label>
        </div>
        <div class="codex-entry">
            <div class="codex-entry-title">üéÆ Controls</div>
            <div class="codex-entry-text">
                <strong>Keyboard:</strong><br>
                WASD / Arrow Keys - Move<br>
                Space - Attack<br>
                E - Interact<br>
                Shift - Sprint<br>
                Escape - Pause<br><br>
                <strong>Touch:</strong><br>
                Left joystick - Move<br>
                üëä - Attack<br>
                ü§ù - Interact<br>
                üèÉ - Sprint (hold)<br>
                ‚è∏Ô∏è - Pause
            </div>
        </div>
    `;
}

function initAchievements() {
    const content = document.getElementById('achievements-content');
    let html = '';
    
    ACHIEVEMENTS_LIST.forEach(achievement => {
        const isUnlocked = GameState.achievements.includes(achievement.id);
        html += `
            <div class="codex-entry" style="opacity: ${isUnlocked ? 1 : 0.5}">
                <div class="codex-entry-title">${achievement.icon} ${achievement.name}</div>
                <div class="codex-entry-text">${isUnlocked ? achievement.desc : '???'}</div>
            </div>
        `;
    });
    
    content.innerHTML = html;
}

function initLoadAct() {
    const content = document.getElementById('load-act-content');
    const acts = [
        { num: 1, name: "Maafannu Awakening", unlocked: true },
        { num: 2, name: "Mal√© Core Wars", unlocked: GameState.completedMissions.includes('act1_climax') },
        { num: 3, name: "Synthetic Surge", unlocked: false },
        { num: 4, name: "Hulhumal√© Heist", unlocked: false },
        { num: 5, name: "Parliament Plague", unlocked: false },
        { num: 6, name: "Atoll Anarchy", unlocked: false },
        { num: 7, name: "The President's Pawn", unlocked: false },
        { num: 8, name: "The Great Betrayal", unlocked: false },
        { num: 9, name: "Syndicate Revolution", unlocked: false },
        { num: 10, name: "Coup d'√âtat", unlocked: false },
        { num: 11, name: "Epilogue: Cycles Broken?", unlocked: false }
    ];
    
    let html = '';
    acts.forEach(act => {
        html += `
            <div class="codex-entry" style="opacity: ${act.unlocked ? 1 : 0.5}; cursor: ${act.unlocked ? 'pointer' : 'default'}"
                 onclick="${act.unlocked ? `loadAct(${act.num})` : ''}">
                <div class="codex-entry-title">Act ${act.num}: ${act.name}</div>
                <div class="codex-entry-text">${act.unlocked ? 'Click to start' : 'üîí Locked'}</div>
            </div>
        `;
    });
    
    content.innerHTML = html;
}

function loadAct(actNum) {
    GameState.currentAct = actNum;
    GameState.currentMission = 0;
    closeSubMenu('load-act-menu');
    startGame();
}

// ==================== GAME FLOW ====================
function startNewGame() {
    // Reset game state
    GameState.currentAct = 1;
    GameState.currentMission = 0;
    GameState.player.health = 100;
    GameState.player.stamina = 100;
    GameState.player.karma = 50;
    GameState.player.familyMeter = 50;
    GameState.player.money = 0;
    GameState.completedMissions = [];
    GameState.completedSideMissions = [];
    GameState.choices = [];
    GameState.achievements = [];
    GameState.upgrades = [];
    GameState.flags = {
        metHulhuHustlers: false,
        completedTutorial: false,
        sawNunnuNews: false,
        familyDinnerHappened: false,
        rippooSecretHinted: false,
        recruitedMinors: false
    };
    
    startGame();
}

function continueGame() {
    if (localStorage.getItem('rta_save')) {
        loadGame();
        startGame();
    }
}

function startGame() {
    // Hide menu, show game
    document.getElementById('main-menu').classList.add('hidden');
    document.getElementById('hud').classList.remove('hidden');
    document.getElementById('touch-controls').classList.remove('hidden');
    document.getElementById('mission-tracker').classList.remove('hidden');
    document.getElementById('radio-display').classList.remove('hidden');
    
    // Generate map tiles first
    generateMapTiles(GameState.world.currentMap);
    
    // Set initial map
    const map = MAPS[GameState.world.currentMap];
    GameState.player.x = map.spawnX * TILE_SIZE;
    GameState.player.y = map.spawnY * TILE_SIZE;
    
    // Spawn NPCs
    spawnNPCs();
    
    // Start game loop
    GameState.isPlaying = true;
    GameState.isPaused = false;
    
    // Start current mission
    if (GameState.currentMission < MISSIONS.act1.length) {
        startMission(MISSIONS.act1[GameState.currentMission]);
    }
    
    // Start radio
    startRadio();
    
    // Start game loop
    requestAnimationFrame(gameLoop);
    
    // Show act intro
    showNotification(`Act ${GameState.currentAct}`, getActTitle(GameState.currentAct));
}

function getActTitle(act) {
    const titles = {
        1: "Maafannu Awakening",
        2: "Mal√© Core Wars",
        3: "Synthetic Surge",
        4: "Hulhumal√© Heist",
        5: "Parliament Plague",
        6: "Atoll Anarchy",
        7: "The President's Pawn",
        8: "The Great Betrayal",
        9: "Syndicate Revolution",
        10: "Coup d'√âtat",
        11: "Epilogue: Cycles Broken?"
    };
    return titles[act] || "Unknown";
}

function togglePause() {
    GameState.isPaused = !GameState.isPaused;
    document.getElementById('pause-menu').classList.toggle('hidden', !GameState.isPaused);
}

function quitToMenu() {
    GameState.isPlaying = false;
    GameState.isPaused = false;
    
    document.getElementById('pause-menu').classList.add('hidden');
    document.getElementById('hud').classList.add('hidden');
    document.getElementById('touch-controls').classList.add('hidden');
    document.getElementById('mission-tracker').classList.add('hidden');
    document.getElementById('radio-display').classList.add('hidden');
    document.getElementById('dialogue-box').classList.add('hidden');
    document.getElementById('main-menu').classList.remove('hidden');
    
    // Enable continue button if save exists
    if (localStorage.getItem('rta_save')) {
        document.getElementById('btn-continue').disabled = false;
    }
}

// ==================== SAVE/LOAD ====================
function saveGame() {
    const saveData = {
        version: 1,
        timestamp: Date.now(),
        state: GameState
    };
    
    localStorage.setItem('rta_save', JSON.stringify(saveData));
}

function loadGame() {
    const saveData = localStorage.getItem('rta_save');
    if (saveData) {
        try {
            const data = JSON.parse(saveData);
            Object.assign(GameState, data.state);
            document.getElementById('btn-continue').disabled = false;
        } catch (e) {
            console.error('Failed to load save:', e);
        }
    }
}

// ==================== GAME LOOP ====================
function gameLoop(timestamp) {
    if (!GameState.isPlaying) return;
    
    // Calculate delta time
    deltaTime = (timestamp - lastTime) / 1000;
    lastTime = timestamp;
    frameCount++;
    
    // Cap delta time to prevent huge jumps
    if (deltaTime > 0.1) deltaTime = 0.1;
    
    if (!GameState.isPaused && !GameState.isInDialogue && !GameState.isInMinigame) {
        update(deltaTime);
    }
    
    render();
    
    requestAnimationFrame(gameLoop);
}

function update(dt) {
    // Update player
    updatePlayer(dt);
    
    // Update NPCs
    updateNPCs(dt);
    
    // Update enemies
    updateEnemies(dt);
    
    // Update camera
    updateCamera(dt);
    
    // Update world time
    updateWorldTime(dt);
    
    // Update weather
    updateWeather(dt);
    
    // Check mission objectives
    checkMissionObjectives();
    
    // Regenerate stamina
    if (!GameState.player.isSprinting && GameState.player.stamina < GameState.player.maxStamina) {
        GameState.player.stamina = Math.min(GameState.player.maxStamina, GameState.player.stamina + 10 * dt);
    }
    
    // Update HUD
    updateHUD();
}

function updatePlayer(dt) {
    const player = GameState.player;
    let dx = 0, dy = 0;
    
    // Keyboard input
    if (Input.keys['KeyW'] || Input.keys['ArrowUp']) dy -= 1;
    if (Input.keys['KeyS'] || Input.keys['ArrowDown']) dy += 1;
    if (Input.keys['KeyA'] || Input.keys['ArrowLeft']) dx -= 1;
    if (Input.keys['KeyD'] || Input.keys['ArrowRight']) dx += 1;
    
    // Joystick input
    if (Math.abs(Input.joystick.x) > 0.1) dx = Input.joystick.x;
    if (Math.abs(Input.joystick.y) > 0.1) dy = Input.joystick.y;
    
    // Keyboard sprint
    if (Input.keys['ShiftLeft'] || Input.keys['ShiftRight']) {
        player.isSprinting = true;
    } else if (!Input.touch.active) {
        player.isSprinting = false;
    }
    
    // Normalize diagonal movement
    if (dx !== 0 && dy !== 0) {
        const len = Math.sqrt(dx * dx + dy * dy);
        dx /= len;
        dy /= len;
    }
    
    // Calculate speed
    let speed = player.speed;
    if (player.isSprinting && player.stamina > 0) {
        speed *= 1.8;
        player.stamina -= 20 * dt;
    }
    
    // Apply movement
    if (dx !== 0 || dy !== 0) {
        player.isMoving = true;
        
        // Update direction
        if (Math.abs(dx) > Math.abs(dy)) {
            player.direction = dx > 0 ? 'right' : 'left';
        } else {
            player.direction = dy > 0 ? 'down' : 'up';
        }
        
        // Calculate new position
        const newX = player.x + dx * speed * dt * 60;
        const newY = player.y + dy * speed * dt * 60;
        
        // Check collision
        if (!checkCollision(newX, player.y, player.width, player.height)) {
            player.x = newX;
        }
        if (!checkCollision(player.x, newY, player.width, player.height)) {
            player.y = newY;
        }
        
        // Clamp to map bounds
        const map = MAPS[GameState.world.currentMap];
        player.x = Math.max(TILE_SIZE, Math.min(player.x, (map.width - 2) * TILE_SIZE));
        player.y = Math.max(TILE_SIZE, Math.min(player.y, (map.height - 2) * TILE_SIZE));
    } else {
        player.isMoving = false;
    }
    
    // Attack cooldown
    if (player.attackCooldown > 0) {
        player.attackCooldown -= dt;
    }
    
    // Keyboard attack
    if (Input.keys['Space'] && player.attackCooldown <= 0) {
        playerAttack();
    }
    
    // Keyboard interact
    if (Input.keys['KeyE']) {
        playerInteract();
        Input.keys['KeyE'] = false; // Prevent repeat
    }
}

function checkCollision(x, y, w, h) {
    const map = MAPS[GameState.world.currentMap];
    
    // Check tile collision
    const tileX1 = Math.floor(x / TILE_SIZE);
    const tileY1 = Math.floor(y / TILE_SIZE);
    const tileX2 = Math.floor((x + w) / TILE_SIZE);
    const tileY2 = Math.floor((y + h) / TILE_SIZE);
    
    for (let ty = tileY1; ty <= tileY2; ty++) {
        for (let tx = tileX1; tx <= tileX2; tx++) {
            if (ty >= 0 && ty < map.height && tx >= 0 && tx < map.width) {
                const tile = map.tiles[ty][tx];
                if (tile === 0 || tile === 3) { // Water or building
                    return true;
                }
            }
        }
    }
    
    return false;
}

function playerAttack() {
    const player = GameState.player;
    if (player.attackCooldown > 0) return;
    
    player.isAttacking = true;
    player.attackCooldown = 0.5;
    
    // Play attack sound
    playSound('hit');
    
    // Check for enemies in range
    const attackRange = 50;
    const attackAngle = getDirectionAngle(player.direction);
    
    currentEnemies.forEach(enemy => {
        const dx = enemy.x - player.x;
        const dy = enemy.y - player.y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        
        if (dist < attackRange) {
            // Calculate damage
            let damage = 10;
            if (GameState.upgrades.includes('combat1')) damage *= 1.2;
            if (GameState.upgrades.includes('combat2')) damage *= 1.25;
            
            enemy.health -= damage;
            enemy.hitFlash = 0.2;
            
            // Camera shake
            Camera.shake = 5;
            
            // Check if defeated
            if (enemy.health <= 0) {
                defeatEnemy(enemy);
            }
        }
    });
    
    setTimeout(() => {
        player.isAttacking = false;
    }, 200);
}

function getDirectionAngle(direction) {
    switch (direction) {
        case 'up': return -Math.PI / 2;
        case 'down': return Math.PI / 2;
        case 'left': return Math.PI;
        case 'right': return 0;
    }
}

function playerInteract() {
    const player = GameState.player;
    const interactRange = 50;
    
    // Check NPCs
    for (let npc of currentNPCs) {
        const dx = npc.x - player.x;
        const dy = npc.y - player.y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        
        if (dist < interactRange) {
            interactWithNPC(npc);
            return;
        }
    }
    
    // Check items
    for (let i = currentItems.length - 1; i >= 0; i--) {
        const item = currentItems[i];
        const dx = item.x - player.x;
        const dy = item.y - player.y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        
        if (dist < interactRange) {
            collectItem(item, i);
            return;
        }
    }
    
    // Check zones
    const map = MAPS[GameState.world.currentMap];
    for (let zoneKey in map.zones) {
        const zone = map.zones[zoneKey];
        if (player.x >= zone.x * TILE_SIZE && player.x < (zone.x + zone.w) * TILE_SIZE &&
            player.y >= zone.y * TILE_SIZE && player.y < (zone.y + zone.h) * TILE_SIZE) {
            interactWithZone(zoneKey, zone);
            return;
        }
    }
}

function interactWithNPC(npc) {
    if (npc.dialogue) {
        showDialogue(npc.dialogue);
    } else if (npc.type === 'tourist' && !npc.robbed) {
        // Pickpocket attempt
        attemptPickpocket(npc);
    } else if (npc.type === 'shopkeeper') {
        showNotification('Shop', 'Coming soon: Buy items and upgrades');
    }
}

function attemptPickpocket(npc) {
    const stealthSkill = GameState.player.skills.stealth;
    const successChance = 0.5 + (stealthSkill * 0.1);
    
    if (GameState.upgrades.includes('stealth2')) {
        successChance *= 1.3;
    }
    
    if (Math.random() < successChance) {
        // Success
        npc.robbed = true;
        const money = Math.floor(Math.random() * 50) + 20;
        GameState.player.money += money;
        
        // Add wallet to inventory for mission tracking
        GameState.player.inventory.push({ type: 'wallet', value: money });
        
        showNotification('Success!', `Stole ${money} faisaa üí∞`);
        playSound('coin');
        
        // Update mission objective
        updateMissionObjective('collect', 'wallet', 1);
        
        // Achievement check
        if (!GameState.achievements.includes('first_score')) {
            unlockAchievement('first_score');
        }
        
        // Karma hit
        GameState.player.karma = Math.max(0, GameState.player.karma - 2);
    } else {
        // Failed - alert nearby NPCs
        showNotification('Failed!', 'They noticed you! üëÄ');
        GameState.world.heat = Math.min(5, GameState.world.heat + 1);
        npc.alerted = true;
    }
}

function collectItem(item, index) {
    if (item.type === 'money') {
        GameState.player.money += item.value;
        showNotification('Collected', `+${item.value} faisaa üí∞`);
        playSound('coin');
    } else if (item.type === 'wallet') {
        GameState.player.inventory.push(item);
        GameState.player.money += item.value || 30;
        updateMissionObjective('collect', 'wallet', 1);
        showNotification('Collected', 'Wallet üëõ');
    } else if (item.type === 'health') {
        GameState.player.health = Math.min(GameState.player.maxHealth, GameState.player.health + 25);
        showNotification('Healed', '+25 Health ‚ù§Ô∏è');
    }
    
    currentItems.splice(index, 1);
}

function interactWithZone(zoneKey, zone) {
    if (zoneKey === 'fishMarket') {
        showNotification(zone.name, 'Tourists everywhere. Easy pickings...');
    } else if (zoneKey === 'teaShop') {
        showDialogue(DIALOGUES.rippoo_confrontation);
    } else if (zoneKey === 'safehouse') {
        showNotification(zone.name, 'Safe! Heat reduced. Game saved.');
        GameState.world.heat = 0;
        saveGame();
    } else if (zoneKey === 'rondaHome') {
        if (!GameState.flags.familyDinnerHappened) {
            showDialogue(DIALOGUES.ronda_disown);
            GameState.flags.familyDinnerHappened = true;
        } else {
            showDialogue(DIALOGUES.nappey_support);
        }
    }
}

function defeatEnemy(enemy) {
    // Remove from array
    const index = currentEnemies.indexOf(enemy);
    if (index > -1) {
        currentEnemies.splice(index, 1);
    }
    
    // Drop loot
    if (Math.random() < 0.5) {
        currentItems.push({
            type: 'money',
            x: enemy.x,
            y: enemy.y,
            value: Math.floor(Math.random() * 30) + 10
        });
    }
    
    // Update mission
    updateMissionObjective('defeat', enemy.type, 1);
    
    // Karma
    GameState.player.karma = Math.max(0, GameState.player.karma - 3);
    
    showNotification('Enemy Defeated', `${enemy.name} down!`);
}

// Continue in next part...


// ==================== NPC SYSTEM ====================
function spawnNPCs() {
    currentNPCs = [];
    currentItems = [];
    currentEnemies = [];
    
    const map = MAPS[GameState.world.currentMap];
    
    // Spawn tourists in fish market
    if (map.zones.fishMarket) {
        const zone = map.zones.fishMarket;
        for (let i = 0; i < 8; i++) {
            currentNPCs.push({
                type: 'tourist',
                sprite: SPRITES.tourist,
                x: (zone.x + Math.random() * zone.w) * TILE_SIZE,
                y: (zone.y + Math.random() * zone.h) * TILE_SIZE,
                direction: Math.random() * Math.PI * 2,
                speed: 0.5 + Math.random() * 0.5,
                robbed: false,
                alerted: false
            });
        }
    }
    
    // Spawn gang members
    if (GameState.flags.metHulhuHustlers || GameState.currentMission >= 1) {
        for (let i = 0; i < 3; i++) {
            currentNPCs.push({
                type: 'gangMember',
                sprite: SPRITES.gangMember,
                name: 'Hulhu Hustler',
                x: 200 + Math.random() * 200,
                y: 300 + Math.random() * 200,
                direction: Math.random() * Math.PI * 2,
                speed: 0.3,
                dialogue: DIALOGUES.tutorial_intro
            });
        }
    }
    
    // Spawn enemies based on mission
    const mission = MISSIONS.act1[GameState.currentMission];
    if (mission && mission.type === 'combat') {
        spawnEnemiesForMission(mission);
    }
    
    // Spawn random items
    for (let i = 0; i < 5; i++) {
        currentItems.push({
            type: Math.random() < 0.7 ? 'money' : 'health',
            x: (5 + Math.random() * (map.width - 10)) * TILE_SIZE,
            y: (5 + Math.random() * (map.height - 10)) * TILE_SIZE,
            value: Math.floor(Math.random() * 20) + 5
        });
    }
}

function spawnEnemiesForMission(mission) {
    const map = MAPS[GameState.world.currentMap];
    const enemyCount = mission.objectives.find(o => o.type === 'defeat')?.count || 3;
    
    for (let i = 0; i < enemyCount; i++) {
        let enemyType = 'kudaThug';
        let sprite = SPRITES.gangMember;
        let name = 'Kuda Henveiru Thug';
        
        if (mission.objectives[0].target === 'masodiScout') {
            enemyType = 'masodiScout';
            name = 'Masodi Scout';
        } else if (mission.objectives[0].target === 'wantedMember') {
            enemyType = 'wantedMember';
            name = 'Wanted Member';
            sprite = SPRITES.gangLeader;
        } else if (mission.objectives[0].target === 'marn') {
            enemyType = 'marn';
            name = 'Marn (Wanted Boss)';
            sprite = SPRITES.gangLeader;
        }
        
        currentEnemies.push({
            type: enemyType,
            sprite: sprite,
            name: name,
            x: 300 + Math.random() * 400,
            y: 200 + Math.random() * 300,
            health: enemyType === 'marn' ? 100 : 30,
            maxHealth: enemyType === 'marn' ? 100 : 30,
            speed: 1 + Math.random() * 0.5,
            direction: Math.random() * Math.PI * 2,
            state: 'patrol',
            attackCooldown: 0,
            hitFlash: 0
        });
    }
}

function updateNPCs(dt) {
    currentNPCs.forEach(npc => {
        // Simple wandering behavior
        if (Math.random() < 0.01) {
            npc.direction = Math.random() * Math.PI * 2;
        }
        
        if (!npc.alerted) {
            npc.x += Math.cos(npc.direction) * npc.speed * dt * 30;
            npc.y += Math.sin(npc.direction) * npc.speed * dt * 30;
        }
        
        // Keep in bounds
        const map = MAPS[GameState.world.currentMap];
        npc.x = Math.max(TILE_SIZE, Math.min(npc.x, (map.width - 2) * TILE_SIZE));
        npc.y = Math.max(TILE_SIZE, Math.min(npc.y, (map.height - 2) * TILE_SIZE));
    });
}

function updateEnemies(dt) {
    const player = GameState.player;
    
    currentEnemies.forEach(enemy => {
        // Update hit flash
        if (enemy.hitFlash > 0) {
            enemy.hitFlash -= dt;
        }
        
        // AI behavior
        const dx = player.x - enemy.x;
        const dy = player.y - enemy.y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        
        if (dist < 200) {
            // Chase player
            enemy.state = 'chase';
            enemy.x += (dx / dist) * enemy.speed * dt * 60;
            enemy.y += (dy / dist) * enemy.speed * dt * 60;
            
            // Attack if close
            if (dist < 40 && enemy.attackCooldown <= 0) {
                enemyAttack(enemy);
            }
        } else {
            // Patrol
            enemy.state = 'patrol';
            if (Math.random() < 0.02) {
                enemy.direction = Math.random() * Math.PI * 2;
            }
            enemy.x += Math.cos(enemy.direction) * enemy.speed * 0.3 * dt * 60;
            enemy.y += Math.sin(enemy.direction) * enemy.speed * 0.3 * dt * 60;
        }
        
        // Update attack cooldown
        if (enemy.attackCooldown > 0) {
            enemy.attackCooldown -= dt;
        }
        
        // Keep in bounds
        const map = MAPS[GameState.world.currentMap];
        enemy.x = Math.max(TILE_SIZE, Math.min(enemy.x, (map.width - 2) * TILE_SIZE));
        enemy.y = Math.max(TILE_SIZE, Math.min(enemy.y, (map.height - 2) * TILE_SIZE));
    });
}

function enemyAttack(enemy) {
    enemy.attackCooldown = 1;
    
    const damage = enemy.type === 'marn' ? 15 : 8;
    GameState.player.health -= damage;
    
    Camera.shake = 8;
    playSound('hurt');
    
    if (GameState.player.health <= 0) {
        playerDeath();
    }
}

function playerDeath() {
    showNotification('Wasted!', 'You were defeated...');
    
    // Reset to safehouse
    setTimeout(() => {
        GameState.player.health = GameState.player.maxHealth;
        GameState.player.x = 400;
        GameState.player.y = 300;
        GameState.world.heat = 0;
        spawnNPCs();
    }, 2000);
}

// ==================== CAMERA ====================
function updateCamera(dt) {
    // Follow player
    Camera.targetX = GameState.player.x - CANVAS_WIDTH / 2;
    Camera.targetY = GameState.player.y - CANVAS_HEIGHT / 2;
    
    // Smooth follow
    Camera.x += (Camera.targetX - Camera.x) * 5 * dt;
    Camera.y += (Camera.targetY - Camera.y) * 5 * dt;
    
    // Camera shake
    if (Camera.shake > 0) {
        Camera.shake -= dt * 20;
        Camera.x += (Math.random() - 0.5) * Camera.shake;
        Camera.y += (Math.random() - 0.5) * Camera.shake;
    }
    
    // Clamp to map bounds
    const map = MAPS[GameState.world.currentMap];
    Camera.x = Math.max(0, Math.min(Camera.x, map.width * TILE_SIZE - CANVAS_WIDTH));
    Camera.y = Math.max(0, Math.min(Camera.y, map.height * TILE_SIZE - CANVAS_HEIGHT));
}

// ==================== WORLD UPDATES ====================
function updateWorldTime(dt) {
    // 1 game hour = 60 real seconds
    GameState.world.time += dt / 60;
    if (GameState.world.time >= 24) {
        GameState.world.time = 0;
    }
}

function updateWeather(dt) {
    // Random weather changes
    if (Math.random() < 0.0001) {
        const weathers = ['clear', 'clear', 'clear', 'cloudy', 'rain', 'storm'];
        GameState.world.weather = weathers[Math.floor(Math.random() * weathers.length)];
        
        if (GameState.world.weather === 'rain' || GameState.world.weather === 'storm') {
            createRainEffect();
        } else {
            clearRainEffect();
        }
    }
}

function createRainEffect() {
    const overlay = document.getElementById('weather-overlay');
    overlay.innerHTML = '';
    
    for (let i = 0; i < 100; i++) {
        const drop = document.createElement('div');
        drop.className = 'rain-drop';
        drop.style.left = Math.random() * 100 + '%';
        drop.style.animationDuration = (0.5 + Math.random() * 0.5) + 's';
        drop.style.animationDelay = Math.random() * 2 + 's';
        overlay.appendChild(drop);
    }
}

function clearRainEffect() {
    document.getElementById('weather-overlay').innerHTML = '';
}

// ==================== RENDERING ====================
function render() {
    // Clear canvas
    ctx.fillStyle = '#1a3a4a';
    ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
    
    // Save context for camera transform
    ctx.save();
    ctx.translate(-Camera.x, -Camera.y);
    
    // Render map
    renderMap();
    
    // Render items
    renderItems();
    
    // Render NPCs
    renderNPCs();
    
    // Render enemies
    renderEnemies();
    
    // Render player
    renderPlayer();
    
    // Render zone labels
    renderZoneLabels();
    
    // Restore context
    ctx.restore();
    
    // Render minimap
    renderMinimap();
    
    // Render weather effects
    renderWeatherEffects();
    
    // Render time of day overlay
    renderTimeOverlay();
}

function renderMap() {
    const map = MAPS[GameState.world.currentMap];
    
    // Initialize tile renderer if not exists
    if (!window.tileRenderer) {
        window.tileRenderer = new TileRenderer(TILE_SIZE);
    }
    
    // Calculate visible tiles
    const startX = Math.floor(Camera.x / TILE_SIZE);
    const startY = Math.floor(Camera.y / TILE_SIZE);
    const endX = Math.ceil((Camera.x + CANVAS_WIDTH) / TILE_SIZE);
    const endY = Math.ceil((Camera.y + CANVAS_HEIGHT) / TILE_SIZE);
    
    for (let y = startY; y <= endY && y < map.height; y++) {
        for (let x = startX; x <= endX && x < map.width; x++) {
            if (y < 0 || x < 0) continue;
            
            const tile = map.tiles[y][x];
            const screenX = x * TILE_SIZE;
            const screenY = y * TILE_SIZE;
            
            // Use new GTA 2-style tile renderer
            window.tileRenderer.renderTile(ctx, screenX, screenY, tile);
        }
    }
}

function renderItems() {
    currentItems.forEach(item => {
        let emoji;
        switch (item.type) {
            case 'money': emoji = ITEMS.money; break;
            case 'wallet': emoji = ITEMS.wallet; break;
            case 'health': emoji = '‚ù§Ô∏è'; break;
            default: emoji = '‚ùì';
        }
        
        // Bobbing animation
        const bob = Math.sin(frameCount * 0.1) * 3;
        
        ctx.font = '24px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(emoji, item.x, item.y + bob);
    });
}

function renderNPCs() {
    currentNPCs.forEach(npc => {
        // Use new GTA 2-style NPC renderer
        const npcType = npc.type || 'civilian';
        CharacterRenderer.drawNPC(ctx, npc.x, npc.y, npcType);
        
        // Alert indicator
        if (npc.alerted) {
            ctx.fillStyle = '#ff0000';
            ctx.font = '16px Arial';
            ctx.fillText('!', npc.x, npc.y - 20);
        }
        
        // Interaction hint
        const dx = npc.x - GameState.player.x;
        const dy = npc.y - GameState.player.y;
        if (Math.sqrt(dx * dx + dy * dy) < 50) {
            ctx.fillStyle = 'rgba(255,255,255,0.8)';
            ctx.font = '12px Arial';
            ctx.fillText('[E] / Talk', npc.x, npc.y - 25);
        }
    });
}

function renderEnemies() {
    currentEnemies.forEach(enemy => {
        // Use new GTA 2-style enemy renderer
        CharacterRenderer.drawEnemy(ctx, enemy.x, enemy.y, enemy.type || 'thug');
        
        // Hit flash
        if (enemy.hitFlash > 0) {
            ctx.fillStyle = 'rgba(255,0,0,0.5)';
            ctx.beginPath();
            ctx.arc(enemy.x, enemy.y - 5, 20, 0, Math.PI * 2);
            ctx.fill();
        }
        
        // Health bar
        const barWidth = 30;
        const barHeight = 4;
        const healthPercent = enemy.health / enemy.maxHealth;
        
        ctx.fillStyle = '#333';
        ctx.fillRect(enemy.x - barWidth / 2, enemy.y - 30, barWidth, barHeight);
        
        ctx.fillStyle = healthPercent > 0.5 ? '#00ff00' : healthPercent > 0.25 ? '#ffff00' : '#ff0000';
        ctx.fillRect(enemy.x - barWidth / 2, enemy.y - 30, barWidth * healthPercent, barHeight);
        
        // Name
        ctx.fillStyle = '#ff6666';
        ctx.font = '10px Arial';
        ctx.fillText(enemy.name, enemy.x, enemy.y - 35);
    });
}

function renderPlayer() {
    const player = GameState.player;
    
    // Use new GTA 2-style character renderer
    const characterData = {
        color: '#8b4513',
        skinColor: '#d4a574',
        weapon: player.currentWeapon
    };
    
    CharacterRenderer.drawCharacter(ctx, player.x, player.y, characterData, player.direction);
    
    // Attack effect
    if (player.isAttacking) {
        ctx.strokeStyle = 'rgba(255,100,100,0.8)';
        ctx.lineWidth = 3;
        ctx.beginPath();
        const angle = getDirectionAngle(player.direction);
        ctx.arc(player.x, player.y, 35, angle - 0.5, angle + 0.5);
        ctx.stroke();
    }
    
    // Sprint effect
    if (player.isSprinting && player.isMoving) {
        ctx.fillStyle = 'rgba(255,255,255,0.3)';
        ctx.fillRect(player.x - 15, player.y - 15, 30, 30);
    }
}

function renderZoneLabels() {
    const map = MAPS[GameState.world.currentMap];
    
    for (let zoneKey in map.zones) {
        const zone = map.zones[zoneKey];
        const centerX = (zone.x + zone.w / 2) * TILE_SIZE;
        const centerY = zone.y * TILE_SIZE - 10;
        
        // Check if player is near
        const dx = centerX - GameState.player.x;
        const dy = (zone.y + zone.h / 2) * TILE_SIZE - GameState.player.y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        
        if (dist < 200) {
            ctx.fillStyle = 'rgba(0,0,0,0.7)';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            
            const textWidth = ctx.measureText(zone.name).width;
            ctx.fillRect(centerX - textWidth / 2 - 5, centerY - 12, textWidth + 10, 18);
            
            ctx.fillStyle = '#ffcc00';
            ctx.fillText(zone.name, centerX, centerY);
        }
    }
}

function renderMinimap() {
    const map = MAPS[GameState.world.currentMap];
    const scale = minimapCanvas.width / (map.width * TILE_SIZE);
    
    minimapCtx.fillStyle = '#0a0a0a';
    minimapCtx.fillRect(0, 0, minimapCanvas.width, minimapCanvas.height);
    
    // Draw simplified map
    for (let y = 0; y < map.height; y++) {
        for (let x = 0; x < map.width; x++) {
            const tile = map.tiles[y][x];
            let color;
            
            switch (tile) {
                case 0: color = '#003366'; break;
                case 1: color = '#5a4a3a'; break;
                case 2: color = '#333'; break;
                case 3: color = '#222'; break;
                case 4: color = '#4a6a2a'; break;
                default: color = '#5a4a3a';
            }
            
            minimapCtx.fillStyle = color;
            minimapCtx.fillRect(x * scale * TILE_SIZE, y * scale * TILE_SIZE, 
                               scale * TILE_SIZE + 1, scale * TILE_SIZE + 1);
        }
    }
    
    // Draw player
    minimapCtx.fillStyle = '#00ff00';
    minimapCtx.beginPath();
    minimapCtx.arc(GameState.player.x * scale, GameState.player.y * scale, 3, 0, Math.PI * 2);
    minimapCtx.fill();
    
    // Draw enemies
    minimapCtx.fillStyle = '#ff0000';
    currentEnemies.forEach(enemy => {
        minimapCtx.beginPath();
        minimapCtx.arc(enemy.x * scale, enemy.y * scale, 2, 0, Math.PI * 2);
        minimapCtx.fill();
    });
    
    // Draw mission marker if applicable
    // TODO: Add mission waypoint
}

function renderWeatherEffects() {
    if (GameState.world.weather === 'cloudy') {
        ctx.fillStyle = 'rgba(100,100,100,0.2)';
        ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
    } else if (GameState.world.weather === 'storm') {
        ctx.fillStyle = 'rgba(50,50,80,0.3)';
        ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
        
        // Lightning flash
        if (Math.random() < 0.002) {
            ctx.fillStyle = 'rgba(255,255,255,0.5)';
            ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
        }
    }
}

function renderTimeOverlay() {
    const time = GameState.world.time;
    let alpha = 0;
    
    // Night time (20:00 - 6:00)
    if (time >= 20 || time < 6) {
        alpha = 0.4;
        if (time >= 20) alpha = 0.4 * ((time - 20) / 4);
        if (time < 6) alpha = 0.4 * (1 - time / 6);
    }
    
    if (alpha > 0) {
        ctx.fillStyle = `rgba(0,0,30,${alpha})`;
        ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
    }
}

// ==================== HUD ====================
function updateHUD() {
    document.getElementById('health-bar').style.width = 
        (GameState.player.health / GameState.player.maxHealth * 100) + '%';
    document.getElementById('stamina-bar').style.width = 
        (GameState.player.stamina / GameState.player.maxStamina * 100) + '%';
    document.getElementById('karma-bar').style.width = GameState.player.karma + '%';
    document.getElementById('money-display').textContent = GameState.player.money;
}

// ==================== MISSION SYSTEM ====================
function startMission(mission) {
    GameState.currentMissionData = mission;
    
    document.getElementById('mission-title').textContent = mission.title;
    document.getElementById('mission-objective').textContent = mission.description;
    
    showNotification('New Mission', mission.title);
    
    // Show starting dialogue
    if (mission.dialogueStart && DIALOGUES[mission.dialogueStart]) {
        setTimeout(() => {
            showDialogue(DIALOGUES[mission.dialogueStart]);
        }, 2000);
    }
    
    // Spawn mission-specific content
    if (mission.type === 'combat') {
        spawnEnemiesForMission(mission);
    }
}

function updateMissionObjective(type, target, amount) {
    const mission = GameState.currentMissionData;
    if (!mission) return;
    
    mission.objectives.forEach(obj => {
        if (obj.type === type && obj.target === target) {
            obj.current += amount;
            
            // Update display
            document.getElementById('mission-objective').textContent = 
                `${mission.description} (${obj.current}/${obj.count})`;
        }
    });
    
    checkMissionObjectives();
}

function checkMissionObjectives() {
    const mission = GameState.currentMissionData;
    if (!mission) return;
    
    let allComplete = true;
    
    mission.objectives.forEach(obj => {
        if (obj.type === 'collect' || obj.type === 'defeat' || obj.type === 'recruit') {
            if (obj.current < obj.count) {
                allComplete = false;
            }
        } else if (obj.type === 'deliver' || obj.type === 'trigger' || obj.type === 'interact') {
            if (!obj.current) {
                allComplete = false;
            }
        }
    });
    
    if (allComplete) {
        completeMission(mission);
    }
}

function completeMission(mission) {
    // Mark as completed
    GameState.completedMissions.push(mission.id);
    
    // Apply rewards
    if (mission.rewards) {
        if (mission.rewards.money) {
            GameState.player.money += mission.rewards.money;
        }
        if (mission.rewards.karma) {
            GameState.player.karma = Math.max(0, Math.min(100, 
                GameState.player.karma + mission.rewards.karma));
        }
        if (mission.rewards.reputation) {
            for (let gang in mission.rewards.reputation) {
                if (GameState.gangs[gang]) {
                    GameState.gangs[gang].reputation += mission.rewards.reputation[gang];
                }
            }
        }
    }
    
    // Set flags
    if (mission.setFlag) {
        GameState.flags[mission.setFlag] = true;
    }
    
    // Unlock vehicle
    if (mission.vehicleUnlock) {
        showNotification('Vehicle Unlocked', `${mission.vehicleUnlock} üèçÔ∏è`);
    }
    
    // Show completion
    showNotification('Mission Complete!', `+${mission.rewards?.money || 0} faisaa`);
    
    // Show end dialogue
    if (mission.dialogueEnd && DIALOGUES[mission.dialogueEnd]) {
        setTimeout(() => {
            showDialogue(DIALOGUES[mission.dialogueEnd]);
        }, 1500);
    }
    
    // Check for act end
    if (mission.actEnd) {
        setTimeout(() => {
            showActComplete();
        }, 3000);
    } else {
        // Start next mission
        GameState.currentMission++;
        if (GameState.currentMission < MISSIONS.act1.length) {
            setTimeout(() => {
                startMission(MISSIONS.act1[GameState.currentMission]);
            }, 3000);
        }
    }
    
    // Save progress
    saveGame();
}

function showActComplete() {
    unlockAchievement('act1_complete');
    
    showNotification('Act 1 Complete!', 'Maafannu Awakening');
    
    // In full game, would transition to Act 2
    setTimeout(() => {
        showNotification('To Be Continued...', 'Act 2: Mal√© Core Wars coming soon!');
    }, 3000);
}

// ==================== DIALOGUE SYSTEM ====================
let currentDialogue = null;
let currentDialogueIndex = 0;

function showDialogue(dialogue) {
    GameState.isInDialogue = true;
    currentDialogue = dialogue;
    currentDialogueIndex = 0;
    
    document.getElementById('dialogue-box').classList.remove('hidden');
    updateDialogueDisplay();
}

function updateDialogueDisplay() {
    const box = document.getElementById('dialogue-box');
    const speaker = document.getElementById('dialogue-speaker');
    const text = document.getElementById('dialogue-text');
    const choices = document.getElementById('dialogue-choices');
    
    speaker.textContent = `${currentDialogue.sprite} ${currentDialogue.speaker}`;
    
    if (currentDialogueIndex < currentDialogue.lines.length) {
        const line = currentDialogue.lines[currentDialogueIndex];
        text.textContent = line.text;
        
        if (line.dhivehi) {
            text.style.fontStyle = 'italic';
        } else {
            text.style.fontStyle = 'normal';
        }
        
        choices.innerHTML = '<div class="dialogue-choice" onclick="advanceDialogue()">Continue ‚ñ∂</div>';
    } else if (currentDialogue.choices) {
        text.textContent = 'What do you say?';
        choices.innerHTML = '';
        
        currentDialogue.choices.forEach((choice, index) => {
            const karmaClass = choice.karma > 0 ? 'karma-good' : (choice.karma < 0 ? 'karma-bad' : '');
            choices.innerHTML += `
                <div class="dialogue-choice ${karmaClass}" onclick="selectDialogueChoice(${index})">
                    ${choice.text}
                </div>
            `;
        });
    } else {
        closeDialogue();
    }
}

function advanceDialogue() {
    currentDialogueIndex++;
    updateDialogueDisplay();
}

function selectDialogueChoice(index) {
    const choice = currentDialogue.choices[index];
    
    // Apply karma
    if (choice.karma) {
        GameState.player.karma = Math.max(0, Math.min(100, 
            GameState.player.karma + choice.karma));
    }
    
    // Apply family karma
    if (choice.familyKarma) {
        GameState.player.familyMeter = Math.max(0, Math.min(100,
            GameState.player.familyMeter + choice.familyKarma));
    }
    
    // Record choice
    GameState.choices.push({
        dialogue: currentDialogue.speaker,
        choice: choice.text,
        karma: choice.karma
    });
    
    // Show response dialogue if exists
    if (choice.response && DIALOGUES[choice.response]) {
        currentDialogue = DIALOGUES[choice.response];
        currentDialogueIndex = 0;
        updateDialogueDisplay();
    } else {
        closeDialogue();
    }
    
    // Update mission if applicable
    if (choice.outcome) {
        updateMissionObjective('interact', choice.outcome, true);
    }
}

function closeDialogue() {
    GameState.isInDialogue = false;
    currentDialogue = null;
    document.getElementById('dialogue-box').classList.add('hidden');
}

// ==================== NOTIFICATION SYSTEM ====================
function showNotification(title, text) {
    const notif = document.getElementById('notification');
    document.getElementById('notif-title').textContent = title;
    document.getElementById('notif-text').textContent = text;
    
    notif.classList.add('show');
    
    setTimeout(() => {
        notif.classList.remove('show');
    }, 3000);
}

// ==================== ACHIEVEMENT SYSTEM ====================
function unlockAchievement(id) {
    if (GameState.achievements.includes(id)) return;
    
    const achievement = ACHIEVEMENTS_LIST.find(a => a.id === id);
    if (achievement) {
        GameState.achievements.push(id);
        showNotification(`üèÜ Achievement Unlocked!`, `${achievement.icon} ${achievement.name}`);
        saveGame();
    }
}

// ==================== RADIO SYSTEM ====================
let radioInterval = null;
let currentRadioIndex = 0;
let currentStation = 'raajjeFM';

function startRadio() {
    updateRadio();
    radioInterval = setInterval(updateRadio, 8000);
}

function updateRadio() {
    const station = RADIO_CONTENT[currentStation];
    const segment = station.segments[currentRadioIndex];
    
    document.getElementById('radio-station').textContent = station.name;
    document.getElementById('radio-text').textContent = segment.text;
    
    currentRadioIndex = (currentRadioIndex + 1) % station.segments.length;
}

// ==================== AUDIO SYSTEM (Web Audio API) ====================
function initAudio() {
    if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
}

function playSound(type) {
    initAudio();
    
    const oscillator = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioCtx.destination);
    
    switch (type) {
        case 'hit':
            oscillator.frequency.value = 150;
            oscillator.type = 'square';
            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gainNode.gain.exponentialDecayTo(0.01, audioCtx.currentTime + 0.1);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.1);
            break;
            
        case 'hurt':
            oscillator.frequency.value = 200;
            oscillator.type = 'sawtooth';
            gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
            gainNode.gain.exponentialDecayTo(0.01, audioCtx.currentTime + 0.2);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.2);
            break;
            
        case 'coin':
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
            gainNode.gain.exponentialDecayTo(0.01, audioCtx.currentTime + 0.15);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.15);
            break;
    }
}

// Polyfill for exponentialDecayTo
GainNode.prototype.exponentialDecayTo = function(value, endTime) {
    this.gain.exponentialRampToValueAtTime(Math.max(value, 0.0001), endTime);
};

// ==================== MINI-GAMES ====================

// Boduberu Rhythm Game
let boduberuGame = {
    active: false,
    score: 0,
    combo: 0,
    notes: [],
    bpm: 120,
    noteSpeed: 3
};

function startBoduberuMinigame() {
    GameState.isInMinigame = true;
    boduberuGame.active = true;
    boduberuGame.score = 0;
    boduberuGame.combo = 0;
    boduberuGame.notes = [];
    
    document.getElementById('minigame-overlay').classList.remove('hidden');
    document.getElementById('minigame-title').textContent = 'ü•Å Boduberu Beat';
    document.getElementById('minigame-score').textContent = 'Score: 0 | Combo: 0';
    
    // Generate notes
    for (let i = 0; i < 20; i++) {
        boduberuGame.notes.push({
            lane: Math.floor(Math.random() * 4),
            y: -50 - i * 100,
            hit: false
        });
    }
    
    // Start game loop
    requestAnimationFrame(boduberuLoop);
    
    // Setup input
    document.addEventListener('keydown', boduberuInput);
    minigameCanvas.addEventListener('touchstart', boduberuTouchInput);
}

function boduberuLoop() {
    if (!boduberuGame.active) return;
    
    const ctx = minigameCtx;
    const width = minigameCanvas.width;
    const height = minigameCanvas.height;
    
    // Clear
    ctx.fillStyle = '#1a1a2e';
    ctx.fillRect(0, 0, width, height);
    
    // Draw lanes
    const laneWidth = width / 4;
    const laneColors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4'];
    const laneKeys = ['A', 'S', 'D', 'F'];
    
    for (let i = 0; i < 4; i++) {
        ctx.fillStyle = `${laneColors[i]}33`;
        ctx.fillRect(i * laneWidth, 0, laneWidth, height);
        
        // Hit zone
        ctx.fillStyle = `${laneColors[i]}66`;
        ctx.fillRect(i * laneWidth, height - 60, laneWidth, 50);
        
        // Key label
        ctx.fillStyle = '#fff';
        ctx.font = '20px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(laneKeys[i], i * laneWidth + laneWidth / 2, height - 25);
    }
    
    // Update and draw notes
    let activeNotes = 0;
    boduberuGame.notes.forEach(note => {
        if (note.hit) return;
        
        note.y += boduberuGame.noteSpeed;
        
        if (note.y > height + 50) {
            // Missed
            note.hit = true;
            boduberuGame.combo = 0;
        } else {
            activeNotes++;
            
            // Draw note
            ctx.fillStyle = laneColors[note.lane];
            ctx.beginPath();
            ctx.arc(note.lane * laneWidth + laneWidth / 2, note.y, 20, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = '#fff';
            ctx.font = '24px Arial';
            ctx.fillText('ü•Å', note.lane * laneWidth + laneWidth / 2, note.y + 8);
        }
    });
    
    // Update score display
    document.getElementById('minigame-score').textContent = 
        `Score: ${boduberuGame.score} | Combo: ${boduberuGame.combo}`;
    
    // Check if game over
    if (activeNotes === 0) {
        endBoduberuMinigame();
        return;
    }
    
    requestAnimationFrame(boduberuLoop);
}

function boduberuInput(e) {
    if (!boduberuGame.active) return;
    
    const laneMap = { 'KeyA': 0, 'KeyS': 1, 'KeyD': 2, 'KeyF': 3 };
    const lane = laneMap[e.code];
    
    if (lane !== undefined) {
        checkBoduberuHit(lane);
    }
}

function boduberuTouchInput(e) {
    if (!boduberuGame.active) return;
    
    const rect = minigameCanvas.getBoundingClientRect();
    const x = e.touches[0].clientX - rect.left;
    const lane = Math.floor(x / (rect.width / 4));
    
    checkBoduberuHit(lane);
}

function checkBoduberuHit(lane) {
    const hitZoneY = minigameCanvas.height - 60;
    const hitTolerance = 40;
    
    for (let note of boduberuGame.notes) {
        if (note.hit || note.lane !== lane) continue;
        
        if (Math.abs(note.y - hitZoneY) < hitTolerance) {
            // Hit!
            note.hit = true;
            boduberuGame.combo++;
            boduberuGame.score += 100 * (1 + boduberuGame.combo * 0.1);
            
            playBoduberuSound();
            return;
        }
    }
    
    // Miss
    boduberuGame.combo = 0;
}

function playBoduberuSound() {
    initAudio();
    
    const oscillator = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioCtx.destination);
    
    oscillator.frequency.value = 100 + Math.random() * 50;
    oscillator.type = 'triangle';
    gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
    gainNode.gain.exponentialDecayTo(0.01, audioCtx.currentTime + 0.2);
    
    oscillator.start();
    oscillator.stop(audioCtx.currentTime + 0.2);
}

function endBoduberuMinigame() {
    boduberuGame.active = false;
    GameState.isInMinigame = false;
    
    document.removeEventListener('keydown', boduberuInput);
    minigameCanvas.removeEventListener('touchstart', boduberuTouchInput);
    
    document.getElementById('minigame-overlay').classList.add('hidden');
    
    // Calculate reward
    const reward = Math.floor(boduberuGame.score / 10);
    GameState.player.money += reward;
    
    showNotification('Boduberu Complete!', `Score: ${boduberuGame.score} | +${reward} faisaa`);
    
    // Achievement check
    if (boduberuGame.score >= 2000 && !GameState.achievements.includes('boduberu_master')) {
        unlockAchievement('boduberu_master');
    }
}

// Fishing Mini-game
let fishingGame = {
    active: false,
    fishY: 150,
    hookY: 150,
    fishSpeed: 2,
    fishDirection: 1,
    tension: 0,
    caught: false,
    timer: 30
};

function startFishingMinigame() {
    GameState.isInMinigame = true;
    fishingGame.active = true;
    fishingGame.fishY = 150;
    fishingGame.hookY = 150;
    fishingGame.tension = 0;
    fishingGame.caught = false;
    fishingGame.timer = 30;
    
    document.getElementById('minigame-overlay').classList.remove('hidden');
    document.getElementById('minigame-title').textContent = 'üé£ Dhoni Fishing';
    
    requestAnimationFrame(fishingLoop);
    
    document.addEventListener('keydown', fishingInput);
    document.addEventListener('keyup', fishingInputUp);
    minigameCanvas.addEventListener('touchstart', fishingTouchStart);
    minigameCanvas.addEventListener('touchend', fishingTouchEnd);
}

function fishingLoop() {
    if (!fishingGame.active) return;
    
    const ctx = minigameCtx;
    const width = minigameCanvas.width;
    const height = minigameCanvas.height;
    
    // Clear
    ctx.fillStyle = '#0066aa';
    ctx.fillRect(0, 0, width, height);
    
    // Draw water waves
    ctx.strokeStyle = 'rgba(255,255,255,0.3)';
    ctx.lineWidth = 2;
    for (let i = 0; i < 5; i++) {
        ctx.beginPath();
        ctx.moveTo(0, 50 + i * 60);
        for (let x = 0; x < width; x += 20) {
            ctx.lineTo(x, 50 + i * 60 + Math.sin(x * 0.05 + frameCount * 0.1) * 10);
        }
        ctx.stroke();
    }
    
    // Update fish
    fishingGame.fishY += fishingGame.fishSpeed * fishingGame.fishDirection;
    if (fishingGame.fishY < 50 || fishingGame.fishY > height - 50) {
        fishingGame.fishDirection *= -1;
    }
    
    // Random direction changes
    if (Math.random() < 0.02) {
        fishingGame.fishDirection *= -1;
        fishingGame.fishSpeed = 1 + Math.random() * 3;
    }
    
    // Draw fish zone
    ctx.fillStyle = 'rgba(255,255,0,0.3)';
    ctx.fillRect(width / 2 - 30, fishingGame.fishY - 30, 60, 60);
    
    // Draw fish
    ctx.font = '40px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('üêü', width / 2, fishingGame.fishY + 10);
    
    // Draw hook
    ctx.fillStyle = '#fff';
    ctx.fillText('ü™ù', width / 2, fishingGame.hookY + 10);
    
    // Draw tension meter
    ctx.fillStyle = '#333';
    ctx.fillRect(20, 20, 20, height - 40);
    
    const tensionColor = fishingGame.tension < 50 ? '#00ff00' : 
                        fishingGame.tension < 80 ? '#ffff00' : '#ff0000';
    ctx.fillStyle = tensionColor;
    ctx.fillRect(20, 20 + (100 - fishingGame.tension) * (height - 40) / 100, 
                 20, fishingGame.tension * (height - 40) / 100);
    
    // Check catch
    if (Math.abs(fishingGame.fishY - fishingGame.hookY) < 30) {
        fishingGame.tension += 2;
        
        if (fishingGame.tension >= 100) {
            fishingGame.caught = true;
            endFishingMinigame();
            return;
        }
    } else {
        fishingGame.tension = Math.max(0, fishingGame.tension - 1);
    }
    
    // Timer
    fishingGame.timer -= 1/60;
    document.getElementById('minigame-score').textContent = 
        `Time: ${Math.ceil(fishingGame.timer)}s | Tension: ${Math.floor(fishingGame.tension)}%`;
    
    if (fishingGame.timer <= 0) {
        endFishingMinigame();
        return;
    }
    
    requestAnimationFrame(fishingLoop);
}

let fishingHolding = false;

function fishingInput(e) {
    if (!fishingGame.active) return;
    if (e.code === 'Space') {
        fishingHolding = true;
    }
}

function fishingInputUp(e) {
    if (e.code === 'Space') {
        fishingHolding = false;
    }
}

function fishingTouchStart() {
    fishingHolding = true;
}

function fishingTouchEnd() {
    fishingHolding = false;
}

// Update hook position based on input
setInterval(() => {
    if (fishingGame.active && fishingHolding) {
        fishingGame.hookY = Math.max(50, fishingGame.hookY - 5);
    } else if (fishingGame.active) {
        fishingGame.hookY = Math.min(250, fishingGame.hookY + 3);
    }
}, 1000/60);

function endFishingMinigame() {
    fishingGame.active = false;
    GameState.isInMinigame = false;
    
    document.removeEventListener('keydown', fishingInput);
    document.removeEventListener('keyup', fishingInputUp);
    minigameCanvas.removeEventListener('touchstart', fishingTouchStart);
    minigameCanvas.removeEventListener('touchend', fishingTouchEnd);
    
    document.getElementById('minigame-overlay').classList.add('hidden');
    
    if (fishingGame.caught) {
        const reward = 50 + Math.floor(Math.random() * 50);
        GameState.player.money += reward;
        showNotification('Fish Caught! üêü', `+${reward} faisaa`);
    } else {
        showNotification('Fish Escaped!', 'Better luck next time...');
    }
}

// ==================== INITIALIZE ====================
window.addEventListener('load', init);

// Make functions globally accessible for HTML onclick
window.closeSubMenu = closeSubMenu;
window.showCodexCategory = showCodexCategory;
window.purchaseUpgrade = purchaseUpgrade;
window.loadAct = loadAct;
window.advanceDialogue = advanceDialogue;
window.selectDialogueChoice = selectDialogueChoice;

// Debug functions (remove in production)
window.DEBUG = {
    addMoney: (amount) => { GameState.player.money += amount; updateHUD(); },
    setKarma: (value) => { GameState.player.karma = value; updateHUD(); },
    completeMission: () => { 
        if (GameState.currentMissionData) {
            GameState.currentMissionData.objectives.forEach(o => {
                if (o.count) o.current = o.count;
                else o.current = true;
            });
            checkMissionObjectives();
        }
    },
    spawnEnemy: () => {
        currentEnemies.push({
            type: 'kudaThug',
            sprite: SPRITES.gangMember,
            name: 'Test Enemy',
            x: GameState.player.x + 100,
            y: GameState.player.y,
            health: 30,
            maxHealth: 30,
            speed: 1,
            direction: 0,
            state: 'patrol',
            attackCooldown: 0,
            hitFlash: 0
        });
    },
    startBoduberu: startBoduberuMinigame,
    startFishing: startFishingMinigame
};


// ============================================
// ACT 2 INTEGRATION
// ============================================

// Extend MAPS with Act 2 maps
function loadAct2Content() {
    if (typeof ACT2_MAPS !== 'undefined') {
        // Add Act 2 maps to main MAPS object
        for (let mapKey in ACT2_MAPS) {
            MAPS[mapKey] = ACT2_MAPS[mapKey];
        }
        
        // Generate tiles for new maps
        for (let mapKey in ACT2_MAPS) {
            generateMapTiles(mapKey);
        }
        
        // Add Act 2 dialogues
        if (typeof ACT2_DIALOGUES !== 'undefined') {
            for (let dialogueKey in ACT2_DIALOGUES) {
                DIALOGUES[dialogueKey] = ACT2_DIALOGUES[dialogueKey];
            }
        }
        
        // Add Act 2 missions
        if (typeof ACT2_MISSIONS !== 'undefined') {
            MISSIONS.act2 = ACT2_MISSIONS;
        }
        
        // Add Act 2 side missions
        if (typeof ACT2_SIDE_MISSIONS !== 'undefined') {
            SIDE_MISSIONS.act2 = ACT2_SIDE_MISSIONS;
        }
        
        console.log('Act 2 content loaded successfully');
    }
}

// Generate tiles for a specific map
function generateMapTiles(mapKey) {
    const map = MAPS[mapKey];
    if (!map || map.tiles.length > 0) return;
    
    map.tiles = [];
    
    for (let y = 0; y < map.height; y++) {
        map.tiles[y] = [];
        for (let x = 0; x < map.width; x++) {
            let tile = 1; // Default ground
            
            // Water borders
            if (x === 0 || y === 0 || x === map.width - 1 || y === map.height - 1) {
                tile = 0;
            }
            // Roads
            else if (x % 8 === 0 || y % 8 === 0) {
                tile = 2;
            }
            // Random buildings
            else if (Math.random() < 0.12) {
                tile = 3;
            }
            
            map.tiles[y][x] = tile;
        }
    }
    
    // Add zones
    for (let zoneKey in map.zones) {
        const zone = map.zones[zoneKey];
        for (let y = zone.y; y < zone.y + zone.h && y < map.height; y++) {
            for (let x = zone.x; x < zone.x + zone.w && x < map.width; x++) {
                if (y >= 0 && x >= 0 && y < map.height && x < map.width) {
                    // Different tile types for different zones
                    if (zoneKey.includes('park') || zoneKey.includes('Park')) {
                        map.tiles[y][x] = 6; // Park
                    } else if (zoneKey.includes('mosque') || zoneKey.includes('Mosque')) {
                        map.tiles[y][x] = 7; // Religious
                    } else if (zoneKey.includes('port') || zoneKey.includes('dock') || zoneKey.includes('Dock')) {
                        map.tiles[y][x] = 5; // Dock
                    } else if (zoneKey.includes('HQ') || zoneKey.includes('Outpost')) {
                        map.tiles[y][x] = 8; // Gang territory
                    } else {
                        map.tiles[y][x] = 4; // Generic zone
                    }
                }
            }
        }
    }
}

// Transition to Act 2
function startAct2() {
    GameState.currentAct = 2;
    GameState.currentMission = 0;
    GameState.world.currentMap = 'male_henveiru';
    
    // Load Act 2 content
    loadAct2Content();
    
    // Set player position
    const map = MAPS[GameState.world.currentMap];
    GameState.player.x = map.spawnX * TILE_SIZE;
    GameState.player.y = map.spawnY * TILE_SIZE;
    
    // Spawn NPCs for Act 2
    spawnAct2NPCs();
    
    // Update radio
    if (typeof ACT2_RADIO !== 'undefined') {
        RADIO_CONTENT.raajjeFM.segments = ACT2_RADIO.raajjeFM.segments;
        RADIO_CONTENT.undergroundFM.segments = ACT2_RADIO.undergroundFM.segments;
    }
    
    // Show act intro
    showNotification('Act 2', 'Mal√© Core Wars');
    
    // Start first mission
    if (MISSIONS.act2 && MISSIONS.act2.length > 0) {
        setTimeout(() => {
            startMission(MISSIONS.act2[0]);
        }, 2000);
    }
    
    saveGame();
}

// Spawn NPCs for Act 2
function spawnAct2NPCs() {
    currentNPCs = [];
    currentItems = [];
    currentEnemies = [];
    
    const map = MAPS[GameState.world.currentMap];
    
    // Spawn gang members based on territory
    if (map.gangTerritory === 'Kuda Henveiru') {
        for (let i = 0; i < 5; i++) {
            currentEnemies.push({
                type: 'kudaThug',
                sprite: SPRITES.gangMember,
                name: 'Kuda Henveiru Thug',
                x: 300 + Math.random() * 400,
                y: 200 + Math.random() * 300,
                health: 35,
                maxHealth: 35,
                speed: 1.2,
                direction: Math.random() * Math.PI * 2,
                state: 'patrol',
                attackCooldown: 0,
                hitFlash: 0
            });
        }
    } else if (map.gangTerritory === 'Mal√© Sharks') {
        // Sharks are neutral until player makes choice
        for (let i = 0; i < 3; i++) {
            currentNPCs.push({
                type: 'sharkMember',
                sprite: 'ü¶à',
                name: 'Mal√© Shark',
                x: 400 + Math.random() * 200,
                y: 300 + Math.random() * 200,
                direction: Math.random() * Math.PI * 2,
                speed: 0.3,
                dialogue: ACT2_DIALOGUES?.shark_first_meeting
            });
        }
    } else if (map.gangTerritory === 'Masodi') {
        for (let i = 0; i < 6; i++) {
            currentEnemies.push({
                type: 'masodiEnforcer',
                sprite: 'üòà',
                name: 'Masodi Enforcer',
                x: 350 + Math.random() * 300,
                y: 250 + Math.random() * 250,
                health: 40,
                maxHealth: 40,
                speed: 1.3,
                direction: Math.random() * Math.PI * 2,
                state: 'patrol',
                attackCooldown: 0,
                hitFlash: 0
            });
        }
    }
    
    // Spawn civilians
    for (let i = 0; i < 6; i++) {
        currentNPCs.push({
            type: 'civilian',
            sprite: SPRITES.npc,
            x: Math.random() * (map.width - 4) * TILE_SIZE + 2 * TILE_SIZE,
            y: Math.random() * (map.height - 4) * TILE_SIZE + 2 * TILE_SIZE,
            direction: Math.random() * Math.PI * 2,
            speed: 0.4
        });
    }
    
    // Spawn items
    for (let i = 0; i < 8; i++) {
        currentItems.push({
            type: Math.random() < 0.6 ? 'money' : 'health',
            x: (5 + Math.random() * (map.width - 10)) * TILE_SIZE,
            y: (5 + Math.random() * (map.height - 10)) * TILE_SIZE,
            value: Math.floor(Math.random() * 40) + 15
        });
    }
    
    // Spawn special NPCs based on mission
    if (GameState.currentMission >= 2 && !GameState.flags.rippooSecretRevealed) {
        // Rippoo at tea shop
        const teaShop = map.zones?.rippooTeaShop;
        if (teaShop) {
            currentNPCs.push({
                type: 'rippoo',
                sprite: SPRITES.rippoo,
                name: 'Rippoo (Mother)',
                x: (teaShop.x + teaShop.w / 2) * TILE_SIZE,
                y: (teaShop.y + teaShop.h / 2) * TILE_SIZE,
                direction: 0,
                speed: 0,
                dialogue: ACT2_DIALOGUES?.rippoo_secret_reveal
            });
        }
    }
}

// Travel between maps
function travelToMap(mapKey) {
    if (!MAPS[mapKey]) {
        showNotification('Error', 'Map not found');
        return;
    }
    
    // Fade out effect
    showNotification('Traveling...', MAPS[mapKey].name);
    
    setTimeout(() => {
        GameState.world.currentMap = mapKey;
        const map = MAPS[mapKey];
        
        // Generate tiles if needed
        if (!map.tiles || map.tiles.length === 0) {
            generateMapTiles(mapKey);
        }
        
        // Set player position
        GameState.player.x = map.spawnX * TILE_SIZE;
        GameState.player.y = map.spawnY * TILE_SIZE;
        
        // Reset camera
        Camera.x = GameState.player.x - CANVAS_WIDTH / 2;
        Camera.y = GameState.player.y - CANVAS_HEIGHT / 2;
        
        // Spawn appropriate NPCs
        if (GameState.currentAct === 2) {
            spawnAct2NPCs();
        } else {
            spawnNPCs();
        }
        
        // Update mission objective if travel was required
        updateMissionObjective('travel', mapKey, true);
        
        showNotification('Arrived', map.name);
    }, 1000);
}

// Heist planning mini-game
let heistPlanningActive = false;
let currentHeist = null;

function startHeistPlanning(heistId) {
    if (typeof HEIST_PLANS === 'undefined' || !HEIST_PLANS[heistId]) {
        showNotification('Error', 'Heist not found');
        return;
    }
    
    heistPlanningActive = true;
    currentHeist = HEIST_PLANS[heistId];
    GameState.isInMinigame = true;
    
    // Show heist planning UI
    document.getElementById('minigame-overlay').classList.remove('hidden');
    document.getElementById('minigame-title').textContent = `üéØ ${currentHeist.name} - Planning`;
    
    renderHeistPlanning();
}

function renderHeistPlanning() {
    const ctx = minigameCtx;
    const width = minigameCanvas.width;
    const height = minigameCanvas.height;
    
    // Clear
    ctx.fillStyle = '#1a1a2e';
    ctx.fillRect(0, 0, width, height);
    
    // Title
    ctx.fillStyle = '#ffcc00';
    ctx.font = 'bold 18px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('Choose Your Approach', width / 2, 30);
    
    // Draw approach options
    const approaches = currentHeist.approaches;
    const optionHeight = 80;
    const startY = 60;
    
    approaches.forEach((approach, index) => {
        const y = startY + index * (optionHeight + 10);
        
        // Background
        ctx.fillStyle = '#2a2a4e';
        ctx.fillRect(20, y, width - 40, optionHeight);
        
        // Border
        ctx.strokeStyle = '#778da9';
        ctx.lineWidth = 2;
        ctx.strokeRect(20, y, width - 40, optionHeight);
        
        // Name
        ctx.fillStyle = '#fff';
        ctx.font = 'bold 14px Arial';
        ctx.textAlign = 'left';
        ctx.fillText(approach.name, 30, y + 20);
        
        // Description
        ctx.fillStyle = '#aaa';
        ctx.font = '11px Arial';
        ctx.fillText(approach.description, 30, y + 38);
        
        // Requirements
        ctx.fillStyle = '#ffcc00';
        ctx.font = '10px Arial';
        let reqText = 'Requires: ';
        for (let req in approach.requirements) {
            reqText += `${req}: ${approach.requirements[req]} `;
        }
        ctx.fillText(reqText, 30, y + 55);
        
        // Rewards
        ctx.fillStyle = '#00ff00';
        ctx.fillText(`Reward: ${approach.rewards.money} faisaa`, 30, y + 70);
        
        // Click handler
        minigameCanvas.onclick = (e) => {
            const rect = minigameCanvas.getBoundingClientRect();
            const clickY = e.clientY - rect.top;
            
            approaches.forEach((app, idx) => {
                const appY = startY + idx * (optionHeight + 10);
                if (clickY >= appY && clickY <= appY + optionHeight) {
                    selectHeistApproach(idx);
                }
            });
        };
    });
    
    // Instructions
    ctx.fillStyle = '#778da9';
    ctx.font = '12px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('Click an approach to select', width / 2, height - 20);
}

function selectHeistApproach(index) {
    const approach = currentHeist.approaches[index];
    
    // Check requirements
    let canProceed = true;
    for (let req in approach.requirements) {
        if (req === 'money' && GameState.player.money < approach.requirements[req]) {
            canProceed = false;
            showNotification('Not Enough Faisaa', `Need ${approach.requirements[req]} faisaa`);
        } else if (req !== 'money' && GameState.player.skills[req] < approach.requirements[req]) {
            canProceed = false;
            showNotification('Skill Too Low', `Need ${req} level ${approach.requirements[req]}`);
        }
    }
    
    if (!canProceed) return;
    
    // Deduct money if required
    if (approach.requirements.money) {
        GameState.player.money -= approach.requirements.money;
    }
    
    // Calculate success based on risks
    let success = true;
    for (let risk in approach.risks) {
        if (Math.random() < approach.risks[risk]) {
            success = false;
            break;
        }
    }
    
    // End heist planning
    heistPlanningActive = false;
    currentHeist = null;
    GameState.isInMinigame = false;
    document.getElementById('minigame-overlay').classList.add('hidden');
    minigameCanvas.onclick = null;
    
    if (success) {
        GameState.player.money += approach.rewards.money;
        GameState.player.karma += approach.rewards.karma;
        showNotification('Heist Successful!', `+${approach.rewards.money} faisaa`);
        updateMissionObjective('steal', 'shipment', true);
    } else {
        showNotification('Heist Failed!', 'You were detected!');
        GameState.world.heat = Math.min(5, GameState.world.heat + 2);
        // Spawn enemies
        for (let i = 0; i < 3; i++) {
            currentEnemies.push({
                type: 'guard',
                sprite: 'üëÆüèæ',
                name: 'Security Guard',
                x: GameState.player.x + (Math.random() - 0.5) * 200,
                y: GameState.player.y + (Math.random() - 0.5) * 200,
                health: 25,
                maxHealth: 25,
                speed: 1.5,
                direction: 0,
                state: 'chase',
                attackCooldown: 0,
                hitFlash: 0
            });
        }
    }
}

// Charisma mini-game for recruitment
let charismaGameActive = false;
let charismaTarget = null;
let charismaWords = [];
let charismaInput = '';
let charismaScore = 0;
let charismaTimer = 30;

const CHARISMA_PHRASES = [
    { word: 'FAISAA', meaning: 'Money - promise rewards' },
    { word: 'DHIMAA', meaning: 'Blood - appeal to loyalty' },
    { word: 'FAMILY', meaning: 'Family - emotional appeal' },
    { word: 'POWER', meaning: 'Power - promise influence' },
    { word: 'RESPECT', meaning: 'Respect - appeal to honor' },
    { word: 'REVENGE', meaning: 'Revenge - appeal to anger' }
];

function startCharismaGame(target) {
    charismaGameActive = true;
    charismaTarget = target;
    charismaWords = [...CHARISMA_PHRASES].sort(() => Math.random() - 0.5).slice(0, 4);
    charismaInput = '';
    charismaScore = 0;
    charismaTimer = 30;
    GameState.isInMinigame = true;
    
    document.getElementById('minigame-overlay').classList.remove('hidden');
    document.getElementById('minigame-title').textContent = 'üó£Ô∏è Persuasion';
    
    // Start timer
    const timerInterval = setInterval(() => {
        charismaTimer--;
        if (charismaTimer <= 0 || !charismaGameActive) {
            clearInterval(timerInterval);
            if (charismaGameActive) endCharismaGame();
        }
    }, 1000);
    
    document.addEventListener('keydown', charismaKeyHandler);
    requestAnimationFrame(charismaLoop);
}

function charismaKeyHandler(e) {
    if (!charismaGameActive) return;
    
    if (e.key === 'Backspace') {
        charismaInput = charismaInput.slice(0, -1);
    } else if (e.key === 'Enter') {
        checkCharismaWord();
    } else if (e.key.length === 1 && /[a-zA-Z]/.test(e.key)) {
        charismaInput += e.key.toUpperCase();
    }
}

function checkCharismaWord() {
    const matchedWord = charismaWords.find(w => w.word === charismaInput);
    if (matchedWord) {
        charismaScore += 25;
        charismaWords = charismaWords.filter(w => w !== matchedWord);
        
        // Add new word
        const remaining = CHARISMA_PHRASES.filter(p => !charismaWords.includes(p));
        if (remaining.length > 0) {
            charismaWords.push(remaining[Math.floor(Math.random() * remaining.length)]);
        }
    }
    charismaInput = '';
    
    if (charismaScore >= 100) {
        endCharismaGame();
    }
}

function charismaLoop() {
    if (!charismaGameActive) return;
    
    const ctx = minigameCtx;
    const width = minigameCanvas.width;
    const height = minigameCanvas.height;
    
    // Clear
    ctx.fillStyle = '#1a1a2e';
    ctx.fillRect(0, 0, width, height);
    
    // Timer
    ctx.fillStyle = charismaTimer > 10 ? '#fff' : '#ff0000';
    ctx.font = 'bold 16px Arial';
    ctx.textAlign = 'right';
    ctx.fillText(`Time: ${charismaTimer}s`, width - 20, 25);
    
    // Score
    ctx.fillStyle = '#00ff00';
    ctx.textAlign = 'left';
    ctx.fillText(`Score: ${charismaScore}/100`, 20, 25);
    
    // Words to type
    ctx.fillStyle = '#ffcc00';
    ctx.font = '14px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('Type these words to persuade:', width / 2, 60);
    
    charismaWords.forEach((word, index) => {
        const y = 90 + index * 40;
        
        ctx.fillStyle = '#fff';
        ctx.font = 'bold 18px Arial';
        ctx.fillText(word.word, width / 2, y);
        
        ctx.fillStyle = '#778da9';
        ctx.font = '11px Arial';
        ctx.fillText(word.meaning, width / 2, y + 15);
    });
    
    // Input field
    ctx.fillStyle = '#333';
    ctx.fillRect(50, height - 60, width - 100, 40);
    ctx.strokeStyle = '#778da9';
    ctx.lineWidth = 2;
    ctx.strokeRect(50, height - 60, width - 100, 40);
    
    ctx.fillStyle = '#fff';
    ctx.font = '20px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(charismaInput + '_', width / 2, height - 32);
    
    requestAnimationFrame(charismaLoop);
}

function endCharismaGame() {
    charismaGameActive = false;
    GameState.isInMinigame = false;
    document.removeEventListener('keydown', charismaKeyHandler);
    document.getElementById('minigame-overlay').classList.add('hidden');
    
    if (charismaScore >= 100) {
        showNotification('Recruitment Success!', `${charismaTarget} joined your crew!`);
        updateMissionObjective('recruit', 'gangMember', 1);
    } else {
        showNotification('Recruitment Failed', 'They weren\'t convinced...');
    }
}

// Override completeMission to handle act transitions
const originalCompleteMission = completeMission;
completeMission = function(mission) {
    // Call original function
    originalCompleteMission(mission);
    
    // Check for act transition
    if (mission.actEnd && mission.unlocks && mission.unlocks.includes('act2_start')) {
        setTimeout(() => {
            startAct2();
        }, 3000);
    } else if (mission.actEnd && mission.unlocks && mission.unlocks.includes('act3_start')) {
        setTimeout(() => {
            showNotification('Act 2 Complete!', 'Mal√© Core Wars');
            setTimeout(() => {
                showNotification('To Be Continued...', 'Act 3: Synthetic Surge coming soon!');
            }, 2000);
        }, 3000);
    }
};

// Update render function for new tile types
const originalRenderMap = renderMap;
renderMap = function() {
    const map = MAPS[GameState.world.currentMap];
    
    // Calculate visible tiles
    const startX = Math.floor(Camera.x / TILE_SIZE);
    const startY = Math.floor(Camera.y / TILE_SIZE);
    const endX = Math.ceil((Camera.x + CANVAS_WIDTH) / TILE_SIZE);
    const endY = Math.ceil((Camera.y + CANVAS_HEIGHT) / TILE_SIZE);
    
    for (let y = startY; y <= endY && y < map.height; y++) {
        for (let x = startX; x <= endX && x < map.width; x++) {
            if (y < 0 || x < 0) continue;
            
            const tile = map.tiles[y][x];
            let color;
            
            switch (tile) {
                case 0: color = '#0066aa'; break; // Water
                case 1: color = '#8B7355'; break; // Ground
                case 2: color = '#555555'; break; // Road
                case 3: color = '#4a4a4a'; break; // Building
                case 4: color = '#6B8E23'; break; // Market/Zone
                case 5: color = '#8B4513'; break; // Dock
                case 6: color = '#228B22'; break; // Park
                case 7: color = '#DAA520'; break; // Religious
                case 8: color = '#8B0000'; break; // Gang territory
                default: color = '#8B7355';
            }
            
            ctx.fillStyle = color;
            ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            
            // Add texture
            if (tile === 1 || tile === 4 || tile === 6) {
                ctx.fillStyle = 'rgba(0,0,0,0.1)';
                if ((x + y) % 2 === 0) {
                    ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                }
            }
            
            // Water animation
            if (tile === 0) {
                ctx.fillStyle = `rgba(255,255,255,${0.1 + Math.sin(frameCount * 0.05 + x + y) * 0.05})`;
                ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            }
            
            // Gang territory pulsing
            if (tile === 8) {
                ctx.fillStyle = `rgba(255,0,0,${0.1 + Math.sin(frameCount * 0.08) * 0.1})`;
                ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            }
        }
    }
};

// Load Act 2 content on game start
const originalInit = init;
init = function() {
    originalInit();
    
    // Load Act 2 content after a short delay
    setTimeout(() => {
        loadAct2Content();
    }, 100);
};

// Update loadAct function to handle Act 2
const originalLoadAct = loadAct;
loadAct = function(actNum) {
    if (actNum === 2) {
        document.getElementById('main-menu').classList.add('hidden');
        document.getElementById('hud').classList.remove('hidden');
        document.getElementById('touch-controls').classList.remove('hidden');
        document.getElementById('mission-tracker').classList.remove('hidden');
        document.getElementById('radio-display').classList.remove('hidden');
        
        GameState.isPlaying = true;
        GameState.isPaused = false;
        
        startAct2();
        requestAnimationFrame(gameLoop);
    } else {
        originalLoadAct(actNum);
    }
};

// Add debug commands for Act 2
window.DEBUG.startAct2 = startAct2;
window.DEBUG.travelTo = travelToMap;
window.DEBUG.startHeist = () => startHeistPlanning('portHeist');
window.DEBUG.startCharisma = () => startCharismaGame('Street Kid');

console.log('Act 2 integration loaded');


// ============================================
// ACT 3 INTEGRATION
// ============================================

function loadAct3Content() {
    if (typeof ACT3_MAPS !== 'undefined') {
        // Add Act 3 maps
        for (let mapKey in ACT3_MAPS) {
            MAPS[mapKey] = ACT3_MAPS[mapKey];
            generateMapTiles(mapKey);
        }
        
        // Add Act 3 dialogues
        if (typeof ACT3_DIALOGUES !== 'undefined') {
            for (let dialogueKey in ACT3_DIALOGUES) {
                DIALOGUES[dialogueKey] = ACT3_DIALOGUES[dialogueKey];
            }
        }
        
        // Add Act 3 missions
        if (typeof ACT3_MISSIONS !== 'undefined') {
            MISSIONS.act3 = ACT3_MISSIONS;
        }
        
        // Add Act 3 side missions
        if (typeof ACT3_SIDE_MISSIONS !== 'undefined') {
            SIDE_MISSIONS.act3 = ACT3_SIDE_MISSIONS;
        }
        
        console.log('Act 3 content loaded successfully');
    }
}

// Generate Hulhumal√© grid layout
function generateHulhumaleMap(mapKey) {
    const map = MAPS[mapKey];
    if (!map || !map.gridLayout) return;
    
    map.tiles = [];
    
    for (let y = 0; y < map.height; y++) {
        map.tiles[y] = [];
        for (let x = 0; x < map.width; x++) {
            let tile = 1; // Default ground
            
            // Water borders (beach on south)
            if (x === 0 || y === 0 || x === map.width - 1) {
                tile = 0;
            }
            // Beach at bottom
            else if (y >= map.height - 5) {
                tile = 9; // Sand
            }
            // Grid roads (Hulhumal√© has regular grid)
            else if (x % 6 === 0 || y % 6 === 0) {
                tile = 2; // Road
            }
            // Apartment blocks
            else if ((x % 6 === 2 || x % 6 === 3) && (y % 6 === 2 || y % 6 === 3)) {
                tile = 10; // Modern building
            }
            // Parks
            else if (Math.random() < 0.05) {
                tile = 6; // Park
            }
            
            map.tiles[y][x] = tile;
        }
    }
    
    // Add zones
    for (let zoneKey in map.zones) {
        const zone = map.zones[zoneKey];
        let tileType = 4;
        
        if (zoneKey.includes('Lab') || zoneKey.includes('lab')) tileType = 11; // Lab
        else if (zoneKey.includes('construction') || zoneKey.includes('Construction')) tileType = 12; // Construction
        else if (zoneKey.includes('beach') || zoneKey.includes('Beach')) tileType = 9; // Beach
        else if (zoneKey.includes('ferry') || zoneKey.includes('Ferry')) tileType = 5; // Dock
        else if (zoneKey.includes('airport') || zoneKey.includes('Airport')) tileType = 13; // Airport
        else if (zoneKey.includes('luxury') || zoneKey.includes('Luxury')) tileType = 14; // Luxury
        
        for (let y = zone.y; y < zone.y + zone.h && y < map.height; y++) {
            for (let x = zone.x; x < zone.x + zone.w && x < map.width; x++) {
                if (y >= 0 && x >= 0 && y < map.height && x < map.width) {
                    map.tiles[y][x] = tileType;
                }
            }
        }
    }
}

// Start Act 3
function startAct3() {
    GameState.currentAct = 3;
    GameState.currentMission = 0;
    GameState.world.currentMap = 'hulhumale_phase1';
    
    // Load Act 3 content
    loadAct3Content();
    
    // Generate Hulhumal√© maps
    generateHulhumaleMap('hulhumale_phase1');
    generateHulhumaleMap('hulhumale_phase2');
    
    // Set player position
    const map = MAPS[GameState.world.currentMap];
    GameState.player.x = map.spawnX * TILE_SIZE;
    GameState.player.y = map.spawnY * TILE_SIZE;
    
    // Spawn NPCs
    spawnAct3NPCs();
    
    // Update radio
    if (typeof ACT3_RADIO !== 'undefined') {
        RADIO_CONTENT.raajjeFM.segments = ACT3_RADIO.raajjeFM.segments;
        RADIO_CONTENT.undergroundFM.segments = ACT3_RADIO.undergroundFM.segments;
    }
    
    showNotification('Act 3', 'Synthetic Surge');
    
    // Start first mission
    if (MISSIONS.act3 && MISSIONS.act3.length > 0) {
        setTimeout(() => {
            startMission(MISSIONS.act3[0]);
        }, 2000);
    }
    
    saveGame();
}

// Spawn NPCs for Act 3
function spawnAct3NPCs() {
    currentNPCs = [];
    currentItems = [];
    currentEnemies = [];
    
    const map = MAPS[GameState.world.currentMap];
    
    // Spawn construction workers
    for (let i = 0; i < 8; i++) {
        currentNPCs.push({
            type: 'worker',
            sprite: 'üë∑üèæ',
            name: 'Construction Worker',
            x: Math.random() * (map.width - 4) * TILE_SIZE + 2 * TILE_SIZE,
            y: Math.random() * (map.height - 10) * TILE_SIZE + 2 * TILE_SIZE,
            direction: Math.random() * Math.PI * 2,
            speed: 0.3
        });
    }
    
    // Spawn tourists on beach
    for (let i = 0; i < 4; i++) {
        currentNPCs.push({
            type: 'tourist',
            sprite: 'üèñÔ∏è',
            name: 'Tourist',
            x: Math.random() * (map.width - 10) * TILE_SIZE + 5 * TILE_SIZE,
            y: (map.height - 3) * TILE_SIZE,
            direction: Math.random() * Math.PI * 2,
            speed: 0.2
        });
    }
    
    // Spawn gang members based on territory
    if (map.gangTerritory === 'Synthetic Syndicate') {
        for (let i = 0; i < 5; i++) {
            currentEnemies.push({
                type: 'syndicateThug',
                sprite: 'üß™',
                name: 'Syndicate Enforcer',
                x: 300 + Math.random() * 400,
                y: 200 + Math.random() * 300,
                health: 45,
                maxHealth: 45,
                speed: 1.3,
                direction: Math.random() * Math.PI * 2,
                state: 'patrol',
                attackCooldown: 0,
                hitFlash: 0
            });
        }
    }
    
    // Spawn items
    for (let i = 0; i < 10; i++) {
        currentItems.push({
            type: Math.random() < 0.5 ? 'money' : (Math.random() < 0.5 ? 'health' : 'chemical'),
            x: (5 + Math.random() * (map.width - 10)) * TILE_SIZE,
            y: (5 + Math.random() * (map.height - 15)) * TILE_SIZE,
            value: Math.floor(Math.random() * 50) + 20
        });
    }
    
    // Special NPCs
    if (GameState.world.currentMap === 'velana_airport') {
        // DhoDho
        const dhodhoZone = map.zones?.dhodhoOffice;
        if (dhodhoZone) {
            currentNPCs.push({
                type: 'dhodho',
                sprite: 'üë®üèæ‚Äç‚úàÔ∏è',
                name: 'DhoDho (Uncle)',
                x: (dhodhoZone.x + dhodhoZone.w / 2) * TILE_SIZE,
                y: (dhodhoZone.y + dhodhoZone.h / 2) * TILE_SIZE,
                direction: 0,
                speed: 0,
                dialogue: ACT3_DIALOGUES?.dhodho_first_meeting
            });
        }
    }
}

// Extended tile rendering for Act 3
const originalRenderMapAct3 = renderMap;
renderMap = function() {
    const map = MAPS[GameState.world.currentMap];
    
    const startX = Math.floor(Camera.x / TILE_SIZE);
    const startY = Math.floor(Camera.y / TILE_SIZE);
    const endX = Math.ceil((Camera.x + CANVAS_WIDTH) / TILE_SIZE);
    const endY = Math.ceil((Camera.y + CANVAS_HEIGHT) / TILE_SIZE);
    
    for (let y = startY; y <= endY && y < map.height; y++) {
        for (let x = startX; x <= endX && x < map.width; x++) {
            if (y < 0 || x < 0) continue;
            
            const tile = map.tiles[y]?.[x] ?? 1;
            let color;
            
            switch (tile) {
                case 0: color = '#0066aa'; break; // Water
                case 1: color = '#8B7355'; break; // Ground
                case 2: color = '#555555'; break; // Road
                case 3: color = '#4a4a4a'; break; // Building
                case 4: color = '#6B8E23'; break; // Zone
                case 5: color = '#8B4513'; break; // Dock
                case 6: color = '#228B22'; break; // Park
                case 7: color = '#DAA520'; break; // Religious
                case 8: color = '#8B0000'; break; // Gang territory
                case 9: color = '#F4D03F'; break; // Sand/Beach
                case 10: color = '#708090'; break; // Modern building
                case 11: color = '#9B59B6'; break; // Lab (purple)
                case 12: color = '#E67E22'; break; // Construction (orange)
                case 13: color = '#34495E'; break; // Airport
                case 14: color = '#2ECC71'; break; // Luxury
                default: color = '#8B7355';
            }
            
            ctx.fillStyle = color;
            ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            
            // Texture effects
            if (tile === 9) { // Sand sparkle
                ctx.fillStyle = `rgba(255,255,255,${0.1 + Math.sin(frameCount * 0.1 + x * y) * 0.05})`;
                ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            }
            
            if (tile === 11) { // Lab glow
                ctx.fillStyle = `rgba(155,89,182,${0.2 + Math.sin(frameCount * 0.15) * 0.1})`;
                ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            }
            
            if (tile === 12) { // Construction animation
                if (Math.random() < 0.01) {
                    ctx.fillStyle = '#fff';
                    ctx.fillRect(x * TILE_SIZE + Math.random() * TILE_SIZE, y * TILE_SIZE, 2, 2);
                }
            }
            
            // Water animation
            if (tile === 0) {
                ctx.fillStyle = `rgba(255,255,255,${0.1 + Math.sin(frameCount * 0.05 + x + y) * 0.05})`;
                ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            }
        }
    }
};

// Update loadAct function for Act 3
const originalLoadActAct3 = loadAct;
loadAct = function(actNum) {
    if (actNum === 3) {
        document.getElementById('main-menu').classList.add('hidden');
        document.getElementById('hud').classList.remove('hidden');
        document.getElementById('touch-controls').classList.remove('hidden');
        document.getElementById('mission-tracker').classList.remove('hidden');
        document.getElementById('radio-display').classList.remove('hidden');
        
        GameState.isPlaying = true;
        GameState.isPaused = false;
        
        startAct3();
        requestAnimationFrame(gameLoop);
    } else {
        originalLoadActAct3(actNum);
    }
};

// Update completeMission for Act 3 transitions
const originalCompleteMissionAct3 = completeMission;
completeMission = function(mission) {
    originalCompleteMissionAct3(mission);
    
    if (mission.unlocks && mission.unlocks.includes('act4_start')) {
        setTimeout(() => {
            showNotification('Act 3 Complete!', 'Synthetic Surge');
            // Will transition to Act 4 when built
        }, 3000);
    }
};

// Debug commands for Act 3
window.DEBUG.startAct3 = startAct3;
window.DEBUG.startCrypto = () => startCryptoGame(10000);
window.DEBUG.startCooking = startDrugCookingGame;

// Load Act 3 content on init
setTimeout(() => {
    loadAct3Content();
}, 200);

console.log('Act 3 integration loaded');


// ============================================
// ACT 4 INTEGRATION
// ============================================

function loadAct4Content() {
    if (typeof ACT4_MAPS !== 'undefined') {
        for (let mapKey in ACT4_MAPS) {
            MAPS[mapKey] = ACT4_MAPS[mapKey];
            generatePoliticalMapTiles(mapKey);
        }
        
        if (typeof ACT4_DIALOGUES !== 'undefined') {
            for (let dialogueKey in ACT4_DIALOGUES) {
                DIALOGUES[dialogueKey] = ACT4_DIALOGUES[dialogueKey];
            }
        }
        
        if (typeof ACT4_MISSIONS !== 'undefined') {
            MISSIONS.act4 = ACT4_MISSIONS;
        }
        
        if (typeof ACT4_SIDE_MISSIONS !== 'undefined') {
            SIDE_MISSIONS.act4 = ACT4_SIDE_MISSIONS;
        }
        
        console.log('Act 4 content loaded successfully');
    }
}

// Generate political district map tiles
function generatePoliticalMapTiles(mapKey) {
    const map = MAPS[mapKey];
    if (!map || map.tiles.length > 0) return;
    
    map.tiles = [];
    
    for (let y = 0; y < map.height; y++) {
        map.tiles[y] = [];
        for (let x = 0; x < map.width; x++) {
            let tile = 1; // Default ground
            
            // Water borders
            if (x === 0 || y === 0 || x === map.width - 1 || y === map.height - 1) {
                tile = 0;
            }
            // Main roads
            else if (x % 10 === 0 || y % 10 === 0) {
                tile = 2;
            }
            // Secondary roads
            else if (x % 5 === 0 || y % 5 === 0) {
                tile = 15; // Paved walkway
            }
            // Government buildings
            else if (Math.random() < 0.08) {
                tile = 16; // Government building
            }
            
            map.tiles[y][x] = tile;
        }
    }
    
    // Add zones with special tiles
    for (let zoneKey in map.zones) {
        const zone = map.zones[zoneKey];
        let tileType = 16;
        
        if (zoneKey.includes('parliament') || zoneKey.includes('Parliament') || zoneKey.includes('Majlis')) tileType = 17;
        else if (zoneKey.includes('palace') || zoneKey.includes('Palace') || zoneKey.includes('Muliaage')) tileType = 18;
        else if (zoneKey.includes('court') || zoneKey.includes('Court')) tileType = 19;
        else if (zoneKey.includes('police') || zoneKey.includes('Police')) tileType = 20;
        else if (zoneKey.includes('square') || zoneKey.includes('Square')) tileType = 21;
        else if (zoneKey.includes('cell') || zoneKey.includes('Cell') || zoneKey.includes('prison')) tileType = 22;
        else if (zoneKey.includes('yard') || zoneKey.includes('Yard')) tileType = 23;
        else if (zoneKey.includes('protest') || zoneKey.includes('Protest')) tileType = 24;
        
        for (let y = zone.y; y < zone.y + zone.h && y < map.height; y++) {
            for (let x = zone.x; x < zone.x + zone.w && x < map.width; x++) {
                if (y >= 0 && x >= 0 && y < map.height && x < map.width) {
                    map.tiles[y][x] = tileType;
                }
            }
        }
    }
}

// Start Act 4
function startAct4() {
    GameState.currentAct = 4;
    GameState.currentMission = 0;
    GameState.world.currentMap = 'parliament_district';
    
    loadAct4Content();
    
    const map = MAPS[GameState.world.currentMap];
    GameState.player.x = map.spawnX * TILE_SIZE;
    GameState.player.y = map.spawnY * TILE_SIZE;
    
    spawnAct4NPCs();
    
    if (typeof ACT4_RADIO !== 'undefined') {
        RADIO_CONTENT.raajjeFM.segments = ACT4_RADIO.raajjeFM.segments;
        RADIO_CONTENT.undergroundFM.segments = ACT4_RADIO.undergroundFM.segments;
    }
    
    showNotification('Act 4', 'Parliament Plague');
    
    if (MISSIONS.act4 && MISSIONS.act4.length > 0) {
        setTimeout(() => {
            startMission(MISSIONS.act4[0]);
        }, 2000);
    }
    
    saveGame();
}

// Spawn NPCs for Act 4
function spawnAct4NPCs() {
    currentNPCs = [];
    currentItems = [];
    currentEnemies = [];
    
    const map = MAPS[GameState.world.currentMap];
    
    // Politicians
    for (let i = 0; i < 5; i++) {
        currentNPCs.push({
            type: 'politician',
            sprite: 'ü§µüèæ',
            name: 'MP',
            x: Math.random() * (map.width - 4) * TILE_SIZE + 2 * TILE_SIZE,
            y: Math.random() * (map.height - 4) * TILE_SIZE + 2 * TILE_SIZE,
            direction: Math.random() * Math.PI * 2,
            speed: 0.2
        });
    }
    
    // Security guards
    for (let i = 0; i < 6; i++) {
        currentEnemies.push({
            type: 'securityGuard',
            sprite: 'üëÆüèæ',
            name: 'Security Guard',
            x: 200 + Math.random() * 400,
            y: 150 + Math.random() * 300,
            health: 40,
            maxHealth: 40,
            speed: 1.2,
            direction: Math.random() * Math.PI * 2,
            state: 'patrol',
            attackCooldown: 0,
            hitFlash: 0
        });
    }
    
    // Protesters (neutral)
    for (let i = 0; i < 8; i++) {
        currentNPCs.push({
            type: 'protester',
            sprite: 'üì¢',
            name: 'Protester',
            x: Math.random() * (map.width - 4) * TILE_SIZE + 2 * TILE_SIZE,
            y: Math.random() * (map.height - 4) * TILE_SIZE + 2 * TILE_SIZE,
            direction: Math.random() * Math.PI * 2,
            speed: 0.3
        });
    }
    
    // Journalists
    for (let i = 0; i < 3; i++) {
        currentNPCs.push({
            type: 'journalist',
            sprite: 'üì∞',
            name: 'Journalist',
            x: Math.random() * (map.width - 4) * TILE_SIZE + 2 * TILE_SIZE,
            y: Math.random() * (map.height - 4) * TILE_SIZE + 2 * TILE_SIZE,
            direction: Math.random() * Math.PI * 2,
            speed: 0.4
        });
    }
    
    // Items
    for (let i = 0; i < 8; i++) {
        currentItems.push({
            type: Math.random() < 0.4 ? 'money' : (Math.random() < 0.5 ? 'health' : 'document'),
            x: (5 + Math.random() * (map.width - 10)) * TILE_SIZE,
            y: (5 + Math.random() * (map.height - 10)) * TILE_SIZE,
            value: Math.floor(Math.random() * 60) + 25
        });
    }
    
    // Special NPCs
    const alibeZone = map.zones?.alibeOffice;
    if (alibeZone) {
        currentNPCs.push({
            type: 'alibe',
            sprite: 'üó≥Ô∏è',
            name: 'Alibe (Opposition Leader)',
            x: (alibeZone.x + alibeZone.w / 2) * TILE_SIZE,
            y: (alibeZone.y + alibeZone.h / 2) * TILE_SIZE,
            direction: 0,
            speed: 0,
            dialogue: ACT4_DIALOGUES?.alibe_first_meeting
        });
    }
}

// Extended tile rendering for Act 4
const originalRenderMapAct4 = renderMap;
renderMap = function() {
    const map = MAPS[GameState.world.currentMap];
    
    const startX = Math.floor(Camera.x / TILE_SIZE);
    const startY = Math.floor(Camera.y / TILE_SIZE);
    const endX = Math.ceil((Camera.x + CANVAS_WIDTH) / TILE_SIZE);
    const endY = Math.ceil((Camera.y + CANVAS_HEIGHT) / TILE_SIZE);
    
    for (let y = startY; y <= endY && y < map.height; y++) {
        for (let x = startX; x <= endX && x < map.width; x++) {
            if (y < 0 || x < 0) continue;
            
            const tile = map.tiles[y]?.[x] ?? 1;
            let color;
            
            switch (tile) {
                case 0: color = '#0066aa'; break; // Water
                case 1: color = '#8B7355'; break; // Ground
                case 2: color = '#555555'; break; // Road
                case 3: color = '#4a4a4a'; break; // Building
                case 4: color = '#6B8E23'; break; // Zone
                case 5: color = '#8B4513'; break; // Dock
                case 6: color = '#228B22'; break; // Park
                case 7: color = '#DAA520'; break; // Religious
                case 8: color = '#8B0000'; break; // Gang territory
                case 9: color = '#F4D03F'; break; // Sand
                case 10: color = '#708090'; break; // Modern building
                case 11: color = '#9B59B6'; break; // Lab
                case 12: color = '#E67E22'; break; // Construction
                case 13: color = '#34495E'; break; // Airport
                case 14: color = '#2ECC71'; break; // Luxury
                case 15: color = '#7F8C8D'; break; // Paved walkway
                case 16: color = '#5D6D7E'; break; // Government building
                case 17: color = '#1ABC9C'; break; // Parliament (teal)
                case 18: color = '#E74C3C'; break; // Presidential Palace (red)
                case 19: color = '#9B59B6'; break; // Supreme Court (purple)
                case 20: color = '#3498DB'; break; // Police HQ (blue)
                case 21: color = '#F39C12'; break; // Republic Square (gold)
                case 22: color = '#2C3E50'; break; // Prison cell (dark)
                case 23: color = '#95A5A6'; break; // Prison yard (gray)
                case 24: color = '#E74C3C'; break; // Protest zone (red)
                default: color = '#8B7355';
            }
            
            ctx.fillStyle = color;
            ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            
            // Special effects
            if (tile === 17) { // Parliament glow
                ctx.fillStyle = `rgba(26,188,156,${0.15 + Math.sin(frameCount * 0.05) * 0.1})`;
                ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            }
            
            if (tile === 18) { // Palace shimmer
                ctx.fillStyle = `rgba(231,76,60,${0.1 + Math.sin(frameCount * 0.08) * 0.05})`;
                ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            }
            
            if (tile === 24) { // Protest zone pulse
                ctx.fillStyle = `rgba(255,0,0,${0.2 + Math.sin(frameCount * 0.1) * 0.15})`;
                ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            }
            
            if (tile === 22) { // Prison darkness
                ctx.fillStyle = 'rgba(0,0,0,0.3)';
                ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            }
            
            // Water animation
            if (tile === 0) {
                ctx.fillStyle = `rgba(255,255,255,${0.1 + Math.sin(frameCount * 0.05 + x + y) * 0.05})`;
                ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            }
        }
    }
};

// Flashback mode
let isFlashbackMode = false;

function startFlashback(year) {
    isFlashbackMode = true;
    
    // Apply sepia filter effect
    const overlay = document.createElement('div');
    overlay.id = 'flashback-overlay';
    overlay.style.cssText = `
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(112, 66, 20, 0.3);
        pointer-events: none;
        z-index: 45;
    `;
    document.getElementById('game-container').appendChild(overlay);
    
    showNotification(`Flashback: ${year}`, 'Memory sequence...');
}

function endFlashback() {
    isFlashbackMode = false;
    const overlay = document.getElementById('flashback-overlay');
    if (overlay) overlay.remove();
}

// Update loadAct function for Act 4
const originalLoadActAct4 = loadAct;
loadAct = function(actNum) {
    if (actNum === 4) {
        document.getElementById('main-menu').classList.add('hidden');
        document.getElementById('hud').classList.remove('hidden');
        document.getElementById('touch-controls').classList.remove('hidden');
        document.getElementById('mission-tracker').classList.remove('hidden');
        document.getElementById('radio-display').classList.remove('hidden');
        
        GameState.isPlaying = true;
        GameState.isPaused = false;
        
        startAct4();
        requestAnimationFrame(gameLoop);
    } else {
        originalLoadActAct4(actNum);
    }
};

// Debug commands for Act 4
window.DEBUG.startAct4 = startAct4;
window.DEBUG.startSpeech = () => startSpeechGame('democracy');
window.DEBUG.flashback = () => startFlashback(2012);

// Load Act 4 content
setTimeout(() => {
    loadAct4Content();
}, 300);

console.log('Act 4 integration loaded');


// ============================================
// ACT 5 INTEGRATION
// ============================================

function loadAct5Content() {
    if (typeof ACT5_MAPS !== 'undefined') {
        for (let mapKey in ACT5_MAPS) {
            MAPS[mapKey] = ACT5_MAPS[mapKey];
            generatePrisonMapTiles(mapKey);
        }
        
        if (typeof ACT5_DIALOGUES !== 'undefined') {
            for (let dialogueKey in ACT5_DIALOGUES) {
                DIALOGUES[dialogueKey] = ACT5_DIALOGUES[dialogueKey];
            }
        }
        
        if (typeof ACT5_MISSIONS !== 'undefined') {
            MISSIONS.act5 = ACT5_MISSIONS;
        }
        
        if (typeof ACT5_SIDE_MISSIONS !== 'undefined') {
            SIDE_MISSIONS.act5 = ACT5_SIDE_MISSIONS;
        }
        
        console.log('Act 5 content loaded successfully');
    }
}

// Generate prison map tiles
function generatePrisonMapTiles(mapKey) {
    const map = MAPS[mapKey];
    if (!map || map.tiles.length > 0) return;
    
    map.tiles = [];
    
    for (let y = 0; y < map.height; y++) {
        map.tiles[y] = [];
        for (let x = 0; x < map.width; x++) {
            let tile = 25; // Prison floor
            
            // Walls
            if (x === 0 || y === 0 || x === map.width - 1 || y === map.height - 1) {
                tile = 26; // Prison wall
            }
            // Corridors
            else if (x % 8 === 0 || y % 8 === 0) {
                tile = 27; // Corridor
            }
            // Cell bars
            else if (Math.random() < 0.05) {
                tile = 28; // Bars
            }
            
            map.tiles[y][x] = tile;
        }
    }
    
    // Add zones with special tiles
    for (let zoneKey in map.zones) {
        const zone = map.zones[zoneKey];
        let tileType = 25;
        
        if (zoneKey.includes('cell') || zoneKey.includes('Cell')) tileType = 29;
        else if (zoneKey.includes('mess') || zoneKey.includes('Mess')) tileType = 30;
        else if (zoneKey.includes('yard') || zoneKey.includes('Yard')) tileType = 31;
        else if (zoneKey.includes('solitary') || zoneKey.includes('Solitary')) tileType = 32;
        else if (zoneKey.includes('warden') || zoneKey.includes('Warden')) tileType = 33;
        else if (zoneKey.includes('infirmary') || zoneKey.includes('Infirmary')) tileType = 34;
        else if (zoneKey.includes('tunnel') || zoneKey.includes('Tunnel')) tileType = 35;
        else if (zoneKey.includes('underwater') || zoneKey.includes('Underwater')) tileType = 0;
        else if (zoneKey.includes('exit') || zoneKey.includes('Exit') || zoneKey.includes('Freedom')) tileType = 36;
        
        for (let y = zone.y; y < zone.y + zone.h && y < map.height; y++) {
            for (let x = zone.x; x < zone.x + zone.w && x < map.width; x++) {
                if (y >= 0 && x >= 0 && y < map.height && x < map.width) {
                    map.tiles[y][x] = tileType;
                }
            }
        }
    }
}

// Start Act 5
function startAct5() {
    GameState.currentAct = 5;
    GameState.currentMission = 0;
    GameState.world.currentMap = 'dhoonidhoo_interior';
    
    loadAct5Content();
    
    const map = MAPS[GameState.world.currentMap];
    GameState.player.x = map.spawnX * TILE_SIZE;
    GameState.player.y = map.spawnY * TILE_SIZE;
    
    spawnAct5NPCs();
    
    if (typeof ACT5_RADIO !== 'undefined') {
        RADIO_CONTENT.raajjeFM.segments = ACT5_RADIO.raajjeFM.segments;
        RADIO_CONTENT.undergroundFM.segments = ACT5_RADIO.undergroundFM.segments;
    }
    
    showNotification('Act 5', 'Prison & Redemption');
    
    if (MISSIONS.act5 && MISSIONS.act5.length > 0) {
        setTimeout(() => {
            startMission(MISSIONS.act5[0]);
        }, 2000);
    }
    
    saveGame();
}

// Spawn NPCs for Act 5
function spawnAct5NPCs() {
    currentNPCs = [];
    currentItems = [];
    currentEnemies = [];
    
    const map = MAPS[GameState.world.currentMap];
    
    // Prison guards (enemies)
    for (let i = 0; i < 8; i++) {
        currentEnemies.push({
            type: 'prisonGuard',
            sprite: 'üëÆüèæ',
            name: 'Prison Guard',
            x: Math.random() * (map.width - 4) * TILE_SIZE + 2 * TILE_SIZE,
            y: Math.random() * (map.height - 4) * TILE_SIZE + 2 * TILE_SIZE,
            health: 50,
            maxHealth: 50,
            speed: 1.0,
            direction: Math.random() * Math.PI * 2,
            state: 'patrol',
            attackCooldown: 0,
            hitFlash: 0
        });
    }
    
    // Inmates (neutral/friendly)
    for (let i = 0; i < 12; i++) {
        currentNPCs.push({
            type: 'inmate',
            sprite: 'üë§',
            name: 'Inmate',
            x: Math.random() * (map.width - 4) * TILE_SIZE + 2 * TILE_SIZE,
            y: Math.random() * (map.height - 4) * TILE_SIZE + 2 * TILE_SIZE,
            direction: Math.random() * Math.PI * 2,
            speed: 0.3
        });
    }
    
    // Gang inmates (potential enemies)
    for (let i = 0; i < 5; i++) {
        currentEnemies.push({
            type: 'gangInmate',
            sprite: 'üí™üèæ',
            name: 'Gang Member',
            x: Math.random() * (map.width - 4) * TILE_SIZE + 2 * TILE_SIZE,
            y: Math.random() * (map.height - 4) * TILE_SIZE + 2 * TILE_SIZE,
            health: 35,
            maxHealth: 35,
            speed: 0.8,
            direction: Math.random() * Math.PI * 2,
            state: 'idle',
            attackCooldown: 0,
            hitFlash: 0
        });
    }
    
    // Special NPCs
    const muazZone = map.zones?.muazCell;
    if (muazZone) {
        currentNPCs.push({
            type: 'muaz',
            sprite: 'üë§',
            name: 'Muaz (Half-Brother)',
            x: (muazZone.x + muazZone.w / 2) * TILE_SIZE,
            y: (muazZone.y + muazZone.h / 2) * TILE_SIZE,
            direction: 0,
            speed: 0,
            dialogue: ACT5_DIALOGUES?.muaz_first_meeting,
            isSpecial: true
        });
    }
    
    const wardenZone = map.zones?.wardenOffice;
    if (wardenZone) {
        currentNPCs.push({
            type: 'warden',
            sprite: 'üëî',
            name: 'Warden Rasheed',
            x: (wardenZone.x + wardenZone.w / 2) * TILE_SIZE,
            y: (wardenZone.y + wardenZone.h / 2) * TILE_SIZE,
            direction: 0,
            speed: 0,
            dialogue: ACT5_DIALOGUES?.warden_intimidation,
            isSpecial: true
        });
    }
    
    const yardZone = map.zones?.exerciseYard;
    if (yardZone) {
        currentNPCs.push({
            type: 'bigIsmail',
            sprite: 'üí™üèæ',
            name: 'Big Ismail',
            x: (yardZone.x + yardZone.w / 2) * TILE_SIZE,
            y: (yardZone.y + yardZone.h / 2) * TILE_SIZE,
            direction: 0,
            speed: 0,
            dialogue: ACT5_DIALOGUES?.ismail_alliance_offer,
            isSpecial: true
        });
        
        currentNPCs.push({
            type: 'oldHussain',
            sprite: 'üë¥üèæ',
            name: 'Old Man Hussain',
            x: (yardZone.x + 2) * TILE_SIZE,
            y: (yardZone.y + 2) * TILE_SIZE,
            direction: 0,
            speed: 0,
            dialogue: ACT5_DIALOGUES?.hussain_father_truth,
            isSpecial: true
        });
    }
    
    // Contraband items
    for (let i = 0; i < 5; i++) {
        currentItems.push({
            type: Math.random() < 0.3 ? 'contraband' : (Math.random() < 0.5 ? 'health' : 'money'),
            x: (5 + Math.random() * (map.width - 10)) * TILE_SIZE,
            y: (5 + Math.random() * (map.height - 10)) * TILE_SIZE,
            value: Math.floor(Math.random() * 30) + 10
        });
    }
}

// Extended tile rendering for Act 5
const originalRenderMapAct5 = renderMap;
renderMap = function() {
    const map = MAPS[GameState.world.currentMap];
    
    const startX = Math.floor(Camera.x / TILE_SIZE);
    const startY = Math.floor(Camera.y / TILE_SIZE);
    const endX = Math.ceil((Camera.x + CANVAS_WIDTH) / TILE_SIZE);
    const endY = Math.ceil((Camera.y + CANVAS_HEIGHT) / TILE_SIZE);
    
    for (let y = startY; y <= endY && y < map.height; y++) {
        for (let x = startX; x <= endX && x < map.width; x++) {
            if (y < 0 || x < 0) continue;
            
            const tile = map.tiles[y]?.[x] ?? 1;
            let color;
            
            switch (tile) {
                case 0: color = '#0066aa'; break; // Water
                case 1: color = '#8B7355'; break; // Ground
                case 2: color = '#555555'; break; // Road
                // ... previous tiles ...
                case 25: color = '#3d3d3d'; break; // Prison floor
                case 26: color = '#1a1a1a'; break; // Prison wall
                case 27: color = '#4a4a4a'; break; // Corridor
                case 28: color = '#2c2c2c'; break; // Bars
                case 29: color = '#2a2a2a'; break; // Cell
                case 30: color = '#4a3a2a'; break; // Mess hall
                case 31: color = '#5a5a4a'; break; // Exercise yard
                case 32: color = '#1a0a0a'; break; // Solitary (dark red)
                case 33: color = '#4a4a5a'; break; // Warden office
                case 34: color = '#5a6a5a'; break; // Infirmary (green tint)
                case 35: color = '#2a2a1a'; break; // Tunnel
                case 36: color = '#6a8a6a'; break; // Exit/Freedom
                default: color = '#8B7355';
            }
            
            ctx.fillStyle = color;
            ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            
            // Prison atmosphere effects
            if (map.isPrison) {
                // Dim lighting
                ctx.fillStyle = 'rgba(0,0,0,0.2)';
                ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            }
            
            if (map.isDark) {
                // Very dark tunnel
                ctx.fillStyle = 'rgba(0,0,0,0.5)';
                ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            }
            
            // Solitary confinement darkness
            if (tile === 32) {
                ctx.fillStyle = 'rgba(50,0,0,0.3)';
                ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            }
            
            // Exit glow
            if (tile === 36) {
                ctx.fillStyle = `rgba(100,200,100,${0.2 + Math.sin(frameCount * 0.1) * 0.1})`;
                ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            }
            
            // Water animation
            if (tile === 0) {
                ctx.fillStyle = `rgba(255,255,255,${0.1 + Math.sin(frameCount * 0.05 + x + y) * 0.05})`;
                ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            }
        }
    }
};

// Update loadAct function for Act 5
const originalLoadActAct5 = loadAct;
loadAct = function(actNum) {
    if (actNum === 5) {
        document.getElementById('main-menu').classList.add('hidden');
        document.getElementById('hud').classList.remove('hidden');
        document.getElementById('touch-controls').classList.remove('hidden');
        document.getElementById('mission-tracker').classList.remove('hidden');
        document.getElementById('radio-display').classList.remove('hidden');
        
        GameState.isPlaying = true;
        GameState.isPaused = false;
        
        startAct5();
        requestAnimationFrame(gameLoop);
    } else {
        originalLoadActAct5(actNum);
    }
};

// Debug commands for Act 5
window.DEBUG.startAct5 = startAct5;
window.DEBUG.startWorkout = () => startWorkoutGame();
window.DEBUG.startTunnel = () => startTunnelGame();

// Load Act 5 content
setTimeout(() => {
    loadAct5Content();
}, 400);

console.log('Act 5 integration loaded');


// ============================================
// ACT 6 INTEGRATION
// ============================================

function loadAct6Content() {
    if (typeof ACT6_MAPS !== 'undefined') {
        for (let mapKey in ACT6_MAPS) {
            MAPS[mapKey] = ACT6_MAPS[mapKey];
            generateSouthernMapTiles(mapKey);
        }
        
        if (typeof ACT6_DIALOGUES !== 'undefined') {
            for (let dialogueKey in ACT6_DIALOGUES) {
                DIALOGUES[dialogueKey] = ACT6_DIALOGUES[dialogueKey];
            }
        }
        
        if (typeof ACT6_MISSIONS !== 'undefined') {
            MISSIONS.act6 = ACT6_MISSIONS;
        }
        
        if (typeof ACT6_SIDE_MISSIONS !== 'undefined') {
            SIDE_MISSIONS.act6 = ACT6_SIDE_MISSIONS;
        }
        
        console.log('Act 6 content loaded successfully');
    }
}

// Generate southern island map tiles
function generateSouthernMapTiles(mapKey) {
    const map = MAPS[mapKey];
    if (!map || map.tiles.length > 0) return;
    
    map.tiles = [];
    
    for (let y = 0; y < map.height; y++) {
        map.tiles[y] = [];
        for (let x = 0; x < map.width; x++) {
            let tile = 1; // Default ground
            
            // Water borders (islands)
            if (x < 3 || y < 3 || x > map.width - 4 || y > map.height - 4) {
                tile = 0; // Ocean
            }
            // Beach edges
            else if (x < 5 || y < 5 || x > map.width - 6 || y > map.height - 6) {
                tile = 9; // Sand/beach
            }
            // Roads
            else if (x % 12 === 0 || y % 12 === 0) {
                tile = 2; // Road
            }
            // Vegetation
            else if (Math.random() < 0.15) {
                tile = 6; // Palm trees/vegetation
            }
            
            map.tiles[y][x] = tile;
        }
    }
    
    // Add zones with special tiles
    for (let zoneKey in map.zones) {
        const zone = map.zones[zoneKey];
        let tileType = 1;
        
        if (zoneKey.includes('harbor') || zoneKey.includes('Harbor')) tileType = 37;
        else if (zoneKey.includes('market') || zoneKey.includes('Market')) tileType = 38;
        else if (zoneKey.includes('mosque') || zoneKey.includes('Mosque')) tileType = 7;
        else if (zoneKey.includes('beach') || zoneKey.includes('Beach')) tileType = 9;
        else if (zoneKey.includes('airport') || zoneKey.includes('Airport')) tileType = 13;
        else if (zoneKey.includes('resort') || zoneKey.includes('Resort')) tileType = 14;
        else if (zoneKey.includes('gang') || zoneKey.includes('Gang')) tileType = 8;
        else if (zoneKey.includes('causeway') || zoneKey.includes('Causeway') || zoneKey.includes('link') || zoneKey.includes('Link')) tileType = 39;
        else if (zoneKey.includes('ruins') || zoneKey.includes('Ruins')) tileType = 40;
        else if (zoneKey.includes('village') || zoneKey.includes('Village')) tileType = 41;
        else if (zoneKey.includes('sea') || zoneKey.includes('Sea')) tileType = 0;
        else if (zoneKey.includes('shark') || zoneKey.includes('Shark')) tileType = 42;
        else if (zoneKey.includes('smuggler') || zoneKey.includes('Smuggler')) tileType = 43;
        
        for (let y = zone.y; y < zone.y + zone.h && y < map.height; y++) {
            for (let x = zone.x; x < zone.x + zone.w && x < map.width; x++) {
                if (y >= 0 && x >= 0 && y < map.height && x < map.width) {
                    map.tiles[y][x] = tileType;
                }
            }
        }
    }
}

// Start Act 6
function startAct6() {
    GameState.currentAct = 6;
    GameState.currentMission = 0;
    GameState.world.currentMap = 'addu_hithadhoo';
    
    loadAct6Content();
    
    const map = MAPS[GameState.world.currentMap];
    GameState.player.x = map.spawnX * TILE_SIZE;
    GameState.player.y = map.spawnY * TILE_SIZE;
    
    spawnAct6NPCs();
    
    if (typeof ACT6_RADIO !== 'undefined') {
        RADIO_CONTENT.raajjeFM.segments = ACT6_RADIO.raajjeFM.segments;
        if (ACT6_RADIO.adduFM) {
            RADIO_CONTENT.adduFM = ACT6_RADIO.adduFM;
        }
    }
    
    showNotification('Act 6', 'Southern Empire');
    
    if (MISSIONS.act6 && MISSIONS.act6.length > 0) {
        setTimeout(() => {
            startMission(MISSIONS.act6[0]);
        }, 2000);
    }
    
    saveGame();
}

// Spawn NPCs for Act 6
function spawnAct6NPCs() {
    currentNPCs = [];
    currentItems = [];
    currentEnemies = [];
    
    const map = MAPS[GameState.world.currentMap];
    
    // Fishermen
    for (let i = 0; i < 6; i++) {
        currentNPCs.push({
            type: 'fisherman',
            sprite: 'üé£',
            name: 'Fisherman',
            x: Math.random() * (map.width - 6) * TILE_SIZE + 3 * TILE_SIZE,
            y: Math.random() * (map.height - 6) * TILE_SIZE + 3 * TILE_SIZE,
            direction: Math.random() * Math.PI * 2,
            speed: 0.2
        });
    }
    
    // Local villagers
    for (let i = 0; i < 8; i++) {
        currentNPCs.push({
            type: 'villager',
            sprite: 'üë§',
            name: 'Villager',
            x: Math.random() * (map.width - 6) * TILE_SIZE + 3 * TILE_SIZE,
            y: Math.random() * (map.height - 6) * TILE_SIZE + 3 * TILE_SIZE,
            direction: Math.random() * Math.PI * 2,
            speed: 0.3
        });
    }
    
    // Gang members (Kalo Oiy)
    for (let i = 0; i < 5; i++) {
        currentEnemies.push({
            type: 'kaloOiy',
            sprite: 'üêç',
            name: 'Kalo Oiy Member',
            x: Math.random() * (map.width - 6) * TILE_SIZE + 3 * TILE_SIZE,
            y: Math.random() * (map.height - 6) * TILE_SIZE + 3 * TILE_SIZE,
            health: 40,
            maxHealth: 40,
            speed: 1.0,
            direction: Math.random() * Math.PI * 2,
            state: 'patrol',
            attackCooldown: 0,
            hitFlash: 0
        });
    }
    
    // Special NPCs
    const gangZone = map.zones?.gangTerritory;
    if (gangZone) {
        currentNPCs.push({
            type: 'kudaManik',
            sprite: 'üêç',
            name: 'Kuda Manik',
            x: (gangZone.x + gangZone.w / 2) * TILE_SIZE,
            y: (gangZone.y + gangZone.h / 2) * TILE_SIZE,
            direction: 0,
            speed: 0,
            dialogue: ACT6_DIALOGUES?.kudamanik_introduction,
            isSpecial: true
        });
    }
    
    const harborZone = map.zones?.harbor;
    if (harborZone) {
        currentNPCs.push({
            type: 'muaz',
            sprite: 'üë§',
            name: 'Muaz',
            x: (harborZone.x + harborZone.w / 2) * TILE_SIZE,
            y: (harborZone.y + harborZone.h / 2) * TILE_SIZE,
            direction: 0,
            speed: 0,
            dialogue: ACT6_DIALOGUES?.muaz_addu_arrival,
            isSpecial: true
        });
    }
    
    // Items (fish, money, etc.)
    for (let i = 0; i < 10; i++) {
        currentItems.push({
            type: Math.random() < 0.3 ? 'fish' : (Math.random() < 0.5 ? 'money' : 'health'),
            x: (5 + Math.random() * (map.width - 10)) * TILE_SIZE,
            y: (5 + Math.random() * (map.height - 10)) * TILE_SIZE,
            value: Math.floor(Math.random() * 50) + 20
        });
    }
}

// Extended tile rendering for Act 6
const originalRenderMapAct6 = renderMap;
renderMap = function() {
    const map = MAPS[GameState.world.currentMap];
    
    const startX = Math.floor(Camera.x / TILE_SIZE);
    const startY = Math.floor(Camera.y / TILE_SIZE);
    const endX = Math.ceil((Camera.x + CANVAS_WIDTH) / TILE_SIZE);
    const endY = Math.ceil((Camera.y + CANVAS_HEIGHT) / TILE_SIZE);
    
    for (let y = startY; y <= endY && y < map.height; y++) {
        for (let x = startX; x <= endX && x < map.width; x++) {
            if (y < 0 || x < 0) continue;
            
            const tile = map.tiles[y]?.[x] ?? 1;
            let color;
            
            switch (tile) {
                case 0: color = '#006699'; break; // Ocean (deeper blue for south)
                case 1: color = '#8B7355'; break; // Ground
                case 2: color = '#555555'; break; // Road
                case 6: color = '#228B22'; break; // Vegetation
                case 7: color = '#DAA520'; break; // Mosque
                case 8: color = '#8B0000'; break; // Gang territory
                case 9: color = '#F4D03F'; break; // Beach/sand
                case 13: color = '#34495E'; break; // Airport
                case 14: color = '#2ECC71'; break; // Resort
                case 37: color = '#4a6a8a'; break; // Harbor
                case 38: color = '#8a6a4a'; break; // Market
                case 39: color = '#666666'; break; // Causeway
                case 40: color = '#5a5a5a'; break; // British ruins
                case 41: color = '#7a6a5a'; break; // Village
                case 42: color = '#004466'; break; // Shark point (dark water)
                case 43: color = '#3a3a3a'; break; // Smuggler cove
                default: color = '#8B7355';
            }
            
            ctx.fillStyle = color;
            ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            
            // Island atmosphere - brighter, tropical
            if (map.isAddu || map.isFuvahmulah) {
                // Slight tropical tint
                ctx.fillStyle = 'rgba(100,200,150,0.05)';
                ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            }
            
            // Water animation (more active for southern seas)
            if (tile === 0) {
                ctx.fillStyle = `rgba(255,255,255,${0.15 + Math.sin(frameCount * 0.08 + x + y) * 0.1})`;
                ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            }
            
            // Beach shimmer
            if (tile === 9) {
                ctx.fillStyle = `rgba(255,255,200,${0.1 + Math.sin(frameCount * 0.03 + x) * 0.05})`;
                ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            }
            
            // Gang territory pulse
            if (tile === 8) {
                ctx.fillStyle = `rgba(139,0,0,${0.2 + Math.sin(frameCount * 0.05) * 0.1})`;
                ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            }
            
            // Causeway highlight
            if (tile === 39) {
                ctx.fillStyle = 'rgba(255,255,255,0.1)';
                ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            }
        }
    }
};

// Update loadAct function for Act 6
const originalLoadActAct6 = loadAct;
loadAct = function(actNum) {
    if (actNum === 6) {
        document.getElementById('main-menu').classList.add('hidden');
        document.getElementById('hud').classList.remove('hidden');
        document.getElementById('touch-controls').classList.remove('hidden');
        document.getElementById('mission-tracker').classList.remove('hidden');
        document.getElementById('radio-display').classList.remove('hidden');
        
        GameState.isPlaying = true;
        GameState.isPaused = false;
        
        startAct6();
        requestAnimationFrame(gameLoop);
    } else {
        originalLoadActAct6(actNum);
    }
};

// Debug commands for Act 6
window.DEBUG.startAct6 = startAct6;
window.DEBUG.startDiving = () => startDivingGame();

// Load Act 6 content
setTimeout(() => {
    loadAct6Content();
}, 500);

console.log('Act 6 integration loaded');


// ============================================
// ACT 7 INTEGRATION
// ============================================

function loadAct7Content() {
    if (typeof ACT7_MAPS !== 'undefined') {
        for (let mapKey in ACT7_MAPS) {
            MAPS[mapKey] = ACT7_MAPS[mapKey];
            generateResortMapTiles(mapKey);
        }
        
        if (typeof ACT7_DIALOGUES !== 'undefined') {
            for (let dialogueKey in ACT7_DIALOGUES) {
                DIALOGUES[dialogueKey] = ACT7_DIALOGUES[dialogueKey];
            }
        }
        
        if (typeof ACT7_MISSIONS !== 'undefined') {
            MISSIONS.act7 = ACT7_MISSIONS;
        }
        
        if (typeof ACT7_SIDE_MISSIONS !== 'undefined') {
            SIDE_MISSIONS.act7 = ACT7_SIDE_MISSIONS;
        }
        
        console.log('Act 7 content loaded successfully');
    }
}

// Generate resort map tiles
function generateResortMapTiles(mapKey) {
    const map = MAPS[mapKey];
    if (!map || map.tiles.length > 0) return;
    
    map.tiles = [];
    
    for (let y = 0; y < map.height; y++) {
        map.tiles[y] = [];
        for (let x = 0; x < map.width; x++) {
            let tile = 0; // Default water (resort islands)
            
            // Island shape (elliptical)
            const centerX = map.width / 2;
            const centerY = map.height / 2;
            const dx = (x - centerX) / (map.width * 0.4);
            const dy = (y - centerY) / (map.height * 0.4);
            const dist = Math.sqrt(dx * dx + dy * dy);
            
            if (dist < 1) {
                // Inside island
                if (dist > 0.85) {
                    tile = 9; // Beach
                } else if (dist > 0.7) {
                    tile = 6; // Vegetation
                } else {
                    tile = 44; // Resort ground (luxury)
                }
            }
            
            // Paths
            if (dist < 0.8 && (x % 10 === 0 || y % 10 === 0)) {
                tile = 45; // Resort path
            }
            
            map.tiles[y][x] = tile;
        }
    }
    
    // Add zones with special tiles
    for (let zoneKey in map.zones) {
        const zone = map.zones[zoneKey];
        let tileType = 44;
        
        if (zoneKey.includes('jetty') || zoneKey.includes('Jetty') || zoneKey.includes('dock')) tileType = 46;
        else if (zoneKey.includes('reception') || zoneKey.includes('Reception') || zoneKey.includes('lobby')) tileType = 47;
        else if (zoneKey.includes('overwater') || zoneKey.includes('Overwater')) tileType = 48;
        else if (zoneKey.includes('beach') || zoneKey.includes('Beach')) tileType = 9;
        else if (zoneKey.includes('spa') || zoneKey.includes('Spa')) tileType = 49;
        else if (zoneKey.includes('restaurant') || zoneKey.includes('Restaurant') || zoneKey.includes('dining')) tileType = 50;
        else if (zoneKey.includes('diving') || zoneKey.includes('Diving')) tileType = 51;
        else if (zoneKey.includes('staff') || zoneKey.includes('Staff')) tileType = 52;
        else if (zoneKey.includes('vip') || zoneKey.includes('VIP') || zoneKey.includes('Presidential')) tileType = 53;
        else if (zoneKey.includes('pool') || zoneKey.includes('Pool')) tileType = 54;
        else if (zoneKey.includes('terminal') || zoneKey.includes('Terminal')) tileType = 13;
        else if (zoneKey.includes('hangar') || zoneKey.includes('Hangar')) tileType = 55;
        else if (zoneKey.includes('underwater') || zoneKey.includes('Underwater')) tileType = 0;
        else if (zoneKey.includes('shipwreck') || zoneKey.includes('Shipwreck')) tileType = 56;
        else if (zoneKey.includes('cave') || zoneKey.includes('Cave')) tileType = 57;
        
        for (let y = zone.y; y < zone.y + zone.h && y < map.height; y++) {
            for (let x = zone.x; x < zone.x + zone.w && x < map.width; x++) {
                if (y >= 0 && x >= 0 && y < map.height && x < map.width) {
                    map.tiles[y][x] = tileType;
                }
            }
        }
    }
}

// Start Act 7
function startAct7() {
    GameState.currentAct = 7;
    GameState.currentMission = 0;
    GameState.world.currentMap = 'reethi_rah';
    
    loadAct7Content();
    
    const map = MAPS[GameState.world.currentMap];
    GameState.player.x = map.spawnX * TILE_SIZE;
    GameState.player.y = map.spawnY * TILE_SIZE;
    
    spawnAct7NPCs();
    
    if (typeof ACT7_RADIO !== 'undefined') {
        RADIO_CONTENT.raajjeFM.segments = ACT7_RADIO.raajjeFM.segments;
        if (ACT7_RADIO.resortFM) {
            RADIO_CONTENT.resortFM = ACT7_RADIO.resortFM;
        }
    }
    
    showNotification('Act 7', 'Resort Wars');
    
    if (MISSIONS.act7 && MISSIONS.act7.length > 0) {
        setTimeout(() => {
            startMission(MISSIONS.act7[0]);
        }, 2000);
    }
    
    saveGame();
}

// Spawn NPCs for Act 7
function spawnAct7NPCs() {
    currentNPCs = [];
    currentItems = [];
    currentEnemies = [];
    
    const map = MAPS[GameState.world.currentMap];
    
    // Tourists
    for (let i = 0; i < 10; i++) {
        currentNPCs.push({
            type: 'tourist',
            sprite: ['üë®üèª', 'üë©üèº', 'üë®üèΩ', 'üë©üèæ', 'üßîüèª'][Math.floor(Math.random() * 5)],
            name: 'Tourist',
            x: Math.random() * (map.width - 10) * TILE_SIZE + 5 * TILE_SIZE,
            y: Math.random() * (map.height - 10) * TILE_SIZE + 5 * TILE_SIZE,
            direction: Math.random() * Math.PI * 2,
            speed: 0.2
        });
    }
    
    // Resort staff
    for (let i = 0; i < 6; i++) {
        currentNPCs.push({
            type: 'staff',
            sprite: 'üëî',
            name: 'Resort Staff',
            x: Math.random() * (map.width - 10) * TILE_SIZE + 5 * TILE_SIZE,
            y: Math.random() * (map.height - 10) * TILE_SIZE + 5 * TILE_SIZE,
            direction: Math.random() * Math.PI * 2,
            speed: 0.4
        });
    }
    
    // Security (potential enemies)
    for (let i = 0; i < 4; i++) {
        currentEnemies.push({
            type: 'security',
            sprite: 'üï¥Ô∏è',
            name: 'Security Guard',
            x: Math.random() * (map.width - 10) * TILE_SIZE + 5 * TILE_SIZE,
            y: Math.random() * (map.height - 10) * TILE_SIZE + 5 * TILE_SIZE,
            health: 45,
            maxHealth: 45,
            speed: 1.2,
            direction: Math.random() * Math.PI * 2,
            state: 'patrol',
            attackCooldown: 0,
            hitFlash: 0
        });
    }
    
    // Special NPCs
    const beachZone = map.zones?.beach;
    if (beachZone) {
        currentNPCs.push({
            type: 'rishbe',
            sprite: 'üì∏',
            name: 'Rishbe (Influencer)',
            x: (beachZone.x + beachZone.w / 2) * TILE_SIZE,
            y: (beachZone.y + beachZone.h / 2) * TILE_SIZE,
            direction: 0,
            speed: 0,
            dialogue: ACT7_DIALOGUES?.rishbe_first_meeting,
            isSpecial: true
        });
    }
    
    const staffZone = map.zones?.staffQuarters;
    if (staffZone) {
        currentNPCs.push({
            type: 'manager',
            sprite: 'üëî',
            name: 'Mr. Ahmed (Manager)',
            x: (staffZone.x + staffZone.w / 2) * TILE_SIZE,
            y: (staffZone.y + staffZone.h / 2) * TILE_SIZE,
            direction: 0,
            speed: 0,
            dialogue: ACT7_DIALOGUES?.manager_meeting,
            isSpecial: true
        });
    }
    
    const vipZone = map.zones?.vipVilla;
    if (vipZone) {
        currentNPCs.push({
            type: 'oligarch',
            sprite: 'üé∞',
            name: 'Viktor Petrov',
            x: (vipZone.x + vipZone.w / 2) * TILE_SIZE,
            y: (vipZone.y + vipZone.h / 2) * TILE_SIZE,
            direction: 0,
            speed: 0,
            dialogue: ACT7_DIALOGUES?.oligarch_meeting,
            isSpecial: true
        });
    }
    
    const divingZone = map.zones?.divingCenter;
    if (divingZone) {
        currentNPCs.push({
            type: 'diveMaster',
            sprite: 'ü§ø',
            name: 'Deep Hussain',
            x: (divingZone.x + divingZone.w / 2) * TILE_SIZE,
            y: (divingZone.y + divingZone.h / 2) * TILE_SIZE,
            direction: 0,
            speed: 0,
            dialogue: ACT7_DIALOGUES?.deep_dive_intro,
            isSpecial: true
        });
    }
    
    // Luxury items
    for (let i = 0; i < 8; i++) {
        currentItems.push({
            type: Math.random() < 0.3 ? 'jewelry' : (Math.random() < 0.5 ? 'money' : 'health'),
            x: (8 + Math.random() * (map.width - 16)) * TILE_SIZE,
            y: (8 + Math.random() * (map.height - 16)) * TILE_SIZE,
            value: Math.floor(Math.random() * 200) + 100
        });
    }
}

// Extended tile rendering for Act 7
const originalRenderMapAct7 = renderMap;
renderMap = function() {
    const map = MAPS[GameState.world.currentMap];
    
    const startX = Math.floor(Camera.x / TILE_SIZE);
    const startY = Math.floor(Camera.y / TILE_SIZE);
    const endX = Math.ceil((Camera.x + CANVAS_WIDTH) / TILE_SIZE);
    const endY = Math.ceil((Camera.y + CANVAS_HEIGHT) / TILE_SIZE);
    
    for (let y = startY; y <= endY && y < map.height; y++) {
        for (let x = startX; x <= endX && x < map.width; x++) {
            if (y < 0 || x < 0) continue;
            
            const tile = map.tiles[y]?.[x] ?? 0;
            let color;
            
            switch (tile) {
                case 0: color = '#0088bb'; break; // Crystal clear water
                case 6: color = '#228B22'; break; // Vegetation
                case 9: color = '#F5DEB3'; break; // White sand beach
                case 13: color = '#34495E'; break; // Terminal
                case 44: color = '#D4C4A8'; break; // Resort ground
                case 45: color = '#C9B896'; break; // Resort path
                case 46: color = '#8B7355'; break; // Jetty/dock
                case 47: color = '#E8DCC8'; break; // Reception
                case 48: color = '#87CEEB'; break; // Overwater (water with structure)
                case 49: color = '#DDA0DD'; break; // Spa (lavender)
                case 50: color = '#F4A460'; break; // Restaurant
                case 51: color = '#4682B4'; break; // Diving center
                case 52: color = '#A9A9A9'; break; // Staff quarters
                case 53: color = '#FFD700'; break; // VIP villa (gold)
                case 54: color = '#00CED1'; break; // Pool
                case 55: color = '#696969'; break; // Hangar
                case 56: color = '#2F4F4F'; break; // Shipwreck
                case 57: color = '#1a1a2e'; break; // Cave
                default: color = '#0088bb';
            }
            
            ctx.fillStyle = color;
            ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            
            // Resort luxury effects
            if (map.isResort) {
                // Slight golden tint for luxury
                if (tile >= 44 && tile <= 53) {
                    ctx.fillStyle = 'rgba(255,215,0,0.05)';
                    ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                }
            }
            
            // Water sparkle effect
            if (tile === 0 || tile === 48 || tile === 54) {
                const sparkle = Math.sin(frameCount * 0.1 + x * 0.5 + y * 0.3);
                if (sparkle > 0.8) {
                    ctx.fillStyle = 'rgba(255,255,255,0.3)';
                    ctx.fillRect(x * TILE_SIZE + 4, y * TILE_SIZE + 4, 4, 4);
                }
            }
            
            // VIP villa glow
            if (tile === 53) {
                ctx.fillStyle = `rgba(255,215,0,${0.1 + Math.sin(frameCount * 0.05) * 0.05})`;
                ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            }
            
            // Beach shimmer
            if (tile === 9) {
                ctx.fillStyle = `rgba(255,255,255,${0.1 + Math.sin(frameCount * 0.03 + x) * 0.05})`;
                ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            }
        }
    }
};

// Update loadAct function for Act 7
const originalLoadActAct7 = loadAct;
loadAct = function(actNum) {
    if (actNum === 7) {
        document.getElementById('main-menu').classList.add('hidden');
        document.getElementById('hud').classList.remove('hidden');
        document.getElementById('touch-controls').classList.remove('hidden');
        document.getElementById('mission-tracker').classList.remove('hidden');
        document.getElementById('radio-display').classList.remove('hidden');
        
        GameState.isPlaying = true;
        GameState.isPaused = false;
        
        startAct7();
        requestAnimationFrame(gameLoop);
    } else {
        originalLoadActAct7(actNum);
    }
};

// Debug commands for Act 7
window.DEBUG.startAct7 = startAct7;
window.DEBUG.startSeaplane = () => startSeaplaneGame();
window.DEBUG.startAdvancedDiving = () => startAdvancedDivingGame();

// Load Act 7 content
setTimeout(() => {
    loadAct7Content();
}, 600);

console.log('Act 7 integration loaded');


// ============================================
// ACT 8 INTEGRATION
// ============================================

function loadAct8Content() {
    if (typeof ACT8_MAPS !== 'undefined') {
        for (let mapKey in ACT8_MAPS) {
            MAPS[mapKey] = ACT8_MAPS[mapKey];
            generateInteriorMapTiles(mapKey);
        }
        
        if (typeof ACT8_DIALOGUES !== 'undefined') {
            for (let dialogueKey in ACT8_DIALOGUES) {
                DIALOGUES[dialogueKey] = ACT8_DIALOGUES[dialogueKey];
            }
        }
        
        if (typeof ACT8_MISSIONS !== 'undefined') {
            MISSIONS.act8 = ACT8_MISSIONS;
        }
        
        if (typeof ACT8_SIDE_MISSIONS !== 'undefined') {
            SIDE_MISSIONS.act8 = ACT8_SIDE_MISSIONS;
        }
        
        console.log('Act 8 content loaded successfully');
    }
}

// Generate interior map tiles
function generateInteriorMapTiles(mapKey) {
    const map = MAPS[mapKey];
    if (!map || map.tiles.length > 0) return;
    
    map.tiles = [];
    
    for (let y = 0; y < map.height; y++) {
        map.tiles[y] = [];
        for (let x = 0; x < map.width; x++) {
            let tile = 58; // Default interior floor
            
            // Walls
            if (x === 0 || y === 0 || x === map.width - 1 || y === map.height - 1) {
                tile = 59; // Interior wall
            }
            // Room dividers
            else if ((x % 15 === 0 || y % 12 === 0) && Math.random() < 0.7) {
                tile = 59; // Wall
            }
            
            map.tiles[y][x] = tile;
        }
    }
    
    // Add zones with special tiles
    for (let zoneKey in map.zones) {
        const zone = map.zones[zoneKey];
        let tileType = 58;
        
        if (zoneKey.includes('entrance') || zoneKey.includes('Entrance')) tileType = 60;
        else if (zoneKey.includes('living') || zoneKey.includes('Living') || zoneKey.includes('main') || zoneKey.includes('Main')) tileType = 61;
        else if (zoneKey.includes('kitchen') || zoneKey.includes('Kitchen')) tileType = 62;
        else if (zoneKey.includes('Room') || zoneKey.includes('room')) tileType = 63;
        else if (zoneKey.includes('secret') || zoneKey.includes('Secret') || zoneKey.includes('hidden') || zoneKey.includes('Hidden')) tileType = 64;
        else if (zoneKey.includes('backyard') || zoneKey.includes('Backyard')) tileType = 6;
        else if (zoneKey.includes('office') || zoneKey.includes('Office')) tileType = 65;
        else if (zoneKey.includes('newsroom') || zoneKey.includes('Newsroom')) tileType = 66;
        else if (zoneKey.includes('archive') || zoneKey.includes('Archive')) tileType = 67;
        else if (zoneKey.includes('rooftop') || zoneKey.includes('Rooftop') || zoneKey.includes('roof')) tileType = 68;
        else if (zoneKey.includes('grave') || zoneKey.includes('Grave') || zoneKey.includes('cemetery')) tileType = 69;
        else if (zoneKey.includes('edge') || zoneKey.includes('Edge')) tileType = 70;
        else if (zoneKey.includes('weapon') || zoneKey.includes('Weapon')) tileType = 71;
        else if (zoneKey.includes('dock') || zoneKey.includes('Dock') || zoneKey.includes('loading')) tileType = 72;
        
        for (let y = zone.y; y < zone.y + zone.h && y < map.height; y++) {
            for (let x = zone.x; x < zone.x + zone.w && x < map.width; x++) {
                if (y >= 0 && x >= 0 && y < map.height && x < map.width) {
                    map.tiles[y][x] = tileType;
                }
            }
        }
    }
}

// Start Act 8
function startAct8() {
    GameState.currentAct = 8;
    GameState.currentMission = 0;
    GameState.world.currentMap = 'ronda_home';
    
    loadAct8Content();
    
    const map = MAPS[GameState.world.currentMap];
    GameState.player.x = map.spawnX * TILE_SIZE;
    GameState.player.y = map.spawnY * TILE_SIZE;
    
    spawnAct8NPCs();
    
    if (typeof ACT8_RADIO !== 'undefined') {
        RADIO_CONTENT.raajjeFM.segments = ACT8_RADIO.raajjeFM.segments;
        if (ACT8_RADIO.undergroundFM) {
            RADIO_CONTENT.undergroundFM = ACT8_RADIO.undergroundFM;
        }
    }
    
    showNotification('Act 8', 'The Reckoning');
    
    if (MISSIONS.act8 && MISSIONS.act8.length > 0) {
        setTimeout(() => {
            startMission(MISSIONS.act8[0]);
        }, 2000);
    }
    
    saveGame();
}

// Spawn NPCs for Act 8
function spawnAct8NPCs() {
    currentNPCs = [];
    currentItems = [];
    currentEnemies = [];
    
    const map = MAPS[GameState.world.currentMap];
    
    // Family members
    const rippooZone = map.zones?.rippooRoom || map.zones?.livingRoom;
    if (rippooZone) {
        currentNPCs.push({
            type: 'rippoo',
            sprite: 'üëµüèæ',
            name: 'Rippoo (Mother)',
            x: (rippooZone.x + rippooZone.w / 2) * TILE_SIZE,
            y: (rippooZone.y + rippooZone.h / 2) * TILE_SIZE,
            direction: 0,
            speed: 0,
            dialogue: ACT8_DIALOGUES?.rippoo_final_truth,
            isSpecial: true,
            isFamily: true
        });
    }
    
    const nunnuZone = map.zones?.nunnuRoom;
    if (nunnuZone) {
        currentNPCs.push({
            type: 'nunnu',
            sprite: 'üë©üèæ',
            name: 'Nunnu (Sister)',
            x: (nunnuZone.x + nunnuZone.w / 2) * TILE_SIZE,
            y: (nunnuZone.y + nunnuZone.h / 2) * TILE_SIZE,
            direction: 0,
            speed: 0,
            dialogue: ACT8_DIALOGUES?.nunnu_danger_warning,
            isSpecial: true,
            isFamily: true
        });
    }
    
    // Items (family artifacts)
    currentItems.push({
        type: 'fatherPhoto',
        x: (map.width / 2) * TILE_SIZE,
        y: (map.height / 2) * TILE_SIZE,
        value: 0,
        isStoryItem: true
    });
    
    // Hidden items in secret areas
    const secretZone = map.zones?.secretBasement;
    if (secretZone) {
        currentItems.push({
            type: 'fatherFiles',
            x: (secretZone.x + secretZone.w / 2) * TILE_SIZE,
            y: (secretZone.y + secretZone.h / 2) * TILE_SIZE,
            value: 0,
            isStoryItem: true,
            isHidden: true
        });
    }
}

// Extended tile rendering for Act 8
const originalRenderMapAct8 = renderMap;
renderMap = function() {
    const map = MAPS[GameState.world.currentMap];
    
    const startX = Math.floor(Camera.x / TILE_SIZE);
    const startY = Math.floor(Camera.y / TILE_SIZE);
    const endX = Math.ceil((Camera.x + CANVAS_WIDTH) / TILE_SIZE);
    const endY = Math.ceil((Camera.y + CANVAS_HEIGHT) / TILE_SIZE);
    
    for (let y = startY; y <= endY && y < map.height; y++) {
        for (let x = startX; x <= endX && x < map.width; x++) {
            if (y < 0 || x < 0) continue;
            
            const tile = map.tiles[y]?.[x] ?? 58;
            let color;
            
            switch (tile) {
                case 0: color = '#0077aa'; break; // Water
                case 6: color = '#228B22'; break; // Vegetation/backyard
                case 58: color = '#8B7355'; break; // Interior floor
                case 59: color = '#4a4a4a'; break; // Interior wall
                case 60: color = '#6a5a4a'; break; // Entrance
                case 61: color = '#9a8a7a'; break; // Living room
                case 62: color = '#aaa090'; break; // Kitchen
                case 63: color = '#7a6a5a'; break; // Bedroom
                case 64: color = '#3a3a3a'; break; // Secret room (dark)
                case 65: color = '#5a5a6a'; break; // Office
                case 66: color = '#6a6a7a'; break; // Newsroom
                case 67: color = '#5a5a5a'; break; // Archive
                case 68: color = '#8a8a8a'; break; // Rooftop
                case 69: color = '#4a5a4a'; break; // Cemetery/grave
                case 70: color = '#aa4a4a'; break; // Danger edge (red tint)
                case 71: color = '#4a4a5a'; break; // Weapon cache
                case 72: color = '#6a6a6a'; break; // Loading dock
                default: color = '#8B7355';
            }
            
            ctx.fillStyle = color;
            ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            
            // Family home warmth
            if (map.isFamilyHome) {
                ctx.fillStyle = 'rgba(255,200,150,0.05)';
                ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            }
            
            // Cemetery atmosphere
            if (map.isCemetery) {
                ctx.fillStyle = 'rgba(100,100,120,0.1)';
                ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            }
            
            // Rooftop wind effect
            if (map.isRooftop) {
                const wind = Math.sin(frameCount * 0.02 + x * 0.1);
                ctx.fillStyle = `rgba(200,200,220,${0.05 + wind * 0.02})`;
                ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            }
            
            // Secret room darkness
            if (tile === 64) {
                ctx.fillStyle = 'rgba(0,0,0,0.3)';
                ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            }
            
            // Danger zone pulse
            if (tile === 70) {
                ctx.fillStyle = `rgba(255,0,0,${0.1 + Math.sin(frameCount * 0.1) * 0.05})`;
                ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            }
            
            // Grave markers
            if (tile === 69 && Math.random() < 0.02) {
                ctx.fillStyle = '#666';
                ctx.fillRect(x * TILE_SIZE + 4, y * TILE_SIZE + 2, 8, 12);
            }
        }
    }
};

// Update loadAct function for Act 8
const originalLoadActAct8 = loadAct;
loadAct = function(actNum) {
    if (actNum === 8) {
        document.getElementById('main-menu').classList.add('hidden');
        document.getElementById('hud').classList.remove('hidden');
        document.getElementById('touch-controls').classList.remove('hidden');
        document.getElementById('mission-tracker').classList.remove('hidden');
        document.getElementById('radio-display').classList.remove('hidden');
        
        GameState.isPlaying = true;
        GameState.isPaused = false;
        
        startAct8();
        requestAnimationFrame(gameLoop);
    } else {
        originalLoadActAct8(actNum);
    }
};

// Debug commands for Act 8
window.DEBUG.startAct8 = startAct8;

// Load Act 8 content
setTimeout(() => {
    loadAct8Content();
}, 700);

console.log('Act 8 integration loaded');


// ============================================
// ACT 9 INTEGRATION
// ============================================

function loadAct9Content() {
    if (typeof ACT9_MAPS !== 'undefined') {
        for (let mapKey in ACT9_MAPS) {
            MAPS[mapKey] = ACT9_MAPS[mapKey];
            generatePoliticalMapTiles(mapKey);
        }
        
        if (typeof ACT9_DIALOGUES !== 'undefined') {
            for (let dialogueKey in ACT9_DIALOGUES) {
                DIALOGUES[dialogueKey] = ACT9_DIALOGUES[dialogueKey];
            }
        }
        
        if (typeof ACT9_MISSIONS !== 'undefined') {
            MISSIONS.act9 = ACT9_MISSIONS;
        }
        
        if (typeof ACT9_SIDE_MISSIONS !== 'undefined') {
            SIDE_MISSIONS.act9 = ACT9_SIDE_MISSIONS;
        }
        
        console.log('Act 9 content loaded successfully');
    }
}

// Generate political/election map tiles
function generatePoliticalMapTiles(mapKey) {
    const map = MAPS[mapKey];
    if (!map || map.tiles.length > 0) return;
    
    map.tiles = [];
    
    for (let y = 0; y < map.height; y++) {
        map.tiles[y] = [];
        for (let x = 0; x < map.width; x++) {
            let tile = 73; // Default political floor
            
            // Walls
            if (x === 0 || y === 0 || x === map.width - 1 || y === map.height - 1) {
                tile = 74; // Political wall
            }
            
            // Rally ground is outdoor
            if (map.isRally || map.isOutdoor) {
                tile = 75; // Outdoor ground
            }
            
            map.tiles[y][x] = tile;
        }
    }
    
    // Add zones with special tiles
    for (let zoneKey in map.zones) {
        const zone = map.zones[zoneKey];
        let tileType = 73;
        
        if (zoneKey.includes('entrance') || zoneKey.includes('Entrance')) tileType = 76;
        else if (zoneKey.includes('stage') || zoneKey.includes('Stage')) tileType = 77;
        else if (zoneKey.includes('crowd') || zoneKey.includes('Crowd') || zoneKey.includes('audience')) tileType = 78;
        else if (zoneKey.includes('vip') || zoneKey.includes('VIP')) tileType = 79;
        else if (zoneKey.includes('media') || zoneKey.includes('Media') || zoneKey.includes('press')) tileType = 80;
        else if (zoneKey.includes('office') || zoneKey.includes('Office')) tileType = 81;
        else if (zoneKey.includes('war') || zoneKey.includes('War') || zoneKey.includes('control')) tileType = 82;
        else if (zoneKey.includes('studio') || zoneKey.includes('Studio')) tileType = 83;
        else if (zoneKey.includes('server') || zoneKey.includes('Server')) tileType = 84;
        else if (zoneKey.includes('voting') || zoneKey.includes('Voting') || zoneKey.includes('booth')) tileType = 85;
        else if (zoneKey.includes('counting') || zoneKey.includes('Counting')) tileType = 86;
        else if (zoneKey.includes('security') || zoneKey.includes('Security')) tileType = 87;
        else if (zoneKey.includes('backstage') || zoneKey.includes('Backstage')) tileType = 88;
        else if (zoneKey.includes('volunteer') || zoneKey.includes('Volunteer')) tileType = 89;
        else if (zoneKey.includes('screen') || zoneKey.includes('Screen')) tileType = 90;
        else if (zoneKey.includes('lounge') || zoneKey.includes('Lounge')) tileType = 91;
        
        for (let y = zone.y; y < zone.y + zone.h && y < map.height; y++) {
            for (let x = zone.x; x < zone.x + zone.w && x < map.width; x++) {
                if (y >= 0 && x >= 0 && y < map.height && x < map.width) {
                    map.tiles[y][x] = tileType;
                }
            }
        }
    }
}

// Start Act 9
function startAct9() {
    GameState.currentAct = 9;
    GameState.currentMission = 0;
    GameState.world.currentMap = 'campaign_hq_mooizbe';
    
    loadAct9Content();
    
    const map = MAPS[GameState.world.currentMap];
    GameState.player.x = map.spawnX * TILE_SIZE;
    GameState.player.y = map.spawnY * TILE_SIZE;
    
    spawnAct9NPCs();
    
    if (typeof ACT9_RADIO !== 'undefined') {
        RADIO_CONTENT.raajjeFM.segments = ACT9_RADIO.raajjeFM.segments;
        if (ACT9_RADIO.oppositionFM) {
            RADIO_CONTENT.oppositionFM = ACT9_RADIO.oppositionFM;
        }
    }
    
    showNotification('Act 9', 'Election Chaos');
    
    if (MISSIONS.act9 && MISSIONS.act9.length > 0) {
        setTimeout(() => {
            startMission(MISSIONS.act9[0]);
        }, 2000);
    }
    
    saveGame();
}

// Spawn NPCs for Act 9
function spawnAct9NPCs() {
    currentNPCs = [];
    currentItems = [];
    currentEnemies = [];
    
    const map = MAPS[GameState.world.currentMap];
    
    // Political staff
    for (let i = 0; i < 8; i++) {
        currentNPCs.push({
            type: 'campaignStaff',
            sprite: ['üëî', 'üë©üèæ‚Äçüíº', 'üßëüèæ‚Äçüíº'][Math.floor(Math.random() * 3)],
            name: 'Campaign Staff',
            x: Math.random() * (map.width - 10) * TILE_SIZE + 5 * TILE_SIZE,
            y: Math.random() * (map.height - 10) * TILE_SIZE + 5 * TILE_SIZE,
            direction: Math.random() * Math.PI * 2,
            speed: 0.3
        });
    }
    
    // Security
    for (let i = 0; i < 4; i++) {
        currentNPCs.push({
            type: 'security',
            sprite: 'üï¥Ô∏è',
            name: 'Security',
            x: Math.random() * (map.width - 10) * TILE_SIZE + 5 * TILE_SIZE,
            y: Math.random() * (map.height - 10) * TILE_SIZE + 5 * TILE_SIZE,
            direction: Math.random() * Math.PI * 2,
            speed: 0.4
        });
    }
    
    // Key characters
    const mooizbeZone = map.zones?.mooizbeOffice;
    if (mooizbeZone) {
        currentNPCs.push({
            type: 'mooizbe',
            sprite: 'üé©',
            name: 'President Mooizbe',
            x: (mooizbeZone.x + mooizbeZone.w / 2) * TILE_SIZE,
            y: (mooizbeZone.y + mooizbeZone.h / 2) * TILE_SIZE,
            direction: 0,
            speed: 0,
            dialogue: ACT9_DIALOGUES?.mooizbe_campaign_meeting,
            isSpecial: true,
            isPolitician: true
        });
    }
    
    const warRoomZone = map.zones?.warRoom;
    if (warRoomZone) {
        currentNPCs.push({
            type: 'fathimath',
            sprite: 'üë©üèæ‚Äçüíº',
            name: 'Fathimath (Campaign Manager)',
            x: (warRoomZone.x + warRoomZone.w / 2) * TILE_SIZE,
            y: (warRoomZone.y + warRoomZone.h / 2) * TILE_SIZE,
            direction: 0,
            speed: 0,
            dialogue: ACT9_DIALOGUES?.dirty_tricks_choice,
            isSpecial: true
        });
    }
    
    // Campaign items
    currentItems.push({
        type: 'campaignPoster',
        x: (map.width / 3) * TILE_SIZE,
        y: (map.height / 3) * TILE_SIZE,
        value: 100
    });
    
    currentItems.push({
        type: 'bribeMoney',
        x: (map.width * 2 / 3) * TILE_SIZE,
        y: (map.height / 3) * TILE_SIZE,
        value: 5000,
        isHidden: true
    });
}

// Debate mini-game
function startDebateGame() {
    if (typeof ACT9_DEBATE_MINIGAME === 'undefined') return;
    
    GameState.isPaused = true;
    
    const debateUI = document.createElement('div');
    debateUI.id = 'debate-game';
    debateUI.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        border: 3px solid #ffd700;
        border-radius: 15px;
        padding: 30px;
        z-index: 2000;
        min-width: 350px;
        max-width: 90vw;
        color: white;
        font-family: Arial, sans-serif;
    `;
    
    let currentRound = 0;
    let totalScore = 0;
    const debate = ACT9_DEBATE_MINIGAME;
    
    function showRound() {
        if (currentRound >= debate.topics.length) {
            endDebate();
            return;
        }
        
        const topic = debate.topics[currentRound];
        debateUI.innerHTML = `
            <h2 style="color: #ffd700; text-align: center; margin-bottom: 10px;">üé§ Presidential Debate</h2>
            <div style="text-align: center; margin-bottom: 15px;">
                Round ${currentRound + 1}/${debate.topics.length} | Score: ${totalScore}
            </div>
            <h3 style="color: #4ecdc4; margin-bottom: 10px;">Topic: ${topic.topic}</h3>
            <p style="margin-bottom: 20px; font-style: italic;">"${topic.question}"</p>
            <div id="debate-options"></div>
        `;
        
        const optionsDiv = debateUI.querySelector('#debate-options');
        topic.options.forEach((option, index) => {
            const btn = document.createElement('button');
            btn.textContent = option.text;
            btn.style.cssText = `
                display: block;
                width: 100%;
                padding: 12px;
                margin: 8px 0;
                background: #2d3436;
                color: white;
                border: 2px solid #636e72;
                border-radius: 8px;
                cursor: pointer;
                font-size: 14px;
                transition: all 0.2s;
            `;
            btn.onmouseover = () => btn.style.borderColor = '#ffd700';
            btn.onmouseout = () => btn.style.borderColor = '#636e72';
            btn.onclick = () => {
                totalScore += option.score;
                
                // Show feedback
                btn.style.background = option.score >= 2 ? '#27ae60' : (option.score >= 1 ? '#f39c12' : '#e74c3c');
                btn.style.borderColor = btn.style.background;
                
                // Karma effect
                if (option.type === 'reform') {
                    GameState.player.karma = Math.min(100, GameState.player.karma + 5);
                } else if (option.type === 'corrupt') {
                    GameState.player.karma = Math.max(-100, GameState.player.karma - 5);
                }
                
                setTimeout(() => {
                    currentRound++;
                    showRound();
                }, 1000);
            };
            optionsDiv.appendChild(btn);
        });
    }
    
    function endDebate() {
        const maxScore = debate.topics.length * 3;
        const percentage = Math.round((totalScore / maxScore) * 100);
        let result, reward;
        
        if (percentage >= 80) {
            result = "VICTORY! You dominated the debate!";
            reward = 10000;
        } else if (percentage >= 60) {
            result = "Good performance. Voters are impressed.";
            reward = 5000;
        } else if (percentage >= 40) {
            result = "Mixed results. The race remains close.";
            reward = 2000;
        } else {
            result = "Poor showing. Your opponents gained ground.";
            reward = 500;
        }
        
        debateUI.innerHTML = `
            <h2 style="color: #ffd700; text-align: center;">üé§ Debate Results</h2>
            <div style="text-align: center; font-size: 48px; margin: 20px 0;">${percentage}%</div>
            <p style="text-align: center; margin-bottom: 20px;">${result}</p>
            <p style="text-align: center; color: #4ecdc4;">+${reward} faisaa</p>
            <button id="debate-close" style="
                display: block;
                width: 100%;
                padding: 15px;
                margin-top: 20px;
                background: #ffd700;
                color: black;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-size: 16px;
                font-weight: bold;
            ">Continue</button>
        `;
        
        GameState.player.money += reward;
        
        debateUI.querySelector('#debate-close').onclick = () => {
            debateUI.remove();
            GameState.isPaused = false;
            showNotification('Debate Complete', `Score: ${percentage}%`);
        };
    }
    
    document.body.appendChild(debateUI);
    showRound();
}

// Extended tile rendering for Act 9
const originalRenderMapAct9 = renderMap;
renderMap = function() {
    const map = MAPS[GameState.world.currentMap];
    
    const startX = Math.floor(Camera.x / TILE_SIZE);
    const startY = Math.floor(Camera.y / TILE_SIZE);
    const endX = Math.ceil((Camera.x + CANVAS_WIDTH) / TILE_SIZE);
    const endY = Math.ceil((Camera.y + CANVAS_HEIGHT) / TILE_SIZE);
    
    for (let y = startY; y <= endY && y < map.height; y++) {
        for (let x = startX; x <= endX && x < map.width; x++) {
            if (y < 0 || x < 0) continue;
            
            const tile = map.tiles[y]?.[x] ?? 73;
            let color;
            
            switch (tile) {
                case 73: color = '#3a3a4a'; break; // Political floor
                case 74: color = '#2a2a3a'; break; // Political wall
                case 75: color = '#4a5a4a'; break; // Outdoor ground
                case 76: color = '#5a5a6a'; break; // Entrance
                case 77: color = '#8a6a4a'; break; // Stage (wood)
                case 78: color = '#4a4a5a'; break; // Crowd area
                case 79: color = '#6a5a7a'; break; // VIP section
                case 80: color = '#5a6a7a'; break; // Media area
                case 81: color = '#4a4a5a'; break; // Office
                case 82: color = '#3a4a5a'; break; // War room
                case 83: color = '#5a5a6a'; break; // Studio
                case 84: color = '#2a3a4a'; break; // Server room
                case 85: color = '#5a6a5a'; break; // Voting booths
                case 86: color = '#4a5a5a'; break; // Counting room
                case 87: color = '#4a4a4a'; break; // Security
                case 88: color = '#3a3a3a'; break; // Backstage
                case 89: color = '#5a5a5a'; break; // Volunteer area
                case 90: color = '#2a2a4a'; break; // Screen area
                case 91: color = '#5a4a5a'; break; // Lounge
                default: color = '#3a3a4a';
            }
            
            ctx.fillStyle = color;
            ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            
            // Political atmosphere
            if (map.isPolitical) {
                // Slight blue tint for political buildings
                ctx.fillStyle = 'rgba(50,50,100,0.05)';
                ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            }
            
            // Rally energy
            if (map.isRally) {
                const energy = Math.sin(frameCount * 0.05 + x * 0.2 + y * 0.2);
                if (energy > 0.7) {
                    ctx.fillStyle = 'rgba(255,215,0,0.1)';
                    ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                }
            }
            
            // Stage spotlight
            if (tile === 77) {
                ctx.fillStyle = `rgba(255,255,200,${0.1 + Math.sin(frameCount * 0.03) * 0.05})`;
                ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            }
            
            // Voting booth privacy
            if (tile === 85) {
                ctx.fillStyle = 'rgba(0,100,0,0.1)';
                ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            }
            
            // VIP glow
            if (tile === 79) {
                ctx.fillStyle = `rgba(150,100,200,${0.1 + Math.sin(frameCount * 0.04) * 0.05})`;
                ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            }
        }
    }
};

// Update loadAct function for Act 9
const originalLoadActAct9 = loadAct;
loadAct = function(actNum) {
    if (actNum === 9) {
        document.getElementById('main-menu').classList.add('hidden');
        document.getElementById('hud').classList.remove('hidden');
        document.getElementById('touch-controls').classList.remove('hidden');
        document.getElementById('mission-tracker').classList.remove('hidden');
        document.getElementById('radio-display').classList.remove('hidden');
        
        GameState.isPlaying = true;
        GameState.isPaused = false;
        
        startAct9();
        requestAnimationFrame(gameLoop);
    } else {
        originalLoadActAct9(actNum);
    }
};

// Debug commands for Act 9
window.DEBUG.startAct9 = startAct9;
window.DEBUG.startDebate = startDebateGame;

// Load Act 9 content
setTimeout(() => {
    loadAct9Content();
}, 800);

console.log('Act 9 integration loaded');


// ============================================
// ACT 10 & EPILOGUE INTEGRATION
// ============================================

function loadAct10Content() {
    if (typeof ACT10_MAPS !== 'undefined') {
        for (let mapKey in ACT10_MAPS) {
            MAPS[mapKey] = ACT10_MAPS[mapKey];
            generateFinalMapTiles(mapKey);
        }
        
        if (typeof ACT10_DIALOGUES !== 'undefined') {
            for (let dialogueKey in ACT10_DIALOGUES) {
                DIALOGUES[dialogueKey] = ACT10_DIALOGUES[dialogueKey];
            }
        }
        
        if (typeof ACT10_MISSIONS !== 'undefined') {
            MISSIONS.act10 = ACT10_MISSIONS;
        }
        
        if (typeof EPILOGUE_MISSIONS !== 'undefined') {
            MISSIONS.epilogue = EPILOGUE_MISSIONS;
        }
        
        console.log('Act 10 & Epilogue content loaded successfully');
    }
}

// Generate final act map tiles
function generateFinalMapTiles(mapKey) {
    const map = MAPS[mapKey];
    if (!map || map.tiles.length > 0) return;
    
    map.tiles = [];
    
    for (let y = 0; y < map.height; y++) {
        map.tiles[y] = [];
        for (let x = 0; x < map.width; x++) {
            let tile = 92; // Default final floor
            
            // Walls for interiors
            if (map.isInterior || map.isPalace || map.isMilitary) {
                if (x === 0 || y === 0 || x === map.width - 1 || y === map.height - 1) {
                    tile = 93; // Wall
                }
            }
            
            // Outdoor areas
            if (map.isOutdoor || map.isFinalBattle) {
                tile = 94; // Outdoor ground
            }
            
            // Epilogue peaceful
            if (map.isPeaceful) {
                tile = 95; // Beach sand
            }
            
            // Prison
            if (map.isPrison) {
                tile = 96; // Prison floor
            }
            
            map.tiles[y][x] = tile;
        }
    }
    
    // Add zones with special tiles
    for (let zoneKey in map.zones) {
        const zone = map.zones[zoneKey];
        let tileType = 92;
        
        if (zoneKey.includes('gate') || zoneKey.includes('Gate') || zoneKey.includes('entrance')) tileType = 97;
        else if (zoneKey.includes('courtyard') || zoneKey.includes('Courtyard')) tileType = 98;
        else if (zoneKey.includes('throne') || zoneKey.includes('Throne')) tileType = 99;
        else if (zoneKey.includes('security') || zoneKey.includes('Security')) tileType = 100;
        else if (zoneKey.includes('escape') || zoneKey.includes('Escape') || zoneKey.includes('passage')) tileType = 101;
        else if (zoneKey.includes('parade') || zoneKey.includes('Parade')) tileType = 102;
        else if (zoneKey.includes('command') || zoneKey.includes('Command')) tileType = 103;
        else if (zoneKey.includes('armory') || zoneKey.includes('Armory') || zoneKey.includes('weapon')) tileType = 104;
        else if (zoneKey.includes('detention') || zoneKey.includes('Detention') || zoneKey.includes('cell')) tileType = 105;
        else if (zoneKey.includes('monument') || zoneKey.includes('Monument')) tileType = 106;
        else if (zoneKey.includes('protest') || zoneKey.includes('Protest')) tileType = 107;
        else if (zoneKey.includes('barricade') || zoneKey.includes('Barricade') || zoneKey.includes('police')) tileType = 108;
        else if (zoneKey.includes('sniper') || zoneKey.includes('Sniper')) tileType = 109;
        else if (zoneKey.includes('runway') || zoneKey.includes('Runway')) tileType = 110;
        else if (zoneKey.includes('hangar') || zoneKey.includes('Hangar')) tileType = 111;
        else if (zoneKey.includes('shore') || zoneKey.includes('Shore')) tileType = 112;
        else if (zoneKey.includes('palm') || zoneKey.includes('Palm')) tileType = 113;
        else if (zoneKey.includes('sunset') || zoneKey.includes('Sunset')) tileType = 114;
        else if (zoneKey.includes('grave') || zoneKey.includes('Grave')) tileType = 115;
        else if (zoneKey.includes('mourner') || zoneKey.includes('Mourner')) tileType = 116;
        else if (zoneKey.includes('yard') || zoneKey.includes('Yard')) tileType = 117;
        else if (zoneKey.includes('balcony') || zoneKey.includes('Balcony')) tileType = 118;
        
        for (let y = zone.y; y < zone.y + zone.h && y < map.height; y++) {
            for (let x = zone.x; x < zone.x + zone.w && x < map.width; x++) {
                if (y >= 0 && x >= 0 && y < map.height && x < map.width) {
                    map.tiles[y][x] = tileType;
                }
            }
        }
    }
}

// Start Act 10
function startAct10() {
    GameState.currentAct = 10;
    GameState.currentMission = 0;
    GameState.world.currentMap = 'safe_house_final';
    
    loadAct10Content();
    
    const map = MAPS[GameState.world.currentMap];
    GameState.player.x = map.spawnX * TILE_SIZE;
    GameState.player.y = map.spawnY * TILE_SIZE;
    
    spawnAct10NPCs();
    
    if (typeof ACT10_RADIO !== 'undefined') {
        RADIO_CONTENT.raajjeFM.segments = ACT10_RADIO.raajjeFM.segments;
        if (ACT10_RADIO.freedomFM) {
            RADIO_CONTENT.freedomFM = ACT10_RADIO.freedomFM;
        }
    }
    
    showNotification('Act 10', 'Coup d\'√âtat');
    
    if (MISSIONS.act10 && MISSIONS.act10.length > 0) {
        setTimeout(() => {
            startMission(MISSIONS.act10[0]);
        }, 2000);
    }
    
    saveGame();
}

// Spawn NPCs for Act 10
function spawnAct10NPCs() {
    currentNPCs = [];
    currentItems = [];
    currentEnemies = [];
    
    const map = MAPS[GameState.world.currentMap];
    
    // Muaz (always present)
    currentNPCs.push({
        type: 'muaz',
        sprite: 'üë§',
        name: 'Muaz (Brother)',
        x: (map.width / 2 + 2) * TILE_SIZE,
        y: (map.height / 2) * TILE_SIZE,
        direction: 0,
        speed: 0,
        dialogue: ACT10_DIALOGUES?.storm_gathers,
        isSpecial: true,
        isFamily: true
    });
    
    // Armed allies
    for (let i = 0; i < 5; i++) {
        currentNPCs.push({
            type: 'ally',
            sprite: 'üî´',
            name: 'Armed Ally',
            x: Math.random() * (map.width - 10) * TILE_SIZE + 5 * TILE_SIZE,
            y: Math.random() * (map.height - 10) * TILE_SIZE + 5 * TILE_SIZE,
            direction: Math.random() * Math.PI * 2,
            speed: 0.2
        });
    }
    
    // Weapons cache
    const weaponZone = map.zones?.weaponRoom || map.zones?.armory;
    if (weaponZone) {
        currentItems.push({
            type: 'weapon',
            x: (weaponZone.x + weaponZone.w / 2) * TILE_SIZE,
            y: (weaponZone.y + weaponZone.h / 2) * TILE_SIZE,
            value: 0,
            isStoryItem: true
        });
    }
}

// Show ending screen
function showEnding(endingId) {
    const ending = ENDINGS[endingId];
    if (!ending) return;
    
    GameState.isPaused = true;
    GameState.ending = endingId;
    
    const endingUI = document.createElement('div');
    endingUI.id = 'ending-screen';
    endingUI.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #0a0a0a 0%, ${ending.color}33 100%);
        z-index: 3000;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white;
        font-family: Arial, sans-serif;
        animation: fadeIn 2s ease-in;
    `;
    
    endingUI.innerHTML = `
        <style>
            @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
            @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        </style>
        <div style="font-size: 80px; animation: pulse 2s infinite;">${ending.icon}</div>
        <h1 style="font-size: 48px; color: ${ending.color}; margin: 20px 0; text-shadow: 2px 2px 10px black;">
            ${ending.title}
        </h1>
        <h2 style="font-size: 24px; color: #aaa; margin-bottom: 30px; font-style: italic;">
            "${ending.subtitle}"
        </h2>
        <p style="max-width: 600px; text-align: center; font-size: 18px; line-height: 1.6; margin-bottom: 40px;">
            ${ending.summary}
        </p>
        <div style="display: flex; gap: 20px; margin-top: 20px;">
            <button id="ending-epilogue" style="
                padding: 15px 30px;
                background: ${ending.color};
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-size: 18px;
                font-weight: bold;
            ">View Epilogue</button>
            <button id="ending-credits" style="
                padding: 15px 30px;
                background: #333;
                color: white;
                border: 2px solid ${ending.color};
                border-radius: 8px;
                cursor: pointer;
                font-size: 18px;
            ">Credits</button>
        </div>
        <div style="margin-top: 40px; color: #666;">
            <p>Final Karma: ${GameState.player.karma}</p>
            <p>Family Bond: ${GameState.player.familyMeter}%</p>
            <p>Total Faisaa: ${GameState.player.money.toLocaleString()}</p>
        </div>
    `;
    
    document.body.appendChild(endingUI);
    
    // Epilogue button
    endingUI.querySelector('#ending-epilogue').onclick = () => {
        endingUI.remove();
        showEpilogue(endingId);
    };
    
    // Credits button
    endingUI.querySelector('#ending-credits').onclick = () => {
        endingUI.remove();
        showCredits();
    };
    
    // Save completed ending
    GameState.completedEndings = GameState.completedEndings || [];
    if (!GameState.completedEndings.includes(endingId)) {
        GameState.completedEndings.push(endingId);
    }
    saveGame();
}

// Show epilogue scene
function showEpilogue(endingId) {
    const epilogue = EPILOGUE_MISSIONS[endingId];
    const dialogue = ACT10_DIALOGUES[`${endingId}_epilogue`];
    
    if (!epilogue || !dialogue) {
        showCredits();
        return;
    }
    
    // Load epilogue map
    GameState.world.currentMap = epilogue.scene;
    const map = MAPS[epilogue.scene];
    if (map) {
        generateFinalMapTiles(epilogue.scene);
        GameState.player.x = map.spawnX * TILE_SIZE;
        GameState.player.y = map.spawnY * TILE_SIZE;
    }
    
    GameState.isPaused = false;
    
    // Start epilogue dialogue
    setTimeout(() => {
        startDialogue(dialogue);
    }, 1000);
    
    // After dialogue, show credits
    setTimeout(() => {
        showCredits();
    }, dialogue.lines.length * 4000 + 5000);
}

// Show credits
function showCredits() {
    const creditsUI = document.createElement('div');
    creditsUI.id = 'credits-screen';
    creditsUI.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #0a0a0a;
        z-index: 3000;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        padding-top: 50px;
        color: white;
        font-family: Arial, sans-serif;
        overflow-y: auto;
    `;
    
    creditsUI.innerHTML = `
        <h1 style="font-size: 36px; color: #ffd700; margin-bottom: 40px;">
            üèùÔ∏è RAAJJE THEFT AUTO 1 üèùÔ∏è
        </h1>
        <h2 style="color: #4ecdc4; margin-bottom: 30px;">The Baokalo Chronicles</h2>
        
        <div style="max-width: 500px; text-align: center;">
            <h3 style="color: #ffd700; margin: 20px 0;">Story & Design</h3>
            <p>Based on the Game Bible</p>
            
            <h3 style="color: #ffd700; margin: 20px 0;">Development</h3>
            <p>Pure HTML/CSS/JavaScript</p>
            <p>No External Libraries</p>
            
            <h3 style="color: #ffd700; margin: 20px 0;">Special Thanks</h3>
            <p>The People of Maldives</p>
            <p>For their resilience and hope</p>
            
            <h3 style="color: #ffd700; margin: 20px 0;">Historical Note</h3>
            <p style="font-size: 14px; color: #888; line-height: 1.6;">
                This game is a work of fiction inspired by real events in Maldivian history.
                The 1988 coup attempt, 2012 political crisis, and ongoing challenges with
                gang violence and political corruption are real issues that deserve attention
                and peaceful resolution.
            </p>
            
            <h3 style="color: #ffd700; margin: 20px 0;">Dhivehi Phrases Used</h3>
            <p style="font-size: 14px; color: #888;">
                Aharen (I/Me) ‚Ä¢ Kaley (You) ‚Ä¢ Mashakah (We/Us)<br>
                Faisaa (Money) ‚Ä¢ Raajje (Maldives) ‚Ä¢ Thibeyfulhaa (Sir/Madam)
            </p>
            
            <div style="margin-top: 50px;">
                <p style="color: #ffd700; font-size: 24px;">üôè Shukuriyaa üôè</p>
                <p style="color: #888;">Thank You for Playing</p>
            </div>
        </div>
        
        <button id="credits-close" style="
            margin-top: 40px;
            margin-bottom: 50px;
            padding: 15px 40px;
            background: #ffd700;
            color: black;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
        ">Return to Main Menu</button>
    `;
    
    document.body.appendChild(creditsUI);
    
    creditsUI.querySelector('#credits-close').onclick = () => {
        creditsUI.remove();
        GameState.isPaused = false;
        GameState.isPlaying = false;
        document.getElementById('main-menu').classList.remove('hidden');
        document.getElementById('hud').classList.add('hidden');
        document.getElementById('touch-controls').classList.add('hidden');
    };
}

// Extended tile rendering for Act 10
const originalRenderMapAct10 = renderMap;
renderMap = function() {
    const map = MAPS[GameState.world.currentMap];
    
    const startX = Math.floor(Camera.x / TILE_SIZE);
    const startY = Math.floor(Camera.y / TILE_SIZE);
    const endX = Math.ceil((Camera.x + CANVAS_WIDTH) / TILE_SIZE);
    const endY = Math.ceil((Camera.y + CANVAS_HEIGHT) / TILE_SIZE);
    
    for (let y = startY; y <= endY && y < map.height; y++) {
        for (let x = startX; x <= endX && x < map.width; x++) {
            if (y < 0 || x < 0) continue;
            
            const tile = map.tiles[y]?.[x] ?? 92;
            let color;
            
            switch (tile) {
                case 92: color = '#4a4a5a'; break; // Final floor
                case 93: color = '#2a2a3a'; break; // Wall
                case 94: color = '#5a5a5a'; break; // Outdoor
                case 95: color = '#F5DEB3'; break; // Beach sand
                case 96: color = '#3a3a3a'; break; // Prison floor
                case 97: color = '#5a5a6a'; break; // Gate
                case 98: color = '#6a6a7a'; break; // Courtyard
                case 99: color = '#8a7a5a'; break; // Throne room (gold tint)
                case 100: color = '#4a4a5a'; break; // Security
                case 101: color = '#2a2a2a'; break; // Escape passage
                case 102: color = '#5a6a5a'; break; // Parade ground
                case 103: color = '#3a4a5a'; break; // Command center
                case 104: color = '#4a3a3a'; break; // Armory
                case 105: color = '#2a2a2a'; break; // Detention
                case 106: color = '#7a7a8a'; break; // Monument
                case 107: color = '#5a5a6a'; break; // Protest area
                case 108: color = '#4a4a4a'; break; // Barricade
                case 109: color = '#3a3a4a'; break; // Sniper position
                case 110: color = '#5a5a5a'; break; // Runway
                case 111: color = '#4a4a4a'; break; // Hangar
                case 112: color = '#87CEEB'; break; // Shore (water edge)
                case 113: color = '#228B22'; break; // Palm grove
                case 114: color = '#FFB347'; break; // Sunset point
                case 115: color = '#4a5a4a'; break; // Grave
                case 116: color = '#5a5a5a'; break; // Mourners area
                case 117: color = '#5a5a5a'; break; // Prison yard
                case 118: color = '#6a6a7a'; break; // Balcony
                default: color = '#4a4a5a';
            }
            
            ctx.fillStyle = color;
            ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            
            // Palace grandeur
            if (map.isPalace) {
                ctx.fillStyle = 'rgba(255,215,0,0.03)';
                ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            }
            
            // Military atmosphere
            if (map.isMilitary) {
                ctx.fillStyle = 'rgba(50,100,50,0.05)';
                ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            }
            
            // Final battle chaos
            if (map.isFinalBattle) {
                const chaos = Math.sin(frameCount * 0.1 + x * 0.3 + y * 0.3);
                if (chaos > 0.8) {
                    ctx.fillStyle = 'rgba(255,100,0,0.1)';
                    ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                }
            }
            
            // Epilogue peace
            if (map.isPeaceful) {
                const shimmer = Math.sin(frameCount * 0.02 + x * 0.1);
                ctx.fillStyle = `rgba(255,200,100,${0.05 + shimmer * 0.03})`;
                ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            }
            
            // Throne room glow
            if (tile === 99) {
                ctx.fillStyle = `rgba(255,215,0,${0.1 + Math.sin(frameCount * 0.03) * 0.05})`;
                ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            }
            
            // Sunset effect
            if (tile === 114) {
                const sunset = Math.sin(frameCount * 0.01);
                ctx.fillStyle = `rgba(255,${150 + sunset * 50},${100 + sunset * 50},0.2)`;
                ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            }
        }
    }
};

// Update loadAct function for Act 10
const originalLoadActAct10 = loadAct;
loadAct = function(actNum) {
    if (actNum === 10) {
        document.getElementById('main-menu').classList.add('hidden');
        document.getElementById('hud').classList.remove('hidden');
        document.getElementById('touch-controls').classList.remove('hidden');
        document.getElementById('mission-tracker').classList.remove('hidden');
        document.getElementById('radio-display').classList.remove('hidden');
        
        GameState.isPlaying = true;
        GameState.isPaused = false;
        
        startAct10();
        requestAnimationFrame(gameLoop);
    } else {
        originalLoadActAct10(actNum);
    }
};

// Debug commands for Act 10
window.DEBUG.startAct10 = startAct10;
window.DEBUG.showEnding = showEnding;
window.DEBUG.showCredits = showCredits;
window.DEBUG.tyrantEnding = () => showEnding('tyrant');
window.DEBUG.puppetEnding = () => showEnding('puppet');
window.DEBUG.redemptionEnding = () => showEnding('redemption');
window.DEBUG.martyrEnding = () => showEnding('martyr');

// Load Act 10 content
setTimeout(() => {
    loadAct10Content();
}, 900);

console.log('Act 10 & Epilogue integration loaded');


// ========== act2.js ==========
// ============================================
// ACT 2: MAL√â CORE WARS
// Timeline: 2016 - Baokalo rises in gang hierarchy
// ============================================

// ==================== ACT 2 MAPS ====================
const ACT2_MAPS = {
    male_henveiru: {
        name: "Henveiru District, Mal√©",
        width: 60,
        height: 50,
        spawnX: 10,
        spawnY: 25,
        tiles: [],
        npcs: [],
        items: [],
        zones: {
            kudaTurf: { x: 25, y: 15, w: 20, h: 20, name: "Kuda Henveiru Territory ‚ö†Ô∏è" },
            sultanPark: { x: 5, y: 5, w: 15, h: 12, name: "Sultan Park üå≥" },
            mosque: { x: 45, y: 10, w: 10, h: 10, name: "Friday Mosque üïå" },
            drugDen: { x: 50, y: 35, w: 8, h: 8, name: "Drug Den üíä" }
        },
        gangTerritory: "Kuda Henveiru",
        enemyGangs: ["kudaHenveiru", "masodi"]
    },
    
    male_galolhu: {
        name: "Galolhu District, Mal√©",
        width: 55,
        height: 45,
        spawnX: 30,
        spawnY: 40,
        tiles: [],
        npcs: [],
        items: [],
        zones: {
            parliament: { x: 20, y: 10, w: 15, h: 12, name: "People's Majlis üèõÔ∏è" },
            presidentialPalace: { x: 5, y: 5, w: 12, h: 10, name: "Presidential Palace üè∞" },
            maleSharksHQ: { x: 40, y: 25, w: 10, h: 10, name: "Mal√© Sharks HQ ü¶à" },
            rippooTeaShop: { x: 25, y: 35, w: 8, h: 6, name: "Rippoo's Tea Shop ‚òï" }
        },
        gangTerritory: "Mal√© Sharks",
        politicalZone: true
    },
    
    male_machchangolhi: {
        name: "Machchangolhi District, Mal√©",
        width: 50,
        height: 45,
        spawnX: 25,
        spawnY: 35,
        tiles: [],
        npcs: [],
        items: [],
        zones: {
            port: { x: 0, y: 20, w: 10, h: 25, name: "Mal√© Port üö¢" },
            smugglersDock: { x: 5, y: 35, w: 8, h: 8, name: "Smuggler's Dock üì¶" },
            warehouse: { x: 35, y: 15, w: 12, h: 10, name: "Abandoned Warehouse üèöÔ∏è" },
            masodiOutpost: { x: 40, y: 30, w: 8, h: 8, name: "Masodi Outpost ‚öîÔ∏è" }
        },
        gangTerritory: "Masodi",
        smugglingHub: true
    }
};

// ==================== ACT 2 CHARACTERS ====================
const ACT2_CHARACTERS = {
    rippoo_razor: {
        name: "Rippoo 'The Razor' Ronda",
        sprite: "üë©üèæ",
        angrySprite: "üò§",
        role: "Mother / Former Gang Legend",
        backstory: "1993-1998: Mal√© Sharks enforcer. Left gang life when pregnant with Nunnu. Secret: She killed a man who threatened her family.",
        dialogues: {
            secret_reveal: {
                speaker: "Rippoo",
                sprite: "üë©üèæ",
                lines: [
                    { text: "*locks door* Sit down, Kipal.", dhivehi: false },
                    { text: "Kaley think mashakah don't know this life?", dhivehi: true },
                    { text: "Before kaley was born... aharen was Rippoo the Razor.", dhivehi: true },
                    { text: "Mal√© Sharks. Five years. Aharen did things...", dhivehi: true },
                    { text: "*shows scar on arm* This? From a man who threatened Nunnu.", dhivehi: false },
                    { text: "He's buried in Villingili. Mashakah buried him.", dhivehi: true },
                    { text: "So don't think kaley can hide from me. Aharen know everything.", dhivehi: true }
                ],
                choices: [
                    { text: "Aharen... aharen didn't know. Why didn't kaley tell me?", karma: 5, familyKarma: 10, response: "rippoo_explain" },
                    { text: "So kaley a hypocrite! Judging me for what kaley did!", karma: -10, familyKarma: -15, response: "rippoo_angry" },
                    { text: "Teach me. Help me survive this.", karma: 0, familyKarma: 5, response: "rippoo_teach" }
                ]
            }
        }
    },
    
    maleSharksLeader: {
        name: "Miyaru Boss (Shark Boss)",
        sprite: "ü¶à",
        role: "Mal√© Sharks Leader",
        territory: "Galolhu",
        dialogues: {
            first_meeting: {
                speaker: "Miyaru Boss",
                sprite: "ü¶à",
                lines: [
                    { text: "So... Rippoo's son. The Razor's blood.", dhivehi: false },
                    { text: "Kaley mother was legend. Best enforcer mashakah ever had.", dhivehi: true },
                    { text: "She left us. But blood is blood.", dhivehi: false },
                    { text: "Work for Sharks. Honor kaley mother's legacy.", dhivehi: true }
                ],
                choices: [
                    { text: "Aharen will honor her legacy. What do kaley need?", karma: -5, reputation: { maleSharks: 20 }, response: "shark_accept" },
                    { text: "Mashakah mother left for a reason. Aharen won't join.", karma: 10, reputation: { maleSharks: -30 }, response: "shark_refuse" },
                    { text: "What can Sharks offer that Hustlers can't?", karma: 0, response: "shark_negotiate" }
                ]
            }
        }
    },
    
    drugDealer: {
        name: "Beys Dealer",
        sprite: "üíä",
        role: "Drug Supplier",
        dialogues: {
            intro: {
                speaker: "Beys Dealer",
                sprite: "üíä",
                lines: [
                    { text: "Shhh... kaley want beys? Good stuff from India.", dhivehi: true },
                    { text: "Heroin, meth, whatever kaley need.", dhivehi: false },
                    { text: "Sell for mashakah. 40% cut. Easy faisaa.", dhivehi: true }
                ],
                choices: [
                    { text: "Aharen in. Where's the product?", karma: -25, familyKarma: -20, response: "drug_accept" },
                    { text: "Drugs destroy families. Aharen won't touch beys.", karma: 15, familyKarma: 10, response: "drug_refuse" },
                    { text: "Maybe. But aharen need to think about it.", karma: 0, response: "drug_maybe" }
                ]
            }
        }
    },
    
    masodiLeader: {
        name: "Shiru (Masodi Boss)",
        sprite: "üòà",
        role: "Masodi Gang Leader",
        territory: "Machchangolhi + Addu connections",
        dialogues: {
            confrontation: {
                speaker: "Shiru",
                sprite: "üòà",
                lines: [
                    { text: "Baokalo. The Addu boy playing Mal√© gangster.", dhivehi: false },
                    { text: "Kaley think Hulhu Hustlers can protect kaley?", dhivehi: true },
                    { text: "Masodi controls the ports. The drugs. The politicians.", dhivehi: false },
                    { text: "Join us or die. Simple choice, Addu sodu.", dhivehi: true }
                ],
                choices: [
                    { text: "Aharen bow to no one. Especially not Masodi.", karma: 5, reputation: { masodi: -50 }, response: "masodi_defy" },
                    { text: "What's in it for mashakah?", karma: -5, response: "masodi_negotiate" },
                    { text: "[Attack Shiru]", karma: -15, combat: true, response: "masodi_attack" }
                ]
            }
        }
    },
    
    corruptPolitician: {
        name: "MP Jabibe",
        sprite: "ü§ë",
        role: "Corrupt Parliamentarian",
        party: "PNC",
        dialogues: {
            bribe: {
                speaker: "MP Jabibe",
                sprite: "ü§ë",
                lines: [
                    { text: "Ah, the young gangster. Mashakah heard about kaley.", dhivehi: true },
                    { text: "Politics and crime... same business, different suits.", dhivehi: false },
                    { text: "Mashakah need... muscle. For the election.", dhivehi: true },
                    { text: "5000 rufiyaa per job. Intimidate voters. Simple.", dhivehi: false }
                ],
                choices: [
                    { text: "Faisaa is faisaa. Aharen do it.", karma: -20, familyKarma: -10, money: 5000, response: "jabibe_accept" },
                    { text: "Aharen criminal, not politician's dog.", karma: 10, response: "jabibe_refuse" },
                    { text: "10,000 or nothing.", karma: -5, money: 10000, response: "jabibe_negotiate" }
                ]
            }
        }
    }
};

// ==================== ACT 2 MISSIONS ====================
const ACT2_MISSIONS = [
    {
        id: "act2_m1",
        title: "New Territory",
        type: "exploration",
        description: "Explore Henveiru district and establish presence",
        objectives: [
            { type: "travel", target: "male_henveiru", current: false },
            { type: "discover", target: "kudaTurf", current: false },
            { type: "discover", target: "sultanPark", current: false }
        ],
        rewards: { money: 200, reputation: { hulhuHustlers: 10 } },
        unlocks: ["act2_m2"]
    },
    {
        id: "act2_m2",
        title: "Kuda Henveiru Clash",
        type: "combat",
        description: "Defend against Kuda Henveiru ambush",
        objectives: [
            { type: "defeat", target: "kudaThug", count: 5, current: 0 }
        ],
        rewards: { money: 300, karma: -10, reputation: { hulhuHustlers: 15, kudaHenveiru: -25 } },
        unlocks: ["act2_m3"]
    },
    {
        id: "act2_m3",
        title: "The Razor's Secret",
        type: "story",
        description: "Confront Rippoo about her past",
        objectives: [
            { type: "travel", target: "rippooTeaShop", current: false },
            { type: "trigger", target: "rippooSecret", current: false }
        ],
        rewards: { karma: 0 },
        dialogueStart: "rippoo_secret_reveal",
        unlocks: ["act2_m4", "act2_m5"],
        setFlag: "rippooSecretRevealed",
        majorStoryBeat: true
    },
    {
        id: "act2_m4",
        title: "Sharks Circling",
        type: "story",
        description: "Meet the Mal√© Sharks leader",
        objectives: [
            { type: "travel", target: "maleSharksHQ", current: false },
            { type: "trigger", target: "sharkMeeting", current: false }
        ],
        rewards: { money: 500 },
        dialogueStart: "shark_first_meeting",
        unlocks: ["act2_m6"],
        moralChoice: true
    },
    {
        id: "act2_m5",
        title: "Drug Trade Introduction",
        type: "story",
        description: "A dealer offers you a partnership",
        objectives: [
            { type: "travel", target: "drugDen", current: false },
            { type: "trigger", target: "drugOffer", current: false }
        ],
        rewards: { money: 0 },
        dialogueStart: "drug_intro",
        unlocks: ["act2_m6"],
        moralChoice: true,
        majorChoice: "drugs" // Affects entire game
    },
    {
        id: "act2_m6",
        title: "Port Heist",
        type: "heist",
        description: "Steal shipment from Masodi-controlled port",
        objectives: [
            { type: "travel", target: "smugglersDock", current: false },
            { type: "steal", target: "shipment", current: false },
            { type: "escape", target: "safehouse", current: false }
        ],
        rewards: { money: 1000, karma: -15, reputation: { masodi: -40 } },
        unlocks: ["act2_m7"],
        heistPlanning: true
    },
    {
        id: "act2_m7",
        title: "Masodi Retaliation",
        type: "combat",
        description: "Masodi attacks your territory",
        objectives: [
            { type: "defend", target: "maafannuTerritory", duration: 90, current: 0 },
            { type: "defeat", target: "masodiEnforcer", count: 8, current: 0 }
        ],
        rewards: { money: 500, karma: -10, reputation: { hulhuHustlers: 30 } },
        unlocks: ["act2_m8"]
    },
    {
        id: "act2_m8",
        title: "Political Puppet",
        type: "story",
        description: "MP Jabibe wants your services",
        objectives: [
            { type: "travel", target: "parliament", current: false },
            { type: "trigger", target: "jabibeMeeting", current: false }
        ],
        rewards: { money: 0 },
        dialogueStart: "jabibe_bribe",
        unlocks: ["act2_m9", "act2_m10"],
        moralChoice: true
    },
    {
        id: "act2_m9",
        title: "Voter Intimidation",
        type: "intimidation",
        description: "Threaten opposition voters for Jabibe",
        objectives: [
            { type: "intimidate", target: "voter", count: 5, current: 0 }
        ],
        rewards: { money: 5000, karma: -25, familyKarma: -15 },
        unlocks: ["act2_m11"],
        requiresChoice: "jabibe_accept"
    },
    {
        id: "act2_m10",
        title: "Expose the Corrupt",
        type: "stealth",
        description: "Gather evidence against Jabibe",
        objectives: [
            { type: "photograph", target: "jabibeEvidence", count: 3, current: 0 },
            { type: "deliver", target: "journalist", current: false }
        ],
        rewards: { money: 200, karma: 20, familyKarma: 10 },
        unlocks: ["act2_m11"],
        requiresChoice: "jabibe_refuse"
    },
    {
        id: "act2_m11",
        title: "Shiru's Challenge",
        type: "boss",
        description: "Face Shiru in Machchangolhi",
        objectives: [
            { type: "travel", target: "masodiOutpost", current: false },
            { type: "defeat", target: "shiru", count: 1, current: 0 }
        ],
        rewards: { money: 2000, karma: -20, reputation: { masodi: -60, hulhuHustlers: 40 } },
        unlocks: ["act2_m12"],
        bossMusic: true
    },
    {
        id: "act2_m12",
        title: "Gang Alliance",
        type: "story",
        description: "Form alliance or go independent",
        objectives: [
            { type: "trigger", target: "allianceChoice", current: false }
        ],
        rewards: { money: 0 },
        moralChoice: true,
        choices: [
            { text: "Alliance with Mal√© Sharks", karma: -10, outcome: "shark_alliance" },
            { text: "Alliance with Hulhu Hustlers only", karma: 0, outcome: "hustler_loyalty" },
            { text: "Go independent - start own crew", karma: 5, outcome: "independent" }
        ],
        unlocks: ["act2_m13"]
    },
    {
        id: "act2_m13",
        title: "Warehouse Takeover",
        type: "combat",
        description: "Capture the abandoned warehouse",
        objectives: [
            { type: "capture", target: "warehouse", current: false },
            { type: "defeat", target: "warehouseGuard", count: 6, current: 0 }
        ],
        rewards: { money: 1500, reputation: { hulhuHustlers: 25 } },
        unlocks: ["act2_m14"]
    },
    {
        id: "act2_m14",
        title: "Family Tensions",
        type: "story",
        description: "Nunnu returns from medical school",
        objectives: [
            { type: "trigger", target: "nunnuReturn", current: false }
        ],
        rewards: { karma: 0 },
        dialogueStart: "nunnu_confrontation",
        unlocks: ["act2_climax"],
        setFlag: "nunnuReturned"
    },
    {
        id: "act2_climax",
        title: "The Mal√© Massacre",
        type: "combat",
        description: "All-out gang war in Galolhu",
        objectives: [
            { type: "survive", target: "gangWar", duration: 120, current: 0 },
            { type: "defeat", target: "enemyGangster", count: 15, current: 0 },
            { type: "protect", target: "hulhuLeader", current: true }
        ],
        rewards: { money: 3000, karma: -30, reputation: { hulhuHustlers: 50 } },
        unlocks: ["act3_start"],
        actEnd: true,
        bossMusic: true
    }
];

// ==================== ACT 2 SIDE MISSIONS ====================
const ACT2_SIDE_MISSIONS = [
    { id: "side2_race1", title: "Henveiru Street Race", type: "race", reward: 200 },
    { id: "side2_race2", title: "Galolhu Night Race", type: "race", reward: 300 },
    { id: "side2_delivery1", title: "Suspicious Package I", type: "delivery", reward: 150 },
    { id: "side2_delivery2", title: "Suspicious Package II", type: "delivery", reward: 200 },
    { id: "side2_delivery3", title: "Suspicious Package III", type: "delivery", reward: 250 },
    { id: "side2_fight1", title: "Underground Fight I", type: "fight", enemies: 3, reward: 200 },
    { id: "side2_fight2", title: "Underground Fight II", type: "fight", enemies: 5, reward: 350 },
    { id: "side2_fight3", title: "Underground Fight III", type: "fight", enemies: 7, reward: 500 },
    { id: "side2_extort1", title: "Shop Protection I", type: "extortion", reward: 300 },
    { id: "side2_extort2", title: "Shop Protection II", type: "extortion", reward: 400 },
    { id: "side2_steal1", title: "Tourist Wallets", type: "pickpocket", target: 10, reward: 250 },
    { id: "side2_steal2", title: "Politician's Briefcase", type: "steal", reward: 500 },
    { id: "side2_boduberu", title: "Boduberu Competition", type: "minigame", game: "boduberu", reward: 200 },
    { id: "side2_fishing", title: "Night Fishing", type: "minigame", game: "fishing", reward: 150 },
    { id: "side2_charisma1", title: "Recruit Members I", type: "charisma", target: 3, reward: 200 },
    { id: "side2_charisma2", title: "Recruit Members II", type: "charisma", target: 5, reward: 350 }
];

// ==================== ACT 2 DIALOGUES ====================
const ACT2_DIALOGUES = {
    rippoo_secret_reveal: {
        speaker: "Rippoo",
        sprite: "üë©üèæ",
        lines: [
            { text: "*locks door* Sit down, Kipal.", dhivehi: false },
            { text: "Kaley think mashakah don't know this life?", dhivehi: true },
            { text: "Before kaley was born... aharen was Rippoo the Razor.", dhivehi: true },
            { text: "Mal√© Sharks. Five years. Aharen did things...", dhivehi: true },
            { text: "*shows scar on arm* This? From a man who threatened Nunnu.", dhivehi: false },
            { text: "He's buried in Villingili. Mashakah buried him.", dhivehi: true },
            { text: "So don't think kaley can hide from me. Aharen know everything.", dhivehi: true }
        ],
        choices: [
            { text: "Aharen... aharen didn't know. Why didn't kaley tell me?", karma: 5, familyKarma: 10, response: "rippoo_explain" },
            { text: "So kaley a hypocrite! Judging me for what kaley did!", karma: -10, familyKarma: -15, response: "rippoo_angry" },
            { text: "Teach me. Help me survive this.", karma: 0, familyKarma: 5, response: "rippoo_teach" }
        ]
    },
    
    rippoo_explain: {
        speaker: "Rippoo",
        sprite: "üë©üèæ",
        lines: [
            { text: "*sighs* Because aharen wanted better for kaley.", dhivehi: true },
            { text: "When Nunnu was born... mashakah saw her face and knew.", dhivehi: true },
            { text: "Aharen couldn't raise her in blood. So aharen left.", dhivehi: true },
            { text: "But kaley... kaley chose this path yourself.", dhivehi: true },
            { text: "Mashakah can't stop kaley. But aharen can guide kaley.", dhivehi: true }
        ]
    },
    
    rippoo_angry: {
        speaker: "Rippoo",
        sprite: "üò§",
        lines: [
            { text: "*slaps Baokalo hard*", dhivehi: false },
            { text: "Kaley sodu! Aharen killed so kaley could LIVE!", dhivehi: true },
            { text: "Every night mashakah see his face. Every night!", dhivehi: true },
            { text: "Kaley think this is a game? This is HELL!", dhivehi: true },
            { text: "Get out. GET OUT OF MASHAKAH HOUSE!", dhivehi: true }
        ]
    },
    
    rippoo_teach: {
        speaker: "Rippoo",
        sprite: "üë©üèæ",
        lines: [
            { text: "*long pause* ...Alright.", dhivehi: false },
            { text: "If kaley going to do this... do it smart.", dhivehi: true },
            { text: "Rule one: Never trust politicians. They use gangs like tools.", dhivehi: false },
            { text: "Rule two: Family first. Always. Even when they hate kaley.", dhivehi: true },
            { text: "Rule three: The Sharks... they remember mashakah. Use that.", dhivehi: true },
            { text: "Now go. And don't get killed, darifulhaakah.", dhivehi: true }
        ]
    },
    
    shark_first_meeting: {
        speaker: "Miyaru Boss",
        sprite: "ü¶à",
        lines: [
            { text: "So... Rippoo's son. The Razor's blood.", dhivehi: false },
            { text: "Kaley mother was legend. Best enforcer mashakah ever had.", dhivehi: true },
            { text: "She left us. But blood is blood.", dhivehi: false },
            { text: "Work for Sharks. Honor kaley mother's legacy.", dhivehi: true }
        ],
        choices: [
            { text: "Aharen will honor her legacy. What do kaley need?", karma: -5, reputation: { maleSharks: 20 }, response: "shark_accept" },
            { text: "Mashakah mother left for a reason. Aharen won't join.", karma: 10, reputation: { maleSharks: -30 }, response: "shark_refuse" },
            { text: "What can Sharks offer that Hustlers can't?", karma: 0, response: "shark_negotiate" }
        ]
    },
    
    shark_accept: {
        speaker: "Miyaru Boss",
        sprite: "ü¶à",
        lines: [
            { text: "*grins* Good. Kaley smart like mother.", dhivehi: true },
            { text: "First job: We need someone to handle Kuda Henveiru.", dhivehi: false },
            { text: "They've been stealing our shipments. Make them stop.", dhivehi: false },
            { text: "Do this, and Sharks will protect kaley. Always.", dhivehi: true }
        ]
    },
    
    shark_refuse: {
        speaker: "Miyaru Boss",
        sprite: "ü¶à",
        lines: [
            { text: "*cold stare* Kaley mother said same thing.", dhivehi: true },
            { text: "She regretted it. Kaley will too.", dhivehi: false },
            { text: "Mashakah give kaley one chance. Don't waste it.", dhivehi: true },
            { text: "Next time we meet... might not be so friendly.", dhivehi: false }
        ]
    },
    
    shark_negotiate: {
        speaker: "Miyaru Boss",
        sprite: "ü¶à",
        lines: [
            { text: "*laughs* Kaley got balls. Like mother.", dhivehi: true },
            { text: "Sharks control Galolhu. Politicians. Drugs. Money.", dhivehi: false },
            { text: "Hustlers? Small time. Fish market pickpockets.", dhivehi: false },
            { text: "With us, kaley could run this whole island.", dhivehi: true },
            { text: "Think about it. Door's always open for Razor's son.", dhivehi: true }
        ]
    },
    
    drug_intro: {
        speaker: "Beys Dealer",
        sprite: "üíä",
        lines: [
            { text: "Psst... kaley. Over here.", dhivehi: true },
            { text: "Aharen heard about kaley. Rising star in Maafannu.", dhivehi: true },
            { text: "Want to make real faisaa? Not this pickpocket bullshit.", dhivehi: true },
            { text: "Beys. Heroin from India. Meth from Thailand.", dhivehi: false },
            { text: "Sell for mashakah. 40% cut. Thousands per week.", dhivehi: true }
        ],
        choices: [
            { text: "Aharen in. Where's the product?", karma: -25, familyKarma: -20, response: "drug_accept" },
            { text: "Drugs destroy families. Aharen won't touch beys.", karma: 15, familyKarma: 10, response: "drug_refuse" },
            { text: "Maybe. But aharen need to think about it.", karma: 0, response: "drug_maybe" }
        ]
    },
    
    drug_accept: {
        speaker: "Beys Dealer",
        sprite: "üíä",
        lines: [
            { text: "*grins* Smart choice. Here's the first batch.", dhivehi: false },
            { text: "Sell to tourists at resorts. Rich foreigners pay double.", dhivehi: false },
            { text: "Don't get caught. Police are paid off, but not all of them.", dhivehi: false },
            { text: "Welcome to the real business, Baokalo.", dhivehi: false }
        ]
    },
    
    drug_refuse: {
        speaker: "Beys Dealer",
        sprite: "üíä",
        lines: [
            { text: "*spits* Kaley sodu. Think kaley better than mashakah?", dhivehi: true },
            { text: "Every gang in Mal√© sells beys. EVERY ONE.", dhivehi: false },
            { text: "Kaley can't survive without it. Mark mashakah words.", dhivehi: true },
            { text: "When kaley change mind... aharen be here.", dhivehi: true }
        ]
    },
    
    drug_maybe: {
        speaker: "Beys Dealer",
        sprite: "üíä",
        lines: [
            { text: "Think fast. This offer won't last.", dhivehi: false },
            { text: "Other gangs want this territory. Masodi especially.", dhivehi: false },
            { text: "Kaley got one week. Then aharen find someone else.", dhivehi: true }
        ]
    },
    
    nunnu_confrontation: {
        speaker: "Nunnu",
        sprite: "üë©üèæ‚Äç‚öïÔ∏è",
        lines: [
            { text: "*sees Baokalo's bruises* What happened to kaley?!", dhivehi: true },
            { text: "Aharen heard rumors in Bangalore. About my brother.", dhivehi: true },
            { text: "Gangs? GANGS?! After everything mashakah sacrificed?!", dhivehi: true },
            { text: "*crying* Aharen studying to save lives. Kaley taking them!", dhivehi: true },
            { text: "How can we be from same family?!", dhivehi: true }
        ],
        choices: [
            { text: "Aharen sorry, Nunnu. But kaley don't understand Mal√©.", karma: 5, familyKarma: 5, response: "nunnu_apologize" },
            { text: "Kaley got scholarship. Aharen got nothing. This is MY way.", karma: -10, familyKarma: -15, response: "nunnu_bitter" },
            { text: "*hug her* Aharen still your brother. Always.", karma: 10, familyKarma: 15, response: "nunnu_hug" }
        ]
    },
    
    nunnu_apologize: {
        speaker: "Nunnu",
        sprite: "üë©üèæ‚Äç‚öïÔ∏è",
        lines: [
            { text: "*wipes tears* Aharen understand more than kaley think.", dhivehi: true },
            { text: "Mashakah saw the poverty. The desperation.", dhivehi: true },
            { text: "But there's always another way, Kipal.", dhivehi: false },
            { text: "Please... come back to us. Before it's too late.", dhivehi: true }
        ]
    },
    
    nunnu_bitter: {
        speaker: "Nunnu",
        sprite: "üë©üèæ‚Äç‚öïÔ∏è",
        lines: [
            { text: "*steps back* Kaley think aharen had it easy?!", dhivehi: true },
            { text: "Mashakah studied 18 hours a day! While kaley partied!", dhivehi: true },
            { text: "Don't blame me for kaley failures!", dhivehi: true },
            { text: "*runs away crying*", dhivehi: false }
        ]
    },
    
    nunnu_hug: {
        speaker: "Nunnu",
        sprite: "üë©üèæ‚Äç‚öïÔ∏è",
        lines: [
            { text: "*hugs back tightly*", dhivehi: false },
            { text: "Aharen missed kaley so much, Kipal.", dhivehi: true },
            { text: "Promise me... promise kaley won't die in this life.", dhivehi: true },
            { text: "Mashakah can't lose another family member.", dhivehi: true },
            { text: "Abuch is gone. Don't make mashakah bury kaley too.", dhivehi: true }
        ]
    },
    
    jabibe_bribe: {
        speaker: "MP Jabibe",
        sprite: "ü§ë",
        lines: [
            { text: "Ah, the young gangster. Mashakah heard about kaley.", dhivehi: true },
            { text: "Politics and crime... same business, different suits.", dhivehi: false },
            { text: "Mashakah need... muscle. For the election.", dhivehi: true },
            { text: "5000 rufiyaa per job. Intimidate opposition voters.", dhivehi: false },
            { text: "Nothing violent. Just... persuasion.", dhivehi: false }
        ],
        choices: [
            { text: "Faisaa is faisaa. Aharen do it.", karma: -20, familyKarma: -10, response: "jabibe_accept" },
            { text: "Aharen criminal, not politician's dog.", karma: 10, response: "jabibe_refuse" },
            { text: "10,000 or nothing.", karma: -5, response: "jabibe_negotiate" }
        ]
    },
    
    jabibe_accept: {
        speaker: "MP Jabibe",
        sprite: "ü§ë",
        lines: [
            { text: "*smiles* Excellent. Kaley smart.", dhivehi: true },
            { text: "Here's the list. These people vote MDP. Make them... reconsider.", dhivehi: false },
            { text: "No killing. Just fear. Fear wins elections.", dhivehi: false },
            { text: "Do this well, and mashakah have more work for kaley.", dhivehi: true }
        ]
    },
    
    jabibe_refuse: {
        speaker: "MP Jabibe",
        sprite: "ü§ë",
        lines: [
            { text: "*frowns* Kaley making a mistake.", dhivehi: true },
            { text: "Mashakah can make kaley life very difficult.", dhivehi: true },
            { text: "Police, judges, prison guards... all on mashakah payroll.", dhivehi: false },
            { text: "Think carefully before refusing again.", dhivehi: false }
        ]
    },
    
    jabibe_negotiate: {
        speaker: "MP Jabibe",
        sprite: "ü§ë",
        lines: [
            { text: "*laughs* Kaley got nerve. Aharen like that.", dhivehi: true },
            { text: "Fine. 8000. But kaley better deliver results.", dhivehi: false },
            { text: "One mistake and mashakah cut kaley loose. Understood?", dhivehi: true }
        ]
    }
};

// ==================== ACT 2 RADIO CONTENT ====================
const ACT2_RADIO = {
    raajjeFM: {
        name: "üìª Raajje FM",
        segments: [
            { type: "news", text: "Election season! PNC promises 'law and order' while hiring gang security..." },
            { type: "news", text: "Drug seizure at port! 50kg heroin. Police: 'Biggest bust ever!' (Masodi shipment untouched)" },
            { type: "satire", text: "MP Jabibe: 'I've never met a gangster!' *photo surfaces with Masodi leaders*" },
            { type: "news", text: "Gang violence up 40%. Government: 'Fake news from opposition!'" },
            { type: "ad", text: "Visit Galolhu! Historic sites, culture, and definitely no gang headquarters!" },
            { type: "satire", text: "Police Commissioner: 'We're winning the war on gangs!' *gang membership increases*" },
            { type: "news", text: "Mal√© Sharks and Kuda Henveiru clash. 3 hospitalized. Police: 'Personal dispute.'" }
        ]
    },
    undergroundFM: {
        name: "üìª Underground FM",
        segments: [
            { type: "truth", text: "Real talk: Politicians fund gangs. Gangs fund politicians. Circle of corruption." },
            { type: "truth", text: "Jabibe's mansion? Built with drug money. Everyone knows. No one acts." },
            { type: "truth", text: "Rippoo the Razor... remember that name. She's why Sharks rule Galolhu." },
            { type: "truth", text: "Baokalo rising fast. Too fast. Someone's gonna clip his wings." },
            { type: "music", text: "‚ô™ Playing: 'Mal√© Nights' - Street anthem ‚ô™" }
        ]
    }
};

// ==================== HEIST PLANNING SYSTEM ====================
const HEIST_PLANS = {
    portHeist: {
        name: "Port Heist",
        location: "smugglersDock",
        approaches: [
            {
                name: "Stealth",
                description: "Sneak in at night, avoid guards, grab shipment",
                requirements: { stealth: 3 },
                risks: { detection: 0.3, combat: 0.1 },
                rewards: { money: 1200, karma: -10 }
            },
            {
                name: "Bribe",
                description: "Pay off the dock workers to look away",
                requirements: { charisma: 3, money: 500 },
                risks: { detection: 0.1, betrayal: 0.2 },
                rewards: { money: 800, karma: -5 }
            },
            {
                name: "Assault",
                description: "Go in guns blazing, take everything",
                requirements: { combat: 4 },
                risks: { detection: 0.9, combat: 0.8, police: 0.5 },
                rewards: { money: 1500, karma: -25 }
            }
        ]
    }
};

// ==================== GANG RECRUITMENT SYSTEM ====================
const RECRUITMENT = {
    requirements: {
        basic: { charisma: 1, reputation: 10 },
        skilled: { charisma: 2, reputation: 25, money: 200 },
        elite: { charisma: 3, reputation: 50, money: 500 }
    },
    
    recruits: [
        { name: "Street Kid", type: "basic", combat: 1, stealth: 2, loyalty: 0.6 },
        { name: "Ex-Fisherman", type: "basic", combat: 2, stealth: 1, loyalty: 0.7 },
        { name: "Dropout", type: "basic", combat: 1, stealth: 1, loyalty: 0.5 },
        { name: "Former Soldier", type: "skilled", combat: 4, stealth: 2, loyalty: 0.8 },
        { name: "Hacker", type: "skilled", combat: 1, stealth: 3, loyalty: 0.6 },
        { name: "Driver", type: "skilled", combat: 2, stealth: 2, loyalty: 0.7 },
        { name: "Assassin", type: "elite", combat: 5, stealth: 4, loyalty: 0.5 },
        { name: "Corrupt Cop", type: "elite", combat: 3, stealth: 3, loyalty: 0.4 }
    ]
};

// ==================== EXPORT FOR MAIN GAME ====================
if (typeof module !== 'undefined' && module.exports) {
    module.exports = {
        ACT2_MAPS,
        ACT2_CHARACTERS,
        ACT2_MISSIONS,
        ACT2_SIDE_MISSIONS,
        ACT2_DIALOGUES,
        ACT2_RADIO,
        HEIST_PLANS,
        RECRUITMENT
    };
}

// Add to global scope for browser
if (typeof window !== 'undefined') {
    window.ACT2_MAPS = ACT2_MAPS;
    window.ACT2_CHARACTERS = ACT2_CHARACTERS;
    window.ACT2_MISSIONS = ACT2_MISSIONS;
    window.ACT2_SIDE_MISSIONS = ACT2_SIDE_MISSIONS;
    window.ACT2_DIALOGUES = ACT2_DIALOGUES;
    window.ACT2_RADIO = ACT2_RADIO;
    window.HEIST_PLANS = HEIST_PLANS;
    window.RECRUITMENT = RECRUITMENT;
}


// ========== act3.js ==========
// ============================================
// ACT 3: SYNTHETIC SURGE
// Timeline: 2017 - Drug empire expansion
// ============================================

// ==================== ACT 3 MAPS ====================
const ACT3_MAPS = {
    hulhumale_phase1: {
        name: "Hulhumal√© Phase 1",
        width: 70,
        height: 55,
        spawnX: 35,
        spawnY: 45,
        tiles: [],
        npcs: [],
        items: [],
        zones: {
            centralPark: { x: 30, y: 20, w: 15, h: 12, name: "Central Park üå≥" },
            beachFront: { x: 0, y: 45, w: 70, h: 10, name: "Beach Front üèñÔ∏è" },
            constructionZone: { x: 50, y: 10, w: 15, h: 20, name: "Construction Zone üèóÔ∏è" },
            apartmentBlocks: { x: 10, y: 15, w: 18, h: 15, name: "Apartment Blocks üè¢" },
            drugLab: { x: 55, y: 35, w: 10, h: 8, name: "Hidden Lab üß™" },
            ferry: { x: 0, y: 25, w: 8, h: 10, name: "Ferry Terminal üö¢" }
        },
        gangTerritory: null,
        isNewCity: true,
        gridLayout: true
    },
    
    hulhumale_phase2: {
        name: "Hulhumal√© Phase 2",
        width: 80,
        height: 60,
        spawnX: 40,
        spawnY: 50,
        tiles: [],
        npcs: [],
        items: [],
        zones: {
            luxuryApartments: { x: 20, y: 15, w: 20, h: 15, name: "Luxury Towers üèôÔ∏è" },
            industrialZone: { x: 55, y: 20, w: 20, h: 20, name: "Industrial Zone üè≠" },
            megaLab: { x: 60, y: 25, w: 12, h: 10, name: "Mega Lab üß™" },
            yacht: { x: 5, y: 40, w: 10, h: 15, name: "Yacht Club ‚õµ" },
            airportLink: { x: 70, y: 45, w: 10, h: 10, name: "Airport Link üõ´" }
        },
        gangTerritory: "Synthetic Syndicate",
        isNewCity: true,
        gridLayout: true
    },
    
    velana_airport: {
        name: "Velana International Airport",
        width: 60,
        height: 50,
        spawnX: 30,
        spawnY: 40,
        tiles: [],
        npcs: [],
        items: [],
        zones: {
            terminal: { x: 20, y: 15, w: 25, h: 15, name: "Terminal üõ´" },
            runway: { x: 5, y: 35, w: 50, h: 8, name: "Runway ‚úàÔ∏è" },
            cargoArea: { x: 45, y: 10, w: 12, h: 12, name: "Cargo Area üì¶" },
            seaplaneTerminal: { x: 5, y: 10, w: 12, h: 12, name: "Seaplane Terminal üõ©Ô∏è" },
            dhodhoOffice: { x: 48, y: 15, w: 6, h: 6, name: "DhoDho's Office üë®üèæ‚Äç‚úàÔ∏è" }
        },
        gangTerritory: null,
        smugglingHub: true
    }
};

// ==================== ACT 3 CHARACTERS ====================
const ACT3_CHARACTERS = {
    dhodho: {
        name: "DhoDho (Uncle)",
        sprite: "üë®üèæ‚Äç‚úàÔ∏è",
        role: "Airport Customs Officer / Smuggling Contact",
        backstory: "Rippoo's brother. Corrupt customs officer who looks the other way for family. Key to drug import operations.",
        dialogues: {
            first_meeting: {
                speaker: "DhoDho",
                sprite: "üë®üèæ‚Äç‚úàÔ∏è",
                lines: [
                    { text: "Kipal! Mashakah nephew! Come, come!", dhivehi: true },
                    { text: "*looks around nervously* Rippoo told me about kaley.", dhivehi: true },
                    { text: "Aharen work customs 15 years. Know every trick.", dhivehi: true },
                    { text: "Kaley need something... imported? Aharen can help.", dhivehi: true },
                    { text: "But family discount only. 20% cut.", dhivehi: true }
                ],
                choices: [
                    { text: "Aharen need chemicals. For... business.", karma: -15, response: "dhodho_chemicals" },
                    { text: "Just visiting uncle. No business today.", karma: 5, response: "dhodho_innocent" },
                    { text: "What else can kaley smuggle?", karma: -10, response: "dhodho_options" }
                ]
            }
        }
    },
    
    syntheticBoss: {
        name: "Dr. Waheed (The Chemist)",
        sprite: "üßëüèæ‚Äçüî¨",
        role: "Synthetic Drug Manufacturer",
        backstory: "Former pharmaceutical researcher. Now cooks meth and synthetic drugs in Hulhumal√©. Genius but unstable.",
        dialogues: {
            lab_intro: {
                speaker: "Dr. Waheed",
                sprite: "üßëüèæ‚Äçüî¨",
                lines: [
                    { text: "*adjusts goggles* Ah, the famous Baokalo.", dhivehi: false },
                    { text: "Kaley want to make real faisaa? Not street corner beys.", dhivehi: true },
                    { text: "Synthetic. Pure. 10x profit margin.", dhivehi: false },
                    { text: "Aharen need distribution. Kaley need product.", dhivehi: true },
                    { text: "Partnership? 50-50 split.", dhivehi: false }
                ],
                choices: [
                    { text: "Aharen in. Show me the lab.", karma: -25, familyKarma: -20, response: "waheed_accept" },
                    { text: "Synthetic kills people. Aharen won't touch it.", karma: 20, familyKarma: 15, response: "waheed_refuse" },
                    { text: "60-40. Aharen take the risk.", karma: -20, response: "waheed_negotiate" }
                ]
            }
        }
    },
    
    cryptoBro: {
        name: "Crypto Maldives",
        sprite: "üí∞",
        role: "Money Launderer / Crypto Trader",
        backstory: "Tech entrepreneur who launders drug money through cryptocurrency. Runs 'legitimate' trading platform.",
        dialogues: {
            crypto_intro: {
                speaker: "Crypto Maldives",
                sprite: "üí∞",
                lines: [
                    { text: "Bro! Kaley heard of Bitcoin? Ethereum?", dhivehi: true },
                    { text: "Forget cash. Digital faisaa is future!", dhivehi: true },
                    { text: "Mashakah can clean kaley money. Untraceable.", dhivehi: true },
                    { text: "Small fee - 15%. But kaley money becomes... legitimate.", dhivehi: false },
                    { text: "Politicians use mashakah service. Very safe.", dhivehi: true }
                ],
                choices: [
                    { text: "Show me how it works.", karma: -10, response: "crypto_tutorial" },
                    { text: "Sounds like a scam.", karma: 5, response: "crypto_skeptic" },
                    { text: "Can aharen invest dirty faisaa?", karma: -15, response: "crypto_invest" }
                ]
            }
        }
    },
    
    mooizbe: {
        name: "President Mooizbe",
        sprite: "ü§¥üèæ",
        role: "President of Maldives (2023-)",
        backstory: "Muizzu-inspired character. Pro-China, anti-India. Uses gangs for political control while publicly denying their existence.",
        dialogues: {
            political_meeting: {
                speaker: "President Mooizbe",
                sprite: "ü§¥üèæ",
                lines: [
                    { text: "*in presidential office* So... kaley the one causing trouble.", dhivehi: true },
                    { text: "Gangs don't exist in Raajje. Officially.", dhivehi: false },
                    { text: "But unofficially... mashakah need people like kaley.", dhivehi: true },
                    { text: "Opposition getting loud. Elections coming.", dhivehi: false },
                    { text: "Help mashakah... and aharen make kaley problems disappear.", dhivehi: true }
                ],
                choices: [
                    { text: "What do kaley need, Mr. President?", karma: -20, response: "mooizbe_accept" },
                    { text: "Aharen don't work for politicians.", karma: 15, response: "mooizbe_refuse" },
                    { text: "How much protection can kaley offer?", karma: -10, response: "mooizbe_negotiate" }
                ]
            }
        }
    },
    
    hulhumaleGangLeader: {
        name: "Phase 2 Boss",
        sprite: "üèóÔ∏è",
        role: "Hulhumal√© Construction Mafia",
        backstory: "Controls construction contracts and worker exploitation. Uses migrant workers as drug mules.",
        dialogues: {
            territory_dispute: {
                speaker: "Phase 2 Boss",
                sprite: "üèóÔ∏è",
                lines: [
                    { text: "Kaley think can just walk into Hulhumal√©?", dhivehi: true },
                    { text: "This is mashakah territory. Every building, every worker.", dhivehi: true },
                    { text: "Mal√© gangs stay in Mal√©. Understood?", dhivehi: false },
                    { text: "*cracks knuckles* Or mashakah bury kaley in concrete.", dhivehi: true }
                ],
                choices: [
                    { text: "Aharen not here to fight. Let's talk business.", karma: 0, response: "phase2_negotiate" },
                    { text: "Mal√© gangs go wherever we want.", karma: -10, response: "phase2_challenge" },
                    { text: "[Attack]", karma: -20, combat: true, response: "phase2_attack" }
                ]
            }
        }
    }
};

// ==================== ACT 3 MISSIONS ====================
const ACT3_MISSIONS = [
    {
        id: "act3_m1",
        title: "New Horizons",
        type: "exploration",
        description: "Take the ferry to Hulhumal√©",
        objectives: [
            { type: "travel", target: "hulhumale_phase1", current: false },
            { type: "discover", target: "centralPark", current: false },
            { type: "discover", target: "beachFront", current: false }
        ],
        rewards: { money: 300 },
        unlocks: ["act3_m2"]
    },
    {
        id: "act3_m2",
        title: "Uncle's Connections",
        type: "story",
        description: "Meet Uncle DhoDho at the airport",
        objectives: [
            { type: "travel", target: "velana_airport", current: false },
            { type: "trigger", target: "dhodhoMeeting", current: false }
        ],
        rewards: { money: 500 },
        dialogueStart: "dhodho_first_meeting",
        unlocks: ["act3_m3", "act3_m4"],
        setFlag: "metDhodho"
    },
    {
        id: "act3_m3",
        title: "Chemical Import",
        type: "smuggling",
        description: "Help DhoDho smuggle chemicals through customs",
        objectives: [
            { type: "stealth", target: "cargoArea", current: false },
            { type: "collect", target: "chemicalBarrel", count: 3, current: 0 },
            { type: "deliver", target: "drugLab", current: false }
        ],
        rewards: { money: 2000, karma: -20 },
        unlocks: ["act3_m5"],
        requiresChoice: "dhodho_chemicals"
    },
    {
        id: "act3_m4",
        title: "Legitimate Business",
        type: "delivery",
        description: "Help DhoDho with legal cargo (cover story)",
        objectives: [
            { type: "collect", target: "legalCargo", count: 5, current: 0 },
            { type: "deliver", target: "apartmentBlocks", current: false }
        ],
        rewards: { money: 500, karma: 5 },
        unlocks: ["act3_m5"],
        requiresChoice: "dhodho_innocent"
    },
    {
        id: "act3_m5",
        title: "The Chemist",
        type: "story",
        description: "Meet Dr. Waheed at the hidden lab",
        objectives: [
            { type: "travel", target: "drugLab", current: false },
            { type: "trigger", target: "waheedMeeting", current: false }
        ],
        rewards: { money: 0 },
        dialogueStart: "waheed_lab_intro",
        unlocks: ["act3_m6", "act3_m7"],
        moralChoice: true,
        majorChoice: "synthetic"
    },
    {
        id: "act3_m6",
        title: "Cook's Apprentice",
        type: "minigame",
        description: "Learn to cook synthetic drugs",
        objectives: [
            { type: "minigame", target: "drugCooking", current: false }
        ],
        rewards: { money: 3000, karma: -30 },
        unlocks: ["act3_m8"],
        requiresChoice: "waheed_accept"
    },
    {
        id: "act3_m7",
        title: "Sabotage",
        type: "stealth",
        description: "Destroy the drug lab",
        objectives: [
            { type: "plant", target: "explosives", count: 3, current: 0 },
            { type: "escape", target: "safeDistance", current: false }
        ],
        rewards: { money: 500, karma: 25, familyKarma: 20 },
        unlocks: ["act3_m8"],
        requiresChoice: "waheed_refuse"
    },
    {
        id: "act3_m8",
        title: "Phase 2 Problems",
        type: "story",
        description: "Confront the Hulhumal√© construction boss",
        objectives: [
            { type: "travel", target: "hulhumale_phase2", current: false },
            { type: "trigger", target: "phase2Meeting", current: false }
        ],
        rewards: { money: 0 },
        dialogueStart: "phase2_territory_dispute",
        unlocks: ["act3_m9", "act3_m10"]
    },
    {
        id: "act3_m9",
        title: "Hostile Takeover",
        type: "combat",
        description: "Fight for Hulhumal√© territory",
        objectives: [
            { type: "defeat", target: "constructionThug", count: 10, current: 0 },
            { type: "capture", target: "industrialZone", current: false }
        ],
        rewards: { money: 4000, karma: -25, reputation: { hulhumaleGang: -50 } },
        unlocks: ["act3_m11"],
        requiresChoice: "phase2_challenge"
    },
    {
        id: "act3_m10",
        title: "Business Partners",
        type: "negotiation",
        description: "Negotiate territory split with Phase 2 Boss",
        objectives: [
            { type: "charisma", target: "phase2Boss", current: false },
            { type: "pay", target: "tribute", amount: 5000, current: false }
        ],
        rewards: { money: -5000, karma: 0, reputation: { hulhumaleGang: 20 } },
        unlocks: ["act3_m11"],
        requiresChoice: "phase2_negotiate"
    },
    {
        id: "act3_m11",
        title: "Crypto Clean",
        type: "story",
        description: "Meet the crypto money launderer",
        objectives: [
            { type: "travel", target: "luxuryApartments", current: false },
            { type: "trigger", target: "cryptoMeeting", current: false }
        ],
        rewards: { money: 0 },
        dialogueStart: "crypto_intro",
        unlocks: ["act3_m12"]
    },
    {
        id: "act3_m12",
        title: "Trading Tutorial",
        type: "minigame",
        description: "Learn crypto trading to launder money",
        objectives: [
            { type: "minigame", target: "cryptoTrading", current: false },
            { type: "earn", target: "cryptoProfit", amount: 1000, current: 0 }
        ],
        rewards: { money: 2000, karma: -15 },
        unlocks: ["act3_m13"]
    },
    {
        id: "act3_m13",
        title: "Presidential Summons",
        type: "story",
        description: "President Mooizbe wants to meet",
        objectives: [
            { type: "travel", target: "presidentialPalace", current: false },
            { type: "trigger", target: "mooizbeMeeting", current: false }
        ],
        rewards: { money: 0 },
        dialogueStart: "mooizbe_political_meeting",
        unlocks: ["act3_m14", "act3_m15"],
        moralChoice: true,
        majorChoice: "political"
    },
    {
        id: "act3_m14",
        title: "Opposition Silencer",
        type: "intimidation",
        description: "Silence opposition journalists",
        objectives: [
            { type: "intimidate", target: "journalist", count: 3, current: 0 },
            { type: "destroy", target: "evidence", current: false }
        ],
        rewards: { money: 10000, karma: -35, familyKarma: -25 },
        unlocks: ["act3_climax"],
        requiresChoice: "mooizbe_accept"
    },
    {
        id: "act3_m15",
        title: "Whistleblower",
        type: "stealth",
        description: "Leak evidence of government corruption",
        objectives: [
            { type: "steal", target: "corruptionFiles", current: false },
            { type: "deliver", target: "foreignJournalist", current: false }
        ],
        rewards: { money: 1000, karma: 30, familyKarma: 20 },
        unlocks: ["act3_climax"],
        requiresChoice: "mooizbe_refuse"
    },
    {
        id: "act3_climax",
        title: "The Bust",
        type: "combat",
        description: "Police raid the mega lab - escape or fight",
        objectives: [
            { type: "survive", target: "policeRaid", duration: 120, current: 0 },
            { type: "escape", target: "yacht", current: false }
        ],
        rewards: { money: 5000, karma: -20 },
        unlocks: ["act4_start"],
        actEnd: true,
        bossMusic: true
    }
];

// ==================== ACT 3 SIDE MISSIONS ====================
const ACT3_SIDE_MISSIONS = [
    { id: "side3_ferry1", title: "Ferry Smuggling I", type: "smuggling", reward: 500 },
    { id: "side3_ferry2", title: "Ferry Smuggling II", type: "smuggling", reward: 750 },
    { id: "side3_construction1", title: "Construction Sabotage", type: "sabotage", reward: 600 },
    { id: "side3_construction2", title: "Worker Recruitment", type: "recruitment", reward: 400 },
    { id: "side3_crypto1", title: "Day Trading I", type: "minigame", game: "crypto", reward: 300 },
    { id: "side3_crypto2", title: "Day Trading II", type: "minigame", game: "crypto", reward: 500 },
    { id: "side3_crypto3", title: "Whale Hunting", type: "minigame", game: "crypto", reward: 1000 },
    { id: "side3_airport1", title: "Cargo Heist", type: "heist", reward: 800 },
    { id: "side3_airport2", title: "VIP Escort", type: "escort", reward: 600 },
    { id: "side3_lab1", title: "Chemical Run I", type: "delivery", reward: 400 },
    { id: "side3_lab2", title: "Chemical Run II", type: "delivery", reward: 600 },
    { id: "side3_race1", title: "Hulhumal√© Street Race", type: "race", reward: 400 },
    { id: "side3_race2", title: "Airport Runway Race", type: "race", reward: 800 },
    { id: "side3_fight1", title: "Construction Yard Brawl", type: "fight", enemies: 8, reward: 500 },
    { id: "side3_fishing", title: "Deep Sea Fishing", type: "minigame", game: "fishing", reward: 300 }
];

// ==================== ACT 3 DIALOGUES ====================
const ACT3_DIALOGUES = {
    dhodho_first_meeting: {
        speaker: "DhoDho",
        sprite: "üë®üèæ‚Äç‚úàÔ∏è",
        lines: [
            { text: "Kipal! Mashakah nephew! Come, come!", dhivehi: true },
            { text: "*looks around nervously* Rippoo told me about kaley.", dhivehi: true },
            { text: "Aharen work customs 15 years. Know every trick.", dhivehi: true },
            { text: "Kaley need something... imported? Aharen can help.", dhivehi: true },
            { text: "But family discount only. 20% cut.", dhivehi: true }
        ],
        choices: [
            { text: "Aharen need chemicals. For... business.", karma: -15, response: "dhodho_chemicals" },
            { text: "Just visiting uncle. No business today.", karma: 5, response: "dhodho_innocent" },
            { text: "What else can kaley smuggle?", karma: -10, response: "dhodho_options" }
        ]
    },
    
    dhodho_chemicals: {
        speaker: "DhoDho",
        sprite: "üë®üèæ‚Äç‚úàÔ∏è",
        lines: [
            { text: "*nods slowly* Chemicals. Aharen understand.", dhivehi: true },
            { text: "Precursors come from India. Labeled as 'cleaning supplies'.", dhivehi: false },
            { text: "Mashakah mark the containers. Kaley pick up at night.", dhivehi: true },
            { text: "Don't tell Rippoo. She'll kill us both.", dhivehi: true }
        ]
    },
    
    dhodho_innocent: {
        speaker: "DhoDho",
        sprite: "üë®üèæ‚Äç‚úàÔ∏è",
        lines: [
            { text: "*relieved* Good, good. Family first.", dhivehi: true },
            { text: "Kaley mother worries about kaley. Mashakah all do.", dhivehi: true },
            { text: "If kaley ever need help... legal help... aharen here.", dhivehi: true },
            { text: "Now come, let uncle show kaley the airport!", dhivehi: true }
        ]
    },
    
    dhodho_options: {
        speaker: "DhoDho",
        sprite: "üë®üèæ‚Äç‚úàÔ∏è",
        lines: [
            { text: "*grins* Kaley ambitious. Like mashakah.", dhivehi: true },
            { text: "Weapons from Pakistan. Luxury goods from Dubai.", dhivehi: false },
            { text: "Even people... if kaley know what aharen mean.", dhivehi: true },
            { text: "But that's dangerous. Very dangerous.", dhivehi: false },
            { text: "Start small. Build trust. Then we talk big business.", dhivehi: true }
        ]
    },
    
    waheed_lab_intro: {
        speaker: "Dr. Waheed",
        sprite: "üßëüèæ‚Äçüî¨",
        lines: [
            { text: "*adjusts goggles* Ah, the famous Baokalo.", dhivehi: false },
            { text: "Kaley want to make real faisaa? Not street corner beys.", dhivehi: true },
            { text: "Synthetic. Pure. 10x profit margin.", dhivehi: false },
            { text: "Aharen need distribution. Kaley need product.", dhivehi: true },
            { text: "Partnership? 50-50 split.", dhivehi: false }
        ],
        choices: [
            { text: "Aharen in. Show me the lab.", karma: -25, familyKarma: -20, response: "waheed_accept" },
            { text: "Synthetic kills people. Aharen won't touch it.", karma: 20, familyKarma: 15, response: "waheed_refuse" },
            { text: "60-40. Aharen take the risk.", karma: -20, response: "waheed_negotiate" }
        ]
    },
    
    waheed_accept: {
        speaker: "Dr. Waheed",
        sprite: "üßëüèæ‚Äçüî¨",
        lines: [
            { text: "*excited* Excellent! Come, come!", dhivehi: false },
            { text: "*shows lab equipment* This is where magic happens.", dhivehi: false },
            { text: "Methylamine, pseudoephedrine, red phosphorus...", dhivehi: false },
            { text: "Kaley don't need to understand. Just distribute.", dhivehi: true },
            { text: "First batch ready in 48 hours. Be ready.", dhivehi: false }
        ]
    },
    
    waheed_refuse: {
        speaker: "Dr. Waheed",
        sprite: "üßëüèæ‚Äçüî¨",
        lines: [
            { text: "*laughs* Morals? In this business?", dhivehi: false },
            { text: "Kaley sell heroin but won't touch synthetic?", dhivehi: true },
            { text: "Hypocrite. But mashakah respect the choice.", dhivehi: true },
            { text: "Just know... if kaley not with us, kaley against us.", dhivehi: false },
            { text: "Choose wisely, Baokalo.", dhivehi: false }
        ]
    },
    
    waheed_negotiate: {
        speaker: "Dr. Waheed",
        sprite: "üßëüèæ‚Äçüî¨",
        lines: [
            { text: "*strokes chin* 60-40... kaley got balls.", dhivehi: true },
            { text: "Fine. But kaley handle ALL distribution risk.", dhivehi: false },
            { text: "Police, rivals, angry customers... kaley problem.", dhivehi: true },
            { text: "Aharen just cook. Deal?", dhivehi: false }
        ]
    },
    
    crypto_intro: {
        speaker: "Crypto Maldives",
        sprite: "üí∞",
        lines: [
            { text: "Bro! Kaley heard of Bitcoin? Ethereum?", dhivehi: true },
            { text: "Forget cash. Digital faisaa is future!", dhivehi: true },
            { text: "Mashakah can clean kaley money. Untraceable.", dhivehi: true },
            { text: "Small fee - 15%. But kaley money becomes... legitimate.", dhivehi: false },
            { text: "Politicians use mashakah service. Very safe.", dhivehi: true }
        ],
        choices: [
            { text: "Show me how it works.", karma: -10, response: "crypto_tutorial" },
            { text: "Sounds like a scam.", karma: 5, response: "crypto_skeptic" },
            { text: "Can aharen invest dirty faisaa?", karma: -15, response: "crypto_invest" }
        ]
    },
    
    crypto_tutorial: {
        speaker: "Crypto Maldives",
        sprite: "üí∞",
        lines: [
            { text: "Simple! Kaley give mashakah rufiyaa.", dhivehi: true },
            { text: "Mashakah buy Bitcoin. Send to mixer.", dhivehi: false },
            { text: "Mixer scrambles everything. Untraceable!", dhivehi: false },
            { text: "Then convert back to clean faisaa.", dhivehi: true },
            { text: "Want to try? Start with 10,000.", dhivehi: true }
        ]
    },
    
    crypto_skeptic: {
        speaker: "Crypto Maldives",
        sprite: "üí∞",
        lines: [
            { text: "*offended* Scam?! Bro, this is TECHNOLOGY!", dhivehi: false },
            { text: "Mashakah made millions! Look at this apartment!", dhivehi: true },
            { text: "Fine, don't believe. Stay poor.", dhivehi: false },
            { text: "When kaley ready for real faisaa, call me.", dhivehi: true }
        ]
    },
    
    crypto_invest: {
        speaker: "Crypto Maldives",
        sprite: "üí∞",
        lines: [
            { text: "*eyes light up* NOW kaley talking!", dhivehi: true },
            { text: "Dirty faisaa becomes clean profit!", dhivehi: true },
            { text: "Mashakah show kaley the trading screen.", dhivehi: true },
            { text: "Buy low, sell high. Simple!", dhivehi: false },
            { text: "But careful - market can crash. Kaley warned.", dhivehi: true }
        ]
    },
    
    mooizbe_political_meeting: {
        speaker: "President Mooizbe",
        sprite: "ü§¥üèæ",
        lines: [
            { text: "*in presidential office* So... kaley the one causing trouble.", dhivehi: true },
            { text: "Gangs don't exist in Raajje. Officially.", dhivehi: false },
            { text: "But unofficially... mashakah need people like kaley.", dhivehi: true },
            { text: "Opposition getting loud. Elections coming.", dhivehi: false },
            { text: "Help mashakah... and aharen make kaley problems disappear.", dhivehi: true }
        ],
        choices: [
            { text: "What do kaley need, Mr. President?", karma: -20, response: "mooizbe_accept" },
            { text: "Aharen don't work for politicians.", karma: 15, response: "mooizbe_refuse" },
            { text: "How much protection can kaley offer?", karma: -10, response: "mooizbe_negotiate" }
        ]
    },
    
    mooizbe_accept: {
        speaker: "President Mooizbe",
        sprite: "ü§¥üèæ",
        lines: [
            { text: "*smiles coldly* Smart choice.", dhivehi: false },
            { text: "There are journalists. Asking questions.", dhivehi: false },
            { text: "About gangs. About drugs. About... mashakah.", dhivehi: true },
            { text: "Make them stop asking. Permanently if needed.", dhivehi: false },
            { text: "Do this, and kaley untouchable. Police, courts... all mine.", dhivehi: true }
        ]
    },
    
    mooizbe_refuse: {
        speaker: "President Mooizbe",
        sprite: "ü§¥üèæ",
        lines: [
            { text: "*face hardens* Kaley making a mistake.", dhivehi: true },
            { text: "Aharen control everything. Police. Military. Courts.", dhivehi: false },
            { text: "One word from mashakah and kaley in Dhoonidhoo forever.", dhivehi: true },
            { text: "Think carefully. Door is still open.", dhivehi: false },
            { text: "For now.", dhivehi: false }
        ]
    },
    
    mooizbe_negotiate: {
        speaker: "President Mooizbe",
        sprite: "ü§¥üèæ",
        lines: [
            { text: "*chuckles* Businessman. Aharen like that.", dhivehi: true },
            { text: "Full immunity. No arrests, no trials.", dhivehi: false },
            { text: "Kaley operations... invisible to law.", dhivehi: true },
            { text: "But kaley must be loyal. Completely.", dhivehi: false },
            { text: "Betray mashakah... and kaley family pays.", dhivehi: true }
        ]
    },
    
    phase2_territory_dispute: {
        speaker: "Phase 2 Boss",
        sprite: "üèóÔ∏è",
        lines: [
            { text: "Kaley think can just walk into Hulhumal√©?", dhivehi: true },
            { text: "This is mashakah territory. Every building, every worker.", dhivehi: true },
            { text: "Mal√© gangs stay in Mal√©. Understood?", dhivehi: false },
            { text: "*cracks knuckles* Or mashakah bury kaley in concrete.", dhivehi: true }
        ],
        choices: [
            { text: "Aharen not here to fight. Let's talk business.", karma: 0, response: "phase2_negotiate" },
            { text: "Mal√© gangs go wherever we want.", karma: -10, response: "phase2_challenge" },
            { text: "[Attack]", karma: -20, combat: true, response: "phase2_attack" }
        ]
    },
    
    phase2_negotiate: {
        speaker: "Phase 2 Boss",
        sprite: "üèóÔ∏è",
        lines: [
            { text: "*pauses* Business? Kaley got faisaa?", dhivehi: true },
            { text: "5000 rufiyaa. Monthly tribute.", dhivehi: false },
            { text: "Kaley can operate in Phase 1. Stay out of Phase 2.", dhivehi: true },
            { text: "Deal?", dhivehi: false }
        ]
    },
    
    phase2_challenge: {
        speaker: "Phase 2 Boss",
        sprite: "üèóÔ∏è",
        lines: [
            { text: "*laughs* Kaley got death wish!", dhivehi: true },
            { text: "BOYS! We got a Mal√© rat!", dhivehi: true },
            { text: "*pulls out rebar* Let's show him Hulhumal√© hospitality!", dhivehi: false }
        ]
    },
    
    phase2_attack: {
        speaker: "Phase 2 Boss",
        sprite: "üèóÔ∏è",
        lines: [
            { text: "*surprised* Kaley sodu‚Äî!", dhivehi: true }
        ]
    }
};

// ==================== ACT 3 RADIO CONTENT ====================
const ACT3_RADIO = {
    raajjeFM: {
        name: "üìª Raajje FM",
        segments: [
            { type: "news", text: "Hulhumal√© development continues! New apartments for 'affordable' 5 million rufiyaa!" },
            { type: "news", text: "Drug bust at airport! 10kg seized! (100kg got through...)" },
            { type: "satire", text: "President Mooizbe: 'India Out!' Also Mooizbe: 'Why won't India help us?'" },
            { type: "news", text: "Cryptocurrency boom! Young Maldivians becoming 'millionaires' (on paper)" },
            { type: "ad", text: "Invest in Hulhumal√©! Where dreams come true! (Terms and conditions apply)" },
            { type: "satire", text: "Construction worker falls from building. Company: 'He was taking selfie.'" },
            { type: "news", text: "Synthetic drug deaths up 300%. Government: 'Fake news!'" }
        ]
    },
    undergroundFM: {
        name: "üìª Underground FM",
        segments: [
            { type: "truth", text: "Hulhumal√© built on migrant worker blood. 50 deaths 'unreported.'" },
            { type: "truth", text: "Airport customs? Biggest smuggling operation in Maldives." },
            { type: "truth", text: "Mooizbe's brother owns construction company. Coincidence?" },
            { type: "truth", text: "Crypto 'millionaires' can't cash out. It's all fake." },
            { type: "music", text: "‚ô™ Playing: 'Concrete Jungle' - Hulhumal√© anthem ‚ô™" }
        ]
    }
};

// ==================== CRYPTO TRADING MINI-GAME ====================
let cryptoGame = {
    active: false,
    balance: 0,
    holdings: { BTC: 0, ETH: 0, DOGE: 0 },
    prices: { BTC: 50000, ETH: 3000, DOGE: 0.1 },
    priceHistory: { BTC: [], ETH: [], DOGE: [] },
    timer: 60,
    profit: 0
};

function startCryptoGame(startingBalance) {
    cryptoGame.active = true;
    cryptoGame.balance = startingBalance || 10000;
    cryptoGame.holdings = { BTC: 0, ETH: 0, DOGE: 0 };
    cryptoGame.prices = { BTC: 50000, ETH: 3000, DOGE: 0.1 };
    cryptoGame.priceHistory = { BTC: [50000], ETH: [3000], DOGE: [0.1] };
    cryptoGame.timer = 60;
    cryptoGame.profit = 0;
    GameState.isInMinigame = true;
    
    document.getElementById('minigame-overlay').classList.remove('hidden');
    document.getElementById('minigame-title').textContent = 'üí∞ Crypto Trading';
    
    // Start price fluctuation
    const priceInterval = setInterval(() => {
        if (!cryptoGame.active) {
            clearInterval(priceInterval);
            return;
        }
        updateCryptoPrices();
    }, 1000);
    
    // Start timer
    const timerInterval = setInterval(() => {
        cryptoGame.timer--;
        if (cryptoGame.timer <= 0 || !cryptoGame.active) {
            clearInterval(timerInterval);
            if (cryptoGame.active) endCryptoGame();
        }
    }, 1000);
    
    document.addEventListener('keydown', cryptoKeyHandler);
    requestAnimationFrame(cryptoLoop);
}

function updateCryptoPrices() {
    // Random price fluctuation
    for (let coin in cryptoGame.prices) {
        const change = (Math.random() - 0.48) * 0.1; // Slight upward bias
        cryptoGame.prices[coin] *= (1 + change);
        cryptoGame.prices[coin] = Math.max(0.01, cryptoGame.prices[coin]);
        
        cryptoGame.priceHistory[coin].push(cryptoGame.prices[coin]);
        if (cryptoGame.priceHistory[coin].length > 30) {
            cryptoGame.priceHistory[coin].shift();
        }
    }
}

function cryptoKeyHandler(e) {
    if (!cryptoGame.active) return;
    
    const buyAmount = 1000;
    
    switch(e.key) {
        case '1': // Buy BTC
            if (cryptoGame.balance >= buyAmount) {
                cryptoGame.balance -= buyAmount;
                cryptoGame.holdings.BTC += buyAmount / cryptoGame.prices.BTC;
            }
            break;
        case '2': // Buy ETH
            if (cryptoGame.balance >= buyAmount) {
                cryptoGame.balance -= buyAmount;
                cryptoGame.holdings.ETH += buyAmount / cryptoGame.prices.ETH;
            }
            break;
        case '3': // Buy DOGE
            if (cryptoGame.balance >= buyAmount) {
                cryptoGame.balance -= buyAmount;
                cryptoGame.holdings.DOGE += buyAmount / cryptoGame.prices.DOGE;
            }
            break;
        case 'q': // Sell BTC
            if (cryptoGame.holdings.BTC > 0) {
                cryptoGame.balance += cryptoGame.holdings.BTC * cryptoGame.prices.BTC;
                cryptoGame.holdings.BTC = 0;
            }
            break;
        case 'w': // Sell ETH
            if (cryptoGame.holdings.ETH > 0) {
                cryptoGame.balance += cryptoGame.holdings.ETH * cryptoGame.prices.ETH;
                cryptoGame.holdings.ETH = 0;
            }
            break;
        case 'e': // Sell DOGE
            if (cryptoGame.holdings.DOGE > 0) {
                cryptoGame.balance += cryptoGame.holdings.DOGE * cryptoGame.prices.DOGE;
                cryptoGame.holdings.DOGE = 0;
            }
            break;
    }
}

function cryptoLoop() {
    if (!cryptoGame.active) return;
    
    const ctx = minigameCtx;
    const width = minigameCanvas.width;
    const height = minigameCanvas.height;
    
    // Clear
    ctx.fillStyle = '#0a0a1a';
    ctx.fillRect(0, 0, width, height);
    
    // Timer
    ctx.fillStyle = cryptoGame.timer > 15 ? '#fff' : '#ff0000';
    ctx.font = 'bold 14px Arial';
    ctx.textAlign = 'right';
    ctx.fillText(`Time: ${cryptoGame.timer}s`, width - 10, 20);
    
    // Balance
    ctx.fillStyle = '#00ff00';
    ctx.textAlign = 'left';
    ctx.fillText(`Balance: $${cryptoGame.balance.toFixed(2)}`, 10, 20);
    
    // Calculate total value
    let totalValue = cryptoGame.balance;
    for (let coin in cryptoGame.holdings) {
        totalValue += cryptoGame.holdings[coin] * cryptoGame.prices[coin];
    }
    ctx.fillText(`Total: $${totalValue.toFixed(2)}`, 10, 38);
    
    // Draw price charts
    const coins = ['BTC', 'ETH', 'DOGE'];
    const colors = ['#f7931a', '#627eea', '#c3a634'];
    const chartHeight = 60;
    const chartY = 55;
    
    coins.forEach((coin, index) => {
        const x = 10 + index * (width / 3 - 5);
        const chartWidth = width / 3 - 20;
        
        // Chart background
        ctx.fillStyle = '#1a1a2e';
        ctx.fillRect(x, chartY, chartWidth, chartHeight);
        
        // Price line
        const history = cryptoGame.priceHistory[coin];
        if (history.length > 1) {
            const minPrice = Math.min(...history);
            const maxPrice = Math.max(...history);
            const range = maxPrice - minPrice || 1;
            
            ctx.strokeStyle = colors[index];
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            history.forEach((price, i) => {
                const px = x + (i / (history.length - 1)) * chartWidth;
                const py = chartY + chartHeight - ((price - minPrice) / range) * chartHeight;
                if (i === 0) ctx.moveTo(px, py);
                else ctx.lineTo(px, py);
            });
            ctx.stroke();
        }
        
        // Coin name and price
        ctx.fillStyle = colors[index];
        ctx.font = 'bold 12px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(coin, x + chartWidth / 2, chartY + chartHeight + 15);
        ctx.fillStyle = '#fff';
        ctx.font = '10px Arial';
        ctx.fillText(`$${cryptoGame.prices[coin].toFixed(coin === 'DOGE' ? 4 : 0)}`, x + chartWidth / 2, chartY + chartHeight + 28);
        
        // Holdings
        ctx.fillStyle = '#aaa';
        ctx.fillText(`Own: ${cryptoGame.holdings[coin].toFixed(4)}`, x + chartWidth / 2, chartY + chartHeight + 40);
    });
    
    // Instructions
    ctx.fillStyle = '#778da9';
    ctx.font = '11px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('Press 1/2/3 to BUY $1000 of BTC/ETH/DOGE', width / 2, height - 35);
    ctx.fillText('Press Q/W/E to SELL ALL BTC/ETH/DOGE', width / 2, height - 20);
    
    requestAnimationFrame(cryptoLoop);
}

function endCryptoGame() {
    cryptoGame.active = false;
    GameState.isInMinigame = false;
    document.removeEventListener('keydown', cryptoKeyHandler);
    document.getElementById('minigame-overlay').classList.add('hidden');
    
    // Calculate final value
    let totalValue = cryptoGame.balance;
    for (let coin in cryptoGame.holdings) {
        totalValue += cryptoGame.holdings[coin] * cryptoGame.prices[coin];
    }
    
    const startingBalance = 10000;
    const profit = totalValue - startingBalance;
    
    if (profit > 0) {
        GameState.player.money += Math.floor(profit);
        showNotification('Trading Complete!', `Profit: +${Math.floor(profit)} faisaa üìà`);
    } else {
        showNotification('Trading Complete!', `Loss: ${Math.floor(profit)} faisaa üìâ`);
    }
    
    // Update mission objective
    if (profit >= 1000) {
        updateMissionObjective('earn', 'cryptoProfit', profit);
    }
}

// ==================== DRUG COOKING MINI-GAME ====================
let cookingGame = {
    active: false,
    temperature: 50,
    targetTemp: 75,
    purity: 0,
    timer: 45,
    stage: 0,
    stages: ['Mixing', 'Heating', 'Cooling', 'Crystallizing']
};

function startDrugCookingGame() {
    cookingGame.active = true;
    cookingGame.temperature = 50;
    cookingGame.targetTemp = 75;
    cookingGame.purity = 0;
    cookingGame.timer = 45;
    cookingGame.stage = 0;
    GameState.isInMinigame = true;
    
    document.getElementById('minigame-overlay').classList.remove('hidden');
    document.getElementById('minigame-title').textContent = 'üß™ Synthesis';
    
    // Timer
    const timerInterval = setInterval(() => {
        cookingGame.timer--;
        if (cookingGame.timer <= 0 || !cookingGame.active) {
            clearInterval(timerInterval);
            if (cookingGame.active) endCookingGame();
        }
    }, 1000);
    
    document.addEventListener('keydown', cookingKeyHandler);
    requestAnimationFrame(cookingLoop);
}

function cookingKeyHandler(e) {
    if (!cookingGame.active) return;
    
    if (e.key === 'ArrowUp' || e.key === 'w') {
        cookingGame.temperature = Math.min(100, cookingGame.temperature + 2);
    } else if (e.key === 'ArrowDown' || e.key === 's') {
        cookingGame.temperature = Math.max(0, cookingGame.temperature - 2);
    } else if (e.key === ' ') {
        // Check if temperature is in target range
        const diff = Math.abs(cookingGame.temperature - cookingGame.targetTemp);
        if (diff < 5) {
            cookingGame.purity += 25;
            cookingGame.stage++;
            
            if (cookingGame.stage >= cookingGame.stages.length) {
                endCookingGame();
                return;
            }
            
            // New target for next stage
            cookingGame.targetTemp = 40 + Math.random() * 50;
        }
    }
}

function cookingLoop() {
    if (!cookingGame.active) return;
    
    const ctx = minigameCtx;
    const width = minigameCanvas.width;
    const height = minigameCanvas.height;
    
    // Clear
    ctx.fillStyle = '#1a1a2e';
    ctx.fillRect(0, 0, width, height);
    
    // Timer
    ctx.fillStyle = cookingGame.timer > 10 ? '#fff' : '#ff0000';
    ctx.font = 'bold 16px Arial';
    ctx.textAlign = 'right';
    ctx.fillText(`Time: ${cookingGame.timer}s`, width - 10, 25);
    
    // Stage
    ctx.fillStyle = '#ffcc00';
    ctx.textAlign = 'left';
    ctx.fillText(`Stage: ${cookingGame.stages[cookingGame.stage]}`, 10, 25);
    
    // Purity
    ctx.fillStyle = '#00ff00';
    ctx.fillText(`Purity: ${cookingGame.purity}%`, 10, 45);
    
    // Temperature gauge
    const gaugeX = width / 2 - 100;
    const gaugeY = 70;
    const gaugeWidth = 200;
    const gaugeHeight = 30;
    
    // Background
    ctx.fillStyle = '#333';
    ctx.fillRect(gaugeX, gaugeY, gaugeWidth, gaugeHeight);
    
    // Target zone
    const targetX = gaugeX + (cookingGame.targetTemp / 100) * gaugeWidth;
    ctx.fillStyle = 'rgba(0, 255, 0, 0.3)';
    ctx.fillRect(targetX - 10, gaugeY, 20, gaugeHeight);
    
    // Current temperature
    const tempX = gaugeX + (cookingGame.temperature / 100) * gaugeWidth;
    ctx.fillStyle = cookingGame.temperature > 80 ? '#ff0000' : '#ff6600';
    ctx.fillRect(tempX - 3, gaugeY - 5, 6, gaugeHeight + 10);
    
    // Temperature labels
    ctx.fillStyle = '#fff';
    ctx.font = '12px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('0¬∞C', gaugeX, gaugeY + gaugeHeight + 15);
    ctx.fillText('50¬∞C', gaugeX + gaugeWidth / 2, gaugeY + gaugeHeight + 15);
    ctx.fillText('100¬∞C', gaugeX + gaugeWidth, gaugeY + gaugeHeight + 15);
    
    // Current temp display
    ctx.font = 'bold 24px Arial';
    ctx.fillText(`${Math.floor(cookingGame.temperature)}¬∞C`, width / 2, gaugeY + gaugeHeight + 50);
    
    // Target temp
    ctx.fillStyle = '#00ff00';
    ctx.font = '14px Arial';
    ctx.fillText(`Target: ${Math.floor(cookingGame.targetTemp)}¬∞C`, width / 2, gaugeY + gaugeHeight + 70);
    
    // Flask visualization
    ctx.fillStyle = '#4a90d9';
    ctx.beginPath();
    ctx.moveTo(width / 2 - 30, height - 100);
    ctx.lineTo(width / 2 - 50, height - 30);
    ctx.lineTo(width / 2 + 50, height - 30);
    ctx.lineTo(width / 2 + 30, height - 100);
    ctx.closePath();
    ctx.fill();
    
    // Bubbles based on temperature
    if (cookingGame.temperature > 60) {
        for (let i = 0; i < cookingGame.temperature / 20; i++) {
            ctx.fillStyle = 'rgba(255,255,255,0.5)';
            ctx.beginPath();
            ctx.arc(
                width / 2 - 30 + Math.random() * 60,
                height - 50 - Math.random() * 40,
                2 + Math.random() * 3,
                0, Math.PI * 2
            );
            ctx.fill();
        }
    }
    
    // Instructions
    ctx.fillStyle = '#778da9';
    ctx.font = '11px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('‚Üë/‚Üì or W/S to adjust temperature', width / 2, height - 15);
    ctx.fillText('SPACE when temperature is in green zone', width / 2, height - 3);
    
    requestAnimationFrame(cookingLoop);
}

function endCookingGame() {
    cookingGame.active = false;
    GameState.isInMinigame = false;
    document.removeEventListener('keydown', cookingKeyHandler);
    document.getElementById('minigame-overlay').classList.add('hidden');
    
    const reward = Math.floor(cookingGame.purity * 30);
    
    if (cookingGame.purity >= 75) {
        GameState.player.money += reward;
        showNotification('Synthesis Complete!', `${cookingGame.purity}% purity! +${reward} faisaa`);
        updateMissionObjective('minigame', 'drugCooking', true);
    } else {
        showNotification('Synthesis Failed!', `Only ${cookingGame.purity}% purity. Batch ruined.`);
    }
}

// ==================== EXPORT FOR MAIN GAME ====================
if (typeof window !== 'undefined') {
    window.ACT3_MAPS = ACT3_MAPS;
    window.ACT3_CHARACTERS = ACT3_CHARACTERS;
    window.ACT3_MISSIONS = ACT3_MISSIONS;
    window.ACT3_SIDE_MISSIONS = ACT3_SIDE_MISSIONS;
    window.ACT3_DIALOGUES = ACT3_DIALOGUES;
    window.ACT3_RADIO = ACT3_RADIO;
    window.startCryptoGame = startCryptoGame;
    window.startDrugCookingGame = startDrugCookingGame;
}


// ========== act4.js ==========
// ============================================
// ACT 4: PARLIAMENT PLAGUE
// Timeline: 2018 - Political corruption deepens
// ============================================

// ==================== ACT 4 MAPS ====================
const ACT4_MAPS = {
    parliament_district: {
        name: "Parliament District",
        width: 65,
        height: 55,
        spawnX: 32,
        spawnY: 45,
        tiles: [],
        npcs: [],
        items: [],
        zones: {
            parliament: { x: 25, y: 15, w: 15, h: 12, name: "People's Majlis üèõÔ∏è" },
            presidentialPalace: { x: 10, y: 20, w: 12, h: 10, name: "Muliaage üè∞" },
            supremeCourt: { x: 45, y: 18, w: 10, h: 8, name: "Supreme Court ‚öñÔ∏è" },
            republicSquare: { x: 28, y: 30, w: 10, h: 8, name: "Republic Square üèõÔ∏è" },
            policeHQ: { x: 50, y: 30, w: 8, h: 8, name: "Police HQ üëÆ" },
            mediaCenter: { x: 8, y: 35, w: 10, h: 8, name: "Media Center üì∫" },
            alibeOffice: { x: 45, y: 40, w: 8, h: 6, name: "Opposition HQ üó≥Ô∏è" }
        },
        gangTerritory: null,
        politicalZone: true
    },
    
    coup_2012_flashback: {
        name: "February 7, 2012 - The Coup",
        width: 60,
        height: 50,
        spawnX: 30,
        spawnY: 40,
        tiles: [],
        npcs: [],
        items: [],
        zones: {
            mndfHQ: { x: 20, y: 15, w: 15, h: 10, name: "MNDF Headquarters üéñÔ∏è" },
            policeStation: { x: 40, y: 20, w: 10, h: 8, name: "Police Station üëÆ" },
            protestArea: { x: 25, y: 30, w: 12, h: 10, name: "Protest Zone üì¢" },
            presidentOffice: { x: 10, y: 25, w: 10, h: 8, name: "President's Office üèõÔ∏è" }
        },
        isFlashback: true,
        year: 2012
    },
    
    dhoonidhoo_prison: {
        name: "Dhoonidhoo Detention Center",
        width: 45,
        height: 40,
        spawnX: 22,
        spawnY: 35,
        tiles: [],
        npcs: [],
        items: [],
        zones: {
            cellBlock: { x: 15, y: 10, w: 15, h: 12, name: "Cell Block A üîí" },
            interrogation: { x: 32, y: 15, w: 8, h: 6, name: "Interrogation üíÄ" },
            yard: { x: 10, y: 25, w: 20, h: 10, name: "Prison Yard üèÉ" },
            adminBuilding: { x: 5, y: 10, w: 8, h: 8, name: "Admin Building üìã" },
            dock: { x: 35, y: 30, w: 8, h: 8, name: "Prison Dock üö¢" }
        },
        isPrison: true
    },
    
    journalist_hideout: {
        name: "Underground Press",
        width: 35,
        height: 30,
        spawnX: 17,
        spawnY: 25,
        tiles: [],
        npcs: [],
        items: [],
        zones: {
            printingRoom: { x: 10, y: 8, w: 15, h: 10, name: "Printing Room üì∞" },
            serverRoom: { x: 5, y: 20, w: 8, h: 6, name: "Server Room üíª" },
            safehouse: { x: 20, y: 18, w: 10, h: 8, name: "Safe House üè†" }
        },
        isHidden: true
    }
};

// ==================== ACT 4 CHARACTERS ====================
const ACT4_CHARACTERS = {
    alibe: {
        name: "Alibe",
        sprite: "üó≥Ô∏è",
        role: "Opposition Leader",
        backstory: "Nasheed-inspired character. Former president, now opposition leader fighting against Mooizbe's authoritarian rule. Idealistic but willing to use gangs for political ends.",
        dialogues: {
            first_meeting: {
                speaker: "Alibe",
                sprite: "üó≥Ô∏è",
                lines: [
                    { text: "So kaley the famous Baokalo. Mashakah heard stories.", dhivehi: true },
                    { text: "Aharen know what kaley think - another politician.", dhivehi: true },
                    { text: "But aharen different. Aharen was president. They took it.", dhivehi: false },
                    { text: "2012. The coup. Aharen remember every face.", dhivehi: false },
                    { text: "Now Mooizbe destroying everything. Mashakah need help.", dhivehi: true }
                ],
                choices: [
                    { text: "What kind of help?", karma: 0, response: "alibe_explain" },
                    { text: "Politicians are all the same.", karma: -5, response: "alibe_cynical" },
                    { text: "Aharen already work for Mooizbe.", karma: -20, response: "alibe_betray" }
                ]
            }
        }
    },
    
    mpJabibe: {
        name: "MP Jabibe",
        sprite: "ü§µüèæ",
        role: "Corrupt Parliamentarian",
        backstory: "Takes bribes from both sides. Sells votes, leaks information. Represents everything wrong with Maldivian politics.",
        dialogues: {
            bribe_offer: {
                speaker: "MP Jabibe",
                sprite: "ü§µüèæ",
                lines: [
                    { text: "*counting money* Ah, Baokalo! Come in, come in!", dhivehi: false },
                    { text: "Kaley want something passed? Blocked? Aharen can arrange.", dhivehi: true },
                    { text: "50,000 rufiyaa per vote. Bulk discount for 10+.", dhivehi: false },
                    { text: "Democracy is expensive, no? Hehe.", dhivehi: false }
                ],
                choices: [
                    { text: "Aharen need the Gang Act delayed.", karma: -15, response: "jabibe_gang_act" },
                    { text: "Who else is buying votes?", karma: 0, response: "jabibe_info" },
                    { text: "Kaley disgusting. Aharen won't deal.", karma: 10, response: "jabibe_refuse" }
                ]
            }
        }
    },
    
    chiefJustice: {
        name: "Chief Justice Abdulla",
        sprite: "‚öñÔ∏è",
        role: "Supreme Court Chief Justice",
        backstory: "Appointed by Mooizbe. Rules in favor of whoever pays most. Key to keeping opposition leaders jailed.",
        dialogues: {
            court_meeting: {
                speaker: "Chief Justice",
                sprite: "‚öñÔ∏è",
                lines: [
                    { text: "*in chambers* The law is... flexible.", dhivehi: false },
                    { text: "Kaley friend needs charges dropped? Possible.", dhivehi: true },
                    { text: "Kaley enemy needs conviction? Also possible.", dhivehi: true },
                    { text: "Justice has a price. What can kaley afford?", dhivehi: false }
                ],
                choices: [
                    { text: "Free Rippoo's old friends.", karma: 5, response: "justice_free" },
                    { text: "Convict my rivals.", karma: -20, response: "justice_convict" },
                    { text: "Record this conversation.", karma: 15, response: "justice_record" }
                ]
            }
        }
    },
    
    youngBaokalo: {
        name: "Young Baokalo (2012)",
        sprite: "üë¶üèæ",
        role: "12-year-old Baokalo during coup",
        backstory: "Flashback character. Witnessed the 2012 coup that shaped his worldview.",
        dialogues: {
            coup_witness: {
                speaker: "Young Baokalo",
                sprite: "üë¶üèæ",
                lines: [
                    { text: "*hiding behind wall* Mama, what's happening?", dhivehi: true },
                    { text: "Why are soldiers fighting police?", dhivehi: false },
                    { text: "*explosion* MAMA!", dhivehi: true },
                    { text: "*Rippoo pulls him away* Come! Now!", dhivehi: true }
                ]
            }
        }
    },
    
    policeCommissioner: {
        name: "Commissioner Hassan",
        sprite: "üëÆüèæ",
        role: "Police Commissioner",
        backstory: "Mooizbe's enforcer. Uses police to harass opposition and protect government allies.",
        dialogues: {
            arrest_threat: {
                speaker: "Commissioner Hassan",
                sprite: "üëÆüèæ",
                lines: [
                    { text: "Baokalo. Aharen been watching kaley.", dhivehi: true },
                    { text: "Drug trafficking. Murder. Extortion.", dhivehi: false },
                    { text: "Aharen can make it all go away. Or...", dhivehi: true },
                    { text: "Kaley can spend 25 years in Dhoonidhoo.", dhivehi: false },
                    { text: "President needs... a favor.", dhivehi: true }
                ],
                choices: [
                    { text: "What does Mooizbe want?", karma: -10, response: "commissioner_task" },
                    { text: "Kaley can't prove anything.", karma: 0, response: "commissioner_bluff" },
                    { text: "[Attack]", karma: -25, combat: true, response: "commissioner_attack" }
                ]
            }
        }
    },
    
    nunnuJournalist: {
        name: "Nunnu (Sister)",
        sprite: "üì∞",
        role: "Investigative Journalist",
        backstory: "Baokalo's sister. Works for underground press exposing corruption. Constantly in danger.",
        dialogues: {
            investigation_help: {
                speaker: "Nunnu",
                sprite: "üì∞",
                lines: [
                    { text: "*shows documents* Look at this, brother.", dhivehi: true },
                    { text: "Mooizbe. Jabibe. The Chief Justice. All connected.", dhivehi: false },
                    { text: "Money from China. Bribes. Offshore accounts.", dhivehi: false },
                    { text: "If mashakah publish this... they'll kill me.", dhivehi: true },
                    { text: "But people deserve to know.", dhivehi: false }
                ],
                choices: [
                    { text: "Aharen protect kaley. Publish it.", karma: 20, familyKarma: 25, response: "nunnu_publish" },
                    { text: "Too dangerous. Hide the evidence.", karma: 5, familyKarma: 10, response: "nunnu_hide" },
                    { text: "Give it to me. Aharen use it for leverage.", karma: -15, familyKarma: -20, response: "nunnu_leverage" }
                ]
            }
        }
    }
};

// ==================== ACT 4 MISSIONS ====================
const ACT4_MISSIONS = [
    {
        id: "act4_m1",
        title: "Political Animal",
        type: "story",
        description: "Enter the Parliament District",
        objectives: [
            { type: "travel", target: "parliament_district", current: false },
            { type: "discover", target: "parliament", current: false },
            { type: "discover", target: "republicSquare", current: false }
        ],
        rewards: { money: 400 },
        unlocks: ["act4_m2"]
    },
    {
        id: "act4_m2",
        title: "The Opposition",
        type: "story",
        description: "Meet opposition leader Alibe",
        objectives: [
            { type: "travel", target: "alibeOffice", current: false },
            { type: "trigger", target: "alibeMeeting", current: false }
        ],
        rewards: { money: 500 },
        dialogueStart: "alibe_first_meeting",
        unlocks: ["act4_m3", "act4_m4"],
        moralChoice: true
    },
    {
        id: "act4_m3",
        title: "Vote Buying",
        type: "corruption",
        description: "Bribe MPs for Alibe's bill",
        objectives: [
            { type: "talk", target: "mpJabibe", current: false },
            { type: "pay", target: "bribe", amount: 50000, current: false },
            { type: "collect", target: "votePromise", count: 5, current: 0 }
        ],
        rewards: { money: -50000, karma: -20, reputation: { opposition: 30 } },
        unlocks: ["act4_m5"],
        requiresChoice: "alibe_explain"
    },
    {
        id: "act4_m4",
        title: "Double Agent",
        type: "betrayal",
        description: "Report Alibe's plans to Mooizbe",
        objectives: [
            { type: "travel", target: "presidentialPalace", current: false },
            { type: "trigger", target: "mooizbeReport", current: false }
        ],
        rewards: { money: 100000, karma: -35, reputation: { government: 50, opposition: -100 } },
        unlocks: ["act4_m5"],
        requiresChoice: "alibe_betray"
    },
    {
        id: "act4_m5",
        title: "Flashback: February 7",
        type: "flashback",
        description: "Relive the 2012 coup as young Baokalo",
        objectives: [
            { type: "travel", target: "coup_2012_flashback", current: false },
            { type: "survive", target: "coupChaos", duration: 60, current: 0 },
            { type: "escape", target: "safeHouse", current: false }
        ],
        rewards: { karma: 0 },
        dialogueStart: "coup_witness",
        unlocks: ["act4_m6"],
        isFlashback: true,
        specialMusic: "coup_theme"
    },
    {
        id: "act4_m6",
        title: "Sister's Investigation",
        type: "story",
        description: "Help Nunnu with her investigation",
        objectives: [
            { type: "travel", target: "journalist_hideout", current: false },
            { type: "trigger", target: "nunnuMeeting", current: false }
        ],
        rewards: { money: 0 },
        dialogueStart: "nunnu_investigation_help",
        unlocks: ["act4_m7", "act4_m8", "act4_m9"],
        moralChoice: true,
        majorChoice: "journalism"
    },
    {
        id: "act4_m7",
        title: "Press Freedom",
        type: "protection",
        description: "Protect Nunnu while she publishes",
        objectives: [
            { type: "escort", target: "nunnu", current: false },
            { type: "defend", target: "printingRoom", duration: 90, current: 0 },
            { type: "defeat", target: "governmentThug", count: 15, current: 0 }
        ],
        rewards: { money: 2000, karma: 25, familyKarma: 30 },
        unlocks: ["act4_m10"],
        requiresChoice: "nunnu_publish"
    },
    {
        id: "act4_m8",
        title: "Buried Truth",
        type: "stealth",
        description: "Hide the evidence safely",
        objectives: [
            { type: "collect", target: "evidence", current: false },
            { type: "travel", target: "safehouse", current: false },
            { type: "hide", target: "documents", current: false }
        ],
        rewards: { money: 500, karma: 5, familyKarma: 10 },
        unlocks: ["act4_m10"],
        requiresChoice: "nunnu_hide"
    },
    {
        id: "act4_m9",
        title: "Blackmail Material",
        type: "corruption",
        description: "Use evidence to blackmail politicians",
        objectives: [
            { type: "collect", target: "evidence", current: false },
            { type: "talk", target: "mpJabibe", current: false },
            { type: "extort", target: "politician", count: 3, current: 0 }
        ],
        rewards: { money: 75000, karma: -25, familyKarma: -30 },
        unlocks: ["act4_m10"],
        requiresChoice: "nunnu_leverage"
    },
    {
        id: "act4_m10",
        title: "Judicial Corruption",
        type: "story",
        description: "Meet the Chief Justice",
        objectives: [
            { type: "travel", target: "supremeCourt", current: false },
            { type: "trigger", target: "justiceMeeting", current: false }
        ],
        rewards: { money: 0 },
        dialogueStart: "court_meeting",
        unlocks: ["act4_m11", "act4_m12"]
    },
    {
        id: "act4_m11",
        title: "Arrest Warrant",
        type: "combat",
        description: "Commissioner Hassan comes for you",
        objectives: [
            { type: "survive", target: "policeRaid", duration: 60, current: 0 },
            { type: "escape", target: "safehouse", current: false }
        ],
        rewards: { money: 0, karma: -10 },
        dialogueStart: "arrest_threat",
        unlocks: ["act4_m12"]
    },
    {
        id: "act4_m12",
        title: "Parliament Siege",
        type: "combat",
        description: "Storm Parliament to rescue arrested allies",
        objectives: [
            { type: "travel", target: "parliament", current: false },
            { type: "defeat", target: "securityGuard", count: 20, current: 0 },
            { type: "rescue", target: "prisoner", count: 3, current: 0 }
        ],
        rewards: { money: 5000, karma: -15 },
        unlocks: ["act4_climax"]
    },
    {
        id: "act4_climax",
        title: "State of Emergency",
        type: "boss",
        description: "Mooizbe declares emergency - escape Mal√©",
        objectives: [
            { type: "survive", target: "martialLaw", duration: 120, current: 0 },
            { type: "defeat", target: "specialForces", count: 10, current: 0 },
            { type: "escape", target: "speedboat", current: false }
        ],
        rewards: { money: 10000, karma: -20 },
        unlocks: ["act5_start"],
        actEnd: true,
        bossMusic: true
    }
];

// ==================== ACT 4 SIDE MISSIONS ====================
const ACT4_SIDE_MISSIONS = [
    { id: "side4_bribe1", title: "Bribe Runner I", type: "delivery", reward: 600 },
    { id: "side4_bribe2", title: "Bribe Runner II", type: "delivery", reward: 800 },
    { id: "side4_protest1", title: "Protest Infiltration", type: "stealth", reward: 500 },
    { id: "side4_protest2", title: "Counter-Protest", type: "combat", reward: 700 },
    { id: "side4_leak1", title: "Document Leak I", type: "stealth", reward: 400 },
    { id: "side4_leak2", title: "Document Leak II", type: "stealth", reward: 600 },
    { id: "side4_intimidate1", title: "Witness Intimidation", type: "intimidation", reward: 500 },
    { id: "side4_intimidate2", title: "Jury Tampering", type: "corruption", reward: 800 },
    { id: "side4_escort1", title: "VIP Escort", type: "escort", reward: 600 },
    { id: "side4_escort2", title: "Journalist Protection", type: "escort", reward: 700 },
    { id: "side4_sabotage1", title: "Media Sabotage", type: "sabotage", reward: 500 },
    { id: "side4_rally", title: "Rally Security", type: "protection", reward: 600 },
    { id: "side4_speech", title: "Speech Writing", type: "minigame", game: "charisma", reward: 400 },
    { id: "side4_debate", title: "Debate Prep", type: "minigame", game: "charisma", reward: 500 }
];

// ==================== ACT 4 DIALOGUES ====================
const ACT4_DIALOGUES = {
    alibe_first_meeting: {
        speaker: "Alibe",
        sprite: "üó≥Ô∏è",
        lines: [
            { text: "So kaley the famous Baokalo. Mashakah heard stories.", dhivehi: true },
            { text: "Aharen know what kaley think - another politician.", dhivehi: true },
            { text: "But aharen different. Aharen was president. They took it.", dhivehi: false },
            { text: "2012. The coup. Aharen remember every face.", dhivehi: false },
            { text: "Now Mooizbe destroying everything. Mashakah need help.", dhivehi: true }
        ],
        choices: [
            { text: "What kind of help?", karma: 0, response: "alibe_explain" },
            { text: "Politicians are all the same.", karma: -5, response: "alibe_cynical" },
            { text: "Aharen already work for Mooizbe.", karma: -20, response: "alibe_betray" }
        ]
    },
    
    alibe_explain: {
        speaker: "Alibe",
        sprite: "üó≥Ô∏è",
        lines: [
            { text: "Mooizbe controls police. Military. Courts.", dhivehi: false },
            { text: "But not the streets. That's kaley territory.", dhivehi: true },
            { text: "Mashakah need... pressure. On certain MPs.", dhivehi: false },
            { text: "Nothing violent. Just... persuasion.", dhivehi: false },
            { text: "Help mashakah pass reform bill. Aharen protect kaley operations.", dhivehi: true }
        ]
    },
    
    alibe_cynical: {
        speaker: "Alibe",
        sprite: "üó≥Ô∏è",
        lines: [
            { text: "*sighs* Kaley not wrong to be suspicious.", dhivehi: true },
            { text: "Aharen made mistakes. Trusted wrong people.", dhivehi: false },
            { text: "But aharen trying to fix this country.", dhivehi: true },
            { text: "Kaley can help... or watch it burn.", dhivehi: false },
            { text: "Choice is kaley.", dhivehi: true }
        ]
    },
    
    alibe_betray: {
        speaker: "Alibe",
        sprite: "üó≥Ô∏è",
        lines: [
            { text: "*face hardens* Kaley work for that dictator?", dhivehi: true },
            { text: "Then kaley enemy. Get out.", dhivehi: false },
            { text: "And tell Mooizbe... aharen coming for him.", dhivehi: true },
            { text: "One way or another.", dhivehi: false }
        ]
    },
    
    jabibe_bribe_offer: {
        speaker: "MP Jabibe",
        sprite: "ü§µüèæ",
        lines: [
            { text: "*counting money* Ah, Baokalo! Come in, come in!", dhivehi: false },
            { text: "Kaley want something passed? Blocked? Aharen can arrange.", dhivehi: true },
            { text: "50,000 rufiyaa per vote. Bulk discount for 10+.", dhivehi: false },
            { text: "Democracy is expensive, no? Hehe.", dhivehi: false }
        ],
        choices: [
            { text: "Aharen need the Gang Act delayed.", karma: -15, response: "jabibe_gang_act" },
            { text: "Who else is buying votes?", karma: 0, response: "jabibe_info" },
            { text: "Kaley disgusting. Aharen won't deal.", karma: 10, response: "jabibe_refuse" }
        ]
    },
    
    jabibe_gang_act: {
        speaker: "MP Jabibe",
        sprite: "ü§µüèæ",
        lines: [
            { text: "Gang Act? Tricky, tricky...", dhivehi: false },
            { text: "Government pushing hard. Death penalty clause.", dhivehi: false },
            { text: "But for right price... aharen can delay committee vote.", dhivehi: true },
            { text: "Six months. 100,000 rufiyaa. Final offer.", dhivehi: false }
        ]
    },
    
    jabibe_info: {
        speaker: "MP Jabibe",
        sprite: "ü§µüèæ",
        lines: [
            { text: "*leans in* Everyone, my friend. Everyone.", dhivehi: false },
            { text: "Mooizbe buys loyalty. Alibe buys opposition.", dhivehi: false },
            { text: "Chinese buy infrastructure votes. Indians buy defense.", dhivehi: false },
            { text: "Aharen? Aharen just... facilitate.", dhivehi: true },
            { text: "Information also has price. 20,000 for names.", dhivehi: false }
        ]
    },
    
    jabibe_refuse: {
        speaker: "MP Jabibe",
        sprite: "ü§µüèæ",
        lines: [
            { text: "*laughs* Disgusting? Aharen just honest!", dhivehi: true },
            { text: "Other MPs take money AND pretend to be clean.", dhivehi: false },
            { text: "Aharen transparent. Professional.", dhivehi: false },
            { text: "Kaley will be back. They always come back.", dhivehi: true }
        ]
    },
    
    court_meeting: {
        speaker: "Chief Justice",
        sprite: "‚öñÔ∏è",
        lines: [
            { text: "*in chambers* The law is... flexible.", dhivehi: false },
            { text: "Kaley friend needs charges dropped? Possible.", dhivehi: true },
            { text: "Kaley enemy needs conviction? Also possible.", dhivehi: true },
            { text: "Justice has a price. What can kaley afford?", dhivehi: false }
        ],
        choices: [
            { text: "Free Rippoo's old friends.", karma: 5, response: "justice_free" },
            { text: "Convict my rivals.", karma: -20, response: "justice_convict" },
            { text: "Record this conversation.", karma: 15, response: "justice_record" }
        ]
    },
    
    justice_free: {
        speaker: "Chief Justice",
        sprite: "‚öñÔ∏è",
        lines: [
            { text: "The old Sharks? Interesting...", dhivehi: false },
            { text: "They've been in Dhoonidhoo 10 years.", dhivehi: false },
            { text: "Paperwork... lost. Evidence... contaminated.", dhivehi: true },
            { text: "200,000 rufiyaa. They walk in one week.", dhivehi: false }
        ]
    },
    
    justice_convict: {
        speaker: "Chief Justice",
        sprite: "‚öñÔ∏è",
        lines: [
            { text: "*smiles* Now kaley speaking aharen language.", dhivehi: true },
            { text: "Give me names. Aharen find charges.", dhivehi: false },
            { text: "Terrorism is popular these days. 25 years minimum.", dhivehi: false },
            { text: "50,000 per conviction. Bulk rates available.", dhivehi: false }
        ]
    },
    
    justice_record: {
        speaker: "Chief Justice",
        sprite: "‚öñÔ∏è",
        lines: [
            { text: "*notices phone* What is... GUARDS!", dhivehi: true },
            { text: "Kaley think can trap me?!", dhivehi: true },
            { text: "Aharen AM the law in this country!", dhivehi: false },
            { text: "Kaley just made powerful enemy, Baokalo.", dhivehi: true }
        ]
    },
    
    coup_witness: {
        speaker: "Young Baokalo",
        sprite: "üë¶üèæ",
        lines: [
            { text: "*hiding behind wall* Mama, what's happening?", dhivehi: true },
            { text: "Why are soldiers fighting police?", dhivehi: false },
            { text: "*explosion* MAMA!", dhivehi: true }
        ]
    },
    
    coup_rippoo_save: {
        speaker: "Rippoo (2012)",
        sprite: "üë©üèæ",
        lines: [
            { text: "*grabs young Baokalo* Come! NOW!", dhivehi: true },
            { text: "Don't look back! Keep running!", dhivehi: true },
            { text: "*gunfire* This way! Through the alley!", dhivehi: false },
            { text: "Aharen won't let them hurt kaley. Never.", dhivehi: true }
        ]
    },
    
    nunnu_investigation_help: {
        speaker: "Nunnu",
        sprite: "üì∞",
        lines: [
            { text: "*shows documents* Look at this, brother.", dhivehi: true },
            { text: "Mooizbe. Jabibe. The Chief Justice. All connected.", dhivehi: false },
            { text: "Money from China. Bribes. Offshore accounts.", dhivehi: false },
            { text: "If mashakah publish this... they'll kill me.", dhivehi: true },
            { text: "But people deserve to know.", dhivehi: false }
        ],
        choices: [
            { text: "Aharen protect kaley. Publish it.", karma: 20, familyKarma: 25, response: "nunnu_publish" },
            { text: "Too dangerous. Hide the evidence.", karma: 5, familyKarma: 10, response: "nunnu_hide" },
            { text: "Give it to me. Aharen use it for leverage.", karma: -15, familyKarma: -20, response: "nunnu_leverage" }
        ]
    },
    
    nunnu_publish: {
        speaker: "Nunnu",
        sprite: "üì∞",
        lines: [
            { text: "*hugs* Thank you, brother.", dhivehi: true },
            { text: "Aharen knew kaley would understand.", dhivehi: true },
            { text: "Mashakah publish tonight. International media ready.", dhivehi: false },
            { text: "They'll come for us. Be ready.", dhivehi: true }
        ]
    },
    
    nunnu_hide: {
        speaker: "Nunnu",
        sprite: "üì∞",
        lines: [
            { text: "*disappointed* Kaley right... it's too dangerous.", dhivehi: true },
            { text: "But someday, brother. Someday truth comes out.", dhivehi: false },
            { text: "Aharen hide copies. Multiple locations.", dhivehi: true },
            { text: "If anything happens to me... kaley know where to look.", dhivehi: true }
        ]
    },
    
    nunnu_leverage: {
        speaker: "Nunnu",
        sprite: "üì∞",
        lines: [
            { text: "*pulls back* Kaley want to use this for... blackmail?", dhivehi: true },
            { text: "This is about justice! Not faisaa!", dhivehi: false },
            { text: "*sighs* Fine. Take it. Kaley always were selfish.", dhivehi: true },
            { text: "Just... don't get us killed.", dhivehi: true }
        ]
    },
    
    arrest_threat: {
        speaker: "Commissioner Hassan",
        sprite: "üëÆüèæ",
        lines: [
            { text: "Baokalo. Aharen been watching kaley.", dhivehi: true },
            { text: "Drug trafficking. Murder. Extortion.", dhivehi: false },
            { text: "Aharen can make it all go away. Or...", dhivehi: true },
            { text: "Kaley can spend 25 years in Dhoonidhoo.", dhivehi: false },
            { text: "President needs... a favor.", dhivehi: true }
        ],
        choices: [
            { text: "What does Mooizbe want?", karma: -10, response: "commissioner_task" },
            { text: "Kaley can't prove anything.", karma: 0, response: "commissioner_bluff" },
            { text: "[Attack]", karma: -25, combat: true, response: "commissioner_attack" }
        ]
    },
    
    commissioner_task: {
        speaker: "Commissioner Hassan",
        sprite: "üëÆüèæ",
        lines: [
            { text: "Smart choice.", dhivehi: false },
            { text: "Alibe planning something. Big rally.", dhivehi: false },
            { text: "Mashakah need it... disrupted. Violently.", dhivehi: true },
            { text: "Make it look like gang violence. Not political.", dhivehi: false },
            { text: "Do this, and kaley file disappears forever.", dhivehi: true }
        ]
    },
    
    commissioner_bluff: {
        speaker: "Commissioner Hassan",
        sprite: "üëÆüèæ",
        lines: [
            { text: "*laughs* Can't prove? Aharen don't need proof!", dhivehi: true },
            { text: "This is Maldives. Aharen AM the proof.", dhivehi: false },
            { text: "One phone call. Terrorism charges.", dhivehi: false },
            { text: "Kaley want to test me?", dhivehi: true }
        ]
    },
    
    commissioner_attack: {
        speaker: "Commissioner Hassan",
        sprite: "üëÆüèæ",
        lines: [
            { text: "Kaley sodu‚Äî! OFFICERS!", dhivehi: true }
        ]
    }
};

// ==================== ACT 4 RADIO CONTENT ====================
const ACT4_RADIO = {
    raajjeFM: {
        name: "üìª Raajje FM",
        segments: [
            { type: "news", text: "Parliament passes new security bill. Opposition calls it 'dictatorship.'" },
            { type: "news", text: "President Mooizbe: 'Democracy is safe. Trust the process.'" },
            { type: "satire", text: "Chief Justice buys third yacht. 'Judges deserve nice things.'" },
            { type: "news", text: "Gang Act debate continues. Death penalty clause controversial." },
            { type: "ad", text: "Vote for stability! Vote for Mooizbe! (Paid for by definitely not China)" },
            { type: "satire", text: "MP Jabibe denies bribery. 'That was a gift! From a friend! Who wanted a favor!'" },
            { type: "news", text: "Opposition leader Alibe under investigation. Again." }
        ]
    },
    undergroundFM: {
        name: "üìª Underground FM",
        segments: [
            { type: "truth", text: "2012 coup architects now in government. Democracy died that day." },
            { type: "truth", text: "Supreme Court for sale. Highest bidder wins." },
            { type: "truth", text: "Police commissioner's offshore accounts revealed." },
            { type: "truth", text: "Gang Act designed to silence political opponents, not gangs." },
            { type: "music", text: "‚ô™ Playing: 'February 7' - The Coup Anthem ‚ô™" }
        ]
    }
};

// ==================== SPEECH/DEBATE MINI-GAME ====================
let speechGame = {
    active: false,
    topic: '',
    points: [],
    selectedPoints: [],
    score: 0,
    timer: 45,
    audience: 50
};

const SPEECH_TOPICS = {
    democracy: {
        name: "Democracy",
        goodPoints: ["Freedom", "Elections", "Rights", "Justice", "Transparency"],
        badPoints: ["Chaos", "Weakness", "Foreign", "Slow", "Expensive"]
    },
    security: {
        name: "Security",
        goodPoints: ["Safety", "Order", "Protection", "Stability", "Peace"],
        badPoints: ["Oppression", "Fear", "Control", "Surveillance", "Tyranny"]
    },
    economy: {
        name: "Economy",
        goodPoints: ["Jobs", "Growth", "Investment", "Tourism", "Development"],
        badPoints: ["Corruption", "Inequality", "Debt", "Foreign", "Exploitation"]
    }
};

function startSpeechGame(topic) {
    const topicData = SPEECH_TOPICS[topic] || SPEECH_TOPICS.democracy;
    
    speechGame.active = true;
    speechGame.topic = topicData.name;
    speechGame.points = [...topicData.goodPoints, ...topicData.badPoints].sort(() => Math.random() - 0.5);
    speechGame.selectedPoints = [];
    speechGame.score = 0;
    speechGame.timer = 45;
    speechGame.audience = 50;
    speechGame.goodPoints = topicData.goodPoints;
    GameState.isInMinigame = true;
    
    document.getElementById('minigame-overlay').classList.remove('hidden');
    document.getElementById('minigame-title').textContent = `üé§ Speech: ${topicData.name}`;
    
    const timerInterval = setInterval(() => {
        speechGame.timer--;
        if (speechGame.timer <= 0 || !speechGame.active) {
            clearInterval(timerInterval);
            if (speechGame.active) endSpeechGame();
        }
    }, 1000);
    
    minigameCanvas.onclick = speechClickHandler;
    requestAnimationFrame(speechLoop);
}

function speechClickHandler(e) {
    if (!speechGame.active) return;
    
    const rect = minigameCanvas.getBoundingClientRect();
    const clickX = e.clientX - rect.left;
    const clickY = e.clientY - rect.top;
    
    const startY = 80;
    const pointHeight = 35;
    
    speechGame.points.forEach((point, index) => {
        const y = startY + index * pointHeight;
        if (clickY >= y && clickY <= y + 30 && clickX >= 50 && clickX <= minigameCanvas.width - 50) {
            selectSpeechPoint(index);
        }
    });
}

function selectSpeechPoint(index) {
    const point = speechGame.points[index];
    
    if (speechGame.goodPoints.includes(point)) {
        speechGame.score += 20;
        speechGame.audience = Math.min(100, speechGame.audience + 10);
        showNotification('Good Point!', `+20 score`);
    } else {
        speechGame.score -= 10;
        speechGame.audience = Math.max(0, speechGame.audience - 15);
        showNotification('Bad Point!', `-10 score`);
    }
    
    speechGame.selectedPoints.push(point);
    speechGame.points.splice(index, 1);
    
    if (speechGame.points.length === 0 || speechGame.selectedPoints.length >= 5) {
        endSpeechGame();
    }
}

function speechLoop() {
    if (!speechGame.active) return;
    
    const ctx = minigameCtx;
    const width = minigameCanvas.width;
    const height = minigameCanvas.height;
    
    // Clear
    ctx.fillStyle = '#1a1a2e';
    ctx.fillRect(0, 0, width, height);
    
    // Timer
    ctx.fillStyle = speechGame.timer > 10 ? '#fff' : '#ff0000';
    ctx.font = 'bold 14px Arial';
    ctx.textAlign = 'right';
    ctx.fillText(`Time: ${speechGame.timer}s`, width - 10, 20);
    
    // Score
    ctx.fillStyle = '#00ff00';
    ctx.textAlign = 'left';
    ctx.fillText(`Score: ${speechGame.score}`, 10, 20);
    
    // Audience meter
    ctx.fillStyle = '#333';
    ctx.fillRect(10, 35, 150, 15);
    ctx.fillStyle = speechGame.audience > 30 ? '#00ff00' : '#ff0000';
    ctx.fillRect(10, 35, speechGame.audience * 1.5, 15);
    ctx.fillStyle = '#fff';
    ctx.font = '10px Arial';
    ctx.fillText(`Audience: ${speechGame.audience}%`, 15, 47);
    
    // Topic
    ctx.fillStyle = '#ffcc00';
    ctx.font = 'bold 16px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(`Topic: ${speechGame.topic}`, width / 2, 65);
    
    // Points to select
    const startY = 80;
    const pointHeight = 35;
    
    speechGame.points.forEach((point, index) => {
        const y = startY + index * pointHeight;
        
        ctx.fillStyle = '#2a2a4e';
        ctx.fillRect(50, y, width - 100, 30);
        ctx.strokeStyle = '#778da9';
        ctx.lineWidth = 1;
        ctx.strokeRect(50, y, width - 100, 30);
        
        ctx.fillStyle = '#fff';
        ctx.font = '14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(point, width / 2, y + 20);
    });
    
    // Instructions
    ctx.fillStyle = '#778da9';
    ctx.font = '11px Arial';
    ctx.fillText('Click points that support your argument', width / 2, height - 15);
    
    requestAnimationFrame(speechLoop);
}

function endSpeechGame() {
    speechGame.active = false;
    GameState.isInMinigame = false;
    minigameCanvas.onclick = null;
    document.getElementById('minigame-overlay').classList.add('hidden');
    
    if (speechGame.score >= 60 && speechGame.audience >= 50) {
        GameState.player.money += 1000;
        showNotification('Speech Success!', `Audience convinced! +1000 faisaa`);
        updateMissionObjective('minigame', 'charisma', true);
    } else {
        showNotification('Speech Failed', 'Audience not convinced...');
    }
}

// ==================== EXPORT FOR MAIN GAME ====================
if (typeof window !== 'undefined') {
    window.ACT4_MAPS = ACT4_MAPS;
    window.ACT4_CHARACTERS = ACT4_CHARACTERS;
    window.ACT4_MISSIONS = ACT4_MISSIONS;
    window.ACT4_SIDE_MISSIONS = ACT4_SIDE_MISSIONS;
    window.ACT4_DIALOGUES = ACT4_DIALOGUES;
    window.ACT4_RADIO = ACT4_RADIO;
    window.startSpeechGame = startSpeechGame;
}


// ========== act5.js ==========
// ============================================
// ACT 5: PRISON & REDEMPTION
// Timeline: 2019 - Incarceration and escape
// ============================================

// ==================== ACT 5 MAPS ====================
const ACT5_MAPS = {
    dhoonidhoo_interior: {
        name: "Dhoonidhoo Prison - Interior",
        width: 50,
        height: 45,
        spawnX: 25,
        spawnY: 40,
        tiles: [],
        npcs: [],
        items: [],
        zones: {
            cellBlockA: { x: 5, y: 5, w: 15, h: 12, name: "Cell Block A üîí" },
            cellBlockB: { x: 30, y: 5, w: 15, h: 12, name: "Cell Block B üîí" },
            messHall: { x: 15, y: 20, w: 20, h: 10, name: "Mess Hall üçΩÔ∏è" },
            exerciseYard: { x: 5, y: 32, w: 25, h: 10, name: "Exercise Yard üèÉ" },
            solitaryConfinement: { x: 35, y: 32, w: 10, h: 8, name: "Solitary üíÄ" },
            wardenOffice: { x: 35, y: 20, w: 10, h: 8, name: "Warden's Office üëî" },
            infirmary: { x: 20, y: 5, w: 8, h: 8, name: "Infirmary üè•" },
            muazCell: { x: 8, y: 8, w: 4, h: 4, name: "Muaz's Cell üë§" }
        },
        isPrison: true,
        restrictedMovement: true
    },
    
    prison_tunnels: {
        name: "Escape Tunnels",
        width: 40,
        height: 35,
        spawnX: 5,
        spawnY: 30,
        tiles: [],
        npcs: [],
        items: [],
        zones: {
            tunnelEntrance: { x: 3, y: 28, w: 5, h: 5, name: "Tunnel Entrance üï≥Ô∏è" },
            mainTunnel: { x: 8, y: 15, w: 25, h: 5, name: "Main Tunnel üöá" },
            caveIn: { x: 20, y: 10, w: 8, h: 5, name: "Cave-In ‚ö†Ô∏è" },
            underwaterSection: { x: 30, y: 5, w: 8, h: 10, name: "Underwater Exit üåä" },
            exitPoint: { x: 35, y: 3, w: 4, h: 4, name: "Freedom üåÖ" }
        },
        isDark: true,
        requiresFlashlight: true
    },
    
    flashback_father: {
        name: "1998 - Father's Last Day",
        width: 45,
        height: 40,
        spawnX: 22,
        spawnY: 35,
        tiles: [],
        npcs: [],
        items: [],
        zones: {
            familyHome: { x: 15, y: 20, w: 12, h: 10, name: "Ronda Home üè†" },
            fatherWorkshop: { x: 30, y: 22, w: 8, h: 8, name: "Father's Workshop üîß" },
            policeRaid: { x: 10, y: 10, w: 15, h: 8, name: "Raid Zone üöî" }
        },
        isFlashback: true,
        year: 1998
    },
    
    safe_house_post_escape: {
        name: "Addu Safe House",
        width: 35,
        height: 30,
        spawnX: 17,
        spawnY: 25,
        tiles: [],
        npcs: [],
        items: [],
        zones: {
            hideout: { x: 10, y: 10, w: 15, h: 12, name: "Safe House üè†" },
            dock: { x: 25, y: 20, w: 8, h: 8, name: "Hidden Dock üö§" },
            lookout: { x: 5, y: 5, w: 6, h: 6, name: "Lookout Point üëÅÔ∏è" }
        },
        isSafeZone: true
    }
};

// ==================== ACT 5 CHARACTERS ====================
const ACT5_CHARACTERS = {
    muaz: {
        name: "Muaz",
        sprite: "üë§",
        role: "Half-Brother (Revealed)",
        backstory: "Baokalo's half-brother from father's secret second family. In prison for gang activity. Knows the truth about their father's death.",
        dialogues: {
            first_meeting: {
                speaker: "Muaz",
                sprite: "üë§",
                lines: [
                    { text: "*stares* Kaley... kaley Baokalo, right?", dhivehi: true },
                    { text: "Aharen been waiting for this moment.", dhivehi: true },
                    { text: "Kaley don't know me. But aharen know kaley.", dhivehi: true },
                    { text: "Mashakah share same blood. Same father.", dhivehi: true },
                    { text: "*shows scar* He gave us both this life.", dhivehi: false }
                ],
                choices: [
                    { text: "What are kaley talking about?", karma: 0, response: "muaz_explain" },
                    { text: "Aharen have no brother.", karma: -5, response: "muaz_denial" },
                    { text: "Father... he had another family?", karma: 5, response: "muaz_truth" }
                ]
            }
        }
    },
    
    warden: {
        name: "Warden Rasheed",
        sprite: "üëî",
        role: "Prison Warden",
        backstory: "Corrupt warden who runs prison like personal fiefdom. Takes bribes, arranges 'accidents'. Connected to Mooizbe.",
        dialogues: {
            intimidation: {
                speaker: "Warden Rasheed",
                sprite: "üëî",
                lines: [
                    { text: "*in office* The famous Baokalo. In MY prison.", dhivehi: false },
                    { text: "Kaley caused lot of trouble outside.", dhivehi: true },
                    { text: "In here? Aharen am god. Aharen decide who lives.", dhivehi: true },
                    { text: "Behave... and maybe kaley survive.", dhivehi: false },
                    { text: "Or... accidents happen. Understand?", dhivehi: true }
                ],
                choices: [
                    { text: "Aharen understand, sir.", karma: -5, response: "warden_submit" },
                    { text: "Kaley don't scare me.", karma: 5, response: "warden_defiant" },
                    { text: "How much for better treatment?", karma: -10, response: "warden_bribe" }
                ]
            }
        }
    },
    
    prisonGangLeader: {
        name: "Big Ismail",
        sprite: "üí™üèæ",
        role: "Prison Gang Boss",
        backstory: "Controls prison black market. Former Masodi lieutenant. Knows everyone's secrets.",
        dialogues: {
            alliance_offer: {
                speaker: "Big Ismail",
                sprite: "üí™üèæ",
                lines: [
                    { text: "*in yard* Fresh meat. Baokalo.", dhivehi: false },
                    { text: "Kaley reputation precedes kaley.", dhivehi: true },
                    { text: "In here, kaley need friends. Protection.", dhivehi: false },
                    { text: "Work with mashakah. Run contraband.", dhivehi: true },
                    { text: "Or... kaley on kaley own. Not recommended.", dhivehi: false }
                ],
                choices: [
                    { text: "What's the deal?", karma: -10, response: "ismail_deal" },
                    { text: "Aharen work alone.", karma: 0, response: "ismail_refuse" },
                    { text: "Aharen take over. Kaley work for me.", karma: -15, response: "ismail_challenge" }
                ]
            }
        }
    },
    
    oldPrisoner: {
        name: "Old Man Hussain",
        sprite: "üë¥üèæ",
        role: "Long-term Prisoner / Father's Friend",
        backstory: "Knew Baokalo's father. In prison 25 years. Knows the truth about the Ronda family.",
        dialogues: {
            father_truth: {
                speaker: "Old Man Hussain",
                sprite: "üë¥üèæ",
                lines: [
                    { text: "*coughs* Kaley... kaley look like him.", dhivehi: true },
                    { text: "Kaley father. Ibrahim. Good man.", dhivehi: true },
                    { text: "He didn't deserve what happened.", dhivehi: false },
                    { text: "They set him up. The politicians.", dhivehi: false },
                    { text: "He knew too much. About the 1988 coup.", dhivehi: true },
                    { text: "About who REALLY brought the mercenaries.", dhivehi: false }
                ],
                choices: [
                    { text: "Tell me everything.", karma: 5, response: "hussain_full_story" },
                    { text: "Who killed him?", karma: 0, response: "hussain_killer" },
                    { text: "Aharen don't want to know.", karma: -5, response: "hussain_ignore" }
                ]
            }
        }
    },
    
    youngBaokaloChild: {
        name: "Young Baokalo (1998)",
        sprite: "üë¶üèæ",
        role: "5-year-old Baokalo",
        backstory: "Flashback character. Witnessed father's arrest.",
        dialogues: {
            father_arrest: {
                speaker: "Young Baokalo",
                sprite: "üë¶üèæ",
                lines: [
                    { text: "*crying* Bappa! Bappa!", dhivehi: true },
                    { text: "Where are they taking Bappa?!", dhivehi: true },
                    { text: "*Rippoo holds him* Mama! Make them stop!", dhivehi: true }
                ]
            }
        }
    },
    
    father: {
        name: "Ibrahim Ronda (Father)",
        sprite: "üë®üèæ",
        role: "Baokalo's Father (Flashback)",
        backstory: "Mechanic who knew too much. Killed in prison under mysterious circumstances.",
        dialogues: {
            last_words: {
                speaker: "Ibrahim",
                sprite: "üë®üèæ",
                lines: [
                    { text: "*being dragged away* Take care of your mother!", dhivehi: true },
                    { text: "Protect your sister! Be strong!", dhivehi: true },
                    { text: "Aharen love kaley! Always!", dhivehi: true },
                    { text: "*to Rippoo* Tell him the truth. When he's ready.", dhivehi: true }
                ]
            }
        }
    },
    
    escapeContact: {
        name: "Guard Fazeel",
        sprite: "üëÆüèæ",
        role: "Corrupt Guard / Escape Contact",
        backstory: "Takes bribes to look the other way. Key to escape plan.",
        dialogues: {
            escape_plan: {
                speaker: "Guard Fazeel",
                sprite: "üëÆüèæ",
                lines: [
                    { text: "*whispers* Kaley want out? Aharen can help.", dhivehi: true },
                    { text: "Old tunnel from construction days.", dhivehi: false },
                    { text: "50,000 rufiyaa. Half now, half when kaley free.", dhivehi: false },
                    { text: "But kaley need to move fast. Warden suspicious.", dhivehi: true }
                ],
                choices: [
                    { text: "Deal. When do we go?", karma: -5, response: "fazeel_accept" },
                    { text: "How do aharen know this isn't trap?", karma: 0, response: "fazeel_suspicious" },
                    { text: "Aharen serve my time.", karma: 10, response: "fazeel_refuse" }
                ]
            }
        }
    }
};

// ==================== ACT 5 MISSIONS ====================
const ACT5_MISSIONS = [
    {
        id: "act5_m1",
        title: "Welcome to Dhoonidhoo",
        type: "story",
        description: "Arrive at prison and meet the warden",
        objectives: [
            { type: "trigger", target: "prisonArrival", current: false },
            { type: "travel", target: "wardenOffice", current: false }
        ],
        rewards: { money: 0 },
        dialogueStart: "warden_intimidation",
        unlocks: ["act5_m2"]
    },
    {
        id: "act5_m2",
        title: "Cell Block Politics",
        type: "story",
        description: "Navigate prison gang dynamics",
        objectives: [
            { type: "travel", target: "cellBlockA", current: false },
            { type: "trigger", target: "ismailMeeting", current: false }
        ],
        rewards: { money: 0 },
        dialogueStart: "ismail_alliance_offer",
        unlocks: ["act5_m3", "act5_m4"],
        moralChoice: true
    },
    {
        id: "act5_m3",
        title: "Contraband Runner",
        type: "stealth",
        description: "Smuggle goods for Big Ismail",
        objectives: [
            { type: "collect", target: "contraband", count: 5, current: 0 },
            { type: "deliver", target: "cellBlockB", current: false },
            { type: "avoid", target: "guard", current: false }
        ],
        rewards: { money: 500, karma: -15 },
        unlocks: ["act5_m5"],
        requiresChoice: "ismail_deal"
    },
    {
        id: "act5_m4",
        title: "Lone Wolf",
        type: "survival",
        description: "Survive without gang protection",
        objectives: [
            { type: "survive", target: "prisonDays", duration: 3, current: 0 },
            { type: "defeat", target: "attacker", count: 3, current: 0 }
        ],
        rewards: { money: 0, karma: 5 },
        unlocks: ["act5_m5"],
        requiresChoice: "ismail_refuse"
    },
    {
        id: "act5_m5",
        title: "Blood Revelation",
        type: "story",
        description: "Meet your half-brother Muaz",
        objectives: [
            { type: "travel", target: "muazCell", current: false },
            { type: "trigger", target: "muazMeeting", current: false }
        ],
        rewards: { money: 0 },
        dialogueStart: "muaz_first_meeting",
        unlocks: ["act5_m6"],
        majorReveal: true
    },
    {
        id: "act5_m6",
        title: "Father's Shadow",
        type: "story",
        description: "Learn the truth from Old Man Hussain",
        objectives: [
            { type: "travel", target: "exerciseYard", current: false },
            { type: "trigger", target: "hussainMeeting", current: false }
        ],
        rewards: { money: 0 },
        dialogueStart: "hussain_father_truth",
        unlocks: ["act5_m7"]
    },
    {
        id: "act5_m7",
        title: "Flashback: The Arrest",
        type: "flashback",
        description: "Relive the day father was taken",
        objectives: [
            { type: "travel", target: "flashback_father", current: false },
            { type: "witness", target: "fatherArrest", current: false }
        ],
        rewards: { karma: 0 },
        dialogueStart: "father_last_words",
        unlocks: ["act5_m8"],
        isFlashback: true,
        specialMusic: "sad_theme"
    },
    {
        id: "act5_m8",
        title: "Brotherhood",
        type: "story",
        description: "Bond with Muaz in prison",
        objectives: [
            { type: "talk", target: "muaz", count: 3, current: 0 },
            { type: "help", target: "muazFight", current: false }
        ],
        rewards: { money: 0, familyKarma: 20 },
        unlocks: ["act5_m9"]
    },
    {
        id: "act5_m9",
        title: "Escape Plan",
        type: "story",
        description: "Contact the corrupt guard",
        objectives: [
            { type: "collect", target: "bribeMoney", amount: 25000, current: 0 },
            { type: "trigger", target: "fazeelMeeting", current: false }
        ],
        rewards: { money: -25000 },
        dialogueStart: "fazeel_escape_plan",
        unlocks: ["act5_m10", "act5_m11"],
        moralChoice: true
    },
    {
        id: "act5_m10",
        title: "Tunnel Run",
        type: "escape",
        description: "Escape through the tunnels with Muaz",
        objectives: [
            { type: "travel", target: "prison_tunnels", current: false },
            { type: "navigate", target: "mainTunnel", current: false },
            { type: "survive", target: "caveIn", current: false },
            { type: "swim", target: "underwaterSection", current: false },
            { type: "reach", target: "exitPoint", current: false }
        ],
        rewards: { money: 0, karma: -10 },
        unlocks: ["act5_m12"],
        requiresChoice: "fazeel_accept",
        tensionMusic: true
    },
    {
        id: "act5_m11",
        title: "Serve Your Time",
        type: "patience",
        description: "Complete your sentence honorably",
        objectives: [
            { type: "survive", target: "prisonMonths", duration: 6, current: 0 },
            { type: "avoid", target: "trouble", current: false },
            { type: "help", target: "inmates", count: 5, current: 0 }
        ],
        rewards: { money: 0, karma: 25, familyKarma: 15 },
        unlocks: ["act5_m12"],
        requiresChoice: "fazeel_refuse"
    },
    {
        id: "act5_m12",
        title: "Safe House",
        type: "story",
        description: "Reach the Addu safe house",
        objectives: [
            { type: "travel", target: "safe_house_post_escape", current: false },
            { type: "trigger", target: "safeArrival", current: false }
        ],
        rewards: { money: 1000 },
        unlocks: ["act5_climax"]
    },
    {
        id: "act5_climax",
        title: "New Beginning",
        type: "story",
        description: "Plan the next move with Muaz",
        objectives: [
            { type: "talk", target: "muaz", current: false },
            { type: "decide", target: "futureChoice", current: false }
        ],
        rewards: { money: 5000 },
        unlocks: ["act6_start"],
        actEnd: true,
        majorChoice: "redemption_path"
    }
];

// ==================== ACT 5 SIDE MISSIONS ====================
const ACT5_SIDE_MISSIONS = [
    { id: "side5_contraband1", title: "Cigarette Run", type: "smuggling", reward: 200 },
    { id: "side5_contraband2", title: "Phone Smuggling", type: "smuggling", reward: 400 },
    { id: "side5_contraband3", title: "Drug Mule", type: "smuggling", reward: 600 },
    { id: "side5_fight1", title: "Yard Fight I", type: "combat", reward: 150 },
    { id: "side5_fight2", title: "Yard Fight II", type: "combat", reward: 250 },
    { id: "side5_fight3", title: "Cell Block Brawl", type: "combat", reward: 400 },
    { id: "side5_favor1", title: "Inmate Favor I", type: "fetch", reward: 100 },
    { id: "side5_favor2", title: "Inmate Favor II", type: "fetch", reward: 150 },
    { id: "side5_info1", title: "Information Trade", type: "dialogue", reward: 200 },
    { id: "side5_info2", title: "Snitch Hunt", type: "investigation", reward: 300 },
    { id: "side5_exercise", title: "Workout Challenge", type: "minigame", game: "exercise", reward: 100 },
    { id: "side5_chess", title: "Chess Match", type: "minigame", game: "strategy", reward: 150 }
];

// ==================== ACT 5 DIALOGUES ====================
const ACT5_DIALOGUES = {
    warden_intimidation: {
        speaker: "Warden Rasheed",
        sprite: "üëî",
        lines: [
            { text: "*in office* The famous Baokalo. In MY prison.", dhivehi: false },
            { text: "Kaley caused lot of trouble outside.", dhivehi: true },
            { text: "In here? Aharen am god. Aharen decide who lives.", dhivehi: true },
            { text: "Behave... and maybe kaley survive.", dhivehi: false },
            { text: "Or... accidents happen. Understand?", dhivehi: true }
        ],
        choices: [
            { text: "Aharen understand, sir.", karma: -5, response: "warden_submit" },
            { text: "Kaley don't scare me.", karma: 5, response: "warden_defiant" },
            { text: "How much for better treatment?", karma: -10, response: "warden_bribe" }
        ]
    },
    
    warden_submit: {
        speaker: "Warden Rasheed",
        sprite: "üëî",
        lines: [
            { text: "*smirks* Good. Kaley learning already.", dhivehi: true },
            { text: "Cell Block A. Bunk 7. Don't cause trouble.", dhivehi: false },
            { text: "Guards! Take him away.", dhivehi: false }
        ]
    },
    
    warden_defiant: {
        speaker: "Warden Rasheed",
        sprite: "üëî",
        lines: [
            { text: "*laughs* Brave words. Stupid, but brave.", dhivehi: false },
            { text: "Kaley remind me of another tough guy.", dhivehi: true },
            { text: "He's in solitary now. Three years.", dhivehi: false },
            { text: "Solitary for kaley first week. Think about attitude.", dhivehi: true }
        ]
    },
    
    warden_bribe: {
        speaker: "Warden Rasheed",
        sprite: "üëî",
        lines: [
            { text: "*interested* Kaley speak aharen language.", dhivehi: true },
            { text: "5000 rufiyaa monthly. Private cell.", dhivehi: false },
            { text: "10000 for... special privileges.", dhivehi: false },
            { text: "Family can deposit to aharen account.", dhivehi: true }
        ]
    },
    
    ismail_alliance_offer: {
        speaker: "Big Ismail",
        sprite: "üí™üèæ",
        lines: [
            { text: "*in yard* Fresh meat. Baokalo.", dhivehi: false },
            { text: "Kaley reputation precedes kaley.", dhivehi: true },
            { text: "In here, kaley need friends. Protection.", dhivehi: false },
            { text: "Work with mashakah. Run contraband.", dhivehi: true },
            { text: "Or... kaley on kaley own. Not recommended.", dhivehi: false }
        ],
        choices: [
            { text: "What's the deal?", karma: -10, response: "ismail_deal" },
            { text: "Aharen work alone.", karma: 0, response: "ismail_refuse" },
            { text: "Aharen take over. Kaley work for me.", karma: -15, response: "ismail_challenge" }
        ]
    },
    
    ismail_deal: {
        speaker: "Big Ismail",
        sprite: "üí™üèæ",
        lines: [
            { text: "*nods* Smart choice.", dhivehi: false },
            { text: "Phones, cigarettes, drugs. All come through mashakah.", dhivehi: true },
            { text: "Kaley distribute to Cell Block A. 20% cut.", dhivehi: false },
            { text: "Don't get caught. Don't talk to guards.", dhivehi: true },
            { text: "Welcome to the family.", dhivehi: false }
        ]
    },
    
    ismail_refuse: {
        speaker: "Big Ismail",
        sprite: "üí™üèæ",
        lines: [
            { text: "*shrugs* Kaley choice.", dhivehi: true },
            { text: "But remember - in here, alone means dead.", dhivehi: false },
            { text: "Mashakah won't protect kaley. Won't help kaley.", dhivehi: true },
            { text: "Good luck, Baokalo. Kaley need it.", dhivehi: false }
        ]
    },
    
    ismail_challenge: {
        speaker: "Big Ismail",
        sprite: "üí™üèæ",
        lines: [
            { text: "*laughs* Kaley got balls! Big balls!", dhivehi: true },
            { text: "But kaley new here. Aharen been king 10 years.", dhivehi: false },
            { text: "Want my throne? Take it.", dhivehi: true },
            { text: "*cracks knuckles* Right here. Right now.", dhivehi: false }
        ]
    },
    
    muaz_first_meeting: {
        speaker: "Muaz",
        sprite: "üë§",
        lines: [
            { text: "*stares* Kaley... kaley Baokalo, right?", dhivehi: true },
            { text: "Aharen been waiting for this moment.", dhivehi: true },
            { text: "Kaley don't know me. But aharen know kaley.", dhivehi: true },
            { text: "Mashakah share same blood. Same father.", dhivehi: true },
            { text: "*shows scar* He gave us both this life.", dhivehi: false }
        ],
        choices: [
            { text: "What are kaley talking about?", karma: 0, response: "muaz_explain" },
            { text: "Aharen have no brother.", karma: -5, response: "muaz_denial" },
            { text: "Father... he had another family?", karma: 5, response: "muaz_truth" }
        ]
    },
    
    muaz_explain: {
        speaker: "Muaz",
        sprite: "üë§",
        lines: [
            { text: "*sighs* Ibrahim Ronda. Our father.", dhivehi: true },
            { text: "He had two families. Kaley mother Rippoo.", dhivehi: false },
            { text: "And aharen mother. Fathimath. In Addu.", dhivehi: true },
            { text: "He visited us when he could. Before...", dhivehi: false },
            { text: "Before they killed him.", dhivehi: true }
        ]
    },
    
    muaz_denial: {
        speaker: "Muaz",
        sprite: "üë§",
        lines: [
            { text: "*angry* Denial won't change blood!", dhivehi: true },
            { text: "Look at us! Same eyes. Same jaw.", dhivehi: false },
            { text: "Kaley mother knows. Ask her.", dhivehi: true },
            { text: "Aharen not here to fight. Aharen here for truth.", dhivehi: false }
        ]
    },
    
    muaz_truth: {
        speaker: "Muaz",
        sprite: "üë§",
        lines: [
            { text: "*nods slowly* Kaley ready to hear.", dhivehi: true },
            { text: "Father was good man. Tried to provide for both families.", dhivehi: false },
            { text: "But he knew things. Dangerous things.", dhivehi: true },
            { text: "About 1988. About who really planned the coup.", dhivehi: false },
            { text: "They silenced him. Made it look like accident.", dhivehi: true },
            { text: "Aharen been searching for truth. Now mashakah search together.", dhivehi: true }
        ]
    },
    
    hussain_father_truth: {
        speaker: "Old Man Hussain",
        sprite: "üë¥üèæ",
        lines: [
            { text: "*coughs* Kaley... kaley look like him.", dhivehi: true },
            { text: "Kaley father. Ibrahim. Good man.", dhivehi: true },
            { text: "He didn't deserve what happened.", dhivehi: false },
            { text: "They set him up. The politicians.", dhivehi: false },
            { text: "He knew too much. About the 1988 coup.", dhivehi: true },
            { text: "About who REALLY brought the mercenaries.", dhivehi: false }
        ],
        choices: [
            { text: "Tell me everything.", karma: 5, response: "hussain_full_story" },
            { text: "Who killed him?", karma: 0, response: "hussain_killer" },
            { text: "Aharen don't want to know.", karma: -5, response: "hussain_ignore" }
        ]
    },
    
    hussain_full_story: {
        speaker: "Old Man Hussain",
        sprite: "üë¥üèæ",
        lines: [
            { text: "1988. Everyone blames Luthufi. The businessman.", dhivehi: false },
            { text: "But he was just... middleman.", dhivehi: true },
            { text: "Real planners? Inside government. Inside Gayoom's circle.", dhivehi: false },
            { text: "Kaley father fixed their boats. Heard conversations.", dhivehi: true },
            { text: "He could have exposed them. So they framed him.", dhivehi: false },
            { text: "Drug charges. Then 'suicide' in prison.", dhivehi: true },
            { text: "Same people still in power. Different titles.", dhivehi: false }
        ]
    },
    
    hussain_killer: {
        speaker: "Old Man Hussain",
        sprite: "üë¥üèæ",
        lines: [
            { text: "*looks around* Names are dangerous.", dhivehi: true },
            { text: "But... one man gave the order.", dhivehi: false },
            { text: "He's old now. Still powerful.", dhivehi: true },
            { text: "His son... in government today.", dhivehi: false },
            { text: "Kaley want revenge? Be careful.", dhivehi: true },
            { text: "They killed kaley father. They'll kill kaley too.", dhivehi: false }
        ]
    },
    
    hussain_ignore: {
        speaker: "Old Man Hussain",
        sprite: "üë¥üèæ",
        lines: [
            { text: "*sad* Maybe kaley right.", dhivehi: true },
            { text: "Truth is heavy burden.", dhivehi: false },
            { text: "But it finds way out. Always.", dhivehi: true },
            { text: "When kaley ready... aharen here.", dhivehi: true }
        ]
    },
    
    father_last_words: {
        speaker: "Ibrahim",
        sprite: "üë®üèæ",
        lines: [
            { text: "*being dragged away* Take care of your mother!", dhivehi: true },
            { text: "Protect your sister! Be strong!", dhivehi: true },
            { text: "Aharen love kaley! Always!", dhivehi: true },
            { text: "*to Rippoo* Tell him the truth. When he's ready.", dhivehi: true }
        ]
    },
    
    fazeel_escape_plan: {
        speaker: "Guard Fazeel",
        sprite: "üëÆüèæ",
        lines: [
            { text: "*whispers* Kaley want out? Aharen can help.", dhivehi: true },
            { text: "Old tunnel from construction days.", dhivehi: false },
            { text: "50,000 rufiyaa. Half now, half when kaley free.", dhivehi: false },
            { text: "But kaley need to move fast. Warden suspicious.", dhivehi: true }
        ],
        choices: [
            { text: "Deal. When do we go?", karma: -5, response: "fazeel_accept" },
            { text: "How do aharen know this isn't trap?", karma: 0, response: "fazeel_suspicious" },
            { text: "Aharen serve my time.", karma: 10, response: "fazeel_refuse" }
        ]
    },
    
    fazeel_accept: {
        speaker: "Guard Fazeel",
        sprite: "üëÆüèæ",
        lines: [
            { text: "*nods* Tomorrow night. 2 AM.", dhivehi: false },
            { text: "Aharen unlock maintenance door.", dhivehi: true },
            { text: "Tunnel entrance in basement. Follow it.", dhivehi: false },
            { text: "Exits near old dock. Boat waiting.", dhivehi: true },
            { text: "Don't be late. Aharen won't wait.", dhivehi: false }
        ]
    },
    
    fazeel_suspicious: {
        speaker: "Guard Fazeel",
        sprite: "üëÆüèæ",
        lines: [
            { text: "*shrugs* Kaley don't trust? Fine.", dhivehi: true },
            { text: "But ask around. Aharen helped others.", dhivehi: false },
            { text: "Aharen not loyal to warden. He's monster.", dhivehi: true },
            { text: "Kaley choice. Freedom or rot here.", dhivehi: false }
        ]
    },
    
    fazeel_refuse: {
        speaker: "Guard Fazeel",
        sprite: "üëÆüèæ",
        lines: [
            { text: "*surprised* Kaley... want to stay?", dhivehi: true },
            { text: "First time aharen hear that.", dhivehi: false },
            { text: "Kaley either brave or stupid.", dhivehi: true },
            { text: "Good luck, Baokalo. Kaley need it here.", dhivehi: false }
        ]
    }
};

// ==================== ACT 5 RADIO CONTENT ====================
const ACT5_RADIO = {
    raajjeFM: {
        name: "üìª Raajje FM",
        segments: [
            { type: "news", text: "Gang leader Baokalo sentenced to 15 years. Justice served!" },
            { type: "news", text: "Prison reform bill rejected. 'Conditions are fine' - Warden" },
            { type: "satire", text: "Dhoonidhoo: 5-star accommodation for criminals! (Bribes extra)" },
            { type: "news", text: "Escaped prisoner recaptured. 'Security is tight' - Police" },
            { type: "ad", text: "Visit Maldives! Where even prisons have ocean views!" }
        ]
    },
    undergroundFM: {
        name: "üìª Underground FM",
        segments: [
            { type: "truth", text: "Dhoonidhoo death toll covered up. 15 'suicides' this year." },
            { type: "truth", text: "Warden Rasheed's Swiss accounts revealed." },
            { type: "truth", text: "Political prisoners mixed with violent criminals. Intentional?" },
            { type: "music", text: "‚ô™ Playing: 'Prison Blues' - Dhoonidhoo Anthem ‚ô™" }
        ]
    }
};

// ==================== PRISON MINI-GAMES ====================

// Exercise Yard Workout
let workoutGame = {
    active: false,
    exercise: '',
    reps: 0,
    targetReps: 0,
    timer: 30,
    score: 0
};

function startWorkoutGame() {
    workoutGame.active = true;
    workoutGame.exercise = ['Push-ups', 'Squats', 'Burpees'][Math.floor(Math.random() * 3)];
    workoutGame.reps = 0;
    workoutGame.targetReps = 15 + Math.floor(Math.random() * 10);
    workoutGame.timer = 30;
    workoutGame.score = 0;
    GameState.isInMinigame = true;
    
    document.getElementById('minigame-overlay').classList.remove('hidden');
    document.getElementById('minigame-title').textContent = `üí™ ${workoutGame.exercise}`;
    
    const timerInterval = setInterval(() => {
        workoutGame.timer--;
        if (workoutGame.timer <= 0 || !workoutGame.active) {
            clearInterval(timerInterval);
            if (workoutGame.active) endWorkoutGame();
        }
    }, 1000);
    
    document.addEventListener('keydown', workoutKeyHandler);
    requestAnimationFrame(workoutLoop);
}

function workoutKeyHandler(e) {
    if (!workoutGame.active) return;
    
    if (e.key === ' ' || e.key === 'Enter') {
        workoutGame.reps++;
        workoutGame.score += 10;
        
        if (workoutGame.reps >= workoutGame.targetReps) {
            endWorkoutGame();
        }
    }
}

function workoutLoop() {
    if (!workoutGame.active) return;
    
    const ctx = minigameCtx;
    const width = minigameCanvas.width;
    const height = minigameCanvas.height;
    
    ctx.fillStyle = '#1a1a2e';
    ctx.fillRect(0, 0, width, height);
    
    // Timer
    ctx.fillStyle = workoutGame.timer > 10 ? '#fff' : '#ff0000';
    ctx.font = 'bold 16px Arial';
    ctx.textAlign = 'right';
    ctx.fillText(`Time: ${workoutGame.timer}s`, width - 10, 25);
    
    // Exercise name
    ctx.fillStyle = '#ffcc00';
    ctx.font = 'bold 24px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(workoutGame.exercise, width / 2, 50);
    
    // Progress bar
    const progress = workoutGame.reps / workoutGame.targetReps;
    ctx.fillStyle = '#333';
    ctx.fillRect(50, 80, width - 100, 30);
    ctx.fillStyle = '#00ff00';
    ctx.fillRect(50, 80, (width - 100) * Math.min(1, progress), 30);
    
    // Reps counter
    ctx.fillStyle = '#fff';
    ctx.font = 'bold 36px Arial';
    ctx.fillText(`${workoutGame.reps} / ${workoutGame.targetReps}`, width / 2, 160);
    
    // Character animation
    const bounce = Math.sin(workoutGame.reps * 0.5) * 10;
    ctx.font = '60px Arial';
    ctx.fillText('üèãÔ∏è', width / 2, 220 + bounce);
    
    // Instructions
    ctx.fillStyle = '#778da9';
    ctx.font = '14px Arial';
    ctx.fillText('Press SPACE or ENTER rapidly!', width / 2, height - 20);
    
    requestAnimationFrame(workoutLoop);
}

function endWorkoutGame() {
    workoutGame.active = false;
    GameState.isInMinigame = false;
    document.removeEventListener('keydown', workoutKeyHandler);
    document.getElementById('minigame-overlay').classList.add('hidden');
    
    if (workoutGame.reps >= workoutGame.targetReps) {
        GameState.player.maxHealth += 5;
        showNotification('Workout Complete!', '+5 Max Health');
    } else {
        showNotification('Workout Failed', `Only ${workoutGame.reps} reps`);
    }
}

// Tunnel Navigation (for escape)
let tunnelGame = {
    active: false,
    position: 0,
    oxygen: 100,
    obstacles: [],
    distance: 100,
    speed: 1
};

function startTunnelGame() {
    tunnelGame.active = true;
    tunnelGame.position = 0;
    tunnelGame.oxygen = 100;
    tunnelGame.obstacles = [];
    tunnelGame.distance = 100;
    tunnelGame.speed = 1;
    GameState.isInMinigame = true;
    
    // Generate obstacles
    for (let i = 0; i < 10; i++) {
        tunnelGame.obstacles.push({
            x: 20 + i * 10,
            type: Math.random() < 0.5 ? 'rock' : 'water'
        });
    }
    
    document.getElementById('minigame-overlay').classList.remove('hidden');
    document.getElementById('minigame-title').textContent = 'üï≥Ô∏è Escape Tunnel';
    
    document.addEventListener('keydown', tunnelKeyHandler);
    requestAnimationFrame(tunnelLoop);
}

function tunnelKeyHandler(e) {
    if (!tunnelGame.active) return;
    
    if (e.key === 'ArrowRight' || e.key === 'd') {
        tunnelGame.position += tunnelGame.speed;
    } else if (e.key === ' ') {
        // Jump over obstacle
        tunnelGame.speed = 2;
        setTimeout(() => tunnelGame.speed = 1, 500);
    }
}

function tunnelLoop() {
    if (!tunnelGame.active) return;
    
    const ctx = minigameCtx;
    const width = minigameCanvas.width;
    const height = minigameCanvas.height;
    
    // Decrease oxygen
    tunnelGame.oxygen -= 0.1;
    
    ctx.fillStyle = '#0a0a0a';
    ctx.fillRect(0, 0, width, height);
    
    // Oxygen bar
    ctx.fillStyle = '#333';
    ctx.fillRect(10, 10, 150, 20);
    ctx.fillStyle = tunnelGame.oxygen > 30 ? '#00aaff' : '#ff0000';
    ctx.fillRect(10, 10, tunnelGame.oxygen * 1.5, 20);
    ctx.fillStyle = '#fff';
    ctx.font = '12px Arial';
    ctx.textAlign = 'left';
    ctx.fillText(`O‚ÇÇ: ${Math.floor(tunnelGame.oxygen)}%`, 15, 25);
    
    // Progress
    ctx.fillStyle = '#333';
    ctx.fillRect(10, 40, width - 20, 15);
    ctx.fillStyle = '#00ff00';
    ctx.fillRect(10, 40, (width - 20) * (tunnelGame.position / tunnelGame.distance), 15);
    
    // Tunnel visualization
    ctx.fillStyle = '#2a2a2a';
    ctx.fillRect(0, 80, width, height - 100);
    
    // Player
    const playerX = 50;
    ctx.font = '30px Arial';
    ctx.fillText('üèÉ', playerX, 150);
    
    // Obstacles
    tunnelGame.obstacles.forEach(obs => {
        const obsX = (obs.x - tunnelGame.position) * 10 + 100;
        if (obsX > 0 && obsX < width) {
            ctx.font = '25px Arial';
            ctx.fillText(obs.type === 'rock' ? 'ü™®' : 'üíß', obsX, 150);
        }
    });
    
    // Check win/lose
    if (tunnelGame.position >= tunnelGame.distance) {
        endTunnelGame(true);
        return;
    }
    
    if (tunnelGame.oxygen <= 0) {
        endTunnelGame(false);
        return;
    }
    
    // Instructions
    ctx.fillStyle = '#778da9';
    ctx.font = '12px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('‚Üí or D to move | SPACE to jump', width / 2, height - 10);
    
    requestAnimationFrame(tunnelLoop);
}

function endTunnelGame(success) {
    tunnelGame.active = false;
    GameState.isInMinigame = false;
    document.removeEventListener('keydown', tunnelKeyHandler);
    document.getElementById('minigame-overlay').classList.add('hidden');
    
    if (success) {
        showNotification('Escaped!', 'Freedom awaits...');
        updateMissionObjective('reach', 'exitPoint', true);
    } else {
        showNotification('Caught!', 'Ran out of oxygen');
        GameState.player.health -= 30;
    }
}

// ==================== EXPORT FOR MAIN GAME ====================
if (typeof window !== 'undefined') {
    window.ACT5_MAPS = ACT5_MAPS;
    window.ACT5_CHARACTERS = ACT5_CHARACTERS;
    window.ACT5_MISSIONS = ACT5_MISSIONS;
    window.ACT5_SIDE_MISSIONS = ACT5_SIDE_MISSIONS;
    window.ACT5_DIALOGUES = ACT5_DIALOGUES;
    window.ACT5_RADIO = ACT5_RADIO;
    window.startWorkoutGame = startWorkoutGame;
    window.startTunnelGame = startTunnelGame;
}


// ========== act6.js ==========
// ============================================
// ACT 6: SOUTHERN EMPIRE
// Timeline: 2020 - Expansion to the South
// ============================================

// ==================== ACT 6 MAPS ====================
const ACT6_MAPS = {
    addu_hithadhoo: {
        name: "Addu City - Hithadhoo",
        width: 70,
        height: 60,
        spawnX: 35,
        spawnY: 50,
        tiles: [],
        npcs: [],
        items: [],
        zones: {
            harbor: { x: 5, y: 45, w: 15, h: 12, name: "Hithadhoo Harbor üö¢" },
            market: { x: 25, y: 35, w: 12, h: 10, name: "Fish Market üêü" },
            mosque: { x: 40, y: 30, w: 8, h: 8, name: "Friday Mosque üïå" },
            school: { x: 55, y: 25, w: 10, h: 8, name: "Addu High School üè´" },
            hospital: { x: 30, y: 15, w: 12, h: 10, name: "Hithadhoo Hospital üè•" },
            gangTerritory: { x: 50, y: 40, w: 15, h: 12, name: "Kalo Oiy Territory üíÄ" },
            causewayNorth: { x: 60, y: 5, w: 8, h: 10, name: "Causeway to Maradhoo ‚Üí" }
        },
        gangTerritory: 'kalo_oiy',
        isAddu: true
    },
    
    addu_maradhoo: {
        name: "Addu City - Maradhoo",
        width: 55,
        height: 50,
        spawnX: 27,
        spawnY: 45,
        tiles: [],
        npcs: [],
        items: [],
        zones: {
            causewaySouth: { x: 5, y: 40, w: 8, h: 8, name: "‚Üê Causeway to Hithadhoo" },
            village: { x: 20, y: 25, w: 15, h: 12, name: "Maradhoo Village üèòÔ∏è" },
            beach: { x: 35, y: 35, w: 15, h: 10, name: "Maradhoo Beach üèñÔ∏è" },
            gangTerritory: { x: 10, y: 10, w: 12, h: 10, name: "Maradhoo Boys Territory üî¥" },
            causewayNorth: { x: 45, y: 5, w: 8, h: 8, name: "Causeway to Feydhoo ‚Üí" }
        },
        gangTerritory: 'maradhoo_boys',
        isAddu: true
    },
    
    addu_feydhoo: {
        name: "Addu City - Feydhoo",
        width: 50,
        height: 45,
        spawnX: 25,
        spawnY: 40,
        tiles: [],
        npcs: [],
        items: [],
        zones: {
            causewaySouth: { x: 5, y: 35, w: 8, h: 8, name: "‚Üê Causeway to Maradhoo" },
            center: { x: 18, y: 20, w: 14, h: 12, name: "Feydhoo Center üèõÔ∏è" },
            gangTerritory: { x: 35, y: 15, w: 10, h: 10, name: "Feydhoo Fighters Territory ‚öîÔ∏è" },
            causewayEast: { x: 40, y: 35, w: 8, h: 8, name: "Link Road to Gan ‚Üí" }
        },
        gangTerritory: 'feydhoo_fighters',
        isAddu: true
    },
    
    addu_gan: {
        name: "Addu City - Gan (Former British Base)",
        width: 65,
        height: 55,
        spawnX: 32,
        spawnY: 50,
        tiles: [],
        npcs: [],
        items: [],
        zones: {
            airport: { x: 10, y: 10, w: 25, h: 15, name: "Gan International Airport ‚úàÔ∏è" },
            britishRuins: { x: 40, y: 15, w: 15, h: 12, name: "British Base Ruins üèöÔ∏è" },
            resort: { x: 45, y: 35, w: 15, h: 12, name: "Equator Village Resort üè®" },
            linkRoad: { x: 5, y: 40, w: 8, h: 8, name: "‚Üê Link Road to Feydhoo" },
            smugglerCove: { x: 55, y: 45, w: 8, h: 8, name: "Smuggler's Cove üè¥‚Äç‚ò†Ô∏è" }
        },
        hasAirport: true,
        isAddu: true
    },
    
    fuvahmulah: {
        name: "Fuvahmulah Island",
        width: 60,
        height: 55,
        spawnX: 30,
        spawnY: 45,
        tiles: [],
        npcs: [],
        items: [],
        zones: {
            harbor: { x: 25, y: 45, w: 10, h: 8, name: "Fuvahmulah Harbor üö¢" },
            thoondu: { x: 10, y: 35, w: 12, h: 10, name: "Thoondu Beach üèñÔ∏è" },
            bandaara: { x: 35, y: 25, w: 10, h: 8, name: "Bandaara Kilhi (Lake) üåä" },
            dhadimago: { x: 20, y: 15, w: 12, h: 10, name: "Dhadimago Village üèòÔ∏è" },
            gangTerritory: { x: 40, y: 35, w: 12, h: 10, name: "Fuvahmulah Fury Territory üî•" },
            tigerSharkPoint: { x: 50, y: 20, w: 8, h: 8, name: "Tiger Shark Point ü¶à" }
        },
        gangTerritory: 'fuvahmulah_fury',
        isFuvahmulah: true,
        uniqueDialect: 'fuvahmulah_bas'
    },
    
    huvadhu_atoll: {
        name: "Huvadhu Atoll",
        width: 55,
        height: 50,
        spawnX: 27,
        spawnY: 45,
        tiles: [],
        npcs: [],
        items: [],
        zones: {
            thinadhoo: { x: 20, y: 20, w: 15, h: 12, name: "Thinadhoo Island üèùÔ∏è" },
            kolamaafushi: { x: 40, y: 15, w: 10, h: 8, name: "Kolamaafushi üèùÔ∏è" },
            gaddhoo: { x: 10, y: 35, w: 10, h: 8, name: "Gaddhoo üèùÔ∏è" },
            openSea: { x: 25, y: 35, w: 15, h: 10, name: "Open Sea üåä" }
        },
        isAtoll: true,
        requiresBoat: true
    }
};

// ==================== ADDU GANGS (from Bible) ====================
const ADDU_GANGS = {
    kalo_oiy: {
        name: "Kalo Oiy",
        meaning: "Black Snake",
        territory: "Hithadhoo",
        strength: 45,
        specialty: "Drug trafficking",
        leader: "Kuda Manik",
        color: "#1a1a1a"
    },
    maradhoo_boys: {
        name: "Maradhoo Boys",
        meaning: "Maradhoo Boys",
        territory: "Maradhoo",
        strength: 30,
        specialty: "Robbery",
        leader: "Bodu Hassan",
        color: "#cc0000"
    },
    feydhoo_fighters: {
        name: "Feydhoo Fighters",
        meaning: "Feydhoo Fighters",
        territory: "Feydhoo",
        strength: 25,
        specialty: "Protection rackets",
        leader: "Ismail Didi",
        color: "#0066cc"
    },
    fuvahmulah_fury: {
        name: "Fuvahmulah Fury",
        meaning: "Fuvahmulah Fury",
        territory: "Fuvahmulah",
        strength: 40,
        specialty: "Fishing boat smuggling",
        leader: "Thakuru",
        color: "#ff6600"
    },
    gan_ghosts: {
        name: "Gan Ghosts",
        meaning: "Gan Ghosts",
        territory: "Gan",
        strength: 20,
        specialty: "Airport smuggling",
        leader: "British Ali",
        color: "#666666"
    },
    southern_syndicate: {
        name: "Southern Syndicate",
        meaning: "Southern Syndicate",
        territory: "All Addu",
        strength: 60,
        specialty: "Multi-island operations",
        leader: "Don Shareef",
        color: "#990099"
    }
};

// ==================== ACT 6 CHARACTERS ====================
const ACT6_CHARACTERS = {
    donShareef: {
        name: "Don Shareef",
        sprite: "üé©",
        role: "Southern Syndicate Boss",
        backstory: "Controls all southern drug routes. Former fisherman turned crime lord. Speaks refined Addu Bas.",
        dialogues: {
            first_meeting: {
                speaker: "Don Shareef",
                sprite: "üé©",
                lines: [
                    { text: "*in mansion* Kon aiy Baokalo. Mal√© aiy famous.", dhivehi: true, dialect: "addu" },
                    { text: "Kaley think kaley can come south and take over?", dhivehi: true },
                    { text: "Addu different from Mal√©. Aharemen control here.", dhivehi: true, dialect: "addu" },
                    { text: "But... aharemen hear kaley good. Useful.", dhivehi: true, dialect: "addu" },
                    { text: "Work WITH aharemen. Not against. Understand?", dhivehi: true }
                ],
                choices: [
                    { text: "What's the arrangement?", karma: 0, response: "shareef_deal" },
                    { text: "Aharen don't work for anyone.", karma: -10, response: "shareef_refuse" },
                    { text: "Aharen here to take over.", karma: -25, response: "shareef_challenge" }
                ]
            }
        }
    },
    
    kudaManik: {
        name: "Kuda Manik",
        sprite: "üêç",
        role: "Kalo Oiy Leader",
        backstory: "Hithadhoo's most feared gangster. Got his name from snake-like cunning. Muaz's contact in Addu.",
        dialogues: {
            introduction: {
                speaker: "Kuda Manik",
                sprite: "üêç",
                lines: [
                    { text: "*hisses* Muaz aiy brother sent kaley?", dhivehi: true, dialect: "addu" },
                    { text: "Aharemen heard about prison escape. Impressive.", dhivehi: true, dialect: "addu" },
                    { text: "Kalo Oiy can use someone like kaley.", dhivehi: true },
                    { text: "But first... prove kaley worth.", dhivehi: true }
                ]
            }
        }
    },
    
    thakuru: {
        name: "Thakuru",
        sprite: "ü¶à",
        role: "Fuvahmulah Fury Leader",
        backstory: "Named after the tiger sharks he swims with. Controls Fuvahmulah's fishing fleet and smuggling routes.",
        dialogues: {
            shark_meeting: {
                speaker: "Thakuru",
                sprite: "ü¶à",
                lines: [
                    { text: "*on boat* Kaley know why they call me Thakuru?", dhivehi: true },
                    { text: "Tiger shark. Aharemen swim with them.", dhivehi: true, dialect: "fuvahmulah" },
                    { text: "Fuvahmulah people... aharemen different.", dhivehi: true, dialect: "fuvahmulah" },
                    { text: "Aharemen own language. Own ways.", dhivehi: true, dialect: "fuvahmulah" },
                    { text: "Kaley want to work here? Learn respect first.", dhivehi: true }
                ],
                choices: [
                    { text: "Teach me your ways.", karma: 5, response: "thakuru_teach" },
                    { text: "Business is business.", karma: -5, response: "thakuru_business" },
                    { text: "Aharen just passing through.", karma: 0, response: "thakuru_pass" }
                ]
            }
        }
    },
    
    britishAli: {
        name: "British Ali",
        sprite: "üéñÔ∏è",
        role: "Gan Ghosts Leader",
        backstory: "Grew up in British base ruins. Speaks English fluently. Runs airport smuggling operations.",
        dialogues: {
            airport_meeting: {
                speaker: "British Ali",
                sprite: "üéñÔ∏è",
                lines: [
                    { text: "*in British accent* Ah, the famous Baokalo!", dhivehi: false },
                    { text: "Welcome to Gan. Former RAF base, you know.", dhivehi: false },
                    { text: "My grandfather worked for the British. Learned their ways.", dhivehi: false },
                    { text: "Now I run... import/export. Through the airport.", dhivehi: false },
                    { text: "Kaley interested in partnership?", dhivehi: true }
                ]
            }
        }
    },
    
    muazSouth: {
        name: "Muaz",
        sprite: "üë§",
        role: "Half-Brother (Guide)",
        backstory: "Guides Baokalo through southern territories. Has connections from mother's Addu family.",
        dialogues: {
            addu_arrival: {
                speaker: "Muaz",
                sprite: "üë§",
                lines: [
                    { text: "*on boat* Welcome to Addu, brother.", dhivehi: true },
                    { text: "Aharen mother's family from here. Aharemen have connections.", dhivehi: true, dialect: "addu" },
                    { text: "But careful. South different from Mal√©.", dhivehi: true },
                    { text: "People here... they remember everything.", dhivehi: false },
                    { text: "Our father had enemies here too.", dhivehi: true }
                ]
            }
        }
    },
    
    fisherwoman: {
        name: "Aisha Fulhu",
        sprite: "üé£",
        role: "Fishing Boat Captain",
        backstory: "One of few female boat captains. Knows all the smuggling routes. Neutral party.",
        dialogues: {
            fishing_lesson: {
                speaker: "Aisha Fulhu",
                sprite: "üé£",
                lines: [
                    { text: "*on dhoni* Kaley want to learn real fishing?", dhivehi: true },
                    { text: "Not this tourist nonsense. Real Maldivian way.", dhivehi: false },
                    { text: "Pole and line. No nets. Sustainable.", dhivehi: false },
                    { text: "Also... good cover for other cargo. Hehe.", dhivehi: true }
                ]
            }
        }
    }
};

// ==================== ACT 6 MISSIONS ====================
const ACT6_MISSIONS = [
    {
        id: "act6_m1",
        title: "Southern Arrival",
        type: "story",
        description: "Arrive in Addu with Muaz",
        objectives: [
            { type: "travel", target: "addu_hithadhoo", current: false },
            { type: "trigger", target: "muazAdduArrival", current: false }
        ],
        rewards: { money: 500 },
        dialogueStart: "muaz_addu_arrival",
        unlocks: ["act6_m2"]
    },
    {
        id: "act6_m2",
        title: "The Black Snake",
        type: "story",
        description: "Meet Kuda Manik of Kalo Oiy",
        objectives: [
            { type: "travel", target: "gangTerritory", current: false },
            { type: "trigger", target: "kudaManikMeeting", current: false }
        ],
        rewards: { money: 300 },
        dialogueStart: "kudamanik_introduction",
        unlocks: ["act6_m3"]
    },
    {
        id: "act6_m3",
        title: "Prove Your Worth",
        type: "combat",
        description: "Clear rival gang from Hithadhoo market",
        objectives: [
            { type: "travel", target: "market", current: false },
            { type: "defeat", target: "rivalGang", count: 8, current: 0 }
        ],
        rewards: { money: 1500, reputation: { kalo_oiy: 20 } },
        unlocks: ["act6_m4"]
    },
    {
        id: "act6_m4",
        title: "Causeway Run",
        type: "driving",
        description: "Drive contraband across the causeways",
        objectives: [
            { type: "collect", target: "contraband", current: false },
            { type: "drive", target: "addu_maradhoo", current: false },
            { type: "deliver", target: "maradhooContact", current: false },
            { type: "avoid", target: "police", current: false }
        ],
        rewards: { money: 2000 },
        unlocks: ["act6_m5"],
        vehicleRequired: "motorcycle"
    },
    {
        id: "act6_m5",
        title: "The Don",
        type: "story",
        description: "Meet Don Shareef of the Southern Syndicate",
        objectives: [
            { type: "travel", target: "addu_gan", current: false },
            { type: "trigger", target: "shareefMeeting", current: false }
        ],
        rewards: { money: 0 },
        dialogueStart: "donshareef_first_meeting",
        unlocks: ["act6_m6", "act6_m7"],
        moralChoice: true
    },
    {
        id: "act6_m6",
        title: "Syndicate Soldier",
        type: "missions",
        description: "Work for Don Shareef",
        objectives: [
            { type: "complete", target: "syndicateMission", count: 3, current: 0 }
        ],
        rewards: { money: 5000, karma: -20, reputation: { southern_syndicate: 40 } },
        unlocks: ["act6_m8"],
        requiresChoice: "shareef_deal"
    },
    {
        id: "act6_m7",
        title: "Independent Operator",
        type: "survival",
        description: "Build your own network without Shareef",
        objectives: [
            { type: "recruit", target: "localGang", count: 2, current: 0 },
            { type: "establish", target: "territory", current: false },
            { type: "survive", target: "syndicateAttack", current: false }
        ],
        rewards: { money: 3000, karma: 5 },
        unlocks: ["act6_m8"],
        requiresChoice: "shareef_refuse"
    },
    {
        id: "act6_m8",
        title: "Fuvahmulah Journey",
        type: "travel",
        description: "Take boat to Fuvahmulah",
        objectives: [
            { type: "travel", target: "harbor", current: false },
            { type: "boat", target: "fuvahmulah", current: false }
        ],
        rewards: { money: 500 },
        unlocks: ["act6_m9"],
        vehicleRequired: "speedboat"
    },
    {
        id: "act6_m9",
        title: "Tiger Shark",
        type: "story",
        description: "Meet Thakuru of Fuvahmulah Fury",
        objectives: [
            { type: "travel", target: "tigerSharkPoint", current: false },
            { type: "trigger", target: "thakuruMeeting", current: false }
        ],
        rewards: { money: 0 },
        dialogueStart: "thakuru_shark_meeting",
        unlocks: ["act6_m10"],
        moralChoice: true
    },
    {
        id: "act6_m10",
        title: "Shark Dive",
        type: "diving",
        description: "Dive with tiger sharks to prove courage",
        objectives: [
            { type: "dive", target: "sharkPoint", current: false },
            { type: "survive", target: "sharkEncounter", duration: 60, current: 0 },
            { type: "collect", target: "underwaterCache", current: false }
        ],
        rewards: { money: 2000, karma: 5 },
        unlocks: ["act6_m11"],
        minigame: "diving"
    },
    {
        id: "act6_m11",
        title: "Fishing Lessons",
        type: "minigame",
        description: "Learn traditional fishing from Aisha",
        objectives: [
            { type: "talk", target: "aishaFulhu", current: false },
            { type: "minigame", target: "fishing", score: 500, current: 0 }
        ],
        rewards: { money: 800 },
        dialogueStart: "aisha_fishing_lesson",
        unlocks: ["act6_m12"]
    },
    {
        id: "act6_m12",
        title: "British Connection",
        type: "story",
        description: "Meet British Ali at Gan Airport",
        objectives: [
            { type: "travel", target: "airport", current: false },
            { type: "trigger", target: "britishAliMeeting", current: false }
        ],
        rewards: { money: 500 },
        dialogueStart: "britishali_airport_meeting",
        unlocks: ["act6_m13"]
    },
    {
        id: "act6_m13",
        title: "Airport Heist",
        type: "heist",
        description: "Steal cargo from Gan Airport",
        objectives: [
            { type: "infiltrate", target: "airport", current: false },
            { type: "steal", target: "cargo", current: false },
            { type: "escape", target: "smugglerCove", current: false }
        ],
        rewards: { money: 10000, karma: -15 },
        unlocks: ["act6_climax"],
        heistPlanning: true
    },
    {
        id: "act6_climax",
        title: "Southern Crown",
        type: "boss",
        description: "Confront Don Shareef for control of the South",
        objectives: [
            { type: "travel", target: "resort", current: false },
            { type: "defeat", target: "syndicateGuard", count: 15, current: 0 },
            { type: "boss", target: "donShareef", current: false },
            { type: "decide", target: "southernFate", current: false }
        ],
        rewards: { money: 25000 },
        unlocks: ["act7_start"],
        actEnd: true,
        bossMusic: true,
        majorChoice: "southern_control"
    }
];

// ==================== ACT 6 SIDE MISSIONS ====================
const ACT6_SIDE_MISSIONS = [
    { id: "side6_fish1", title: "Fishing Run I", type: "fishing", reward: 300 },
    { id: "side6_fish2", title: "Fishing Run II", type: "fishing", reward: 500 },
    { id: "side6_fish3", title: "Night Fishing", type: "fishing", reward: 800 },
    { id: "side6_smuggle1", title: "Boat Smuggling I", type: "smuggling", reward: 600 },
    { id: "side6_smuggle2", title: "Boat Smuggling II", type: "smuggling", reward: 900 },
    { id: "side6_causeway1", title: "Causeway Race I", type: "racing", reward: 400 },
    { id: "side6_causeway2", title: "Causeway Race II", type: "racing", reward: 700 },
    { id: "side6_dive1", title: "Reef Diving I", type: "diving", reward: 500 },
    { id: "side6_dive2", title: "Shipwreck Dive", type: "diving", reward: 1000 },
    { id: "side6_gang1", title: "Gang Turf War", type: "combat", reward: 600 },
    { id: "side6_gang2", title: "Territory Defense", type: "combat", reward: 800 },
    { id: "side6_resort", title: "Resort Delivery", type: "delivery", reward: 500 },
    { id: "side6_british", title: "British Ruins Exploration", type: "exploration", reward: 400 },
    { id: "side6_shark", title: "Shark Photography", type: "diving", reward: 700 }
];

// ==================== ACT 6 DIALOGUES ====================
const ACT6_DIALOGUES = {
    muaz_addu_arrival: {
        speaker: "Muaz",
        sprite: "üë§",
        lines: [
            { text: "*on boat* Welcome to Addu, brother.", dhivehi: true },
            { text: "Aharen mother's family from here. Aharemen have connections.", dhivehi: true },
            { text: "But careful. South different from Mal√©.", dhivehi: true },
            { text: "People here... they remember everything.", dhivehi: false },
            { text: "Our father had enemies here too.", dhivehi: true }
        ]
    },
    
    kudamanik_introduction: {
        speaker: "Kuda Manik",
        sprite: "üêç",
        lines: [
            { text: "*hisses* Muaz aiy brother sent kaley?", dhivehi: true },
            { text: "Aharemen heard about prison escape. Impressive.", dhivehi: true },
            { text: "Kalo Oiy can use someone like kaley.", dhivehi: true },
            { text: "But first... prove kaley worth.", dhivehi: true }
        ]
    },
    
    donshareef_first_meeting: {
        speaker: "Don Shareef",
        sprite: "üé©",
        lines: [
            { text: "*in mansion* Kon aiy Baokalo. Mal√© aiy famous.", dhivehi: true },
            { text: "Kaley think kaley can come south and take over?", dhivehi: true },
            { text: "Addu different from Mal√©. Aharemen control here.", dhivehi: true },
            { text: "But... aharemen hear kaley good. Useful.", dhivehi: true },
            { text: "Work WITH aharemen. Not against. Understand?", dhivehi: true }
        ],
        choices: [
            { text: "What's the arrangement?", karma: 0, response: "shareef_deal" },
            { text: "Aharen don't work for anyone.", karma: -10, response: "shareef_refuse" },
            { text: "Aharen here to take over.", karma: -25, response: "shareef_challenge" }
        ]
    },
    
    shareef_deal: {
        speaker: "Don Shareef",
        sprite: "üé©",
        lines: [
            { text: "*smiles* Smart. Very smart.", dhivehi: false },
            { text: "Kaley run operations in Hithadhoo. 40% to aharemen.", dhivehi: true },
            { text: "Aharemen provide protection. Connections. Boats.", dhivehi: true },
            { text: "Don't betray aharemen. Last one who did...", dhivehi: true },
            { text: "*points to shark tank* ...is in there.", dhivehi: false }
        ]
    },
    
    shareef_refuse: {
        speaker: "Don Shareef",
        sprite: "üé©",
        lines: [
            { text: "*cold* Kaley refuse Don Shareef?", dhivehi: true },
            { text: "Bold. Stupid, but bold.", dhivehi: false },
            { text: "Kaley have one week. Then aharemen come for kaley.", dhivehi: true },
            { text: "Leave Addu... or die here.", dhivehi: false }
        ]
    },
    
    shareef_challenge: {
        speaker: "Don Shareef",
        sprite: "üé©",
        lines: [
            { text: "*laughs* Take over? TAKE OVER?!", dhivehi: true },
            { text: "Aharemen built this empire 20 years!", dhivehi: true },
            { text: "Kaley think kaley can just walk in?!", dhivehi: true },
            { text: "*stands* Guards! Show this Mal√© boy the door.", dhivehi: false },
            { text: "The hard way.", dhivehi: false }
        ]
    },
    
    thakuru_shark_meeting: {
        speaker: "Thakuru",
        sprite: "ü¶à",
        lines: [
            { text: "*on boat* Kaley know why they call me Thakuru?", dhivehi: true },
            { text: "Tiger shark. Aharemen swim with them.", dhivehi: true },
            { text: "Fuvahmulah people... aharemen different.", dhivehi: true },
            { text: "Aharemen own language. Own ways.", dhivehi: true },
            { text: "Kaley want to work here? Learn respect first.", dhivehi: true }
        ],
        choices: [
            { text: "Teach me your ways.", karma: 5, response: "thakuru_teach" },
            { text: "Business is business.", karma: -5, response: "thakuru_business" },
            { text: "Aharen just passing through.", karma: 0, response: "thakuru_pass" }
        ]
    },
    
    thakuru_teach: {
        speaker: "Thakuru",
        sprite: "ü¶à",
        lines: [
            { text: "*nods approvingly* Good answer.", dhivehi: false },
            { text: "First lesson: the sea. She gives, she takes.", dhivehi: true },
            { text: "Respect her. Respect the sharks.", dhivehi: true },
            { text: "Tomorrow, kaley dive with aharemen.", dhivehi: true },
            { text: "If kaley survive... kaley one of us.", dhivehi: true }
        ]
    },
    
    thakuru_business: {
        speaker: "Thakuru",
        sprite: "ü¶à",
        lines: [
            { text: "*frowns* Business? That's Mal√© thinking.", dhivehi: true },
            { text: "Here, everything connected. Family. Sea. Land.", dhivehi: true },
            { text: "Kaley want to do business? Fine.", dhivehi: false },
            { text: "But don't expect loyalty. Just transactions.", dhivehi: true }
        ]
    },
    
    thakuru_pass: {
        speaker: "Thakuru",
        sprite: "ü¶à",
        lines: [
            { text: "*shrugs* Passing through? Nobody passes through Fuvahmulah.", dhivehi: true },
            { text: "Kaley either stay... or kaley leave.", dhivehi: true },
            { text: "But kaley don't 'pass through'.", dhivehi: false },
            { text: "Decide. Now.", dhivehi: true }
        ]
    },
    
    britishali_airport_meeting: {
        speaker: "British Ali",
        sprite: "üéñÔ∏è",
        lines: [
            { text: "*in British accent* Ah, the famous Baokalo!", dhivehi: false },
            { text: "Welcome to Gan. Former RAF base, you know.", dhivehi: false },
            { text: "My grandfather worked for the British. Learned their ways.", dhivehi: false },
            { text: "Now I run... import/export. Through the airport.", dhivehi: false },
            { text: "Kaley interested in partnership?", dhivehi: true }
        ]
    },
    
    aisha_fishing_lesson: {
        speaker: "Aisha Fulhu",
        sprite: "üé£",
        lines: [
            { text: "*on dhoni* Kaley want to learn real fishing?", dhivehi: true },
            { text: "Not this tourist nonsense. Real Maldivian way.", dhivehi: false },
            { text: "Pole and line. No nets. Sustainable.", dhivehi: false },
            { text: "Also... good cover for other cargo. Hehe.", dhivehi: true }
        ]
    }
};

// ==================== ACT 6 RADIO CONTENT ====================
const ACT6_RADIO = {
    raajjeFM: {
        name: "üìª Raajje FM",
        segments: [
            { type: "news", text: "Addu City development continues. New causeway planned." },
            { type: "news", text: "Fuvahmulah airport expansion approved." },
            { type: "satire", text: "Southern atolls: 'We exist too!' - Residents" },
            { type: "news", text: "Gan resort reports record tourism numbers." },
            { type: "ad", text: "Visit Addu! Where the sun rises first in Maldives!" }
        ]
    },
    adduFM: {
        name: "üìª Addu FM",
        segments: [
            { type: "local", text: "Hithadhoo market prices: Tuna 45 rufiyaa/kg" },
            { type: "local", text: "Causeway traffic advisory: Expect delays" },
            { type: "music", text: "‚ô™ Playing: Traditional Addu Boduberu ‚ô™" },
            { type: "local", text: "Fuvahmulah ferry schedule changed due to weather" },
            { type: "satire", text: "Mal√© people confused by Addu Bas. 'What language is that?'" }
        ]
    }
};

// ==================== DIVING MINI-GAME ====================
let divingGame = {
    active: false,
    depth: 0,
    maxDepth: 30,
    oxygen: 100,
    treasures: [],
    sharks: [],
    collected: 0,
    playerY: 50
};

function startDivingGame() {
    divingGame.active = true;
    divingGame.depth = 0;
    divingGame.oxygen = 100;
    divingGame.collected = 0;
    divingGame.playerY = 50;
    divingGame.treasures = [];
    divingGame.sharks = [];
    GameState.isInMinigame = true;
    
    // Generate treasures
    for (let i = 0; i < 5; i++) {
        divingGame.treasures.push({
            x: 50 + Math.random() * 200,
            y: 100 + Math.random() * 150,
            collected: false
        });
    }
    
    // Generate sharks
    for (let i = 0; i < 3; i++) {
        divingGame.sharks.push({
            x: Math.random() * 300,
            y: 80 + Math.random() * 180,
            direction: Math.random() < 0.5 ? 1 : -1,
            speed: 1 + Math.random()
        });
    }
    
    document.getElementById('minigame-overlay').classList.remove('hidden');
    document.getElementById('minigame-title').textContent = 'ü§ø Underwater Diving';
    
    document.addEventListener('keydown', divingKeyHandler);
    requestAnimationFrame(divingLoop);
}

function divingKeyHandler(e) {
    if (!divingGame.active) return;
    
    const speed = 5;
    if (e.key === 'ArrowUp' || e.key === 'w') {
        divingGame.playerY = Math.max(30, divingGame.playerY - speed);
        divingGame.depth = Math.max(0, divingGame.depth - 1);
    } else if (e.key === 'ArrowDown' || e.key === 's') {
        divingGame.playerY = Math.min(250, divingGame.playerY + speed);
        divingGame.depth = Math.min(divingGame.maxDepth, divingGame.depth + 1);
    } else if (e.key === 'ArrowLeft' || e.key === 'a') {
        // Move left (scroll world right)
    } else if (e.key === 'ArrowRight' || e.key === 'd') {
        // Move right (scroll world left)
    }
}

function divingLoop() {
    if (!divingGame.active) return;
    
    const ctx = minigameCtx;
    const width = minigameCanvas.width;
    const height = minigameCanvas.height;
    
    // Decrease oxygen based on depth
    divingGame.oxygen -= 0.1 + (divingGame.depth * 0.02);
    
    // Background gradient (deeper = darker)
    const gradient = ctx.createLinearGradient(0, 0, 0, height);
    gradient.addColorStop(0, '#0088cc');
    gradient.addColorStop(1, '#001133');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, width, height);
    
    // Oxygen bar
    ctx.fillStyle = '#333';
    ctx.fillRect(10, 10, 120, 20);
    ctx.fillStyle = divingGame.oxygen > 30 ? '#00aaff' : '#ff0000';
    ctx.fillRect(10, 10, divingGame.oxygen * 1.2, 20);
    ctx.fillStyle = '#fff';
    ctx.font = '11px Arial';
    ctx.textAlign = 'left';
    ctx.fillText(`O‚ÇÇ: ${Math.floor(divingGame.oxygen)}%`, 15, 24);
    
    // Depth meter
    ctx.fillStyle = '#fff';
    ctx.textAlign = 'right';
    ctx.fillText(`Depth: ${divingGame.depth}m`, width - 10, 24);
    
    // Collected counter
    ctx.textAlign = 'center';
    ctx.fillText(`Treasures: ${divingGame.collected}/5`, width / 2, 24);
    
    // Draw treasures
    divingGame.treasures.forEach(t => {
        if (!t.collected) {
            ctx.font = '20px Arial';
            ctx.fillText('üíé', t.x, t.y);
            
            // Check collection
            const dx = t.x - 150;
            const dy = t.y - divingGame.playerY;
            if (Math.sqrt(dx * dx + dy * dy) < 25) {
                t.collected = true;
                divingGame.collected++;
            }
        }
    });
    
    // Draw and move sharks
    divingGame.sharks.forEach(shark => {
        shark.x += shark.direction * shark.speed;
        if (shark.x < 0 || shark.x > width) shark.direction *= -1;
        
        ctx.font = '25px Arial';
        ctx.save();
        if (shark.direction < 0) {
            ctx.scale(-1, 1);
            ctx.fillText('ü¶à', -shark.x, shark.y);
        } else {
            ctx.fillText('ü¶à', shark.x, shark.y);
        }
        ctx.restore();
        
        // Check shark collision
        const dx = shark.x - 150;
        const dy = shark.y - divingGame.playerY;
        if (Math.sqrt(dx * dx + dy * dy) < 30) {
            divingGame.oxygen -= 20;
            shark.x = shark.direction > 0 ? 0 : width;
        }
    });
    
    // Draw player (diver)
    ctx.font = '30px Arial';
    ctx.fillText('ü§ø', 150, divingGame.playerY);
    
    // Bubbles effect
    for (let i = 0; i < 3; i++) {
        ctx.beginPath();
        ctx.arc(
            140 + Math.random() * 20,
            divingGame.playerY - 20 - Math.random() * 30,
            2 + Math.random() * 3,
            0, Math.PI * 2
        );
        ctx.fillStyle = 'rgba(255,255,255,0.5)';
        ctx.fill();
    }
    
    // Check win/lose
    if (divingGame.collected >= 5) {
        endDivingGame(true);
        return;
    }
    
    if (divingGame.oxygen <= 0) {
        endDivingGame(false);
        return;
    }
    
    // Instructions
    ctx.fillStyle = '#fff';
    ctx.font = '11px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('‚Üë‚Üì to dive | Collect treasures | Avoid sharks!', width / 2, height - 10);
    
    requestAnimationFrame(divingLoop);
}

function endDivingGame(success) {
    divingGame.active = false;
    GameState.isInMinigame = false;
    document.removeEventListener('keydown', divingKeyHandler);
    document.getElementById('minigame-overlay').classList.add('hidden');
    
    if (success) {
        GameState.player.money += 2000;
        showNotification('Dive Complete!', '+2000 faisaa in treasures');
        updateMissionObjective('dive', 'sharkPoint', true);
    } else {
        GameState.player.health -= 40;
        showNotification('Out of Oxygen!', 'Barely made it back...');
    }
}

// ==================== EXPORT FOR MAIN GAME ====================
if (typeof window !== 'undefined') {
    window.ACT6_MAPS = ACT6_MAPS;
    window.ACT6_CHARACTERS = ACT6_CHARACTERS;
    window.ACT6_MISSIONS = ACT6_MISSIONS;
    window.ACT6_SIDE_MISSIONS = ACT6_SIDE_MISSIONS;
    window.ACT6_DIALOGUES = ACT6_DIALOGUES;
    window.ACT6_RADIO = ACT6_RADIO;
    window.ADDU_GANGS = ADDU_GANGS;
    window.startDivingGame = startDivingGame;
}


// ========== act7.js ==========
// ============================================
// ACT 7: RESORT WARS
// Timeline: 2021 - Infiltrating Paradise
// ============================================

// ==================== ACT 7 MAPS ====================
const ACT7_MAPS = {
    reethi_rah: {
        name: "One&Only Reethi Rah",
        width: 80,
        height: 70,
        spawnX: 40,
        spawnY: 60,
        tiles: [],
        npcs: [],
        items: [],
        zones: {
            jetty: { x: 35, y: 55, w: 10, h: 10, name: "Main Jetty üö§" },
            reception: { x: 30, y: 45, w: 12, h: 8, name: "Grand Reception üèõÔ∏è" },
            overwater: { x: 50, y: 30, w: 20, h: 15, name: "Overwater Villas üè†" },
            beach: { x: 10, y: 35, w: 18, h: 12, name: "Private Beach üèñÔ∏è" },
            spa: { x: 20, y: 20, w: 10, h: 8, name: "Luxury Spa üíÜ" },
            restaurant: { x: 40, y: 15, w: 12, h: 10, name: "Fine Dining üçΩÔ∏è" },
            divingCenter: { x: 60, y: 45, w: 10, h: 8, name: "Diving Center ü§ø" },
            staffQuarters: { x: 5, y: 5, w: 12, h: 10, name: "Staff Quarters üë∑" },
            vipVilla: { x: 65, y: 10, w: 12, h: 12, name: "Presidential Villa üëë" }
        },
        isResort: true,
        luxuryLevel: 5
    },
    
    soneva_fushi: {
        name: "Soneva Fushi",
        width: 75,
        height: 65,
        spawnX: 37,
        spawnY: 55,
        tiles: [],
        npcs: [],
        items: [],
        zones: {
            arrival: { x: 30, y: 50, w: 14, h: 10, name: "Arrival Pavilion üå¥" },
            cinema: { x: 15, y: 35, w: 10, h: 8, name: "Open-Air Cinema üé¨" },
            observatory: { x: 55, y: 20, w: 10, h: 10, name: "Observatory üî≠" },
            jungle: { x: 25, y: 15, w: 20, h: 15, name: "Jungle Reserve üå≥" },
            beachVillas: { x: 45, y: 40, w: 18, h: 12, name: "Beach Villas üè°" },
            underwaterRestaurant: { x: 10, y: 20, w: 12, h: 10, name: "Underwater Restaurant üê†" },
            winecellar: { x: 35, y: 25, w: 8, h: 8, name: "Wine Cellar üç∑" },
            staffArea: { x: 60, y: 50, w: 10, h: 10, name: "Staff Area üë∑" }
        },
        isResort: true,
        luxuryLevel: 5
    },
    
    budget_resort: {
        name: "Paradise Island Resort",
        width: 55,
        height: 50,
        spawnX: 27,
        spawnY: 45,
        tiles: [],
        npcs: [],
        items: [],
        zones: {
            lobby: { x: 22, y: 35, w: 10, h: 8, name: "Main Lobby üè®" },
            pool: { x: 30, y: 25, w: 12, h: 10, name: "Swimming Pool üèä" },
            buffet: { x: 15, y: 20, w: 10, h: 8, name: "Buffet Restaurant üç¥" },
            rooms: { x: 35, y: 15, w: 15, h: 12, name: "Guest Rooms üõèÔ∏è" },
            beach: { x: 5, y: 30, w: 12, h: 15, name: "Public Beach üèñÔ∏è" },
            watersports: { x: 45, y: 35, w: 8, h: 8, name: "Water Sports üö£" }
        },
        isResort: true,
        luxuryLevel: 3
    },
    
    seaplane_base: {
        name: "Trans Maldivian Airways Base",
        width: 50,
        height: 45,
        spawnX: 25,
        spawnY: 40,
        tiles: [],
        npcs: [],
        items: [],
        zones: {
            terminal: { x: 18, y: 30, w: 14, h: 10, name: "Seaplane Terminal ‚úàÔ∏è" },
            hangar: { x: 30, y: 15, w: 15, h: 12, name: "Maintenance Hangar üîß" },
            dock: { x: 10, y: 35, w: 10, h: 8, name: "Seaplane Dock üõ©Ô∏è" },
            lounge: { x: 35, y: 30, w: 10, h: 8, name: "VIP Lounge üõãÔ∏è" },
            cargo: { x: 5, y: 15, w: 12, h: 10, name: "Cargo Area üì¶" }
        },
        hasSeaplanes: true
    },
    
    underwater_cache: {
        name: "Underwater Treasure Site",
        width: 40,
        height: 35,
        spawnX: 20,
        spawnY: 30,
        tiles: [],
        npcs: [],
        items: [],
        zones: {
            shallows: { x: 15, y: 25, w: 10, h: 8, name: "Shallow Reef üê†" },
            deepReef: { x: 10, y: 15, w: 12, h: 10, name: "Deep Reef ü™∏" },
            shipwreck: { x: 25, y: 10, w: 10, h: 8, name: "Shipwreck üö¢" },
            cave: { x: 5, y: 5, w: 8, h: 8, name: "Underwater Cave üï≥Ô∏è" }
        },
        isUnderwater: true
    }
};

// ==================== ACT 7 CHARACTERS ====================
const ACT7_CHARACTERS = {
    rishbe: {
        name: "Rishbe",
        sprite: "üì∏",
        role: "Instagram Influencer",
        backstory: "500K followers. Sells 'Maldives lifestyle' to tourists. Secret drug courier using resort connections.",
        dialogues: {
            first_meeting: {
                speaker: "Rishbe",
                sprite: "üì∏",
                lines: [
                    { text: "*taking selfie* OMG hi! Kaley must be the new... staff?", dhivehi: true },
                    { text: "Wait... kaley not staff. Kaley have that... look.", dhivehi: true },
                    { text: "Aharen know everyone in Maldives resorts. EVERYONE.", dhivehi: true },
                    { text: "Kaley want to make real money? Not resort salary.", dhivehi: true },
                    { text: "Rich tourists... they want more than sunset photos. üòè", dhivehi: true }
                ],
                choices: [
                    { text: "What kind of business?", karma: 0, response: "rishbe_business" },
                    { text: "Aharen not interested in tourist scams.", karma: 5, response: "rishbe_refuse" },
                    { text: "How much money we talking?", karma: -5, response: "rishbe_money" }
                ]
            }
        }
    },
    
    shalube: {
        name: "Shalube",
        sprite: "üé≠",
        role: "TikTok Star / Party Host",
        backstory: "1M followers. Hosts exclusive yacht parties. Front for money laundering operations.",
        dialogues: {
            yacht_party: {
                speaker: "Shalube",
                sprite: "üé≠",
                lines: [
                    { text: "*on yacht* Welcome to the REAL Maldives, baby!", dhivehi: false },
                    { text: "Forget those boring resorts. This is where money flows.", dhivehi: true },
                    { text: "Aharen host parties for... special guests.", dhivehi: true },
                    { text: "Politicians. Businessmen. People who need to... relax.", dhivehi: true },
                    { text: "Kaley look like someone who can provide... security.", dhivehi: true }
                ]
            }
        }
    },
    
    resortManager: {
        name: "Mr. Ahmed",
        sprite: "üëî",
        role: "Resort General Manager",
        backstory: "Runs One&Only. Knows about illegal activities but turns blind eye for kickbacks.",
        dialogues: {
            manager_meeting: {
                speaker: "Mr. Ahmed",
                sprite: "üëî",
                lines: [
                    { text: "*in office* Kaley the new... consultant?", dhivehi: true },
                    { text: "Aharen run this resort 15 years. Aharen know everything.", dhivehi: true },
                    { text: "What happens in the villas... stays in the villas.", dhivehi: true },
                    { text: "But some guests... they need special services.", dhivehi: true },
                    { text: "Kaley understand? Good. Here's kaley first assignment.", dhivehi: true }
                ]
            }
        }
    },
    
    russianOligarch: {
        name: "Viktor Petrov",
        sprite: "üé∞",
        role: "Russian Oligarch",
        backstory: "Hiding money in Maldives. Rents entire resort wings. Major target for heist.",
        dialogues: {
            oligarch_meeting: {
                speaker: "Viktor Petrov",
                sprite: "üé∞",
                lines: [
                    { text: "*heavy accent* You are the local... fixer?", dhivehi: false },
                    { text: "I need things done. Quietly. No questions.", dhivehi: false },
                    { text: "Money is not problem. Discretion is everything.", dhivehi: false },
                    { text: "You help me, I help you. Russian way.", dhivehi: false }
                ]
            }
        }
    },
    
    diveMaster: {
        name: "Hussain 'Deep' Rasheed",
        sprite: "ü§ø",
        role: "Dive Master / Smuggler",
        backstory: "Best diver in Maldives. Uses diving trips as cover for underwater smuggling.",
        dialogues: {
            dive_intro: {
                speaker: "Deep Hussain",
                sprite: "ü§ø",
                lines: [
                    { text: "*checking gear* Kaley want to see real Maldives?", dhivehi: true },
                    { text: "Not this resort fakeness. The underwater world.", dhivehi: true },
                    { text: "Aharen know every reef, every cave, every... hiding spot.", dhivehi: true },
                    { text: "Some things better hidden underwater. Kaley understand?", dhivehi: true }
                ]
            }
        }
    },
    
    seaplanePilot: {
        name: "Captain Nazim",
        sprite: "‚úàÔ∏è",
        role: "Seaplane Pilot",
        backstory: "Ex-military pilot. Now flies tourists... and contraband between islands.",
        dialogues: {
            pilot_intro: {
                speaker: "Captain Nazim",
                sprite: "‚úàÔ∏è",
                lines: [
                    { text: "*in cockpit* Beautiful day for flying, no?", dhivehi: true },
                    { text: "Aharen fly these waters 20 years. Know every island.", dhivehi: true },
                    { text: "Some islands... not on tourist maps.", dhivehi: true },
                    { text: "Kaley need fast transport? No questions? Aharen your man.", dhivehi: true }
                ]
            }
        }
    }
};

// ==================== ACT 7 MISSIONS ====================
const ACT7_MISSIONS = [
    {
        id: "act7_m1",
        title: "Paradise Arrival",
        type: "story",
        description: "Arrive at One&Only Reethi Rah undercover",
        objectives: [
            { type: "travel", target: "reethi_rah", current: false },
            { type: "trigger", target: "resortArrival", current: false }
        ],
        rewards: { money: 500 },
        dialogueStart: "resort_arrival",
        unlocks: ["act7_m2"]
    },
    {
        id: "act7_m2",
        title: "The Influencer",
        type: "story",
        description: "Meet Rishbe at the beach",
        objectives: [
            { type: "travel", target: "beach", current: false },
            { type: "trigger", target: "rishbeMeeting", current: false }
        ],
        rewards: { money: 300 },
        dialogueStart: "rishbe_first_meeting",
        unlocks: ["act7_m3"],
        moralChoice: true
    },
    {
        id: "act7_m3",
        title: "Tourist Trap",
        type: "delivery",
        description: "Deliver 'special package' to VIP villa",
        objectives: [
            { type: "collect", target: "package", current: false },
            { type: "deliver", target: "vipVilla", current: false },
            { type: "avoid", target: "security", current: false }
        ],
        rewards: { money: 2000, karma: -10 },
        unlocks: ["act7_m4"]
    },
    {
        id: "act7_m4",
        title: "Deep Dive",
        type: "diving",
        description: "Learn diving from Deep Hussain",
        objectives: [
            { type: "talk", target: "deepHussain", current: false },
            { type: "minigame", target: "diving", score: 300, current: 0 }
        ],
        rewards: { money: 800 },
        dialogueStart: "deep_dive_intro",
        unlocks: ["act7_m5", "act7_m6"]
    },
    {
        id: "act7_m5",
        title: "Underwater Cache",
        type: "diving",
        description: "Retrieve hidden cargo from shipwreck",
        objectives: [
            { type: "travel", target: "underwater_cache", current: false },
            { type: "dive", target: "shipwreck", current: false },
            { type: "collect", target: "cargo", count: 3, current: 0 },
            { type: "surface", target: "boat", current: false }
        ],
        rewards: { money: 5000 },
        unlocks: ["act7_m7"],
        minigame: "advancedDiving"
    },
    {
        id: "act7_m6",
        title: "Yacht Party",
        type: "story",
        description: "Attend Shalube's exclusive yacht party",
        objectives: [
            { type: "travel", target: "jetty", current: false },
            { type: "trigger", target: "yachtParty", current: false },
            { type: "mingle", target: "vipGuests", count: 3, current: 0 }
        ],
        rewards: { money: 1000 },
        dialogueStart: "shalube_yacht_party",
        unlocks: ["act7_m7"]
    },
    {
        id: "act7_m7",
        title: "The Russian",
        type: "story",
        description: "Meet Viktor Petrov at his villa",
        objectives: [
            { type: "travel", target: "vipVilla", current: false },
            { type: "trigger", target: "viktorMeeting", current: false }
        ],
        rewards: { money: 500 },
        dialogueStart: "oligarch_meeting",
        unlocks: ["act7_m8"],
        moralChoice: true
    },
    {
        id: "act7_m8",
        title: "Oligarch's Errand",
        type: "delivery",
        description: "Transport Viktor's 'documents' to Soneva",
        objectives: [
            { type: "collect", target: "documents", current: false },
            { type: "travel", target: "seaplane_base", current: false },
            { type: "fly", target: "soneva_fushi", current: false },
            { type: "deliver", target: "contact", current: false }
        ],
        rewards: { money: 8000, karma: -15 },
        unlocks: ["act7_m9"],
        vehicleRequired: "seaplane"
    },
    {
        id: "act7_m9",
        title: "Wings of Paradise",
        type: "story",
        description: "Learn to fly seaplanes from Captain Nazim",
        objectives: [
            { type: "talk", target: "captainNazim", current: false },
            { type: "minigame", target: "seaplaneFlight", score: 500, current: 0 }
        ],
        rewards: { money: 1000, skill: { piloting: 20 } },
        dialogueStart: "pilot_intro",
        unlocks: ["act7_m10"]
    },
    {
        id: "act7_m10",
        title: "Resort Heist Planning",
        type: "heist",
        description: "Plan the big resort heist",
        objectives: [
            { type: "scout", target: "reethi_rah", current: false },
            { type: "recruit", target: "crew", count: 3, current: 0 },
            { type: "plan", target: "heistApproach", current: false }
        ],
        rewards: { money: 2000 },
        unlocks: ["act7_m11"],
        heistPlanning: true
    },
    {
        id: "act7_m11",
        title: "The Big Score",
        type: "heist",
        description: "Execute the resort heist",
        objectives: [
            { type: "infiltrate", target: "vipVilla", current: false },
            { type: "steal", target: "safe", current: false },
            { type: "escape", target: "seaplane", current: false }
        ],
        rewards: { money: 50000, karma: -25 },
        unlocks: ["act7_m12"],
        heistExecution: true
    },
    {
        id: "act7_m12",
        title: "Betrayal at Sea",
        type: "combat",
        description: "Someone tipped off Viktor - fight your way out",
        objectives: [
            { type: "survive", target: "ambush", current: false },
            { type: "defeat", target: "mercenary", count: 12, current: 0 },
            { type: "escape", target: "speedboat", current: false }
        ],
        rewards: { money: 5000 },
        unlocks: ["act7_climax"]
    },
    {
        id: "act7_climax",
        title: "Paradise Lost",
        type: "boss",
        description: "Confront the traitor and secure your escape",
        objectives: [
            { type: "chase", target: "traitor", current: false },
            { type: "boss", target: "viktorGuard", current: false },
            { type: "decide", target: "resortFate", current: false }
        ],
        rewards: { money: 20000 },
        unlocks: ["act8_start"],
        actEnd: true,
        bossMusic: true,
        majorChoice: "resort_ending"
    }
];

// ==================== ACT 7 SIDE MISSIONS ====================
const ACT7_SIDE_MISSIONS = [
    { id: "side7_photo1", title: "Instagram Shoot I", type: "photography", reward: 400 },
    { id: "side7_photo2", title: "Instagram Shoot II", type: "photography", reward: 600 },
    { id: "side7_dive1", title: "Reef Exploration", type: "diving", reward: 500 },
    { id: "side7_dive2", title: "Night Dive", type: "diving", reward: 800 },
    { id: "side7_dive3", title: "Cave Dive", type: "diving", reward: 1200 },
    { id: "side7_delivery1", title: "VIP Delivery I", type: "delivery", reward: 600 },
    { id: "side7_delivery2", title: "VIP Delivery II", type: "delivery", reward: 900 },
    { id: "side7_party1", title: "Party Security I", type: "security", reward: 700 },
    { id: "side7_party2", title: "Party Security II", type: "security", reward: 1000 },
    { id: "side7_flight1", title: "Seaplane Taxi I", type: "flying", reward: 800 },
    { id: "side7_flight2", title: "Seaplane Taxi II", type: "flying", reward: 1200 },
    { id: "side7_smuggle", title: "Resort Smuggling", type: "smuggling", reward: 1500 }
];

// ==================== ACT 7 DIALOGUES ====================
const ACT7_DIALOGUES = {
    resort_arrival: {
        speaker: "Resort Staff",
        sprite: "üëî",
        lines: [
            { text: "Welcome to One&Only Reethi Rah, sir.", dhivehi: false },
            { text: "Kaley reservation is confirmed. Villa 23.", dhivehi: true },
            { text: "If kaley need anything... ANYTHING... just call.", dhivehi: true },
            { text: "*whispers* Mr. Ahmed wants to see kaley. Staff quarters.", dhivehi: true }
        ]
    },
    
    rishbe_first_meeting: {
        speaker: "Rishbe",
        sprite: "üì∏",
        lines: [
            { text: "*taking selfie* OMG hi! Kaley must be the new... staff?", dhivehi: true },
            { text: "Wait... kaley not staff. Kaley have that... look.", dhivehi: true },
            { text: "Aharen know everyone in Maldives resorts. EVERYONE.", dhivehi: true },
            { text: "Kaley want to make real money? Not resort salary.", dhivehi: true },
            { text: "Rich tourists... they want more than sunset photos. üòè", dhivehi: true }
        ],
        choices: [
            { text: "What kind of business?", karma: 0, response: "rishbe_business" },
            { text: "Aharen not interested in tourist scams.", karma: 5, response: "rishbe_refuse" },
            { text: "How much money we talking?", karma: -5, response: "rishbe_money" }
        ]
    },
    
    rishbe_business: {
        speaker: "Rishbe",
        sprite: "üì∏",
        lines: [
            { text: "*looks around* Okay, listen...", dhivehi: true },
            { text: "These tourists? They pay $2000 a night.", dhivehi: false },
            { text: "But they want... experiences. Special ones.", dhivehi: true },
            { text: "Aharen connect them. Kaley deliver. We split.", dhivehi: true },
            { text: "Easy money. No violence. Just... hospitality. üòâ", dhivehi: true }
        ]
    },
    
    rishbe_refuse: {
        speaker: "Rishbe",
        sprite: "üì∏",
        lines: [
            { text: "*laughs* Tourist scams? Kaley so naive!", dhivehi: true },
            { text: "This is business. High-end business.", dhivehi: false },
            { text: "But okay... kaley loss.", dhivehi: true },
            { text: "When kaley change mind... find aharen at the spa.", dhivehi: true }
        ]
    },
    
    rishbe_money: {
        speaker: "Rishbe",
        sprite: "üì∏",
        lines: [
            { text: "*grins* NOW kaley speaking my language!", dhivehi: true },
            { text: "Last month? Aharen made 50,000 dollars.", dhivehi: false },
            { text: "Just from... connecting people.", dhivehi: true },
            { text: "Kaley in? Good. First job tonight.", dhivehi: true }
        ]
    },
    
    shalube_yacht_party: {
        speaker: "Shalube",
        sprite: "üé≠",
        lines: [
            { text: "*on yacht* Welcome to the REAL Maldives, baby!", dhivehi: false },
            { text: "Forget those boring resorts. This is where money flows.", dhivehi: true },
            { text: "Aharen host parties for... special guests.", dhivehi: true },
            { text: "Politicians. Businessmen. People who need to... relax.", dhivehi: true },
            { text: "Kaley look like someone who can provide... security.", dhivehi: true }
        ]
    },
    
    deep_dive_intro: {
        speaker: "Deep Hussain",
        sprite: "ü§ø",
        lines: [
            { text: "*checking gear* Kaley want to see real Maldives?", dhivehi: true },
            { text: "Not this resort fakeness. The underwater world.", dhivehi: true },
            { text: "Aharen know every reef, every cave, every... hiding spot.", dhivehi: true },
            { text: "Some things better hidden underwater. Kaley understand?", dhivehi: true },
            { text: "First lesson: breathing. Control. Then we go deep.", dhivehi: true }
        ]
    },
    
    oligarch_meeting: {
        speaker: "Viktor Petrov",
        sprite: "üé∞",
        lines: [
            { text: "*heavy accent* You are the local... fixer?", dhivehi: false },
            { text: "I need things done. Quietly. No questions.", dhivehi: false },
            { text: "Money is not problem. Discretion is everything.", dhivehi: false },
            { text: "You help me, I help you. Russian way.", dhivehi: false }
        ],
        choices: [
            { text: "What do you need?", karma: -5, response: "viktor_job" },
            { text: "Aharen don't work for foreigners.", karma: 5, response: "viktor_refuse" },
            { text: "How much are we talking?", karma: -10, response: "viktor_money" }
        ]
    },
    
    viktor_job: {
        speaker: "Viktor Petrov",
        sprite: "üé∞",
        lines: [
            { text: "*nods* Good. Smart man.", dhivehi: false },
            { text: "I have... documents. Need to reach Soneva Fushi.", dhivehi: false },
            { text: "No customs. No questions. You understand?", dhivehi: false },
            { text: "50,000 dollars. Half now, half after.", dhivehi: false }
        ]
    },
    
    viktor_refuse: {
        speaker: "Viktor Petrov",
        sprite: "üé∞",
        lines: [
            { text: "*laughs coldly* Foreigner? I own half this resort.", dhivehi: false },
            { text: "Your president? He calls ME for loans.", dhivehi: false },
            { text: "Think carefully before refusing Viktor Petrov.", dhivehi: false },
            { text: "Door is there. Use it wisely.", dhivehi: false }
        ]
    },
    
    viktor_money: {
        speaker: "Viktor Petrov",
        sprite: "üé∞",
        lines: [
            { text: "*smiles* Ah, businessman. I like.", dhivehi: false },
            { text: "100,000 dollars. One job. No questions.", dhivehi: false },
            { text: "But if you fail... or talk...", dhivehi: false },
            { text: "*gestures to guards* ...my friends here handle problems.", dhivehi: false }
        ]
    },
    
    pilot_intro: {
        speaker: "Captain Nazim",
        sprite: "‚úàÔ∏è",
        lines: [
            { text: "*in cockpit* Beautiful day for flying, no?", dhivehi: true },
            { text: "Aharen fly these waters 20 years. Know every island.", dhivehi: true },
            { text: "Some islands... not on tourist maps.", dhivehi: true },
            { text: "Kaley need fast transport? No questions? Aharen your man.", dhivehi: true },
            { text: "First, kaley learn basics. Then we fly for real.", dhivehi: true }
        ]
    },
    
    manager_meeting: {
        speaker: "Mr. Ahmed",
        sprite: "üëî",
        lines: [
            { text: "*in office* Kaley the new... consultant?", dhivehi: true },
            { text: "Aharen run this resort 15 years. Aharen know everything.", dhivehi: true },
            { text: "What happens in the villas... stays in the villas.", dhivehi: true },
            { text: "But some guests... they need special services.", dhivehi: true },
            { text: "Kaley understand? Good. Here's kaley first assignment.", dhivehi: true }
        ]
    }
};

// ==================== ACT 7 RADIO CONTENT ====================
const ACT7_RADIO = {
    raajjeFM: {
        name: "üìª Raajje FM",
        segments: [
            { type: "news", text: "Tourism numbers hit record high. 2 million visitors expected." },
            { type: "news", text: "New luxury resort opens in Baa Atoll." },
            { type: "satire", text: "Resort workers: 'We see things. We say nothing.'" },
            { type: "ad", text: "Visit Maldives! Where your secrets stay secret!" },
            { type: "news", text: "Russian investment in Maldives tourism increases 300%." }
        ]
    },
    resortFM: {
        name: "üìª Resort FM",
        segments: [
            { type: "music", text: "‚ô™ Playing: Smooth Jazz for Paradise ‚ô™" },
            { type: "ad", text: "Spa treatments starting at only $500!" },
            { type: "info", text: "Tonight's sunset cruise departs at 5:30 PM" },
            { type: "music", text: "‚ô™ Playing: Tropical House Mix ‚ô™" },
            { type: "ad", text: "Private dining on the beach. Reserve now." }
        ]
    }
};

// ==================== SEAPLANE MINI-GAME ====================
let seaplaneGame = {
    active: false,
    x: 200,
    y: 150,
    speed: 0,
    altitude: 100,
    fuel: 100,
    destination: { x: 350, y: 100 },
    obstacles: [],
    score: 0
};

function startSeaplaneGame() {
    seaplaneGame.active = true;
    seaplaneGame.x = 50;
    seaplaneGame.y = 150;
    seaplaneGame.speed = 2;
    seaplaneGame.altitude = 100;
    seaplaneGame.fuel = 100;
    seaplaneGame.score = 0;
    seaplaneGame.obstacles = [];
    GameState.isInMinigame = true;
    
    // Generate clouds/obstacles
    for (let i = 0; i < 5; i++) {
        seaplaneGame.obstacles.push({
            x: 150 + i * 80,
            y: 50 + Math.random() * 150,
            type: Math.random() < 0.3 ? 'storm' : 'cloud'
        });
    }
    
    document.getElementById('minigame-overlay').classList.remove('hidden');
    document.getElementById('minigame-title').textContent = '‚úàÔ∏è Seaplane Flight';
    
    document.addEventListener('keydown', seaplaneKeyHandler);
    requestAnimationFrame(seaplaneLoop);
}

function seaplaneKeyHandler(e) {
    if (!seaplaneGame.active) return;
    
    if (e.key === 'ArrowUp' || e.key === 'w') {
        seaplaneGame.y = Math.max(20, seaplaneGame.y - 5);
        seaplaneGame.altitude = Math.min(200, seaplaneGame.altitude + 5);
    } else if (e.key === 'ArrowDown' || e.key === 's') {
        seaplaneGame.y = Math.min(250, seaplaneGame.y + 5);
        seaplaneGame.altitude = Math.max(0, seaplaneGame.altitude - 5);
    } else if (e.key === 'ArrowRight' || e.key === 'd') {
        seaplaneGame.speed = Math.min(5, seaplaneGame.speed + 0.5);
    } else if (e.key === 'ArrowLeft' || e.key === 'a') {
        seaplaneGame.speed = Math.max(1, seaplaneGame.speed - 0.5);
    }
}

function seaplaneLoop() {
    if (!seaplaneGame.active) return;
    
    const ctx = minigameCtx;
    const width = minigameCanvas.width;
    const height = minigameCanvas.height;
    
    // Move plane
    seaplaneGame.x += seaplaneGame.speed;
    seaplaneGame.fuel -= 0.1;
    seaplaneGame.score += seaplaneGame.speed;
    
    // Sky gradient
    const gradient = ctx.createLinearGradient(0, 0, 0, height);
    gradient.addColorStop(0, '#87CEEB');
    gradient.addColorStop(0.7, '#E0F6FF');
    gradient.addColorStop(1, '#0066aa');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, width, height);
    
    // Ocean
    ctx.fillStyle = '#0077aa';
    ctx.fillRect(0, height - 50, width, 50);
    
    // Islands (background)
    ctx.fillStyle = '#228B22';
    ctx.beginPath();
    ctx.ellipse(100, height - 45, 30, 10, 0, 0, Math.PI * 2);
    ctx.fill();
    ctx.beginPath();
    ctx.ellipse(300, height - 45, 25, 8, 0, 0, Math.PI * 2);
    ctx.fill();
    
    // Draw and move obstacles
    seaplaneGame.obstacles.forEach(obs => {
        obs.x -= seaplaneGame.speed * 0.5;
        if (obs.x < -50) obs.x = width + 50;
        
        if (obs.type === 'storm') {
            ctx.fillStyle = '#555';
            ctx.font = '30px Arial';
            ctx.fillText('‚õàÔ∏è', obs.x, obs.y);
            
            // Storm collision
            const dx = obs.x - seaplaneGame.x;
            const dy = obs.y - seaplaneGame.y;
            if (Math.sqrt(dx * dx + dy * dy) < 30) {
                seaplaneGame.fuel -= 5;
                seaplaneGame.y += (Math.random() - 0.5) * 20;
            }
        } else {
            ctx.fillStyle = '#fff';
            ctx.font = '25px Arial';
            ctx.fillText('‚òÅÔ∏è', obs.x, obs.y);
        }
    });
    
    // Draw seaplane
    ctx.font = '35px Arial';
    ctx.fillText('üõ©Ô∏è', seaplaneGame.x, seaplaneGame.y);
    
    // HUD
    ctx.fillStyle = '#333';
    ctx.fillRect(10, 10, 120, 20);
    ctx.fillStyle = seaplaneGame.fuel > 30 ? '#00aa00' : '#ff0000';
    ctx.fillRect(10, 10, seaplaneGame.fuel * 1.2, 20);
    ctx.fillStyle = '#fff';
    ctx.font = '11px Arial';
    ctx.textAlign = 'left';
    ctx.fillText(`Fuel: ${Math.floor(seaplaneGame.fuel)}%`, 15, 24);
    
    ctx.textAlign = 'right';
    ctx.fillText(`Altitude: ${Math.floor(seaplaneGame.altitude)}m`, width - 10, 24);
    ctx.fillText(`Speed: ${seaplaneGame.speed.toFixed(1)}`, width - 10, 40);
    
    ctx.textAlign = 'center';
    ctx.fillText(`Score: ${Math.floor(seaplaneGame.score)}`, width / 2, 24);
    
    // Destination marker
    if (seaplaneGame.x > 300) {
        ctx.fillStyle = '#00ff00';
        ctx.font = '20px Arial';
        ctx.fillText('üèùÔ∏è', 380, height - 60);
        ctx.font = '10px Arial';
        ctx.fillText('DESTINATION', 380, height - 40);
    }
    
    // Check win/lose
    if (seaplaneGame.x >= 380 && seaplaneGame.y > height - 80) {
        endSeaplaneGame(true);
        return;
    }
    
    if (seaplaneGame.fuel <= 0 || seaplaneGame.y >= height - 30) {
        endSeaplaneGame(false);
        return;
    }
    
    // Instructions
    ctx.fillStyle = '#333';
    ctx.font = '11px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('‚Üë‚Üì altitude | ‚Üê‚Üí speed | Land at destination island!', width / 2, height - 10);
    
    requestAnimationFrame(seaplaneLoop);
}

function endSeaplaneGame(success) {
    seaplaneGame.active = false;
    GameState.isInMinigame = false;
    document.removeEventListener('keydown', seaplaneKeyHandler);
    document.getElementById('minigame-overlay').classList.add('hidden');
    
    if (success) {
        GameState.player.money += 3000;
        GameState.player.skills.piloting = (GameState.player.skills.piloting || 0) + 10;
        showNotification('Flight Complete!', '+3000 faisaa, +10 Piloting');
    } else {
        GameState.player.health -= 30;
        showNotification('Crash Landing!', 'Lost fuel or crashed into ocean');
    }
}

// ==================== ADVANCED DIVING MINI-GAME ====================
let advancedDivingGame = {
    active: false,
    depth: 0,
    maxDepth: 50,
    oxygen: 100,
    nitrogen: 0,
    treasures: [],
    hazards: [],
    collected: 0,
    playerX: 150,
    playerY: 50,
    targetTreasures: 3
};

function startAdvancedDivingGame() {
    advancedDivingGame.active = true;
    advancedDivingGame.depth = 0;
    advancedDivingGame.oxygen = 100;
    advancedDivingGame.nitrogen = 0;
    advancedDivingGame.collected = 0;
    advancedDivingGame.playerX = 150;
    advancedDivingGame.playerY = 50;
    advancedDivingGame.treasures = [];
    advancedDivingGame.hazards = [];
    GameState.isInMinigame = true;
    
    // Generate treasures (deeper = more valuable)
    for (let i = 0; i < 5; i++) {
        advancedDivingGame.treasures.push({
            x: 50 + Math.random() * 300,
            y: 100 + i * 40,
            value: (i + 1) * 1000,
            collected: false,
            type: i < 2 ? 'üíé' : (i < 4 ? 'üì¶' : 'üí∞')
        });
    }
    
    // Generate hazards
    for (let i = 0; i < 4; i++) {
        advancedDivingGame.hazards.push({
            x: Math.random() * 350,
            y: 80 + Math.random() * 180,
            type: Math.random() < 0.5 ? 'shark' : 'jellyfish',
            direction: Math.random() < 0.5 ? 1 : -1,
            speed: 1 + Math.random()
        });
    }
    
    document.getElementById('minigame-overlay').classList.remove('hidden');
    document.getElementById('minigame-title').textContent = 'ü§ø Deep Dive - Shipwreck';
    
    document.addEventListener('keydown', advancedDivingKeyHandler);
    requestAnimationFrame(advancedDivingLoop);
}

function advancedDivingKeyHandler(e) {
    if (!advancedDivingGame.active) return;
    
    const speed = 5;
    if (e.key === 'ArrowUp' || e.key === 'w') {
        advancedDivingGame.playerY = Math.max(30, advancedDivingGame.playerY - speed);
        advancedDivingGame.depth = Math.max(0, advancedDivingGame.depth - 2);
        advancedDivingGame.nitrogen = Math.max(0, advancedDivingGame.nitrogen - 1);
    } else if (e.key === 'ArrowDown' || e.key === 's') {
        advancedDivingGame.playerY = Math.min(280, advancedDivingGame.playerY + speed);
        advancedDivingGame.depth = Math.min(advancedDivingGame.maxDepth, advancedDivingGame.depth + 2);
    } else if (e.key === 'ArrowLeft' || e.key === 'a') {
        advancedDivingGame.playerX = Math.max(20, advancedDivingGame.playerX - speed);
    } else if (e.key === 'ArrowRight' || e.key === 'd') {
        advancedDivingGame.playerX = Math.min(380, advancedDivingGame.playerX + speed);
    }
}

function advancedDivingLoop() {
    if (!advancedDivingGame.active) return;
    
    const ctx = minigameCtx;
    const width = minigameCanvas.width;
    const height = minigameCanvas.height;
    
    // Oxygen decreases faster at depth
    advancedDivingGame.oxygen -= 0.1 + (advancedDivingGame.depth * 0.01);
    // Nitrogen builds up at depth
    if (advancedDivingGame.depth > 20) {
        advancedDivingGame.nitrogen += 0.2;
    }
    
    // Background gradient (deeper = darker)
    const gradient = ctx.createLinearGradient(0, 0, 0, height);
    gradient.addColorStop(0, '#0099cc');
    gradient.addColorStop(0.5, '#006699');
    gradient.addColorStop(1, '#001133');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, width, height);
    
    // Shipwreck at bottom
    ctx.fillStyle = '#3a3a3a';
    ctx.fillRect(100, 250, 200, 40);
    ctx.font = '30px Arial';
    ctx.fillText('üö¢', 180, 275);
    
    // Coral/reef decorations
    ctx.font = '20px Arial';
    ctx.fillText('ü™∏', 50, 280);
    ctx.fillText('ü™∏', 320, 270);
    ctx.fillText('üêö', 150, 290);
    
    // Oxygen bar
    ctx.fillStyle = '#333';
    ctx.fillRect(10, 10, 100, 15);
    ctx.fillStyle = advancedDivingGame.oxygen > 30 ? '#00aaff' : '#ff0000';
    ctx.fillRect(10, 10, advancedDivingGame.oxygen, 15);
    ctx.fillStyle = '#fff';
    ctx.font = '10px Arial';
    ctx.textAlign = 'left';
    ctx.fillText(`O‚ÇÇ: ${Math.floor(advancedDivingGame.oxygen)}%`, 15, 22);
    
    // Nitrogen bar (decompression sickness risk)
    ctx.fillStyle = '#333';
    ctx.fillRect(10, 28, 100, 15);
    ctx.fillStyle = advancedDivingGame.nitrogen < 50 ? '#ffaa00' : '#ff0000';
    ctx.fillRect(10, 28, advancedDivingGame.nitrogen, 15);
    ctx.fillText(`N‚ÇÇ: ${Math.floor(advancedDivingGame.nitrogen)}%`, 15, 40);
    
    // Depth meter
    ctx.textAlign = 'right';
    ctx.fillText(`Depth: ${advancedDivingGame.depth}m`, width - 10, 22);
    
    // Collected counter
    ctx.textAlign = 'center';
    ctx.fillText(`Cargo: ${advancedDivingGame.collected}/${advancedDivingGame.targetTreasures}`, width / 2, 22);
    
    // Draw treasures
    advancedDivingGame.treasures.forEach(t => {
        if (!t.collected) {
            ctx.font = '20px Arial';
            ctx.fillText(t.type, t.x, t.y);
            
            // Check collection
            const dx = t.x - advancedDivingGame.playerX;
            const dy = t.y - advancedDivingGame.playerY;
            if (Math.sqrt(dx * dx + dy * dy) < 25) {
                t.collected = true;
                advancedDivingGame.collected++;
                GameState.player.money += t.value;
            }
        }
    });
    
    // Draw and move hazards
    advancedDivingGame.hazards.forEach(h => {
        h.x += h.direction * h.speed;
        if (h.x < 0 || h.x > width) h.direction *= -1;
        
        ctx.font = '25px Arial';
        if (h.type === 'shark') {
            ctx.save();
            if (h.direction < 0) {
                ctx.scale(-1, 1);
                ctx.fillText('ü¶à', -h.x, h.y);
            } else {
                ctx.fillText('ü¶à', h.x, h.y);
            }
            ctx.restore();
        } else {
            ctx.fillText('üéê', h.x, h.y); // Jellyfish
        }
        
        // Check collision
        const dx = h.x - advancedDivingGame.playerX;
        const dy = h.y - advancedDivingGame.playerY;
        if (Math.sqrt(dx * dx + dy * dy) < 25) {
            if (h.type === 'shark') {
                advancedDivingGame.oxygen -= 15;
            } else {
                advancedDivingGame.oxygen -= 5;
                advancedDivingGame.nitrogen += 10;
            }
            h.x = h.direction > 0 ? 0 : width;
        }
    });
    
    // Draw player (diver)
    ctx.font = '30px Arial';
    ctx.fillText('ü§ø', advancedDivingGame.playerX, advancedDivingGame.playerY);
    
    // Bubbles
    for (let i = 0; i < 3; i++) {
        ctx.beginPath();
        ctx.arc(
            advancedDivingGame.playerX - 10 + Math.random() * 20,
            advancedDivingGame.playerY - 20 - Math.random() * 30,
            2 + Math.random() * 3,
            0, Math.PI * 2
        );
        ctx.fillStyle = 'rgba(255,255,255,0.5)';
        ctx.fill();
    }
    
    // Check win/lose
    if (advancedDivingGame.collected >= advancedDivingGame.targetTreasures && advancedDivingGame.playerY < 50) {
        endAdvancedDivingGame(true);
        return;
    }
    
    if (advancedDivingGame.oxygen <= 0) {
        endAdvancedDivingGame(false, 'oxygen');
        return;
    }
    
    if (advancedDivingGame.nitrogen >= 100) {
        endAdvancedDivingGame(false, 'nitrogen');
        return;
    }
    
    // Instructions
    ctx.fillStyle = '#fff';
    ctx.font = '10px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('WASD to move | Collect cargo | Return to surface to win!', width / 2, height - 10);
    if (advancedDivingGame.collected >= advancedDivingGame.targetTreasures) {
        ctx.fillStyle = '#00ff00';
        ctx.fillText('‚úì Cargo collected! Return to surface!', width / 2, height - 25);
    }
    
    requestAnimationFrame(advancedDivingLoop);
}

function endAdvancedDivingGame(success, failReason) {
    advancedDivingGame.active = false;
    GameState.isInMinigame = false;
    document.removeEventListener('keydown', advancedDivingKeyHandler);
    document.getElementById('minigame-overlay').classList.add('hidden');
    
    if (success) {
        showNotification('Dive Complete!', `Retrieved ${advancedDivingGame.collected} cargo items!`);
        updateMissionObjective('dive', 'shipwreck', true);
    } else {
        GameState.player.health -= 50;
        if (failReason === 'nitrogen') {
            showNotification('Decompression Sickness!', 'Ascended too fast with high nitrogen!');
        } else {
            showNotification('Out of Oxygen!', 'Barely made it back alive...');
        }
    }
}

// ==================== EXPORT FOR MAIN GAME ====================
if (typeof window !== 'undefined') {
    window.ACT7_MAPS = ACT7_MAPS;
    window.ACT7_CHARACTERS = ACT7_CHARACTERS;
    window.ACT7_MISSIONS = ACT7_MISSIONS;
    window.ACT7_SIDE_MISSIONS = ACT7_SIDE_MISSIONS;
    window.ACT7_DIALOGUES = ACT7_DIALOGUES;
    window.ACT7_RADIO = ACT7_RADIO;
    window.startSeaplaneGame = startSeaplaneGame;
    window.startAdvancedDivingGame = startAdvancedDivingGame;
}


// ========== act8.js ==========
// ============================================
// ACT 8: THE RECKONING
// Timeline: 2022 - Family Secrets Unveiled
// ============================================

// ==================== ACT 8 MAPS ====================
const ACT8_MAPS = {
    ronda_home: {
        name: "Ronda Family Home - Maafannu",
        width: 45,
        height: 40,
        spawnX: 22,
        spawnY: 35,
        tiles: [],
        npcs: [],
        items: [],
        zones: {
            entrance: { x: 18, y: 30, w: 8, h: 8, name: "Home Entrance üö™" },
            livingRoom: { x: 15, y: 20, w: 14, h: 10, name: "Living Room üõãÔ∏è" },
            kitchen: { x: 30, y: 20, w: 10, h: 8, name: "Kitchen üç≥" },
            rippooRoom: { x: 5, y: 10, w: 10, h: 10, name: "Rippoo's Room üëµ" },
            nunnuRoom: { x: 30, y: 10, w: 10, h: 8, name: "Nunnu's Room üì∞" },
            secretBasement: { x: 15, y: 5, w: 12, h: 8, name: "Secret Basement üîí" },
            backyard: { x: 5, y: 25, w: 10, h: 10, name: "Backyard üå≥" }
        },
        isInterior: true,
        isFamilyHome: true
    },
    
    dhodho_warehouse: {
        name: "DhoDho's Warehouse - Hulhumal√©",
        width: 50,
        height: 45,
        spawnX: 25,
        spawnY: 40,
        tiles: [],
        npcs: [],
        items: [],
        zones: {
            entrance: { x: 20, y: 35, w: 10, h: 8, name: "Warehouse Entrance üö™" },
            mainFloor: { x: 10, y: 20, w: 30, h: 15, name: "Main Floor üì¶" },
            office: { x: 35, y: 10, w: 10, h: 10, name: "DhoDho's Office üíº" },
            secretRoom: { x: 5, y: 5, w: 12, h: 10, name: "Hidden Room üîê" },
            loadingDock: { x: 40, y: 30, w: 8, h: 10, name: "Loading Dock üöõ" }
        },
        isInterior: true
    },
    
    newspaper_office: {
        name: "Maldives Independent - Office",
        width: 40,
        height: 35,
        spawnX: 20,
        spawnY: 30,
        tiles: [],
        npcs: [],
        items: [],
        zones: {
            reception: { x: 15, y: 25, w: 10, h: 8, name: "Reception üè¢" },
            newsroom: { x: 5, y: 15, w: 20, h: 10, name: "Newsroom üì∞" },
            nunnuDesk: { x: 25, y: 15, w: 10, h: 8, name: "Nunnu's Desk üíª" },
            archive: { x: 30, y: 5, w: 8, h: 10, name: "Archive Room üìÅ" },
            rooftop: { x: 5, y: 5, w: 15, h: 8, name: "Rooftop Access üèóÔ∏è" }
        },
        isInterior: true
    },
    
    father_grave: {
        name: "Mal√© Cemetery",
        width: 40,
        height: 35,
        spawnX: 20,
        spawnY: 30,
        tiles: [],
        npcs: [],
        items: [],
        zones: {
            entrance: { x: 15, y: 28, w: 10, h: 6, name: "Cemetery Gate ‚õ©Ô∏è" },
            oldSection: { x: 5, y: 15, w: 15, h: 12, name: "Old Section ü™¶" },
            fatherGrave: { x: 25, y: 10, w: 8, h: 8, name: "Ibrahim's Grave ü™¶" },
            familyPlot: { x: 20, y: 5, w: 12, h: 8, name: "Ronda Family Plot üë®‚Äçüë©‚Äçüëß‚Äçüë¶" }
        },
        isCemetery: true
    },
    
    confrontation_rooftop: {
        name: "Mal√© Rooftop - Final Confrontation",
        width: 35,
        height: 30,
        spawnX: 17,
        spawnY: 25,
        tiles: [],
        npcs: [],
        items: [],
        zones: {
            stairAccess: { x: 12, y: 22, w: 10, h: 6, name: "Stair Access ü™ú" },
            mainRoof: { x: 5, y: 10, w: 25, h: 12, name: "Main Rooftop üè¢" },
            edge: { x: 5, y: 5, w: 25, h: 5, name: "Rooftop Edge ‚ö†Ô∏è" },
            waterTank: { x: 25, y: 15, w: 6, h: 6, name: "Water Tank üõ¢Ô∏è" }
        },
        isRooftop: true,
        dangerZone: true
    },
    
    muaz_hideout: {
        name: "Muaz's Safe House",
        width: 35,
        height: 30,
        spawnX: 17,
        spawnY: 25,
        tiles: [],
        npcs: [],
        items: [],
        zones: {
            entrance: { x: 12, y: 22, w: 10, h: 6, name: "Hidden Entrance üö™" },
            mainRoom: { x: 8, y: 12, w: 18, h: 10, name: "Main Room üõãÔ∏è" },
            planningArea: { x: 5, y: 5, w: 12, h: 8, name: "Planning Area üìã" },
            weaponCache: { x: 22, y: 5, w: 8, h: 8, name: "Weapon Cache üî´" }
        },
        isInterior: true,
        isSafeHouse: true
    }
};

// ==================== ACT 8 CHARACTERS ====================
const ACT8_CHARACTERS = {
    rippooFinal: {
        name: "Rippoo (Mother)",
        sprite: "üëµüèæ",
        role: "Mother - Final Truth",
        backstory: "Finally reveals the complete truth about the family's criminal past and her role as 'Rippoo the Razor'.",
        dialogues: {
            final_truth: {
                speaker: "Rippoo",
                sprite: "üëµüèæ",
                lines: [
                    { text: "*crying* Aharen should have told kaley long ago...", dhivehi: true },
                    { text: "Kaley father... Ibrahim... he wasn't just a fisherman.", dhivehi: true },
                    { text: "He was the FOUNDER. The first Baokalo.", dhivehi: true },
                    { text: "And aharen... aharen was his enforcer. Rippoo the Razor.", dhivehi: true },
                    { text: "Mashakah built the empire kaley now control.", dhivehi: true },
                    { text: "The politicians... they killed him because he knew too much.", dhivehi: true }
                ]
            }
        }
    },
    
    dhodhoBetrayal: {
        name: "DhoDho (Uncle)",
        sprite: "üë¥üèæ",
        role: "Uncle - Betrayer",
        backstory: "Reveals his true colors. Has been working with enemies all along, jealous of his brother Ibrahim.",
        dialogues: {
            betrayal_reveal: {
                speaker: "DhoDho",
                sprite: "üë¥üèæ",
                lines: [
                    { text: "*laughs* Kaley finally figured it out?", dhivehi: true },
                    { text: "Aharen HATED kaley father. Always the favorite.", dhivehi: true },
                    { text: "He got the empire. Aharen got nothing.", dhivehi: true },
                    { text: "So aharen made a deal. With Mooizbe. With the police.", dhivehi: true },
                    { text: "Ibrahim's death? Aharen arranged it.", dhivehi: true },
                    { text: "And now... aharen will take what's mine.", dhivehi: true }
                ],
                choices: [
                    { text: "Kaley will kill you for this.", karma: -25, response: "dhodho_fight" },
                    { text: "Why? He was your brother!", karma: 0, response: "dhodho_why" },
                    { text: "Aharen forgive you. Family is family.", karma: 25, response: "dhodho_forgive" }
                ]
            }
        }
    },
    
    nunnuDanger: {
        name: "Nunnu (Sister)",
        sprite: "üë©üèæ",
        role: "Sister - In Danger",
        backstory: "Her journalism has made her a target. She's uncovered the truth about the family and the government.",
        dialogues: {
            danger_warning: {
                speaker: "Nunnu",
                sprite: "üë©üèæ",
                lines: [
                    { text: "*scared* Brother... they're coming for aharen.", dhivehi: true },
                    { text: "Aharen found everything. Father's files. The truth.", dhivehi: true },
                    { text: "Mooizbe, DhoDho, the 2012 coup... it's all connected.", dhivehi: true },
                    { text: "If aharen publish this... they'll kill aharen.", dhivehi: true },
                    { text: "But if aharen don't... the cycle continues forever.", dhivehi: true }
                ],
                choices: [
                    { text: "Publish it. Aharen will protect you.", karma: 15, response: "nunnu_publish" },
                    { text: "Don't publish. Your life matters more.", karma: 5, response: "nunnu_hide" },
                    { text: "Give aharen the files. Aharen will use them.", karma: -10, response: "nunnu_files" }
                ]
            }
        }
    },
    
    muazBrother: {
        name: "Muaz (Half-Brother)",
        sprite: "üë§",
        role: "Half-Brother - Alliance",
        backstory: "Fully committed to Baokalo now. Wants revenge for their father together.",
        dialogues: {
            alliance_final: {
                speaker: "Muaz",
                sprite: "üë§",
                lines: [
                    { text: "Brother... mashakah have same blood. Same enemies.", dhivehi: true },
                    { text: "DhoDho betrayed our father. Mooizbe ordered the hit.", dhivehi: true },
                    { text: "Mashakah can end this. Together.", dhivehi: true },
                    { text: "Or... mashakah can walk away. Start new.", dhivehi: true },
                    { text: "What does kaley want? Revenge or peace?", dhivehi: true }
                ],
                choices: [
                    { text: "Revenge. They all pay.", karma: -30, response: "muaz_revenge" },
                    { text: "Peace. The cycle must end.", karma: 30, response: "muaz_peace" },
                    { text: "Justice. Legal way.", karma: 15, response: "muaz_justice" }
                ]
            }
        }
    },
    
    fatherGhost: {
        name: "Ibrahim (Father's Memory)",
        sprite: "üëª",
        role: "Father - Flashback/Vision",
        backstory: "Appears in dreams/visions to guide Baokalo toward the truth.",
        dialogues: {
            grave_vision: {
                speaker: "Ibrahim (Vision)",
                sprite: "üëª",
                lines: [
                    { text: "*ethereal* My son... kaley have grown strong.", dhivehi: true },
                    { text: "Aharen made mistakes. Many mistakes.", dhivehi: true },
                    { text: "The empire... it corrupted aharen. Corrupted everyone.", dhivehi: true },
                    { text: "Kaley can be different. Kaley can break the cycle.", dhivehi: true },
                    { text: "Or kaley can become what aharen was. The choice is kaley.", dhivehi: true }
                ]
            }
        }
    },
    
    enemyLeader: {
        name: "Commissioner Hassan",
        sprite: "üëÆüèæ",
        role: "Police Commissioner - Enemy",
        backstory: "The man who orchestrated Ibrahim's arrest and death. Now targeting the whole family.",
        dialogues: {
            confrontation: {
                speaker: "Commissioner Hassan",
                sprite: "üëÆüèæ",
                lines: [
                    { text: "*sneering* The Ronda boy. Just like kaley father.", dhivehi: true },
                    { text: "Aharen put him in Dhoonidhoo. Aharen watched him die.", dhivehi: true },
                    { text: "And now... aharen will do the same to kaley.", dhivehi: true },
                    { text: "Unless... kaley want to make a deal?", dhivehi: true }
                ],
                choices: [
                    { text: "No deals. Kaley end this now.", karma: 0, response: "hassan_fight" },
                    { text: "What kind of deal?", karma: -15, response: "hassan_deal" },
                    { text: "Aharen have evidence. Kaley going down.", karma: 10, response: "hassan_evidence" }
                ]
            }
        }
    }
};

// ==================== ACT 8 MISSIONS ====================
const ACT8_MISSIONS = [
    {
        id: "act8_m1",
        title: "Homecoming",
        type: "story",
        description: "Return to the family home after years away",
        objectives: [
            { type: "travel", target: "ronda_home", current: false },
            { type: "trigger", target: "familyReunion", current: false }
        ],
        rewards: { money: 500 },
        dialogueStart: "family_reunion",
        unlocks: ["act8_m2"]
    },
    {
        id: "act8_m2",
        title: "Mother's Confession",
        type: "story",
        description: "Rippoo finally tells the truth",
        objectives: [
            { type: "travel", target: "rippooRoom", current: false },
            { type: "trigger", target: "rippooConfession", current: false }
        ],
        rewards: { money: 0, karma: 0 },
        dialogueStart: "rippoo_final_truth",
        unlocks: ["act8_m3"],
        emotionalScene: true
    },
    {
        id: "act8_m3",
        title: "The Secret Basement",
        type: "exploration",
        description: "Discover father's hidden files",
        objectives: [
            { type: "find", target: "basementKey", current: false },
            { type: "travel", target: "secretBasement", current: false },
            { type: "collect", target: "fatherFiles", current: false }
        ],
        rewards: { money: 0 },
        unlocks: ["act8_m4"]
    },
    {
        id: "act8_m4",
        title: "Sister's Warning",
        type: "story",
        description: "Nunnu reveals she's being targeted",
        objectives: [
            { type: "travel", target: "newspaper_office", current: false },
            { type: "trigger", target: "nunnuWarning", current: false }
        ],
        rewards: { money: 0 },
        dialogueStart: "nunnu_danger_warning",
        unlocks: ["act8_m5"],
        moralChoice: true
    },
    {
        id: "act8_m5",
        title: "Protect the Press",
        type: "defense",
        description: "Defend Nunnu from attackers",
        objectives: [
            { type: "defend", target: "nunnuDesk", duration: 120, current: 0 },
            { type: "defeat", target: "hitman", count: 8, current: 0 },
            { type: "escort", target: "nunnu", current: false }
        ],
        rewards: { money: 3000, karma: 10, family: 15 },
        unlocks: ["act8_m6"]
    },
    {
        id: "act8_m6",
        title: "Uncle's Warehouse",
        type: "investigation",
        description: "Investigate DhoDho's suspicious activities",
        objectives: [
            { type: "travel", target: "dhodho_warehouse", current: false },
            { type: "stealth", target: "secretRoom", current: false },
            { type: "collect", target: "evidence", current: false }
        ],
        rewards: { money: 2000 },
        unlocks: ["act8_m7"]
    },
    {
        id: "act8_m7",
        title: "The Betrayal",
        type: "story",
        description: "Confront DhoDho with the evidence",
        objectives: [
            { type: "travel", target: "office", current: false },
            { type: "trigger", target: "dhodhoConfrontation", current: false }
        ],
        rewards: { money: 0 },
        dialogueStart: "dhodho_betrayal_reveal",
        unlocks: ["act8_m8", "act8_m9"],
        majorChoice: "dhodho_fate",
        moralChoice: true
    },
    {
        id: "act8_m8",
        title: "Blood Vengeance",
        type: "combat",
        description: "Kill DhoDho for his betrayal",
        objectives: [
            { type: "boss", target: "dhodho", current: false },
            { type: "defeat", target: "dhodhoGuard", count: 6, current: 0 }
        ],
        rewards: { money: 10000, karma: -40, family: -30 },
        unlocks: ["act8_m10"],
        requiresChoice: "dhodho_fight",
        bossMusic: true
    },
    {
        id: "act8_m9",
        title: "Family Forgiveness",
        type: "story",
        description: "Spare DhoDho despite his betrayal",
        objectives: [
            { type: "trigger", target: "dhodhoSpared", current: false },
            { type: "escort", target: "dhodho", current: false }
        ],
        rewards: { money: 0, karma: 30, family: 20 },
        unlocks: ["act8_m10"],
        requiresChoice: "dhodho_forgive"
    },
    {
        id: "act8_m10",
        title: "Father's Grave",
        type: "story",
        description: "Visit Ibrahim's grave for answers",
        objectives: [
            { type: "travel", target: "father_grave", current: false },
            { type: "trigger", target: "graveVision", current: false }
        ],
        rewards: { money: 0 },
        dialogueStart: "father_grave_vision",
        unlocks: ["act8_m11"],
        emotionalScene: true
    },
    {
        id: "act8_m11",
        title: "Brother's Alliance",
        type: "story",
        description: "Decide the future with Muaz",
        objectives: [
            { type: "travel", target: "muaz_hideout", current: false },
            { type: "trigger", target: "muazAlliance", current: false }
        ],
        rewards: { money: 0 },
        dialogueStart: "muaz_alliance_final",
        unlocks: ["act8_m12"],
        majorChoice: "path_forward",
        moralChoice: true
    },
    {
        id: "act8_m12",
        title: "The Commissioner",
        type: "story",
        description: "Commissioner Hassan makes his move",
        objectives: [
            { type: "survive", target: "policeRaid", current: false },
            { type: "escape", target: "safeHouse", current: false }
        ],
        rewards: { money: 5000 },
        unlocks: ["act8_climax"]
    },
    {
        id: "act8_climax",
        title: "Rooftop Reckoning",
        type: "boss",
        description: "Final confrontation with Commissioner Hassan",
        objectives: [
            { type: "travel", target: "confrontation_rooftop", current: false },
            { type: "defeat", target: "policeElite", count: 10, current: 0 },
            { type: "boss", target: "commissionerHassan", current: false },
            { type: "decide", target: "hassanFate", current: false }
        ],
        rewards: { money: 15000 },
        unlocks: ["act9_start"],
        actEnd: true,
        bossMusic: true,
        majorChoice: "hassan_ending"
    }
];

// ==================== ACT 8 SIDE MISSIONS ====================
const ACT8_SIDE_MISSIONS = [
    { id: "side8_memory1", title: "Childhood Memories I", type: "exploration", reward: 300 },
    { id: "side8_memory2", title: "Childhood Memories II", type: "exploration", reward: 400 },
    { id: "side8_photo", title: "Family Photos", type: "collection", reward: 500 },
    { id: "side8_grave1", title: "Visit Grandfather's Grave", type: "story", reward: 200 },
    { id: "side8_grave2", title: "Clean Family Plot", type: "task", reward: 300 },
    { id: "side8_protect1", title: "Protect Nunnu I", type: "defense", reward: 800 },
    { id: "side8_protect2", title: "Protect Nunnu II", type: "defense", reward: 1000 },
    { id: "side8_evidence1", title: "Gather Evidence I", type: "investigation", reward: 600 },
    { id: "side8_evidence2", title: "Gather Evidence II", type: "investigation", reward: 800 },
    { id: "side8_muaz1", title: "Help Muaz I", type: "combat", reward: 700 },
    { id: "side8_muaz2", title: "Help Muaz II", type: "combat", reward: 900 }
];

// ==================== ACT 8 DIALOGUES ====================
const ACT8_DIALOGUES = {
    family_reunion: {
        speaker: "Rippoo",
        sprite: "üëµüèæ",
        lines: [
            { text: "*opens door* My son... kaley finally home.", dhivehi: true },
            { text: "Aharen heard what kaley did. In the south. The resorts.", dhivehi: true },
            { text: "Kaley becoming... like kaley father.", dhivehi: true },
            { text: "Come inside. Mashakah need to talk. All of us.", dhivehi: true }
        ]
    },
    
    rippoo_final_truth: {
        speaker: "Rippoo",
        sprite: "üëµüèæ",
        lines: [
            { text: "*crying* Aharen should have told kaley long ago...", dhivehi: true },
            { text: "Kaley father... Ibrahim... he wasn't just a fisherman.", dhivehi: true },
            { text: "He was the FOUNDER. The first Baokalo.", dhivehi: true },
            { text: "And aharen... aharen was his enforcer. Rippoo the Razor.", dhivehi: true },
            { text: "Mashakah built the empire kaley now control.", dhivehi: true },
            { text: "The politicians... they killed him because he knew too much.", dhivehi: true },
            { text: "About the 1988 coup. About Gayoom. About everything.", dhivehi: true }
        ]
    },
    
    nunnu_danger_warning: {
        speaker: "Nunnu",
        sprite: "üë©üèæ",
        lines: [
            { text: "*scared* Brother... they're coming for aharen.", dhivehi: true },
            { text: "Aharen found everything. Father's files. The truth.", dhivehi: true },
            { text: "Mooizbe, DhoDho, the 2012 coup... it's all connected.", dhivehi: true },
            { text: "If aharen publish this... they'll kill aharen.", dhivehi: true },
            { text: "But if aharen don't... the cycle continues forever.", dhivehi: true }
        ],
        choices: [
            { text: "Publish it. Aharen will protect you.", karma: 15, response: "nunnu_publish" },
            { text: "Don't publish. Your life matters more.", karma: 5, response: "nunnu_hide" },
            { text: "Give aharen the files. Aharen will use them.", karma: -10, response: "nunnu_files" }
        ]
    },
    
    nunnu_publish: {
        speaker: "Nunnu",
        sprite: "üë©üèæ",
        lines: [
            { text: "*determined* Kaley right. The truth must come out.", dhivehi: true },
            { text: "Aharen will publish tomorrow. Front page.", dhivehi: true },
            { text: "Whatever happens... aharen proud of kaley, brother.", dhivehi: true },
            { text: "Mashakah Rondas... mashakah don't hide from truth.", dhivehi: true }
        ]
    },
    
    nunnu_hide: {
        speaker: "Nunnu",
        sprite: "üë©üèæ",
        lines: [
            { text: "*relieved but sad* Maybe kaley right...", dhivehi: true },
            { text: "Aharen will hide the files. For now.", dhivehi: true },
            { text: "But someday... the truth will come out.", dhivehi: true },
            { text: "Aharen just hope mashakah still alive to see it.", dhivehi: true }
        ]
    },
    
    nunnu_files: {
        speaker: "Nunnu",
        sprite: "üë©üèæ",
        lines: [
            { text: "*hesitant* Kaley want to use them? For what?", dhivehi: true },
            { text: "Blackmail? Leverage? That's not journalism.", dhivehi: true },
            { text: "*sighs* Fine. Take them. Kaley the boss now.", dhivehi: true },
            { text: "Just... don't become what father became.", dhivehi: true }
        ]
    },
    
    dhodho_betrayal_reveal: {
        speaker: "DhoDho",
        sprite: "üë¥üèæ",
        lines: [
            { text: "*laughs* Kaley finally figured it out?", dhivehi: true },
            { text: "Aharen HATED kaley father. Always the favorite.", dhivehi: true },
            { text: "He got the empire. Aharen got nothing.", dhivehi: true },
            { text: "So aharen made a deal. With Mooizbe. With the police.", dhivehi: true },
            { text: "Ibrahim's death? Aharen arranged it.", dhivehi: true },
            { text: "And now... aharen will take what's mine.", dhivehi: true }
        ],
        choices: [
            { text: "Kaley will kill you for this.", karma: -25, response: "dhodho_fight" },
            { text: "Why? He was your brother!", karma: 0, response: "dhodho_why" },
            { text: "Aharen forgive you. Family is family.", karma: 25, response: "dhodho_forgive" }
        ]
    },
    
    dhodho_fight: {
        speaker: "DhoDho",
        sprite: "üë¥üèæ",
        lines: [
            { text: "*draws weapon* Then come, nephew!", dhivehi: true },
            { text: "Aharen killed kaley father. Aharen can kill kaley too!", dhivehi: true },
            { text: "GUARDS! KILL HIM!", dhivehi: true }
        ]
    },
    
    dhodho_why: {
        speaker: "DhoDho",
        sprite: "üë¥üèæ",
        lines: [
            { text: "*bitter* Brother? He was never a brother to aharen.", dhivehi: true },
            { text: "Always Ibrahim this, Ibrahim that.", dhivehi: true },
            { text: "Aharen worked just as hard. Got nothing.", dhivehi: true },
            { text: "So aharen took what aharen deserved.", dhivehi: true }
        ]
    },
    
    dhodho_forgive: {
        speaker: "DhoDho",
        sprite: "üë¥üèæ",
        lines: [
            { text: "*shocked* Kaley... forgive aharen?", dhivehi: true },
            { text: "After everything aharen did?", dhivehi: true },
            { text: "*breaks down* Aharen... aharen sorry. So sorry.", dhivehi: true },
            { text: "Kaley better man than aharen ever was.", dhivehi: true }
        ]
    },
    
    father_grave_vision: {
        speaker: "Ibrahim (Vision)",
        sprite: "üëª",
        lines: [
            { text: "*ethereal* My son... kaley have grown strong.", dhivehi: true },
            { text: "Aharen made mistakes. Many mistakes.", dhivehi: true },
            { text: "The empire... it corrupted aharen. Corrupted everyone.", dhivehi: true },
            { text: "Kaley can be different. Kaley can break the cycle.", dhivehi: true },
            { text: "Or kaley can become what aharen was. The choice is kaley.", dhivehi: true },
            { text: "Whatever kaley choose... aharen love kaley. Always.", dhivehi: true }
        ]
    },
    
    muaz_alliance_final: {
        speaker: "Muaz",
        sprite: "üë§",
        lines: [
            { text: "Brother... mashakah have same blood. Same enemies.", dhivehi: true },
            { text: "DhoDho betrayed our father. Mooizbe ordered the hit.", dhivehi: true },
            { text: "Mashakah can end this. Together.", dhivehi: true },
            { text: "Or... mashakah can walk away. Start new.", dhivehi: true },
            { text: "What does kaley want? Revenge or peace?", dhivehi: true }
        ],
        choices: [
            { text: "Revenge. They all pay.", karma: -30, response: "muaz_revenge" },
            { text: "Peace. The cycle must end.", karma: 30, response: "muaz_peace" },
            { text: "Justice. Legal way.", karma: 15, response: "muaz_justice" }
        ]
    },
    
    muaz_revenge: {
        speaker: "Muaz",
        sprite: "üë§",
        lines: [
            { text: "*nods grimly* Aharen understand, brother.", dhivehi: true },
            { text: "Mashakah will make them all pay.", dhivehi: true },
            { text: "Mooizbe. Hassan. Everyone who hurt our family.", dhivehi: true },
            { text: "Blood for blood. The Maldivian way.", dhivehi: true }
        ]
    },
    
    muaz_peace: {
        speaker: "Muaz",
        sprite: "üë§",
        lines: [
            { text: "*surprised* Peace? After everything?", dhivehi: true },
            { text: "*thinks* Maybe kaley right. Maybe enough blood.", dhivehi: true },
            { text: "Mashakah can disappear. Start over. New names.", dhivehi: true },
            { text: "But... can kaley really walk away from all this?", dhivehi: true }
        ]
    },
    
    muaz_justice: {
        speaker: "Muaz",
        sprite: "üë§",
        lines: [
            { text: "*skeptical* Legal way? In Maldives?", dhivehi: true },
            { text: "The courts are bought. The police are corrupt.", dhivehi: true },
            { text: "But... if kaley have the evidence...", dhivehi: true },
            { text: "Maybe international courts. ICC. UN.", dhivehi: true },
            { text: "Risky. But... honorable. Aharen with kaley.", dhivehi: true }
        ]
    },
    
    hassan_confrontation: {
        speaker: "Commissioner Hassan",
        sprite: "üëÆüèæ",
        lines: [
            { text: "*sneering* The Ronda boy. Just like kaley father.", dhivehi: true },
            { text: "Aharen put him in Dhoonidhoo. Aharen watched him die.", dhivehi: true },
            { text: "And now... aharen will do the same to kaley.", dhivehi: true },
            { text: "Unless... kaley want to make a deal?", dhivehi: true }
        ],
        choices: [
            { text: "No deals. Kaley end this now.", karma: 0, response: "hassan_fight" },
            { text: "What kind of deal?", karma: -15, response: "hassan_deal" },
            { text: "Aharen have evidence. Kaley going down.", karma: 10, response: "hassan_evidence" }
        ]
    },
    
    hassan_fight: {
        speaker: "Commissioner Hassan",
        sprite: "üëÆüèæ",
        lines: [
            { text: "*draws gun* Brave. Stupid, but brave.", dhivehi: true },
            { text: "Just like kaley father's last words.", dhivehi: true },
            { text: "MEN! KILL HIM!", dhivehi: true }
        ]
    },
    
    hassan_deal: {
        speaker: "Commissioner Hassan",
        sprite: "üëÆüèæ",
        lines: [
            { text: "*smiles* Smart. Work for aharen. Like DhoDho did.", dhivehi: true },
            { text: "Kaley run the streets. Aharen get 50%.", dhivehi: true },
            { text: "Everyone wins. Except... kaley soul.", dhivehi: true }
        ]
    },
    
    hassan_evidence: {
        speaker: "Commissioner Hassan",
        sprite: "üëÆüèæ",
        lines: [
            { text: "*laughs nervously* Evidence? What evidence?", dhivehi: true },
            { text: "Kaley bluffing. Kaley have nothing.", dhivehi: true },
            { text: "*sees files* Where... where did kaley get those?!", dhivehi: true },
            { text: "GIVE THEM TO AHAREN!", dhivehi: true }
        ]
    }
};

// ==================== ACT 8 RADIO CONTENT ====================
const ACT8_RADIO = {
    raajjeFM: {
        name: "üìª Raajje FM",
        segments: [
            { type: "news", text: "Police Commissioner Hassan denies corruption allegations." },
            { type: "news", text: "Journalist receives death threats. Identity protected." },
            { type: "satire", text: "'Family values' - When your uncle sells you out." },
            { type: "news", text: "Cemetery vandalism reported in Mal√©. Investigation ongoing." },
            { type: "ad", text: "Family counseling services. Because some secrets hurt." }
        ]
    },
    undergroundFM: {
        name: "üìª Underground FM",
        segments: [
            { type: "truth", text: "The Ronda family secret: What really happened in 1998?" },
            { type: "truth", text: "DhoDho's warehouse: More than just imports." },
            { type: "music", text: "‚ô™ Playing: Boduberu of Betrayal ‚ô™" },
            { type: "truth", text: "Commissioner Hassan's offshore accounts revealed." },
            { type: "call", text: "Caller: 'My family destroyed by same people. Fight back!'" }
        ]
    }
};

// ==================== EXPORT FOR MAIN GAME ====================
if (typeof window !== 'undefined') {
    window.ACT8_MAPS = ACT8_MAPS;
    window.ACT8_CHARACTERS = ACT8_CHARACTERS;
    window.ACT8_MISSIONS = ACT8_MISSIONS;
    window.ACT8_SIDE_MISSIONS = ACT8_SIDE_MISSIONS;
    window.ACT8_DIALOGUES = ACT8_DIALOGUES;
    window.ACT8_RADIO = ACT8_RADIO;
}


// ========== act9.js ==========
// ============================================
// ACT 9: ELECTION CHAOS
// Timeline: 2023 - The Presidential Election
// ============================================

// ==================== ACT 9 MAPS ====================
const ACT9_MAPS = {
    campaign_hq_mooizbe: {
        name: "Mooizbe Campaign HQ",
        width: 50,
        height: 45,
        spawnX: 25,
        spawnY: 40,
        tiles: [],
        npcs: [],
        items: [],
        zones: {
            entrance: { x: 20, y: 38, w: 10, h: 6, name: "HQ Entrance üö™" },
            mainHall: { x: 10, y: 25, w: 30, h: 12, name: "Main Hall üèõÔ∏è" },
            warRoom: { x: 35, y: 10, w: 12, h: 12, name: "War Room üó∫Ô∏è" },
            mediaCenter: { x: 5, y: 10, w: 15, h: 12, name: "Media Center üì∫" },
            mooizbeOffice: { x: 20, y: 5, w: 12, h: 8, name: "President's Office ü™ë" }
        },
        isInterior: true,
        isPolitical: true
    },
    
    campaign_hq_alibe: {
        name: "Alibe Opposition HQ",
        width: 45,
        height: 40,
        spawnX: 22,
        spawnY: 35,
        tiles: [],
        npcs: [],
        items: [],
        zones: {
            entrance: { x: 18, y: 32, w: 8, h: 6, name: "Opposition HQ üö™" },
            meetingRoom: { x: 10, y: 20, w: 25, h: 10, name: "Meeting Room ü§ù" },
            alibeOffice: { x: 30, y: 8, w: 10, h: 10, name: "Alibe's Office üìã" },
            volunteerArea: { x: 5, y: 8, w: 12, h: 10, name: "Volunteer Center üë•" }
        },
        isInterior: true,
        isPolitical: true
    },
    
    rally_ground: {
        name: "Republic Square - Rally Ground",
        width: 60,
        height: 55,
        spawnX: 30,
        spawnY: 50,
        tiles: [],
        npcs: [],
        items: [],
        zones: {
            entrance: { x: 25, y: 48, w: 10, h: 6, name: "Square Entrance üö∂" },
            mainStage: { x: 20, y: 10, w: 20, h: 12, name: "Main Stage üé§" },
            crowdArea: { x: 10, y: 22, w: 40, h: 25, name: "Crowd Area üë•" },
            vipSection: { x: 35, y: 12, w: 10, h: 8, name: "VIP Section ‚≠ê" },
            mediaArea: { x: 5, y: 15, w: 10, h: 10, name: "Media Zone üì∑" },
            securityPost: { x: 50, y: 40, w: 8, h: 8, name: "Security Post üöî" }
        },
        isOutdoor: true,
        isRally: true
    },
    
    tv_station: {
        name: "Raajje TV Station",
        width: 50,
        height: 45,
        spawnX: 25,
        spawnY: 40,
        tiles: [],
        npcs: [],
        items: [],
        zones: {
            lobby: { x: 18, y: 35, w: 14, h: 8, name: "TV Lobby üè¢" },
            newsroom: { x: 5, y: 20, w: 20, h: 14, name: "Newsroom üì∞" },
            studio: { x: 28, y: 20, w: 18, h: 14, name: "Live Studio üé¨" },
            controlRoom: { x: 35, y: 8, w: 12, h: 10, name: "Control Room üéõÔ∏è" },
            serverRoom: { x: 5, y: 8, w: 12, h: 10, name: "Server Room üíæ" }
        },
        isInterior: true,
        isMedia: true
    },
    
    debate_hall: {
        name: "National Debate Hall",
        width: 55,
        height: 50,
        spawnX: 27,
        spawnY: 45,
        tiles: [],
        npcs: [],
        items: [],
        zones: {
            entrance: { x: 22, y: 42, w: 10, h: 6, name: "Hall Entrance üö™" },
            debateStage: { x: 15, y: 10, w: 25, h: 15, name: "Debate Stage üé§" },
            audienceLeft: { x: 5, y: 25, w: 15, h: 15, name: "Mooizbe Supporters üîµ" },
            audienceRight: { x: 35, y: 25, w: 15, h: 15, name: "Alibe Supporters üü°" },
            moderatorDesk: { x: 22, y: 8, w: 10, h: 6, name: "Moderator Desk üìã" },
            backstage: { x: 40, y: 5, w: 12, h: 10, name: "Backstage üé≠" }
        },
        isInterior: true,
        isDebate: true
    },
    
    voting_center: {
        name: "Mal√© Voting Center",
        width: 45,
        height: 40,
        spawnX: 22,
        spawnY: 35,
        tiles: [],
        npcs: [],
        items: [],
        zones: {
            entrance: { x: 18, y: 32, w: 8, h: 6, name: "Voting Center üó≥Ô∏è" },
            registrationDesk: { x: 10, y: 22, w: 12, h: 8, name: "Registration üìù" },
            votingBooths: { x: 25, y: 15, w: 15, h: 15, name: "Voting Booths üó≥Ô∏è" },
            countingRoom: { x: 5, y: 8, w: 15, h: 10, name: "Counting Room üìä" },
            observerArea: { x: 30, y: 8, w: 10, h: 8, name: "Observer Area üëÅÔ∏è" }
        },
        isInterior: true,
        isVoting: true
    },
    
    election_night: {
        name: "Election Night - Results Center",
        width: 50,
        height: 45,
        spawnX: 25,
        spawnY: 40,
        tiles: [],
        npcs: [],
        items: [],
        zones: {
            entrance: { x: 20, y: 38, w: 10, h: 6, name: "Results Center üö™" },
            mainScreen: { x: 15, y: 10, w: 20, h: 12, name: "Results Screen üì∫" },
            pressArea: { x: 5, y: 22, w: 15, h: 12, name: "Press Area üì∞" },
            vipLounge: { x: 35, y: 22, w: 12, h: 12, name: "VIP Lounge ü•Ç" },
            securityOffice: { x: 38, y: 8, w: 10, h: 10, name: "Security Office üîí" }
        },
        isInterior: true,
        isElectionNight: true
    }
};

// ==================== ACT 9 CHARACTERS ====================
const ACT9_CHARACTERS = {
    mooizbe: {
        name: "President Mooizbe",
        sprite: "üé©",
        role: "Incumbent President",
        backstory: "Corrupt president seeking re-election. Will do anything to stay in power.",
        dialogues: {
            campaign_meeting: {
                speaker: "President Mooizbe",
                sprite: "üé©",
                lines: [
                    { text: "*smiles coldly* Ah, the Ronda boy. Kaley useful.", dhivehi: true },
                    { text: "Election coming. Aharen need... insurance.", dhivehi: true },
                    { text: "Alibe thinks he can win. Democracy. *laughs*", dhivehi: true },
                    { text: "Help aharen win, and kaley family protected. Forever.", dhivehi: true },
                    { text: "Refuse... and Commissioner Hassan visits kaley mother.", dhivehi: true }
                ]
            }
        }
    },
    
    alibe: {
        name: "Alibe (Opposition Leader)",
        sprite: "üì¢",
        role: "Opposition Candidate",
        backstory: "Former president, ousted in 2012 coup. Fighting for democracy.",
        dialogues: {
            opposition_meeting: {
                speaker: "Alibe",
                sprite: "üì¢",
                lines: [
                    { text: "*tired but determined* Kaley know who aharen am?", dhivehi: true },
                    { text: "They took aharen presidency. 2012. The coup.", dhivehi: true },
                    { text: "Mooizbe, the military, the judges... all corrupt.", dhivehi: true },
                    { text: "Kaley can help aharen. Or kaley can help them.", dhivehi: true },
                    { text: "But know this: aharen fight for Raajje. Not for aharen.", dhivehi: true }
                ]
            }
        }
    },
    
    campaignManager: {
        name: "Fathimath (Campaign Manager)",
        sprite: "üë©üèæ‚Äçüíº",
        role: "Mooizbe's Campaign Manager",
        backstory: "Ruthless political operative. Knows all the dirty tricks.",
        dialogues: {
            dirty_tricks: {
                speaker: "Fathimath",
                sprite: "üë©üèæ‚Äçüíº",
                lines: [
                    { text: "*businesslike* Kaley here for the special assignments?", dhivehi: true },
                    { text: "Mashakah need votes. By any means.", dhivehi: true },
                    { text: "Island chiefs can be... persuaded. With faisaa.", dhivehi: true },
                    { text: "Opposition rallies can have... accidents.", dhivehi: true },
                    { text: "Kaley understand? Good. Here's kaley first target.", dhivehi: true }
                ]
            }
        }
    },
    
    journalist: {
        name: "Ahmed (TV Journalist)",
        sprite: "üé§",
        role: "Raajje TV Anchor",
        backstory: "Trying to report truth in a controlled media environment.",
        dialogues: {
            media_truth: {
                speaker: "Ahmed",
                sprite: "üé§",
                lines: [
                    { text: "*whispers* Kaley Nunnu's brother, right?", dhivehi: true },
                    { text: "Aharen can't report the truth. They control everything.", dhivehi: true },
                    { text: "But if kaley get aharen evidence... real evidence...", dhivehi: true },
                    { text: "Aharen can broadcast it. Live. Before they cut the feed.", dhivehi: true },
                    { text: "One chance. Make it count.", dhivehi: true }
                ]
            }
        }
    },
    
    voteRigger: {
        name: "Hussain (Election Official)",
        sprite: "üìä",
        role: "Corrupt Election Official",
        backstory: "Controls the vote counting. For the right price.",
        dialogues: {
            vote_rigging: {
                speaker: "Hussain",
                sprite: "üìä",
                lines: [
                    { text: "*nervous* Kaley from the president's office?", dhivehi: true },
                    { text: "Aharen can... adjust the numbers. Certain boxes.", dhivehi: true },
                    { text: "But it's risky. International observers.", dhivehi: true },
                    { text: "50,000 rufiyaa per box. Final offer.", dhivehi: true }
                ],
                choices: [
                    { text: "Deal. Rig the votes.", karma: -40, response: "rig_accept" },
                    { text: "No. Democracy must win.", karma: 30, response: "rig_refuse" },
                    { text: "Aharen recording this. Kaley finished.", karma: 20, response: "rig_expose" }
                ]
            }
        }
    }
};

// ==================== ACT 9 MISSIONS ====================
const ACT9_MISSIONS = [
    {
        id: "act9_m1",
        title: "The Summons",
        type: "story",
        description: "President Mooizbe summons you to his campaign",
        objectives: [
            { type: "travel", target: "campaign_hq_mooizbe", current: false },
            { type: "trigger", target: "mooizbeMeeting", current: false }
        ],
        rewards: { money: 5000 },
        dialogueStart: "mooizbe_campaign_meeting",
        unlocks: ["act9_m2"]
    },
    {
        id: "act9_m2",
        title: "Opposition Contact",
        type: "story",
        description: "Secretly meet with Alibe's campaign",
        objectives: [
            { type: "stealth", target: "campaign_hq_alibe", current: false },
            { type: "trigger", target: "alibeMeeting", current: false }
        ],
        rewards: { money: 0, karma: 10 },
        dialogueStart: "alibe_opposition_meeting",
        unlocks: ["act9_m3"],
        moralChoice: true
    },
    {
        id: "act9_m3",
        title: "Dirty Tricks I",
        type: "sabotage",
        description: "Sabotage opposition rally (or warn them)",
        objectives: [
            { type: "travel", target: "rally_ground", current: false },
            { type: "decide", target: "rallySabotage", current: false }
        ],
        rewards: { money: 10000 },
        unlocks: ["act9_m4"],
        majorChoice: "rally_fate",
        moralChoice: true
    },
    {
        id: "act9_m4",
        title: "Media Control",
        type: "infiltration",
        description: "Infiltrate TV station to control narrative",
        objectives: [
            { type: "travel", target: "tv_station", current: false },
            { type: "stealth", target: "controlRoom", current: false },
            { type: "decide", target: "mediaControl", current: false }
        ],
        rewards: { money: 8000 },
        unlocks: ["act9_m5"],
        majorChoice: "media_truth",
        moralChoice: true
    },
    {
        id: "act9_m5",
        title: "Vote Buying",
        type: "corruption",
        description: "Buy votes from island chiefs",
        objectives: [
            { type: "travel", target: "islandChief1", current: false },
            { type: "bribe", target: "chief1", amount: 20000, current: false },
            { type: "travel", target: "islandChief2", current: false },
            { type: "bribe", target: "chief2", amount: 25000, current: false }
        ],
        rewards: { money: 0, karma: -20 },
        unlocks: ["act9_m6"],
        moralChoice: true
    },
    {
        id: "act9_m6",
        title: "The Debate",
        type: "story",
        description: "Attend the presidential debate",
        objectives: [
            { type: "travel", target: "debate_hall", current: false },
            { type: "trigger", target: "debateStart", current: false },
            { type: "minigame", target: "debate", current: false }
        ],
        rewards: { money: 0 },
        unlocks: ["act9_m7"],
        hasMinigame: "debate"
    },
    {
        id: "act9_m7",
        title: "Dirty Tricks II",
        type: "sabotage",
        description: "Plant evidence against Alibe (or expose Mooizbe)",
        objectives: [
            { type: "stealth", target: "alibeOffice", current: false },
            { type: "decide", target: "evidencePlant", current: false }
        ],
        rewards: { money: 15000 },
        unlocks: ["act9_m8"],
        majorChoice: "evidence_fate",
        moralChoice: true
    },
    {
        id: "act9_m8",
        title: "Election Day",
        type: "story",
        description: "Election day arrives - make your final choice",
        objectives: [
            { type: "travel", target: "voting_center", current: false },
            { type: "trigger", target: "votingStart", current: false },
            { type: "decide", target: "voteRigging", current: false }
        ],
        rewards: { money: 0 },
        dialogueStart: "vote_rigging_choice",
        unlocks: ["act9_m9"],
        majorChoice: "election_integrity",
        moralChoice: true
    },
    {
        id: "act9_m9",
        title: "The Count",
        type: "story",
        description: "Watch the votes being counted",
        objectives: [
            { type: "travel", target: "countingRoom", current: false },
            { type: "defend", target: "ballotBoxes", duration: 60, current: 0 }
        ],
        rewards: { money: 5000 },
        unlocks: ["act9_climax"]
    },
    {
        id: "act9_climax",
        title: "Election Night",
        type: "climax",
        description: "The results are announced - chaos erupts",
        objectives: [
            { type: "travel", target: "election_night", current: false },
            { type: "trigger", target: "resultsAnnounced", current: false },
            { type: "survive", target: "electionRiot", current: false },
            { type: "decide", target: "finalSide", current: false }
        ],
        rewards: { money: 20000 },
        unlocks: ["act10_start"],
        actEnd: true,
        majorChoice: "final_allegiance"
    }
];

// ==================== ACT 9 SIDE MISSIONS ====================
const ACT9_SIDE_MISSIONS = [
    { id: "side9_poster1", title: "Poster Campaign I", type: "task", reward: 500 },
    { id: "side9_poster2", title: "Poster Campaign II", type: "task", reward: 600 },
    { id: "side9_rally1", title: "Rally Security I", type: "defense", reward: 1000 },
    { id: "side9_rally2", title: "Rally Security II", type: "defense", reward: 1200 },
    { id: "side9_bribe1", title: "Bribe Delivery I", type: "delivery", reward: 800 },
    { id: "side9_bribe2", title: "Bribe Delivery II", type: "delivery", reward: 1000 },
    { id: "side9_spy1", title: "Opposition Spy I", type: "stealth", reward: 1500 },
    { id: "side9_spy2", title: "Opposition Spy II", type: "stealth", reward: 2000 },
    { id: "side9_media1", title: "Media Manipulation I", type: "task", reward: 1200 },
    { id: "side9_media2", title: "Media Manipulation II", type: "task", reward: 1500 },
    { id: "side9_intimidate", title: "Voter Intimidation", type: "combat", reward: 2000 }
];

// ==================== ACT 9 DIALOGUES ====================
const ACT9_DIALOGUES = {
    mooizbe_campaign_meeting: {
        speaker: "President Mooizbe",
        sprite: "üé©",
        lines: [
            { text: "*smiles coldly* Ah, the Ronda boy. Kaley useful.", dhivehi: true },
            { text: "Election coming. Aharen need... insurance.", dhivehi: true },
            { text: "Alibe thinks he can win. Democracy. *laughs*", dhivehi: true },
            { text: "Help aharen win, and kaley family protected. Forever.", dhivehi: true },
            { text: "Refuse... and Commissioner Hassan visits kaley mother.", dhivehi: true }
        ],
        choices: [
            { text: "Aharen will help. What do kaley need?", karma: -15, response: "mooizbe_accept" },
            { text: "Aharen need to think about it.", karma: 0, response: "mooizbe_delay" },
            { text: "Never. Kaley a tyrant.", karma: 20, response: "mooizbe_refuse" }
        ]
    },
    
    mooizbe_accept: {
        speaker: "President Mooizbe",
        sprite: "üé©",
        lines: [
            { text: "*pleased* Smart choice. Like kaley father.", dhivehi: true },
            { text: "Fathimath will give kaley assignments.", dhivehi: true },
            { text: "Do them well, and kaley will be rewarded.", dhivehi: true },
            { text: "Fail... and kaley know what happens.", dhivehi: true }
        ]
    },
    
    mooizbe_refuse: {
        speaker: "President Mooizbe",
        sprite: "üé©",
        lines: [
            { text: "*cold fury* Kaley dare refuse aharen?", dhivehi: true },
            { text: "Kaley father made same mistake. Look where he is.", dhivehi: true },
            { text: "Kaley have 24 hours to reconsider.", dhivehi: true },
            { text: "After that... no more chances.", dhivehi: true }
        ]
    },
    
    alibe_opposition_meeting: {
        speaker: "Alibe",
        sprite: "üì¢",
        lines: [
            { text: "*tired but determined* Kaley know who aharen am?", dhivehi: true },
            { text: "They took aharen presidency. 2012. The coup.", dhivehi: true },
            { text: "Mooizbe, the military, the judges... all corrupt.", dhivehi: true },
            { text: "Kaley can help aharen. Or kaley can help them.", dhivehi: true },
            { text: "But know this: aharen fight for Raajje. Not for aharen.", dhivehi: true }
        ],
        choices: [
            { text: "Aharen will help the opposition.", karma: 20, response: "alibe_join" },
            { text: "Aharen just gathering information.", karma: 0, response: "alibe_neutral" },
            { text: "Aharen work for Mooizbe. This is a trap.", karma: -25, response: "alibe_betray" }
        ]
    },
    
    alibe_join: {
        speaker: "Alibe",
        sprite: "üì¢",
        lines: [
            { text: "*hopeful* Kaley serious? After everything?", dhivehi: true },
            { text: "Mashakah need people inside. Mooizbe's campaign.", dhivehi: true },
            { text: "Feed aharen information. Sabotage from within.", dhivehi: true },
            { text: "Together, mashakah can save Raajje.", dhivehi: true }
        ]
    },
    
    alibe_betray: {
        speaker: "Alibe",
        sprite: "üì¢",
        lines: [
            { text: "*shocked* Kaley... kaley work for him?", dhivehi: true },
            { text: "*sad* Aharen thought... never mind.", dhivehi: true },
            { text: "Do what kaley must. Aharen won't beg.", dhivehi: true },
            { text: "But remember: history judges us all.", dhivehi: true }
        ]
    },
    
    dirty_tricks_choice: {
        speaker: "Fathimath",
        sprite: "üë©üèæ‚Äçüíº",
        lines: [
            { text: "The opposition rally is tomorrow. Republic Square.", dhivehi: true },
            { text: "Mashakah have... options.", dhivehi: true },
            { text: "Cut the power. Plant agitators. Or worse.", dhivehi: true },
            { text: "What does kaley recommend?", dhivehi: true }
        ],
        choices: [
            { text: "Cut the power. Non-violent.", karma: -10, response: "sabotage_power" },
            { text: "Plant agitators. Start a riot.", karma: -30, response: "sabotage_riot" },
            { text: "Aharen will warn them instead.", karma: 25, response: "sabotage_warn" }
        ]
    },
    
    sabotage_warn: {
        speaker: "Alibe",
        sprite: "üì¢",
        lines: [
            { text: "*grateful* Kaley warned aharen? Why?", dhivehi: true },
            { text: "Mashakah moved the rally. They found nothing.", dhivehi: true },
            { text: "Kaley taking big risk. Mooizbe will be angry.", dhivehi: true },
            { text: "Thank you. Raajje needs more people like kaley.", dhivehi: true }
        ]
    },
    
    media_control_choice: {
        speaker: "Ahmed",
        sprite: "üé§",
        lines: [
            { text: "Kaley in the control room. Kaley have access.", dhivehi: true },
            { text: "Kaley can broadcast Mooizbe's propaganda...", dhivehi: true },
            { text: "Or kaley can broadcast the truth. Nunnu's files.", dhivehi: true },
            { text: "One button. Kaley choice.", dhivehi: true }
        ],
        choices: [
            { text: "Broadcast the propaganda. Stay safe.", karma: -20, response: "media_propaganda" },
            { text: "Broadcast the truth. Expose everything.", karma: 30, response: "media_truth" },
            { text: "Destroy the equipment. No one broadcasts.", karma: 0, response: "media_destroy" }
        ]
    },
    
    media_truth: {
        speaker: "Ahmed",
        sprite: "üé§",
        lines: [
            { text: "*broadcasting* Citizens of Raajje!", dhivehi: true },
            { text: "What kaley about to see is the truth.", dhivehi: true },
            { text: "Corruption. Murder. The 2012 coup.", dhivehi: true },
            { text: "President Mooizbe is a criminal. Here's the proof.", dhivehi: true }
        ]
    },
    
    vote_rigging_choice: {
        speaker: "Hussain",
        sprite: "üìä",
        lines: [
            { text: "*nervous* Kaley from the president's office?", dhivehi: true },
            { text: "Aharen can... adjust the numbers. Certain boxes.", dhivehi: true },
            { text: "But it's risky. International observers.", dhivehi: true },
            { text: "50,000 rufiyaa per box. Final offer.", dhivehi: true }
        ],
        choices: [
            { text: "Deal. Rig the votes.", karma: -40, response: "rig_accept" },
            { text: "No. Democracy must win.", karma: 30, response: "rig_refuse" },
            { text: "Aharen recording this. Kaley finished.", karma: 20, response: "rig_expose" }
        ]
    },
    
    rig_accept: {
        speaker: "Hussain",
        sprite: "üìä",
        lines: [
            { text: "*relieved* Good. Mashakah understand each other.", dhivehi: true },
            { text: "The boxes from outer islands. Easy to adjust.", dhivehi: true },
            { text: "Mooizbe wins. Everyone happy.", dhivehi: true },
            { text: "Except... kaley know. Democracy.", dhivehi: true }
        ]
    },
    
    rig_expose: {
        speaker: "Hussain",
        sprite: "üìä",
        lines: [
            { text: "*panicked* What?! Kaley recording?!", dhivehi: true },
            { text: "No no no! Aharen was joking! Testing kaley!", dhivehi: true },
            { text: "Please! Aharen have family!", dhivehi: true },
            { text: "*runs away*", dhivehi: true }
        ]
    },
    
    election_results: {
        speaker: "TV Announcer",
        sprite: "üì∫",
        lines: [
            { text: "Ladies and gentlemen... the results are in.", dhivehi: false },
            { text: "With 98% of votes counted...", dhivehi: false },
            { text: "The winner of the 2023 Presidential Election is...", dhivehi: false }
        ]
    },
    
    election_chaos: {
        speaker: "Crowd",
        sprite: "üë•",
        lines: [
            { text: "*shouting* RIGGED! THE ELECTION IS RIGGED!", dhivehi: true },
            { text: "*chaos erupts* MASHAKAH DEMAND RECOUNT!", dhivehi: true },
            { text: "*police sirens* EVERYONE STAY CALM!", dhivehi: false },
            { text: "*gunshots in distance*", dhivehi: false }
        ]
    },
    
    final_choice: {
        speaker: "Muaz",
        sprite: "üë§",
        lines: [
            { text: "Brother! The city is burning!", dhivehi: true },
            { text: "Mooizbe's men are hunting opposition.", dhivehi: true },
            { text: "Alibe is trapped in his HQ.", dhivehi: true },
            { text: "Mashakah can save him... or let him die.", dhivehi: true },
            { text: "What do mashakah do?", dhivehi: true }
        ],
        choices: [
            { text: "Save Alibe. He's the future.", karma: 30, response: "save_alibe" },
            { text: "Let him die. Mooizbe wins.", karma: -40, response: "abandon_alibe" },
            { text: "Use the chaos. Take power ourselves.", karma: -20, response: "seize_power" }
        ]
    }
};

// ==================== ACT 9 MINI-GAME: DEBATE ====================
const ACT9_DEBATE_MINIGAME = {
    name: "Presidential Debate",
    description: "Choose the right arguments to win the debate",
    rounds: 5,
    topics: [
        {
            topic: "Economy",
            question: "How will you improve the economy?",
            options: [
                { text: "More tourism investment", score: 2, type: "moderate" },
                { text: "Fight corruption first", score: 3, type: "reform" },
                { text: "Foreign investment deals", score: 1, type: "corrupt" }
            ]
        },
        {
            topic: "Democracy",
            question: "What about democratic freedoms?",
            options: [
                { text: "Free press is essential", score: 3, type: "reform" },
                { text: "Stability comes first", score: 1, type: "corrupt" },
                { text: "Gradual reform", score: 2, type: "moderate" }
            ]
        },
        {
            topic: "Gangs",
            question: "How will you address gang violence?",
            options: [
                { text: "Root causes: poverty, education", score: 3, type: "reform" },
                { text: "Stronger police powers", score: 1, type: "corrupt" },
                { text: "Community programs", score: 2, type: "moderate" }
            ]
        },
        {
            topic: "Corruption",
            question: "What about government corruption?",
            options: [
                { text: "Independent anti-corruption body", score: 3, type: "reform" },
                { text: "Current system works fine", score: 0, type: "corrupt" },
                { text: "Internal reforms", score: 2, type: "moderate" }
            ]
        },
        {
            topic: "2012 Coup",
            question: "Was the 2012 transfer of power legitimate?",
            options: [
                { text: "It was a coup. Period.", score: 3, type: "reform" },
                { text: "Constitutional process", score: 0, type: "corrupt" },
                { text: "We must move forward", score: 1, type: "moderate" }
            ]
        }
    ]
};

// ==================== ACT 9 RADIO CONTENT ====================
const ACT9_RADIO = {
    raajjeFM: {
        name: "üìª Raajje FM",
        segments: [
            { type: "news", text: "Election Day approaches. President Mooizbe leads in polls." },
            { type: "ad", text: "Vote Mooizbe! Stability. Progress. Leadership." },
            { type: "news", text: "Opposition claims voter intimidation. Government denies." },
            { type: "satire", text: "'Free and fair' - when you control the definition." },
            { type: "news", text: "International observers arrive. 'Cautiously optimistic.'" }
        ]
    },
    oppositionFM: {
        name: "üìª Freedom FM (Pirate)",
        segments: [
            { type: "truth", text: "They're buying votes. We have proof." },
            { type: "call", text: "Caller: 'They offered me 5000 rufiyaa. I said no.'" },
            { type: "music", text: "‚ô™ Playing: Songs of Freedom ‚ô™" },
            { type: "truth", text: "Remember 2012. Don't let them steal it again." },
            { type: "call", text: "Caller: 'My family threatened if we vote opposition.'" }
        ]
    }
};

// ==================== EXPORT FOR MAIN GAME ====================
if (typeof window !== 'undefined') {
    window.ACT9_MAPS = ACT9_MAPS;
    window.ACT9_CHARACTERS = ACT9_CHARACTERS;
    window.ACT9_MISSIONS = ACT9_MISSIONS;
    window.ACT9_SIDE_MISSIONS = ACT9_SIDE_MISSIONS;
    window.ACT9_DIALOGUES = ACT9_DIALOGUES;
    window.ACT9_DEBATE_MINIGAME = ACT9_DEBATE_MINIGAME;
    window.ACT9_RADIO = ACT9_RADIO;
}


// ========== act10.js ==========
// ============================================
// ACT 10: COUP D'√âTAT & EPILOGUE
// Timeline: 2023-2025 - The Final Reckoning
// ============================================

// ==================== ACT 10 MAPS ====================
const ACT10_MAPS = {
    presidential_palace: {
        name: "Muliaage - Presidential Palace",
        width: 60,
        height: 55,
        spawnX: 30,
        spawnY: 50,
        tiles: [],
        npcs: [],
        items: [],
        zones: {
            mainGate: { x: 25, y: 48, w: 10, h: 6, name: "Main Gate üö™" },
            courtyard: { x: 15, y: 35, w: 30, h: 12, name: "Palace Courtyard üèõÔ∏è" },
            mainHall: { x: 20, y: 20, w: 20, h: 14, name: "Grand Hall üëë" },
            throneRoom: { x: 22, y: 8, w: 16, h: 10, name: "Throne Room ü™ë" },
            securityWing: { x: 45, y: 25, w: 12, h: 15, name: "Security Wing üîí" },
            escapeRoute: { x: 5, y: 10, w: 10, h: 20, name: "Secret Passage üö™" }
        },
        isFinalLocation: true,
        isPalace: true
    },
    
    mndf_headquarters: {
        name: "MNDF Headquarters",
        width: 55,
        height: 50,
        spawnX: 27,
        spawnY: 45,
        tiles: [],
        npcs: [],
        items: [],
        zones: {
            entrance: { x: 22, y: 42, w: 10, h: 6, name: "MNDF Gate üö™" },
            parade: { x: 10, y: 28, w: 35, h: 12, name: "Parade Ground üéñÔ∏è" },
            commandCenter: { x: 20, y: 12, w: 15, h: 14, name: "Command Center üì°" },
            armory: { x: 40, y: 15, w: 10, h: 12, name: "Armory üî´" },
            detention: { x: 5, y: 10, w: 12, h: 15, name: "Detention Block üîí" }
        },
        isMilitary: true
    },
    
    republic_square_final: {
        name: "Republic Square - Final Stand",
        width: 65,
        height: 60,
        spawnX: 32,
        spawnY: 55,
        tiles: [],
        npcs: [],
        items: [],
        zones: {
            southEntrance: { x: 27, y: 52, w: 10, h: 6, name: "South Entrance üö∂" },
            centralMonument: { x: 25, y: 25, w: 15, h: 15, name: "Independence Monument üóΩ" },
            protestArea: { x: 10, y: 30, w: 45, h: 20, name: "Protest Zone üì¢" },
            policeBarricade: { x: 10, y: 20, w: 45, h: 8, name: "Police Line üöî" },
            sniperPosition: { x: 50, y: 10, w: 10, h: 10, name: "Rooftop ‚ö†Ô∏è" }
        },
        isOutdoor: true,
        isFinalBattle: true
    },
    
    safe_house_final: {
        name: "Final Safe House",
        width: 40,
        height: 35,
        spawnX: 20,
        spawnY: 30,
        tiles: [],
        npcs: [],
        items: [],
        zones: {
            entrance: { x: 15, y: 28, w: 10, h: 6, name: "Hidden Door üö™" },
            mainRoom: { x: 10, y: 15, w: 20, h: 12, name: "Planning Room üìã" },
            weaponRoom: { x: 5, y: 5, w: 12, h: 10, name: "Arsenal üî´" },
            escapeHatch: { x: 28, y: 5, w: 8, h: 8, name: "Escape Tunnel üï≥Ô∏è" }
        },
        isInterior: true,
        isSafeHouse: true
    },
    
    airport_escape: {
        name: "Velana Airport - Escape",
        width: 70,
        height: 50,
        spawnX: 35,
        spawnY: 45,
        tiles: [],
        npcs: [],
        items: [],
        zones: {
            terminal: { x: 25, y: 35, w: 20, h: 12, name: "Terminal üõ´" },
            runway: { x: 10, y: 15, w: 50, h: 15, name: "Runway ‚úàÔ∏è" },
            hangar: { x: 55, y: 20, w: 12, h: 15, name: "Private Hangar üõ©Ô∏è" },
            checkpoint: { x: 20, y: 30, w: 10, h: 8, name: "Security Check üöî" }
        },
        isAirport: true,
        isEscape: true
    },
    
    // EPILOGUE LOCATIONS
    epilogue_beach: {
        name: "Quiet Beach - Years Later",
        width: 50,
        height: 40,
        spawnX: 25,
        spawnY: 35,
        tiles: [],
        npcs: [],
        items: [],
        zones: {
            shore: { x: 5, y: 30, w: 40, h: 8, name: "Shoreline üèñÔ∏è" },
            palmGrove: { x: 10, y: 15, w: 15, h: 12, name: "Palm Grove üå¥" },
            sunset: { x: 30, y: 10, w: 15, h: 15, name: "Sunset Point üåÖ" }
        },
        isEpilogue: true,
        isPeaceful: true
    },
    
    epilogue_prison: {
        name: "Dhoonidhoo - Life Sentence",
        width: 40,
        height: 35,
        spawnX: 20,
        spawnY: 30,
        tiles: [],
        npcs: [],
        items: [],
        zones: {
            cell: { x: 15, y: 20, w: 10, h: 10, name: "Your Cell üîí" },
            yard: { x: 5, y: 5, w: 30, h: 12, name: "Prison Yard ‚õìÔ∏è" }
        },
        isEpilogue: true,
        isPrison: true
    },
    
    epilogue_palace: {
        name: "Muliaage - Your Palace",
        width: 50,
        height: 45,
        spawnX: 25,
        spawnY: 40,
        tiles: [],
        npcs: [],
        items: [],
        zones: {
            throne: { x: 18, y: 10, w: 14, h: 12, name: "Your Throne üëë" },
            balcony: { x: 20, y: 5, w: 10, h: 6, name: "Balcony üèõÔ∏è" }
        },
        isEpilogue: true,
        isTyrant: true
    },
    
    epilogue_grave: {
        name: "Mal√© Cemetery - Memorial",
        width: 40,
        height: 35,
        spawnX: 20,
        spawnY: 30,
        tiles: [],
        npcs: [],
        items: [],
        zones: {
            yourGrave: { x: 15, y: 12, w: 10, h: 10, name: "Hero's Grave ü™¶" },
            mourners: { x: 10, y: 20, w: 20, h: 10, name: "Mourners üïØÔ∏è" }
        },
        isEpilogue: true,
        isMartyr: true
    }
};

// ==================== ACT 10 MISSIONS ====================
const ACT10_MISSIONS = [
    {
        id: "act10_m1",
        title: "The Storm Gathers",
        type: "story",
        description: "The election results spark chaos across Mal√©",
        objectives: [
            { type: "travel", target: "safe_house_final", current: false },
            { type: "trigger", target: "stormGathers", current: false }
        ],
        rewards: { money: 5000 },
        dialogueStart: "storm_gathers",
        unlocks: ["act10_m2"]
    },
    {
        id: "act10_m2",
        title: "Choose Your Side",
        type: "story",
        description: "Make your final allegiance known",
        objectives: [
            { type: "decide", target: "finalAllegiance", current: false }
        ],
        rewards: { money: 0 },
        dialogueStart: "final_allegiance_choice",
        unlocks: ["act10_m3_tyrant", "act10_m3_puppet", "act10_m3_redemption", "act10_m3_martyr"],
        majorChoice: "ending_path",
        moralChoice: true
    },
    
    // TYRANT PATH
    {
        id: "act10_m3_tyrant",
        title: "Seize Power",
        type: "combat",
        description: "Launch your own coup - take the palace",
        objectives: [
            { type: "travel", target: "presidential_palace", current: false },
            { type: "defeat", target: "palaceGuard", count: 20, current: 0 },
            { type: "boss", target: "mooizbe", current: false }
        ],
        rewards: { money: 50000, karma: -50 },
        requiresPath: "tyrant",
        unlocks: ["act10_tyrant_climax"]
    },
    {
        id: "act10_tyrant_climax",
        title: "The New Tyrant",
        type: "boss",
        description: "Eliminate all opposition - become the new ruler",
        objectives: [
            { type: "boss", target: "alibe", current: false },
            { type: "defeat", target: "opposition", count: 15, current: 0 },
            { type: "trigger", target: "tyrantEnding", current: false }
        ],
        rewards: { money: 100000 },
        requiresPath: "tyrant",
        unlocks: ["epilogue_tyrant"],
        actEnd: true
    },
    
    // PUPPET PATH
    {
        id: "act10_m3_puppet",
        title: "Loyal Servant",
        type: "combat",
        description: "Help Mooizbe crush the opposition",
        objectives: [
            { type: "travel", target: "republic_square_final", current: false },
            { type: "defeat", target: "protesters", count: 25, current: 0 },
            { type: "capture", target: "alibe", current: false }
        ],
        rewards: { money: 30000, karma: -30 },
        requiresPath: "puppet",
        unlocks: ["act10_puppet_climax"]
    },
    {
        id: "act10_puppet_climax",
        title: "The President's Dog",
        type: "story",
        description: "Mooizbe rewards your loyalty... or does he?",
        objectives: [
            { type: "travel", target: "presidential_palace", current: false },
            { type: "trigger", target: "puppetBetrayal", current: false },
            { type: "survive", target: "mooizbeBetrayal", current: false }
        ],
        rewards: { money: 0 },
        requiresPath: "puppet",
        unlocks: ["epilogue_puppet"],
        actEnd: true
    },
    
    // REDEMPTION PATH
    {
        id: "act10_m3_redemption",
        title: "Break the Cycle",
        type: "story",
        description: "Help Alibe peacefully restore democracy",
        objectives: [
            { type: "travel", target: "republic_square_final", current: false },
            { type: "protect", target: "protesters", duration: 120, current: 0 },
            { type: "negotiate", target: "military", current: false }
        ],
        rewards: { money: 10000, karma: 40 },
        requiresPath: "redemption",
        unlocks: ["act10_redemption_climax"]
    },
    {
        id: "act10_redemption_climax",
        title: "A New Dawn",
        type: "story",
        description: "Witness the peaceful transfer of power",
        objectives: [
            { type: "escort", target: "alibe", current: false },
            { type: "travel", target: "presidential_palace", current: false },
            { type: "trigger", target: "peacefulTransfer", current: false }
        ],
        rewards: { money: 20000, karma: 30 },
        requiresPath: "redemption",
        unlocks: ["epilogue_redemption"],
        actEnd: true
    },
    
    // MARTYR PATH
    {
        id: "act10_m3_martyr",
        title: "The Ultimate Sacrifice",
        type: "story",
        description: "Give your life to save Raajje",
        objectives: [
            { type: "travel", target: "republic_square_final", current: false },
            { type: "trigger", target: "martyrChoice", current: false }
        ],
        rewards: { money: 0, karma: 50 },
        requiresPath: "martyr",
        unlocks: ["act10_martyr_climax"]
    },
    {
        id: "act10_martyr_climax",
        title: "For Raajje",
        type: "sacrifice",
        description: "Stand between the military and the people",
        objectives: [
            { type: "stand", target: "centralMonument", current: false },
            { type: "speech", target: "finalSpeech", current: false },
            { type: "trigger", target: "martyrEnding", current: false }
        ],
        rewards: { money: 0 },
        requiresPath: "martyr",
        unlocks: ["epilogue_martyr"],
        actEnd: true
    }
];

// ==================== EPILOGUE MISSIONS ====================
const EPILOGUE_MISSIONS = {
    tyrant: {
        id: "epilogue_tyrant",
        title: "Epilogue: The Iron Fist",
        description: "2025 - You rule Raajje with absolute power",
        scene: "epilogue_palace",
        ending: "TYRANT"
    },
    puppet: {
        id: "epilogue_puppet",
        title: "Epilogue: The Caged Bird",
        description: "2025 - Mooizbe betrayed you. Life in Dhoonidhoo.",
        scene: "epilogue_prison",
        ending: "PUPPET"
    },
    redemption: {
        id: "epilogue_redemption",
        title: "Epilogue: Cycles Broken",
        description: "2025 - Democracy restored. You found peace.",
        scene: "epilogue_beach",
        ending: "REDEMPTION"
    },
    martyr: {
        id: "epilogue_martyr",
        title: "Epilogue: The People's Hero",
        description: "2025 - Your sacrifice inspired a nation.",
        scene: "epilogue_grave",
        ending: "MARTYR"
    }
};

// ==================== ACT 10 DIALOGUES ====================
const ACT10_DIALOGUES = {
    storm_gathers: {
        speaker: "Muaz",
        sprite: "üë§",
        lines: [
            { text: "Brother... the city is burning.", dhivehi: true },
            { text: "Mooizbe declared martial law. Military on streets.", dhivehi: true },
            { text: "Alibe's people are protesting. Thousands.", dhivehi: true },
            { text: "This is it. The moment mashakah waited for.", dhivehi: true },
            { text: "What do mashakah do?", dhivehi: true }
        ]
    },
    
    final_allegiance_choice: {
        speaker: "Narrator",
        sprite: "üìñ",
        lines: [
            { text: "The fate of Raajje hangs in the balance.", dhivehi: false },
            { text: "Your choices have led you here.", dhivehi: false },
            { text: "Now... make your final decision.", dhivehi: false }
        ],
        choices: [
            { text: "Seize power. Aharen will be the new ruler.", karma: -50, response: "path_tyrant", path: "tyrant" },
            { text: "Help Mooizbe. He promised protection.", karma: -30, response: "path_puppet", path: "puppet" },
            { text: "Help Alibe. Restore democracy peacefully.", karma: 30, response: "path_redemption", path: "redemption" },
            { text: "Sacrifice myself. End the violence.", karma: 50, response: "path_martyr", path: "martyr" }
        ]
    },
    
    path_tyrant: {
        speaker: "Baokalo",
        sprite: "üßëüèæ",
        lines: [
            { text: "*cold determination* Mooizbe. Alibe. They're all the same.", dhivehi: true },
            { text: "Politicians. Liars. Users.", dhivehi: true },
            { text: "Aharen built this empire. Aharen will rule it.", dhivehi: true },
            { text: "Raajje needs a strong hand. Aharen hand.", dhivehi: true },
            { text: "Tonight... aharen take the palace.", dhivehi: true }
        ]
    },
    
    path_puppet: {
        speaker: "Baokalo",
        sprite: "üßëüèæ",
        lines: [
            { text: "*resigned* Mooizbe is evil. But he's powerful.", dhivehi: true },
            { text: "Aharen family needs protection. He promised.", dhivehi: true },
            { text: "Maybe... maybe aharen can change things from inside.", dhivehi: true },
            { text: "Help him win. Then... we'll see.", dhivehi: true }
        ]
    },
    
    path_redemption: {
        speaker: "Baokalo",
        sprite: "üßëüèæ",
        lines: [
            { text: "*hopeful* Father was wrong. Aharen was wrong.", dhivehi: true },
            { text: "Violence only breeds more violence.", dhivehi: true },
            { text: "Alibe... he's not perfect. But he believes in democracy.", dhivehi: true },
            { text: "Aharen will help him. Peacefully.", dhivehi: true },
            { text: "The cycle ends. Today.", dhivehi: true }
        ]
    },
    
    path_martyr: {
        speaker: "Baokalo",
        sprite: "üßëüèæ",
        lines: [
            { text: "*at peace* Aharen understand now.", dhivehi: true },
            { text: "Aharen life... it was never about aharen.", dhivehi: true },
            { text: "It was about Raajje. About the people.", dhivehi: true },
            { text: "If aharen death can stop the bloodshed...", dhivehi: true },
            { text: "Then aharen die gladly. For Raajje.", dhivehi: true }
        ]
    },
    
    // TYRANT ENDING
    tyrant_victory: {
        speaker: "Baokalo",
        sprite: "üëë",
        lines: [
            { text: "*sitting on throne* Mooizbe is dead. Alibe is exiled.", dhivehi: true },
            { text: "The military answers to aharen now.", dhivehi: true },
            { text: "Aharen am President. No... aharen am KING.", dhivehi: true },
            { text: "Let them call aharen tyrant. Aharen don't care.", dhivehi: true },
            { text: "Raajje is aharen. Forever.", dhivehi: true }
        ]
    },
    
    tyrant_epilogue: {
        speaker: "Narrator",
        sprite: "üìñ",
        lines: [
            { text: "2025. Two years since the coup.", dhivehi: false },
            { text: "Baokalo rules with an iron fist.", dhivehi: false },
            { text: "The gangs are now the government.", dhivehi: false },
            { text: "Opposition? Silenced. Press? Controlled.", dhivehi: false },
            { text: "The cycle didn't break. It consumed everything.", dhivehi: false },
            { text: "And somewhere, a young boy watches...", dhivehi: false },
            { text: "...and dreams of revenge.", dhivehi: false }
        ]
    },
    
    // PUPPET ENDING
    puppet_betrayal: {
        speaker: "President Mooizbe",
        sprite: "üé©",
        lines: [
            { text: "*laughing* Kaley thought aharen would share power?", dhivehi: true },
            { text: "Kaley useful. But kaley know too much.", dhivehi: true },
            { text: "Commissioner Hassan! Arrest this criminal.", dhivehi: true },
            { text: "Life sentence. Dhoonidhoo. Like kaley father.", dhivehi: true },
            { text: "Thank kaley for kaley service. *laughs*", dhivehi: true }
        ]
    },
    
    puppet_epilogue: {
        speaker: "Narrator",
        sprite: "üìñ",
        lines: [
            { text: "2025. Two years in Dhoonidhoo.", dhivehi: false },
            { text: "Baokalo trusted the wrong man.", dhivehi: false },
            { text: "Mooizbe rules unchallenged.", dhivehi: false },
            { text: "The family? Scattered. Broken.", dhivehi: false },
            { text: "In his cell, Baokalo thinks of his father.", dhivehi: false },
            { text: "Same prison. Same fate.", dhivehi: false },
            { text: "The cycle continues.", dhivehi: false }
        ]
    },
    
    // REDEMPTION ENDING
    redemption_victory: {
        speaker: "Alibe",
        sprite: "üì¢",
        lines: [
            { text: "*emotional* Mashakah did it. Peacefully.", dhivehi: true },
            { text: "Mooizbe has resigned. Free elections coming.", dhivehi: true },
            { text: "Kaley... kaley could have taken power. Why didn't kaley?", dhivehi: true },
            { text: "Kaley broke the cycle. Kaley father would be proud.", dhivehi: true },
            { text: "What will kaley do now?", dhivehi: true }
        ]
    },
    
    redemption_epilogue: {
        speaker: "Narrator",
        sprite: "üìñ",
        lines: [
            { text: "2025. Two years since the peaceful transition.", dhivehi: false },
            { text: "Baokalo left the gang life behind.", dhivehi: false },
            { text: "He runs a fishing business now. Honest work.", dhivehi: false },
            { text: "Rippoo is proud. Nunnu visits often.", dhivehi: false },
            { text: "Muaz? He's in politics now. The legal kind.", dhivehi: false },
            { text: "The cycle is broken.", dhivehi: false },
            { text: "For the first time in generations... there is hope.", dhivehi: false }
        ]
    },
    
    // MARTYR ENDING
    martyr_speech: {
        speaker: "Baokalo",
        sprite: "üßëüèæ",
        lines: [
            { text: "*standing before the military* STOP!", dhivehi: true },
            { text: "Aharen am Baokalo. Son of Ibrahim Ronda.", dhivehi: true },
            { text: "Aharen have killed. Aharen have stolen. Aharen have sinned.", dhivehi: true },
            { text: "But today... aharen stand for something greater.", dhivehi: true },
            { text: "If kaley want to shoot the people... shoot aharen first.", dhivehi: true },
            { text: "SHOOT AHAREN!", dhivehi: true }
        ]
    },
    
    martyr_death: {
        speaker: "Narrator",
        sprite: "üìñ",
        lines: [
            { text: "A single shot rang out.", dhivehi: false },
            { text: "Baokalo fell.", dhivehi: false },
            { text: "But in that moment... something changed.", dhivehi: false },
            { text: "The soldiers lowered their weapons.", dhivehi: false },
            { text: "The crowd surged forward.", dhivehi: false },
            { text: "Not in violence. In grief. In unity.", dhivehi: false },
            { text: "Mooizbe fled that night.", dhivehi: false }
        ]
    },
    
    martyr_epilogue: {
        speaker: "Narrator",
        sprite: "üìñ",
        lines: [
            { text: "2025. Two years since the sacrifice.", dhivehi: false },
            { text: "They call him the People's Hero now.", dhivehi: false },
            { text: "His grave is a shrine. Flowers every day.", dhivehi: false },
            { text: "Raajje is free. Democracy restored.", dhivehi: false },
            { text: "Nunnu wrote his story. A bestseller.", dhivehi: false },
            { text: "Rippoo visits the grave every Friday.", dhivehi: false },
            { text: "'My son,' she whispers. 'You broke the cycle.'", dhivehi: false },
            { text: "And somewhere, a young boy reads the book...", dhivehi: false },
            { text: "...and dreams of being a hero.", dhivehi: false }
        ]
    },
    
    // FINAL FAMILY DIALOGUES
    rippoo_final: {
        speaker: "Rippoo",
        sprite: "üëµüèæ",
        lines: [
            { text: "*crying* My son... whatever kaley choose...", dhivehi: true },
            { text: "Aharen love kaley. Always.", dhivehi: true },
            { text: "Kaley father... he would understand.", dhivehi: true },
            { text: "Go. Do what kaley must.", dhivehi: true }
        ]
    },
    
    nunnu_final: {
        speaker: "Nunnu",
        sprite: "üë©üèæ",
        lines: [
            { text: "*hugging* Brother... be careful.", dhivehi: true },
            { text: "Aharen will tell kaley story. Whatever happens.", dhivehi: true },
            { text: "The world will know who kaley really were.", dhivehi: true }
        ]
    },
    
    muaz_final: {
        speaker: "Muaz",
        sprite: "üë§",
        lines: [
            { text: "Brother... mashakah came so far together.", dhivehi: true },
            { text: "Whatever kaley decide... aharen with kaley.", dhivehi: true },
            { text: "Blood is blood. Forever.", dhivehi: true }
        ]
    }
};

// ==================== ENDING SYSTEM ====================
const ENDINGS = {
    tyrant: {
        id: "tyrant",
        title: "THE TYRANT",
        subtitle: "You became what you hated",
        karmaRange: [-100, -30],
        requirements: { path: "tyrant" },
        color: "#8B0000",
        icon: "üëë",
        summary: "Baokalo seized power through violence, becoming the new dictator of Raajje. The cycle of corruption continues."
    },
    puppet: {
        id: "puppet",
        title: "THE PUPPET",
        subtitle: "Betrayed by those you served",
        karmaRange: [-30, 0],
        requirements: { path: "puppet" },
        color: "#4a4a4a",
        icon: "‚õìÔ∏è",
        summary: "Baokalo trusted Mooizbe and was betrayed. He rots in prison, just like his father before him."
    },
    redemption: {
        id: "redemption",
        title: "REDEMPTION",
        subtitle: "The cycle is broken",
        karmaRange: [0, 50],
        requirements: { path: "redemption" },
        color: "#228B22",
        icon: "üåÖ",
        summary: "Baokalo chose peace over power. Democracy was restored, and he found a new life away from crime."
    },
    martyr: {
        id: "martyr",
        title: "THE MARTYR",
        subtitle: "A hero's sacrifice",
        karmaRange: [50, 100],
        requirements: { path: "martyr" },
        color: "#FFD700",
        icon: "üïØÔ∏è",
        summary: "Baokalo gave his life to save Raajje. His sacrifice inspired a nation and ended the cycle of violence."
    }
};

// ==================== ACT 10 RADIO CONTENT ====================
const ACT10_RADIO = {
    raajjeFM: {
        name: "üìª Raajje FM (State Controlled)",
        segments: [
            { type: "emergency", text: "MARTIAL LAW DECLARED. Stay indoors." },
            { type: "news", text: "President Mooizbe addresses the nation: 'Order will be restored.'" },
            { type: "warning", text: "Curfew in effect. Violators will be arrested." },
            { type: "news", text: "Opposition leaders called 'terrorists' by government." }
        ]
    },
    freedomFM: {
        name: "üìª Freedom FM (Underground)",
        segments: [
            { type: "call", text: "Citizens! This is our moment! Take to the streets!" },
            { type: "truth", text: "Mooizbe stole the election. We have proof." },
            { type: "music", text: "‚ô™ Playing: Songs of Revolution ‚ô™" },
            { type: "call", text: "Remember 2012! Never again!" }
        ]
    }
};

// ==================== EXPORT FOR MAIN GAME ====================
if (typeof window !== 'undefined') {
    window.ACT10_MAPS = ACT10_MAPS;
    window.ACT10_MISSIONS = ACT10_MISSIONS;
    window.EPILOGUE_MISSIONS = EPILOGUE_MISSIONS;
    window.ACT10_DIALOGUES = ACT10_DIALOGUES;
    window.ENDINGS = ENDINGS;
    window.ACT10_RADIO = ACT10_RADIO;
}

</script>
</body>
</html>
